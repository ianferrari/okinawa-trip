<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>å¥å¥å…¨å®¶æ²–ç¹©éŠ ğŸ¦• v16.0 Survival</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* ================= åŸºç¤è¨­å®š ================= */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; -webkit-tap-highlight-color: transparent; transition: background-color 0.5s; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ================= è³ªæ„Ÿç‰¹æ•ˆ ================= */
        .glass { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-dark { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); color: white; }
        .glass-card { background: rgba(255, 255, 255, 0.95); box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.6); }

        /* ================= æ¨¡å¼ç‰¹æ•ˆ ================= */
        body.rainy-mode #bg-layer { filter: grayscale(80%) brightness(0.6); }
        body.rainy-mode .glass-card { border-left: 4px solid #60a5fa !important; }
        .rain-badge { display: none; }
        body.rainy-mode .rain-badge { display: inline-block; }

        /* å¡ç‰‡æ¨£å¼ */
        .smart-card { background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); border: 2px solid #3b82f6; box-shadow: 0 10px 40px -10px rgba(59, 130, 246, 0.4); }
        .safe-card { background: linear-gradient(135deg, #fff1f2 0%, #fff 100%); border-left: 5px solid #e11d48; }
        .parking-card { background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); border: 2px solid #22c55e; }

        /* ================= v16.0 æ–°å¢æ¨£å¼ (é•·æ¢åœ– & æµ·æ´‹åœ–é‘‘) ================= */
        /* é•·æ¢åœ– */
        .bar-container { display: flex; align-items: flex-end; justify-content: space-between; height: 120px; padding-top: 20px; }
        .bar-col { display: flex; flex-direction: column; align-items: center; gap: 4px; flex: 1; }
        .bar-bg { width: 12px; background-color: #f1f5f9; border-radius: 4px; height: 100%; position: relative; overflow: hidden; }
        .bar-fill { position: absolute; bottom: 0; left: 0; right: 0; background-color: #3b82f6; border-radius: 4px; transition: height 0.5s ease-out; }
        .bar-fill.alert { background-color: #ef4444; } /* è¶…æ”¯è®Šç´… */

        /* æµ·æ´‹åœ–é‘‘å¡ç‰‡ */
        .fish-card { scroll-snap-align: center; flex-shrink: 0; width: 200px; background: white; border-radius: 20px; overflow: hidden; border: 4px solid #e0f2fe; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        .fish-card img { width: 100%; height: 150px; object-fit: cover; }
        .fish-card:active { transform: scale(0.95); transition: transform 0.1s; }

        /* è¡Œç¨‹æ™‚é–“è»¸ */
        .timeline-connector { position: absolute; left: 2.2rem; top: 3.5rem; bottom: -1rem; border-left: 2px dashed #cbd5e1; z-index: 0; display: flex; align-items: center; justify-content: center; }
        .travel-pill { background-color: #f8fafc; border: 1px solid #cbd5e1; color: #64748b; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 99px; white-space: nowrap; z-index: 10; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* ç¡¬å¹£ & æ¨™èªŒ */
        .coin-500 { background: radial-gradient(circle at 30% 30%, #fde047, #eab308); border: 2px solid #ca8a04; color: #713f12; }
        .coin-100 { background: radial-gradient(circle at 30% 30%, #f1f5f9, #cbd5e1); border: 2px solid #94a3b8; color: #475569; }
        .coin-50 { background: radial-gradient(circle at 30% 30%, #f1f5f9, #cbd5e1); border: 2px solid #94a3b8; color: #475569; position: relative; }
        .coin-50::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25%; height: 25%; background: #0f172a; border-radius: 50%; border: 1px solid #94a3b8; } 
        .coin-10 { background: radial-gradient(circle at 30% 30%, #fdba74, #ea580c); border: 2px solid #c2410c; color: #7c2d12; }
        .coin-5 { background: radial-gradient(circle at 30% 30%, #fde047, #ca8a04); border: 2px solid #b45309; color: #78350f; position: relative; }
        .coin-5::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25%; height: 25%; background: #0f172a; border-radius: 50%; border: 1px solid #b45309; }
        .coin-1 { background: radial-gradient(circle at 30% 30%, #e2e8f0, #94a3b8); border: 1px solid #64748b; color: #334155; }
        .order-card { background: white; border: 2px solid #e2e8f0; border-radius: 1rem; padding: 1rem; text-align: center; transition: all 0.2s; cursor: pointer; }
        .order-card:active { border-color: #3b82f6; background-color: #eff6ff; transform: scale(0.95); }

        /* ================= å‹•ç•« Keyframes ================= */
        @keyframes pulse-blue { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 50% { transform: rotate(0eg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        @keyframes wave { 0%, 100% { height: 40%; } 50% { height: 100%; } }
        
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-pop { animation: pop 0.4s ease-in-out; }
        .animate-shake { animation: shake 0.3s ease-in-out 3; }
        .pulse-dot { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); animation: pulse-blue 2s infinite; }

        /* å…¶ä»–å…ƒä»¶ */
        #drawing-modal, #modal-overlay, #expense-modal, #gasha-modal, #reward-editor-modal, #gift-modal, #food-modal, #daily-check-modal, #spot-modal, #sos-card-modal, #fish-modal { display: none; }
        .open { display: flex !important; }
        .pt-safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        #toast { visibility: hidden; min-width: 200px; transform: translateX(-50%); background-color: rgba(30, 41, 59, 0.95); color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 999; left: 50%; bottom: 120px; font-size: 14px; backdrop-filter: blur(8px); box-shadow: 0 10px 40px rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        #toast.show { visibility: visible; opacity: 1; bottom: 130px; }
        
        #jpyInput, #twdOutput, #rateInput { font-weight: 900; }
        #rateInput { border-bottom: 2px dashed #ca8a04; color: #ca8a04; width: 100px; text-align: center; }
        .pie-chart { width: 140px; height: 140px; border-radius: 50%; position: relative; margin: 0 auto; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        .pie-chart::after { content: ""; position: absolute; width: 80px; height: 80px; background: white; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 overflow-hidden relative">

    <div id="bg-layer" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-700 transform scale-105" 
         style="background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=1000&fit=crop');">
        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/10 to-slate-100/90"></div>
    </div>

    <div class="z-10 pt-safe-top px-5 pb-2 flex-shrink-0">
        <div class="flex justify-between items-start pt-6 mb-4 text-white">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="bg-blue-600 px-2 py-0.5 rounded-md text-[10px] font-bold tracking-wider uppercase shadow-lg border border-blue-400/30">2026 TRIP</span>
                    <div id="countdown" class="text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10">è¨ˆç®—ä¸­...</div>
                </div>
                <h1 class="text-3xl font-black tracking-tight drop-shadow-lg leading-tight">å¥å¥å…¨å®¶<br>æ²–ç¹©éŠ ğŸ¦•</h1>
                <p class="text-sm opacity-95 font-medium mt-2 text-blue-100 drop-shadow-md"><i class="fas fa-calendar-alt mr-1"></i>3/28 (å…­) - 4/3 (äº”)</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="toggleRainMode()" id="rain-btn" class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-white/20">
                    <i id="rain-icon" class="fas fa-sun text-xl mb-1 block text-yellow-400"></i>
                    <span id="rain-text" class="text-[9px] font-bold opacity-90">æ™´å¤©</span>
                </button>

                <div class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[70px] active:scale-95 transition-transform cursor-pointer" onclick="initWeather()">
                    <i id="weather-icon" class="fas fa-spinner fa-spin text-xl mb-1 block text-blue-300"></i>
                    <span id="weather-temp" class="text-sm font-bold">...</span>
                    <div id="weather-loc" class="text-[9px] opacity-70 mt-0.5">é‡æ•´</div>
                </div>
            </div>
        </div>

        <div id="sub-nav-container" class="mt-2 min-h-[44px]"></div>
    </div>
    
    <div id="main-scroll" class="flex-1 overflow-y-auto p-4 pb-32 z-10 scroll-smooth rounded-t-[2.5rem] bg-slate-50 shadow-[0_-10px_40px_rgba(0,0,0,0.15)] relative top-2">
    </div>

    <div class="fixed bottom-0 w-full glass flex justify-around items-center pb-safe-bottom h-[85px] z-50 rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-itinerary">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-map-location-dot text-xl text-blue-600"></i></div>
            <span class="text-[10px] font-bold text-blue-600">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('checklist')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-checklist">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-clipboard-list text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('missions')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-missions">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-medal text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æˆå°±</span>
        </button>
        <button onclick="switchTab('tools')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-tools">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-toolbox text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">å·¥å…·</span>
        </button>
    </div>

    <button onclick="openQuickExpense()" class="fixed bottom-[100px] right-4 w-14 h-14 bg-pink-500 rounded-full text-white shadow-2xl flex items-center justify-center z-40 active:scale-90 transition-transform border-4 border-white/20 backdrop-blur group">
        <i class="fas fa-plus text-2xl group-active:rotate-90 transition-transform"></i>
    </button>

    <div id="spot-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6 hidden" onclick="closeSpotModal()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl shadow-2xl relative h-[80vh] flex flex-col animate-slide-up" onclick="event.stopPropagation()">
            <button onclick="closeSpotModal()" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/30 text-white backdrop-blur flex items-center justify-center"><i class="fas fa-times"></i></button>
            <div id="spot-hero" class="spot-hero flex-shrink-0">
                <div class="absolute bottom-4 left-4 text-white z-10">
                    <h3 id="spot-title" class="text-2xl font-black drop-shadow-md">æ™¯é»åç¨±</h3>
                    <div id="spot-tags" class="flex gap-2 mt-2"></div>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1 pb-safe-bottom">
                <div id="spot-desc" class="text-gray-600 leading-relaxed mb-6 text-sm"></div>
                <div class="bg-blue-50 rounded-xl p-4 mb-4 border border-blue-100">
                    <div class="text-xs font-bold text-blue-500 uppercase mb-2"><i class="fas fa-lightbulb mr-1"></i> å¥å¥çˆ¸ç­†è¨˜ (Tips)</div>
                    <div id="spot-tips" class="text-sm font-bold text-gray-800"></div>
                </div>
                <a id="spot-nav-btn" href="#" target="_blank" class="block w-full bg-blue-600 text-white text-center font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform"><i class="fas fa-location-arrow mr-2"></i> å°èˆªå»é€™è£¡</a>
            </div>
        </div>
    </div>

    <div id="fish-modal" class="fixed inset-0 z-[100] bg-blue-900/90 backdrop-blur-md flex items-center justify-center p-4 hidden" onclick="document.getElementById('fish-modal').classList.remove('open')">
        <div class="w-full max-w-sm relative" onclick="event.stopPropagation()">
            <h3 class="text-center text-white text-2xl font-black mb-4 drop-shadow-md"><i class="fas fa-fish mr-2"></i>å¥å¥çš„æµ·æ´‹åœ–é‘‘</h3>
            <div id="fish-container" class="flex overflow-x-auto gap-4 pb-8 snap-x snap-mandatory hide-scrollbar">
                </div>
            <p class="text-center text-blue-200 text-xs mt-2">å·¦å³æ»‘å‹•æ‰¾æ‰¾çœ‹ï¼</p>
            <button onclick="document.getElementById('fish-modal').classList.remove('open')" class="absolute -bottom-12 left-1/2 -translate-x-1/2 w-10 h-10 bg-white/20 rounded-full text-white flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div id="sos-card-modal" class="fixed inset-0 z-[200] bg-red-600 flex flex-col items-center justify-center p-6 text-white hidden text-center">
        <button onclick="closeSosCard()" class="absolute top-6 right-6 text-white/70 text-4xl"><i class="fas fa-times-circle"></i></button>
        <div class="mb-8 animate-pulse"><i class="fas fa-exclamation-triangle text-6xl text-yellow-300"></i></div>
        <div class="text-xl font-bold mb-2 opacity-80">æˆ‘æ˜¯å°ç£äººï¼Œè«‹å¹«åŠ©æˆ‘</div>
        <h2 id="sos-jp-text" class="text-4xl sm:text-5xl font-black leading-tight mb-4 bg-white text-red-600 p-4 rounded-xl shadow-xl w-full">åŠ©ã‘ã¦ãã ã•ã„</h2>
        <p id="sos-sub-text" class="text-lg font-bold opacity-90">Please help me.</p>
        
        <div class="grid grid-cols-2 gap-4 w-full mt-10">
            <button onclick="setSosMsg('sick')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40">å°å­©ç”Ÿç—…<br>å­ä¾›ãŒç—…æ°—</button>
            <button onclick="setSosMsg('lost')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40">è¿·è·¯äº†<br>è¿·å­ã§ã™</button>
            <button onclick="setSosMsg('police')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40">å ±è­¦<br>è­¦å¯Ÿã‚’å‘¼ã‚“ã§</button>
            <button onclick="setSosMsg('ambulance')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40">å«æ•‘è­·è»Š<br>æ•‘æ€¥è»Šï¼</button>
        </div>
    </div>

    <div id="drawing-modal" class="fixed inset-0 z-[200] bg-white flex flex-col hidden">
        <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-white z-10">
            <h3 class="font-black text-xl text-gray-800"><i class="fas fa-palette text-purple-500 mr-2"></i>å°å°ç•«å®¶</h3>
            <button onclick="closeDrawing()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 relative bg-slate-50 overflow-hidden" id="canvas-container">
            <canvas id="drawing-canvas" class="w-full h-full touch-none"></canvas>
        </div>
        <div class="p-4 bg-white border-t border-gray-100 pb-safe-bottom">
            <div class="flex justify-between items-center gap-2">
                <div class="flex gap-2">
                    <button class="color-btn w-8 h-8 rounded-full bg-black ring-2 ring-offset-2 ring-transparent active" onclick="setColor('black', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-red-500 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#ef4444', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#3b82f6', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-green-500 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#22c55e', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-yellow-400 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#facc15', this)"></button>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearCanvas()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                    <button onclick="saveDrawing()" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg"><i class="fas fa-save"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="gift-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden" onclick="closeGiftModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-5 shadow-2xl relative h-[70vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 class="text-lg font-black text-gray-800"><i class="fas fa-gift text-red-500 mr-2"></i>ä¼´æ‰‹ç¦®æ¸…å–®</h3>
                <button onclick="closeGiftModal()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="gift-list-container" class="flex-1 overflow-y-auto space-y-2 mb-4 hide-scrollbar"></div>
            <div class="border-t pt-4 space-y-3">
                <input id="gift-who" type="text" placeholder="å°è±¡ (å¦‚: é˜¿å¬¤)" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500 font-bold">
                <input id="gift-what" type="text" placeholder="è¦è²·ä»€éº¼?" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500">
                <div class="flex gap-2">
                    <input id="gift-budget" type="number" placeholder="é ç®—(Â¥)" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500">
                    <button onclick="addGift()" class="bg-red-500 text-white font-bold px-6 py-2 rounded-xl shadow-lg active:scale-95 whitespace-nowrap"><i class="fas fa-plus mr-1"></i> æ–°å¢</button>
                </div>
            </div>
        </div>
    </div>
    <div id="expense-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6" onclick="closeQuickExpense()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl relative animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-gray-800"><i class="fas fa-bolt text-yellow-400 mr-2"></i>å¿«é€Ÿè¨˜å¸³</h3>
                <button onclick="closeQuickExpense()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="shopping" class="peer sr-only" checked><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-bag-shopping"></i> è³¼ç‰©</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="food" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-utensils"></i> é¤é£²</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="play" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-purple-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-ticket"></i> å¨›æ¨‚</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="transport" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-car"></i> äº¤é€š</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="other" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-slate-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-box"></i> å…¶ä»–</div></label>
                </div>
                <input id="quickExName" type="text" placeholder="å“é …åç¨± (å¦‚: å†°æ·‡æ·‹)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-pink-500">
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                    <input id="quickExPrice" type="number" placeholder="é‡‘é¡ (æ—¥å¹£)" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-8 pr-4 py-3 text-xl font-black text-gray-800 focus:outline-pink-500">
                </div>
                <button onclick="saveQuickExpense()" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-transform text-lg mt-2"><i class="fas fa-check mr-2"></i> å„²å­˜é€™ç­†</button>
            </div>
        </div>
    </div>

    <div id="gasha-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col hidden" onclick="closeGashaModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative animate-pop" onclick="event.stopPropagation()">
            <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-yellow-400 w-20 h-20 rounded-full flex items-center justify-center text-4xl shadow-lg border-4 border-white">ğŸ‰</div>
            <div class="mt-8">
                <div class="text-sm font-bold text-gray-400 mb-1 uppercase tracking-widest">Congratulations!</div>
                <div class="text-2xl font-black text-gray-900 mb-4">æ­å–œç²å¾—çå‹µ</div>
                <div class="bg-yellow-50 rounded-2xl p-6 border-2 border-yellow-200 mb-6">
                    <div id="gasha-reward-icon" class="text-6xl mb-3 block"></div>
                    <div id="gasha-reward-text" class="text-xl font-bold text-yellow-700"></div>
                </div>
                <button onclick="closeGashaModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold w-full shadow-lg active:scale-95 transition-transform">å¤ªæ£’äº†ï¼æ”¶ä¸‹</button>
            </div>
        </div>
    </div>

    <div id="food-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 hidden" onclick="document.getElementById('food-modal').classList.remove('open')">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-black text-gray-800 mb-2">ä»Šå¤©åƒä»€éº¼ï¼ŸğŸ˜‹</h3>
            <p class="text-xs text-gray-400 mb-6">ä¸çŸ¥é“åƒä»€éº¼çš„æ™‚å€™ï¼Œè®“å‘½é‹æ±ºå®šï¼</p>
            <div class="bg-orange-50 rounded-full w-48 h-48 mx-auto flex flex-col items-center justify-center border-4 border-orange-200 mb-8 relative overflow-hidden shadow-inner">
                <div id="food-result" class="text-7xl mb-2 z-10">â“</div>
                <div id="food-text" class="text-lg font-bold text-orange-800 z-10">é»æ“ŠæŒ‰éˆ•</div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-white/40 to-transparent"></div>
            </div>
            <button onclick="spinFood()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform text-lg"><i class="fas fa-dice mr-2"></i> å¹«æˆ‘é¸ï¼</button>
        </div>
    </div>

    <div id="daily-check-modal" class="fixed inset-0 z-[150] bg-blue-900/90 backdrop-blur-md flex items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-slide-up">
            <div class="text-center mb-6">
                <div class="inline-block p-3 rounded-full bg-blue-100 text-blue-600 text-3xl mb-3"><i class="fas fa-door-open"></i></div>
                <h3 class="text-2xl font-black text-gray-800">å‡ºé–€å‰æª¢æŸ¥ï¼</h3>
                <p class="text-sm text-gray-500">ç¢ºèªæ²’å¿˜è¨˜é€™äº›æ±è¥¿å†å‡ºç™¼</p>
            </div>
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100 active:bg-blue-50 transition-colors">
                    <input type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="checkDailyItem(this)">
                    <span class="font-bold text-gray-700">ğŸ”‘ æˆ¿å¡é‚„äº†å—ï¼Ÿ</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100 active:bg-blue-50 transition-colors">
                    <input type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="checkDailyItem(this)">
                    <span class="font-bold text-gray-700">ğŸ’§ æ°´å£ºè£æ»¿äº†å—ï¼Ÿ</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100 active:bg-blue-50 transition-colors">
                    <input type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="checkDailyItem(this)">
                    <span class="font-bold text-gray-700">ğŸ¼ å°¿å¸ƒ/å¥¶ç²‰å¸¶å¤ å—ï¼Ÿ</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100 active:bg-blue-50 transition-colors">
                    <input type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="checkDailyItem(this)">
                    <span class="font-bold text-gray-700">ğŸ“± Wifiæ©Ÿ/æ‰‹æ©Ÿï¼Ÿ</span>
                </label>
            </div>
            <button id="daily-check-btn" onclick="finishDailyCheck()" disabled class="w-full bg-gray-300 text-white font-bold py-3 rounded-xl transition-all"><i class="fas fa-check mr-2"></i> éƒ½å¸¶äº†ï¼Œå‡ºç™¼ï¼</button>
        </div>
    </div>

    <div id="reward-editor-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden" onclick="closeRewardEditor()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-5 shadow-2xl relative h-[70vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 class="text-lg font-black text-gray-800"><i class="fas fa-gift text-pink-500 mr-2"></i>è¨­å®šæ‰­è›‹çå“</h3>
                <button onclick="closeRewardEditor()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="reward-list" class="flex-1 overflow-y-auto space-y-2 mb-4 hide-scrollbar"></div>
            <div class="border-t pt-4">
                <div class="flex gap-2 mb-2">
                    <select id="new-reward-icon" class="bg-gray-50 border border-gray-200 rounded-xl px-2 text-xl">
                        <option value="ğŸ¬">ğŸ¬</option><option value="ğŸ“º">ğŸ“º</option><option value="ğŸ¦">ğŸ¦</option>
                        <option value="ğŸ§¸">ğŸ§¸</option><option value="ğŸ¹">ğŸ¹</option><option value="ğŸ§â€â™‚ï¸">ğŸ§â€â™‚ï¸</option>
                        <option value="ğŸ¥š">ğŸ¥š</option><option value="ğŸš—">ğŸš—</option>
                    </select>
                    <input id="new-reward-text" type="text" placeholder="è¼¸å…¥æ–°çå“" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-sm">
                </div>
                <button onclick="addReward()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow active:scale-[0.98]"><i class="fas fa-plus mr-1"></i> æ–°å¢çé …</button>
                <button onclick="resetRewards()" class="w-full mt-2 text-xs text-gray-400 py-2">æ¢å¾©é è¨­å€¼</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col hidden" onclick="closeModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800"><i class="fas fa-times text-2xl"></i></button>
            <div id="modal-tag" class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-widest">çµ¦å¸æ©Ÿçœ‹ (For Driver)</div>
            <div id="modal-title" class="text-2xl font-black text-gray-900 mb-6 border-b pb-4">ã“ã®ãƒ›ãƒ†ãƒ«ã¾ã§<br>ãŠé¡˜ã„ã—ã¾ã™</div>
            <div id="modal-content" class="text-xl font-bold text-blue-700 mb-2"></div>
            <div id="modal-note" class="text-xs text-gray-400">è«‹å¸¶æˆ‘å»é€™å®¶é£¯åº—</div>
            <div class="mt-8"><button onclick="closeModal()" class="bg-gray-100 text-gray-600 px-6 py-3 rounded-xl font-bold w-full">é—œé–‰</button></div>
        </div>
    </div>

    <div id="driver-hud" class="fixed inset-0 bg-black z-[200] hidden flex-col p-6 text-white font-mono transition-opacity duration-300">
        <div class="flex justify-between items-center mb-4">
            <div class="flex flex-col">
                <span class="text-xs text-gray-500 uppercase tracking-widest">TIME</span>
                <span id="hud-clock" class="text-2xl font-bold text-gray-300">12:30</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleRoadType()" id="btn-road-type" class="px-4 py-2 rounded-lg border border-blue-900 bg-blue-900/20 text-blue-400 text-sm font-bold active:bg-blue-800 transition-colors">ä¸€èˆ¬é“è·¯ (50)</button>
                <button onclick="closeDriverMode()" class="w-10 h-10 rounded-full bg-red-900/30 text-red-500 border border-red-900/50 flex items-center justify-center active:scale-95"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <div class="flex flex-col items-center text-center relative mb-4">
            <div class="w-full">
                <h1 id="hud-title" class="text-3xl font-black text-white leading-tight drop-shadow-md truncate px-2">è¼‰å…¥ä¸­...</h1>
                <div class="my-4 w-full bg-gray-900 rounded-xl border border-gray-800 p-3 relative group active:bg-gray-800 transition-colors cursor-pointer" onclick="copyHudMapCode()">
                    <div class="text-[9px] text-gray-500 tracking-[0.2em] mb-1">MAPCODE</div>
                    <div id="hud-mapcode" class="text-4xl font-black text-yellow-400 tracking-wider font-mono">--- ---</div>
                </div>
                <a id="hud-nav-btn" href="#" target="_blank" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xl font-black py-4 rounded-xl shadow-[0_0_20px_rgba(37,99,235,0.3)] active:scale-[0.98] transition-all flex items-center justify-center gap-3"><i class="fas fa-location-arrow animate-pulse"></i><span>GO å°èˆª</span></a>
            </div>
        </div>

        <div class="flex-1 flex flex-col justify-center items-center relative">
            <div class="text-xs text-gray-600 font-bold uppercase tracking-[0.5em] mb-2">SPEED (GPS)</div>
            <div class="flex items-baseline justify-center gap-2 relative">
                <span id="hud-speed" class="text-[9rem] font-black text-white leading-none tracking-tighter transition-all duration-200 drop-shadow-2xl">0</span>
                <span class="text-xl text-gray-500 font-bold absolute -right-12 bottom-8">km/h</span>
            </div>
            <div id="speed-warning" class="opacity-0 transition-opacity duration-300 text-red-500 font-black text-lg mt-2 tracking-widest bg-red-900/30 px-3 py-1 rounded animate-pulse">
                âš ï¸ SLOW DOWN
            </div>
        </div>

        <div class="absolute bottom-8 right-6 flex gap-4">
             <button onclick="changeHudEvent(-1)" class="w-16 h-16 rounded-2xl border border-gray-800 bg-gray-900/80 text-gray-500 flex items-center justify-center active:bg-gray-800 backdrop-blur"><i class="fas fa-chevron-left text-xl"></i></button>
            <button onclick="changeHudEvent(1)" class="w-16 h-16 rounded-2xl border border-gray-700 bg-gray-800/80 text-white flex items-center justify-center active:bg-gray-700 shadow-lg shadow-white/5 backdrop-blur"><i class="fas fa-chevron-right text-xl"></i></button>
        </div>
    </div>

    <div id="toast"><i class="fas fa-check-circle mr-2 text-green-400"></i><span id="toast-msg">å·²è¤‡è£½</span></div>
    // ================= 2. é‚è¼¯èˆ‡åŠŸèƒ½ (LOGIC) =================

    function init() {
        if(isRainyMode) updateRainyModeUI();
        switchTab('itinerary');
        updateCountdown();
        setInterval(updateCountdown, 60000);
        initWeather();
        checkDailyPopup(); 
    }

    // å¤©æ°£æ¨¡çµ„
    function initWeather() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => fetchWeather(position.coords.latitude, position.coords.longitude, "ç›®å‰ä½ç½®"),
                (error) => fetchWeather(26.5915, 127.9773, "åè­·å¸‚")
            );
        } else { fetchWeather(26.5915, 127.9773, "åè­·å¸‚"); }
    }

    async function fetchWeather(lat, lon, label) {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            const temp = Math.round(data.current_weather.temperature);
            const code = data.current_weather.weathercode;
            document.getElementById('weather-temp').innerText = temp + "Â°C";
            document.getElementById('weather-loc').innerText = label;
            const iconEl = document.getElementById('weather-icon');
            if (code <= 1) iconEl.className = "fas fa-sun text-xl mb-1 block text-yellow-400";
            else if (code <= 3) iconEl.className = "fas fa-cloud-sun text-xl mb-1 block text-yellow-400";
            else if (code <= 65) iconEl.className = "fas fa-cloud-rain text-xl mb-1 block text-blue-300";
            else iconEl.className = "fas fa-bolt text-xl mb-1 block text-yellow-500";
        } catch (e) {
            document.getElementById('weather-temp').innerText = "24Â°C";
            document.getElementById('weather-loc').innerText = "é å ±";
        }
    }

    function updateCountdown() {
        const tripStart = new Date(`${TRIP_YEAR}-03-28T13:15:00`).getTime();
        const tripEnd = new Date(`${TRIP_YEAR}-04-03T23:59:59`).getTime();
        const now = new Date().getTime();
        const el = document.getElementById('countdown');
        if (now < tripStart) {
            const diff = tripStart - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            el.innerText = `é‚„æœ‰ ${days} å¤© ${hours} å°æ™‚`;
            el.className = "text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10";
        } else if (now >= tripStart && now <= tripEnd) {
            el.innerText = "âœˆï¸ æ—…ç¨‹é€²è¡Œä¸­";
            el.className = "text-[10px] font-bold opacity-100 bg-pink-500/80 text-white px-2 py-0.5 rounded-md animate-pulse";
        } else {
            el.innerText = "å›æ†¶æ»¿è¼‰ â¤ï¸";
            el.className = "text-[10px] font-medium opacity-90 bg-gray-500/50 px-2 py-0.5 rounded-md";
        }
    }

    // é é¢åˆ‡æ›
    window.switchTab = (tab, shouldRender = true) => {
        activeTab = tab;
        document.querySelectorAll('.nav-btn').forEach(btn => {
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            const box = btn.querySelector('.icon-box');
            if (btn.id === `btn-${tab}`) {
                icon.className = icon.className.replace('text-gray-400', 'text-blue-600');
                span.className = 'text-[10px] font-bold text-blue-600';
                box.className = 'icon-box p-2 rounded-2xl mb-1 transition-all bg-blue-50';
            } else {
                let defaultIcon = 'toolbox';
                if (btn.id.includes('itinerary')) defaultIcon = 'map-location-dot';
                if (btn.id.includes('checklist')) defaultIcon = 'clipboard-list';
                if (btn.id.includes('missions')) defaultIcon = 'medal';
                icon.className = `fas fa-${defaultIcon} text-xl text-gray-400`;
                span.className = 'text-[10px] font-bold text-gray-400';
                box.className = 'icon-box p-2 rounded-2xl mb-1 transition-all';
            }
        });
        renderHeaderSubNav();
        if (shouldRender) renderContent();
        setTimeout(updateSubNavStyle, 50);
    }
    
    window.switchChecklist = (id) => { currentChecklistFilter = id; renderContent(); updateSubNavStyle(); }
    window.switchTool = (id) => { currentToolFilter = id; renderContent(); updateSubNavStyle(); }
    
    function updateSubNavStyle() {
        if (activeTab === 'checklist') {
            checklistDB.forEach(c => {
                const btn = document.getElementById(`btn-chk-${c.id}`);
                if (btn) btn.className = currentChecklistFilter === c.id ?
                    "flex-1 py-2 rounded-xl text-xs font-bold transition-all bg-white text-blue-600 shadow-sm" :
                    "flex-1 py-2 rounded-xl text-xs font-bold transition-all text-white/80";
            });
        } else if (activeTab === 'tools') {
            // v15.2 å·¥å…·é¸å–®æŒ‰éˆ•ç‹€æ…‹æ›´æ–° (æ–°å¢ signs, coins, sizes, orders)
            ['calc', 'drive', 'signs', 'coins', 'sizes', 'jp', 'orders', 'sos', 'sync'].forEach(t => {
                const btn = document.getElementById(`btn-tool-${t}`);
                if (btn) {
                    let c = "bg-white text-blue-600";
                    if (t === 'calc') c = "bg-white text-yellow-600";
                    if (t === 'sos') c = "bg-white text-red-600";
                    if (t === 'sync') c = "bg-white text-purple-600";
                    btn.className = currentToolFilter === t ?
                        `flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all ${c} shadow-sm` :
                        "flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all text-white/80";
                }
            });
        }
    }

    // æ¸²æŸ“ä¸Šæ–¹å­é¸å–®
    function renderHeaderSubNav() {
        const container = document.getElementById('sub-nav-container');
        if (activeTab === 'itinerary') {
            container.innerHTML = `<div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar px-2">${itineraryDB.map((d, i) => `<button onclick="currentDayIdx=${i}; renderContent(); updateHeaderActive()" class="day-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md transition-all duration-300 ${i === currentDayIdx ? 'tab-active' : 'tab-inactive'}"><div class="text-[10px] opacity-80 uppercase">${d.day}</div><div>${d.date.split(' ')[0]}</div></button>`).join('')}</div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${itineraryDB[currentDayIdx].bg}')`;
        } else if (activeTab === 'checklist') {
            container.innerHTML = `<div class="flex glass-dark p-1 rounded-2xl mx-1">${checklistDB.map(c => `<button id="btn-chk-${c.id}" onclick="switchChecklist('${c.id}')" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentChecklistFilter === c.id ? 'bg-white text-blue-600 shadow-sm' : 'text-white/80'}">${c.title.split(' ')[1]}</button>`).join('')}</div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${bgImages.SHOP}')`;
        } else if (activeTab === 'tools') {
            // å·¥å…·é¸å–®æŒ‰éˆ• (å®Œæ•´ç‰ˆ v15.2)
            container.innerHTML = `
            <div class="flex glass-dark p-1 rounded-2xl mx-1 overflow-x-auto hide-scrollbar">
                <button id="btn-tool-calc" onclick="switchTool('calc')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='calc'?'bg-white text-yellow-600':'text-white/80'}">ğŸ’° åŒ¯ç‡</button>
                <button id="btn-tool-drive" onclick="switchTool('drive')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='drive'?'bg-white text-blue-600':'text-white/80'}">ğŸš— é§•é§›</button>
                <button id="btn-tool-signs" onclick="switchTool('signs')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='signs'?'bg-white text-blue-600':'text-white/80'}">ğŸ›‘ æ¨™èªŒ</button>
                <button id="btn-tool-coins" onclick="switchTool('coins')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='coins'?'bg-white text-blue-600':'text-white/80'}">ğŸª™ ç¡¬å¹£</button>
                <button id="btn-tool-sizes" onclick="switchTool('sizes')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='sizes'?'bg-white text-blue-600':'text-white/80'}">ğŸ‘• å°ºå¯¸</button>
                <button id="btn-tool-jp" onclick="switchTool('jp')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='jp'?'bg-white text-blue-600':'text-white/80'}">ğŸ—£ï¸ æ—¥èª</button>
                <button id="btn-tool-orders" onclick="switchTool('orders')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='orders'?'bg-white text-blue-600':'text-white/80'}">ğŸ£ é»é¤</button>
                <button id="btn-tool-sos" onclick="switchTool('sos')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='sos'?'bg-white text-red-600':'text-white/80'}">ğŸš¨ æ€¥é›£</button>
                <button id="btn-tool-sync" onclick="switchTool('sync')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='sync'?'bg-white text-purple-600':'text-white/80'}">â˜ï¸ åŒæ­¥</button>
            </div>`;
            let bg = bgImages.TOOL;
            if (currentToolFilter === 'calc') bg = bgImages.CALC;
            if (currentToolFilter === 'sync') bg = bgImages.SYNC;
            if (currentToolFilter === 'sos') bg = bgImages.SOS;
            document.getElementById('bg-layer').style.backgroundImage = `url('${bg}')`;
        } else if (activeTab === 'missions') {
            container.innerHTML = `<div class="text-center text-white/90 text-sm font-bold pt-2 drop-shadow-md">å®Œæˆä»»å‹™ç²å¾—ä»£å¹£ï¼</div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${bgImages.MISSION}')`;
        }
    }

    function updateHeaderActive() {
        document.querySelectorAll('.day-btn').forEach((btn, i) => {
            btn.className = `day-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md transition-all duration-300 ${i === currentDayIdx ? 'tab-active' : 'tab-inactive'}`;
        });
        document.getElementById('bg-layer').style.backgroundImage = `url('${itineraryDB[currentDayIdx].bg}')`;
    }

    // æ¸²æŸ“ä¸»å…§å®¹ (Render Main Content) - v15.2
    function renderContent() {
        const main = document.getElementById('main-scroll');
        
        // 1. è¡Œç¨‹ (Itinerary)
        if (activeTab === 'itinerary') {
            const d = itineraryDB[currentDayIdx];
            const diaryKey = `diary_${d.day}`;
            const savedDiary = localStorage.getItem(diaryKey) || "";
            
            main.innerHTML = `
            <div class="animate-slide-up">
                <div class="glass-card rounded-3xl p-5 mb-6 relative overflow-hidden border-l-4 border-blue-500">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded-md">Day ${currentDayIdx + 1}</span>
                        <h2 class="text-xl font-bold text-gray-800">${d.date}</h2>
                    </div>
                    <div class="text-sm font-medium text-gray-500 mb-3">${d.title}</div>
                    <div class="text-sm bg-slate-50 p-3 rounded-xl border border-slate-100 text-gray-600 flex items-start gap-2">
                        <i class="fas fa-star text-yellow-500 mt-0.5"></i> <span class="font-medium">${d.highlights}</span>
                    </div>
                </div>
                
                <div class="space-y-4">
                    ${d.events.map((e, idx) => {
                        const isRainyItem = isRainyMode && e.rainy;
                        const current = isRainyItem ? { ...e, ...e.rainy } : e;
                        const badge = isRainyItem ? `<span class="absolute top-2 right-2 bg-blue-500 text-white text-[9px] px-2 py-0.5 rounded-full"><i class="fas fa-umbrella mr-1"></i>é›¨å¤©å‚™æ¡ˆ</span>` : "";
                        const mapLink = current.map ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(current.map)}` : null;
                        const shareBtn = `<button onclick="shareEvent('${current.title}', '${current.mapcode || ''}', '${current.note || ''}')" class="glass px-3 py-1.5 rounded-full text-xs text-green-600 font-bold border border-green-100 active:bg-green-50"><i class="fas fa-share-nodes mr-1"></i>åˆ†äº«</button>`;
                        
                        // æ™‚é–“è»¸èˆ‡ç§»å‹•æ™‚é–“è† å›Š
                        const isLast = idx === d.events.length - 1;
                        const travelHtml = (current.travel && !isLast) ? `<div class="travel-pill">${current.travel}</div>` : '';
                        const connector = !isLast ? `<div class="timeline-connector">${travelHtml}</div>` : '';
                        
                        // åœç•™æ™‚é–“
                        const durationTag = current.duration ? `<span class="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded-md ml-2 font-bold shadow-sm"><i class="fas fa-clock mr-1"></i>åœç•™ ${current.duration}</span>` : '';
                        
                        // æ¨™é¡Œé€£çµ
                        const titleHtml = current.spotId 
                            ? `<div onclick="openSpotModal('${current.spotId}')" class="font-bold text-blue-600 text-lg cursor-pointer hover:underline decoration-blue-300 underline-offset-4 decoration-2 flex items-center gap-1">${current.title} <i class="fas fa-circle-info text-xs opacity-50"></i></div>`
                            : `<h3 class="font-bold text-gray-800 text-lg">${current.title}</h3>`;

                        return `
                        <div class="relative group">
                            ${connector}
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-4 relative z-10 overflow-hidden transition-all active:scale-[0.98] ${isRainyItem ? "border-l-4 border-blue-400 bg-blue-50/50" : ""}">
                                ${badge}
                                <div class="flex flex-col items-center gap-2 mt-1 min-w-[3.5rem]">
                                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-50 to-indigo-50 text-blue-600 flex items-center justify-center text-xl shadow-inner border border-white z-10 relative">
                                        <i class="fas ${current.icon}"></i>
                                    </div>
                                </div>
                                <div class="flex-1 py-1 min-w-0">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="flex items-center">
                                            <h3 class="font-bold text-gray-800 text-lg mr-1">${current.time}</h3>
                                        </div>
                                        <div class="flex gap-2 shrink-0">
                                            ${shareBtn}
                                            ${mapLink ? `<a href="${mapLink}" target="_blank" class="glass px-3 py-1.5 rounded-full text-xs text-blue-600 font-bold border border-blue-100 active:bg-blue-50"><i class="fas fa-location-arrow mr-1"></i> GO</a>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex items-center flex-wrap mb-2 gap-y-1">
                                        ${titleHtml}
                                        ${durationTag}
                                    </div>
                                    ${current.note ? `<p class="text-xs text-gray-500 bg-slate-50 p-2 rounded-lg border border-slate-100 leading-relaxed"><i class="fas fa-info-circle mr-1 text-blue-400"></i>${current.note}</p>` : ''}
                                    ${current.mapcode ? `<div onclick="copyMapCode('${current.mapcode}')" class="mt-2 text-[10px] inline-block bg-yellow-50 text-yellow-700 px-2 py-1 rounded border border-yellow-200 cursor-pointer active:bg-yellow-100"><i class="fas fa-hashtag mr-1"></i>MapCode: ${current.mapcode}</div>` : ''}
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>
                
                <div class="mt-4 bg-yellow-50 p-4 rounded-2xl border border-yellow-200 relative mb-6">
                    <label class="text-[10px] font-bold text-yellow-600 uppercase mb-1 block"><i class="fas fa-pen-nib mr-1"></i> ä»Šæ—¥éš¨ç­† (One-Line Diary)</label>
                    <textarea class="w-full bg-transparent border-none text-sm text-gray-700 focus:ring-0 p-0 resize-none h-16 leading-relaxed focus:outline-none" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼å¥½ç¬‘çš„äº‹ï¼Ÿ(è‡ªå‹•å„²å­˜)" oninput="localStorage.setItem('${diaryKey}', this.value)">${savedDiary}</textarea>
                </div>
                <div class="h-12"></div>
            </div>`;
        } else if (activeTab === 'checklist') {
            const list = checklistDB.find(c => c.id === currentChecklistFilter);
            main.innerHTML = `
            <div class="animate-slide-up glass-card rounded-3xl p-6 min-h-[60vh]">
                <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-4 border-gray-100 flex items-center gap-2">
                    <span class="w-1.5 h-6 bg-blue-500 rounded-full"></span>${list.title}
                </h3>
                <div class="space-y-3">
                    ${list.items.map((item, i) => { 
                        const key = `chk_${currentChecklistFilter}_${item.text}`; 
                        const isChecked = localStorage.getItem(key) === '1'; 
                        const textStyle = isChecked ? 'text-gray-400 line-through' : 'text-gray-700'; 
                        return `<div class="flex items-start gap-2 group"><label class="flex-1 flex items-start gap-3 p-3 rounded-2xl transition-all border border-transparent hover:bg-slate-50 cursor-pointer select-none border-slate-100 shadow-sm bg-white"><div class="relative flex items-center mt-0.5"><input type="checkbox" class="custom-checkbox peer appearance-none w-6 h-6 border-2 border-slate-300 rounded-lg transition-all checked:bg-blue-500 checked:border-blue-500" ${isChecked ? 'checked' : ''} onchange="toggleCheck('${key}')"><i class="fas fa-check text-white absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 peer-checked:opacity-100 text-xs pointer-events-none"></i></div><div class="flex-1"><div class="font-bold transition-colors text-[15px] ${textStyle}">${item.text}</div>${item.sub ? `<div class="text-xs text-gray-400 mt-0.5">${item.sub}</div>` : ''}</div></label><button onclick="deleteChecklistItem(${i})" class="mt-3 w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 active:scale-90 transition-all rounded-full hover:bg-red-50"><i class="fas fa-trash-alt"></i></button></div>`; 
                    }).join('')}
                </div>
                <button onclick="addChecklistItem()" class="w-full mt-4 py-3 border-2 border-dashed border-gray-300 rounded-2xl text-gray-500 font-bold hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all active:scale-[0.98]"><i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®</button>
                <div class="mt-8 pt-4 border-t border-gray-100"><button onclick="resetChecklist('${currentChecklistFilter}')" class="w-full py-4 bg-slate-50 rounded-2xl text-xs text-gray-400 font-bold tracking-wide active:bg-slate-100 mb-2"><i class="fas fa-rotate-right mr-1"></i> é‡ç½®å‹¾é¸ç‹€æ…‹</button><button onclick="openGiftModal()" class="w-full py-4 bg-red-50 text-red-500 rounded-2xl text-lg font-bold shadow-sm active:scale-95 border border-red-100"><i class="fas fa-gift mr-2"></i> ç®¡ç†ä¼´æ‰‹ç¦®æ¸…å–®</button></div>
            </div>`;
        } else if (activeTab === 'missions') {
            const balance = getGashaBalance();
            main.innerHTML = `<div class="animate-slide-up space-y-4"><div id="gasha-machine" class="glass-card rounded-3xl p-6 text-center border-4 border-pink-400 bg-pink-50 relative overflow-hidden"><div class="absolute -left-10 -top-10 w-32 h-32 bg-pink-200 rounded-full opacity-50 blur-xl"></div><div class="relative z-10"><div class="flex justify-between items-start mb-2"><h3 class="text-xl font-black text-pink-600">ğŸ‰ å¿«æ¨‚æ‰­è›‹æ©Ÿ</h3><button onclick="openRewardEditor()" class="text-[10px] bg-white border border-pink-200 text-pink-400 px-2 py-1 rounded-full"><i class="fas fa-cog"></i> è¨­å®šçå“</button></div><div class="text-4xl font-black text-gray-800 mb-2">${balance} <span class="text-sm text-gray-500 font-medium">æšä»£å¹£</span></div><p class="text-xs text-gray-500 mb-4">æ¯å®Œæˆ 1 å€‹ä»»å‹™ï¼Œå°±èƒ½è½‰ 1 æ¬¡ï¼</p><button onclick="spinGasha()" ${balance <= 0 ? 'disabled' : ''} class="w-full py-4 rounded-2xl font-bold text-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 ${balance > 0 ? 'bg-gradient-to-r from-pink-500 to-purple-500 text-white shadow-pink-300/50' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}">${balance > 0 ? '<i class="fas fa-gift animate-bounce"></i> æŠ•å…¥ä»£å¹£è½‰å‹•' : 'å»å®Œæˆä»»å‹™è³ºä»£å¹£ï¼'}</button></div></div><div class="grid grid-cols-2 gap-4">${missionsDB.map(m => {const isDone = localStorage.getItem(m.id) === '1'; return `<div onclick="toggleMission('${m.id}')" class="glass-card rounded-3xl p-4 flex flex-col items-center justify-center text-center gap-2 aspect-square relative overflow-hidden transition-all active:scale-95 cursor-pointer ${isDone ? 'border-2 border-yellow-400 bg-yellow-50/90' : 'grayscale opacity-80'}">${isDone ? '<div class="absolute top-2 right-2 text-yellow-500 text-xl animate-pop"><i class="fas fa-check-circle"></i></div>' : ''}<div class="w-14 h-14 rounded-full ${isDone ? 'bg-yellow-400 text-white' : 'bg-slate-200 text-slate-400'} flex items-center justify-center text-2xl mb-1 shadow-sm transition-colors"><i class="fas ${m.icon}"></i></div><div class="font-bold text-slate-800 leading-tight">${m.title}</div><div class="text-[10px] text-slate-500 leading-tight">${m.desc}</div></div>`}).join('')}</div></div>`;
        } else if (activeTab === 'tools') {
            if (currentToolFilter === 'calc') {
                // 1. è¨ˆç®—ç¸½é¡èˆ‡åˆ†é¡
                let totalJPY = 0; 
                const catTotals = {}; 
                expenses.forEach(e => { 
                    totalJPY += e.price; 
                    const cat = e.cat || 'other'; 
                    if (!catTotals[cat]) catTotals[cat] = 0; 
                    catTotals[cat] += e.price; 
                }); 
                // 2. è¨ˆç®—é ç®—èˆ‡å…ç¨…
                let totalTWD = Math.round(totalJPY * CURRENT_RATE); 
                let budgetLeft = TOTAL_BUDGET - totalTWD; 
                let budgetPercent = Math.min((totalTWD / TOTAL_BUDGET) * 100, 100); 
                let taxBasketTotal = taxBasket.reduce((a, b) => a + b, 0); 
                let taxDiff = 5500 - taxBasketTotal; 
                let taxPercent = Math.min((taxBasketTotal / 5500) * 100, 100); 
                let taxMsg = taxDiff > 0 ? `é‚„å·® Â¥${taxDiff.toLocaleString()}` : "ğŸ‰ å…ç¨…é”æˆï¼"; 
                let taxBasketItems = taxBasket.map((price) => `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-md text-[10px] font-bold">Â¥${price}</span>`).join(" "); 
                // 3. ç”¢ç”Ÿåœ“é¤…åœ– CSS
                let gradientStr = "conic-gradient(#e2e8f0 0deg 360deg)";
                let legendHTML = `<div class="text-center w-full text-xs text-gray-400 mt-2">å°šç„¡è³‡æ–™</div>`; 
                if (totalJPY > 0) { 
                    const sortedCats = Object.keys(catTotals).sort((a,b) => catTotals[b] - catTotals[a]); 
                    const gradients = []; 
                    let currentDeg = 0; 
                    legendHTML = ""; 
                    sortedCats.forEach(c => { 
                        const percent = catTotals[c] / totalJPY; 
                        const deg = percent * 360; 
                        const color = expenseCats[c] ? expenseCats[c].color : '#999'; 
                        gradients.push(`${color} ${currentDeg}deg ${currentDeg + deg}deg`); 
                        currentDeg += deg; 
                        legendHTML += `<div class="flex items-center gap-1 text-[10px] w-1/3 mb-1"><div class="w-2 h-2 rounded-full" style="background:${color}"></div><span class="opacity-70">${expenseCats[c].name} ${Math.round(percent*100)}%</span></div>`; 
                    }); 
                    gradientStr = `conic-gradient(${gradients.join(', ')})`; 
                } 
                // 4. ç”¢ç”Ÿåˆ—è¡¨ HTML
                let expenseListHTML = expenses.length === 0 ? 
                    `<div class="text-center py-8 text-gray-400 text-sm">ğŸ›ï¸ é‚„æ²’è²·æ±è¥¿...</div>` : 
                    expenses.map((item, idx) => { 
                        const cat = item.cat || 'other'; 
                        const catInfo = expenseCats[cat] || expenseCats.other;
                        return `<div class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm mb-2"><div class="flex-1 flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs" style="background:${catInfo.color}"><i class="fas ${catInfo.icon}"></i></div><div><div class="font-bold text-gray-700">${item.name}</div><div class="text-xs text-gray-400">Â¥${item.price.toLocaleString()}</div></div></div><button onclick="deleteExpense(${idx})" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center active:scale-90"><i class="fas fa-trash-alt text-xs"></i></button></div>`; 
                    }).join('');
                
                main.innerHTML = `<div class="animate-slide-up space-y-4"><div class="glass-card rounded-3xl p-6 text-center shadow-lg border-2 border-yellow-300 relative"><button onclick="fetchExchangeRate()" id="fetchRateBtn" class="absolute top-4 right-4 bg-yellow-100 text-yellow-700 p-2 rounded-full text-xs shadow-sm active:scale-90 transition-transform"><i class="fas fa-sync-alt"></i></button><h3 class="text-xs font-bold text-yellow-600 mb-2 uppercase tracking-wider">åŒ¯ç‡æ›ç®—å™¨</h3><div class="text-xl font-bold text-gray-500 mb-4 flex items-center justify-center gap-2">1 JPY = <input type="number" id="rateInput" value="${CURRENT_RATE}" onchange="updateRate(this.value)" class="text-yellow-600 text-3xl font-black bg-transparent focus:outline-none focus:border-b-2 focus:border-yellow-500 transition-colors" step="0.0001"> TWD</div><div class="flex flex-col gap-4"><div class="bg-blue-50 p-4 rounded-xl border border-blue-100 relative"><label class="block text-sm font-medium text-gray-600 mb-1">æ—¥å¹£ (JPY)</label><input type="number" id="jpyInput" oninput="convertCurrency()" placeholder="è¼¸å…¥æ—¥å¹£é‡‘é¡" class="w-full text-3xl text-gray-800 bg-transparent focus:outline-none text-center p-2 font-black"></div><i class="fas fa-arrow-down text-3xl text-blue-500 animate-bounce absolute left-1/2 -translate-x-1/2 top-[52%] z-10 drop-shadow-sm"></i><div class="bg-green-50 p-4 rounded-xl border border-green-100"><label class="block text-sm font-medium text-gray-600 mb-1">ç´„ç­‰æ–¼å°å¹£ (TWD)</label><div id="twdOutput" class="w-full text-4xl text-green-700 text-center p-2 font-black">0</div></div></div></div><div class="bg-gradient-to-br from-pink-50 to-white rounded-3xl p-5 border-2 border-pink-200 shadow-md relative overflow-hidden"><div class="flex justify-between items-center mb-3"><h3 class="font-black text-pink-600 flex items-center"><i class="fas fa-bag-shopping mr-2"></i>å…ç¨…æ¹Šå–®ç¥å™¨</h3><button onclick="resetTaxBasket()" class="text-[10px] bg-white border border-gray-200 px-2 py-1 rounded text-gray-400">æ¸…ç©º</button></div><div class="flex gap-2 mb-3"><input type="number" id="taxItemInput" placeholder="Â¥ å•†å“é‡‘é¡" class="flex-1 min-w-0 bg-white border-2 border-pink-100 rounded-xl px-4 py-3 text-xl font-bold focus:outline-pink-400 text-gray-700"><button onclick="addTaxItem()" class="flex-none w-16 bg-pink-500 text-white rounded-xl shadow-lg active:scale-95 flex items-center justify-center"><i class="fas fa-plus text-2xl"></i></button></div><div class="mb-2"><div class="flex justify-between text-xs mb-1 font-bold text-gray-500"><span>ç›®å‰: Â¥${taxBasketTotal.toLocaleString()}</span><span class="${taxDiff > 0 ? 'text-blue-500' : 'text-orange-500'}">${taxMsg}</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div class="${taxDiff>0?'bg-blue-500':'bg-gradient-to-r from-yellow-400 to-orange-500 animate-pulse'} h-3 rounded-full transition-all duration-300" style="width: ${taxPercent}%"></div></div></div><div class="flex flex-wrap gap-1 min-h-[20px]">${taxBasketItems}</div></div><div class="glass-card rounded-3xl p-4"><div class="flex justify-between items-center mb-2"><div class="text-xs font-bold text-gray-500">ç¸½é ç®—: $${TOTAL_BUDGET.toLocaleString()}</div><div class="text-xs font-bold ${budgetLeft < 0 ? 'text-red-500' : 'text-green-500'}">å‰©é¤˜: $${budgetLeft.toLocaleString()}</div></div><div class="w-full bg-gray-200 rounded-full h-1.5 mb-4"><div class="bg-green-500 h-1.5 rounded-full transition-all duration-500" style="width: ${budgetPercent}%"></div></div><div class="pie-chart" style="background: ${gradientStr}"></div><div class="flex flex-wrap justify-center mt-3 px-2">${legendHTML}</div></div><div class="glass-card rounded-3xl p-4"><h3 class="text-sm font-bold text-gray-600 mb-3"><i class="fas fa-pen mr-1"></i> è¨˜ä¸€ç­†</h3><div class="flex gap-2 mb-3 overflow-x-auto hide-scrollbar pb-1"><label class="cursor-pointer"><input type="radio" name="cat" value="shopping" class="peer sr-only" checked><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-bag-shopping"></i> è³¼ç‰©</div></label><label class="cursor-pointer"><input type="radio" name="cat" value="food" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-utensils"></i> é¤é£²</div></label><label class="cursor-pointer"><input type="radio" name="cat" value="play" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-purple-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-ticket"></i> å¨›æ¨‚</div></label><label class="cursor-pointer"><input type="radio" name="cat" value="transport" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-car"></i> äº¤é€š</div></label><label class="cursor-pointer"><input type="radio" name="cat" value="other" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-slate-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-box"></i> å…¶ä»–</div></label></div><div class="flex flex-col gap-3 mb-3"><input id="exName" type="text" placeholder="å“é …åç¨±" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-blue-500"><input id="exPrice" type="number" placeholder="Â¥ é‡‘é¡" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-blue-500 font-bold"></div><div class="flex gap-2"><button onclick="addExpense()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.98] transition-transform"><i class="fas fa-plus-circle mr-2"></i> æ–°å¢</button><button onclick="exportExpenses()" class="px-4 bg-slate-200 text-slate-600 font-bold rounded-xl active:scale-[0.98] transition-transform"><i class="fas fa-share-from-square"></i></button><button onclick="setBudget()" class="px-4 bg-slate-200 text-slate-600 font-bold rounded-xl active:scale-[0.98] transition-transform"><i class="fas fa-cog"></i></button></div></div><div class="pb-24">${expenseListHTML}</div></div>`; setTimeout(() => { const i = document.getElementById('jpyInput'); if(i) i.focus(); }, 100);
            }
            } else if (currentToolFilter === 'drive') {
                 const parkingHTML = !parkingData ? `<div class="p-6 rounded-3xl parking-card border border-green-200 relative overflow-hidden bg-white"><div class="text-center"><i class="fas fa-square-parking text-4xl text-green-500 mb-3"></i><h3 class="text-lg font-bold text-gray-800 mb-1">é‚„æ²’è¨˜éŒ„åœè»Šä½ç½®</h3><button onclick="saveParking()" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg mt-3"><i class="fas fa-map-pin mr-2"></i> ğŸ…¿ï¸ æˆ‘åœé€™</button></div></div>` : `<div class="p-6 rounded-3xl parking-card border border-green-500 relative overflow-hidden bg-green-50"><div class="relative z-10"><div class="flex justify-between items-start mb-2"><h3 class="text-lg font-black text-green-800"><i class="fas fa-circle-check mr-2"></i>è»Šå­åœåœ¨é€™ï¼</h3><div class="text-xs text-green-600 font-bold bg-white px-2 py-1 rounded">${parkingData.time}</div></div><div class="bg-white p-3 rounded-xl border border-green-200 mb-4 shadow-sm"><div class="text-[10px] text-gray-400 uppercase">å‚™è¨» (æ¨“å±¤/å€åŸŸ)</div><div class="text-xl font-bold text-gray-800">${parkingData.note}</div></div><div class="flex gap-2"><button onclick="findCar()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.95] transition-transform"><i class="fas fa-person-walking-arrow-right mr-2"></i> å¸¶æˆ‘æ‰¾è»Š</button><button onclick="clearParking()" class="px-4 bg-white text-red-500 border border-red-200 font-bold rounded-xl active:scale-[0.95] transition-transform"><i class="fas fa-trash-alt"></i></button></div></div></div>`;
                 const gasHelperHTML = `<div class="bg-gradient-to-br from-red-500 to-red-600 rounded-3xl p-1 shadow-lg mb-6 relative overflow-hidden text-white"><div class="bg-white/10 backdrop-blur-sm p-5 rounded-[1.3rem] border border-white/20"><div class="flex justify-between items-start mb-4"><div><div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mb-1">GAS STATION</div><h3 class="text-2xl font-black">åŠ æ²¹è«‹æ‰¾ <span class="text-yellow-300">ç´…æ§</span></h3><p class="text-xs opacity-90">Regular (ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼) = 92/95ç„¡é‰›</p></div><div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-red-600 text-2xl shadow-md"><i class="fas fa-gas-pump"></i></div></div><div class="grid grid-cols-2 gap-2 text-center mb-4"><div class="bg-black/20 rounded-lg p-2"><i class="fas fa-hand-sparkles mb-1 block opacity-70"></i><div class="text-[10px]">1.é™¤éœé›»</div></div><div class="bg-black/20 rounded-lg p-2"><i class="fas fa-credit-card mb-1 block opacity-70"></i><div class="text-[10px]">2.ä»˜éŒ¢/é¸æ²¹</div></div><div class="bg-red-700 rounded-lg p-2 border border-red-400"><i class="fas fa-fill-drip mb-1 block"></i><div class="text-[10px] font-bold">3.ç´…æ§åŠ æ²¹</div></div><div class="bg-black/20 rounded-lg p-2"><i class="fas fa-receipt mb-1 block opacity-70"></i><div class="text-[10px]">4.æ‹¿æ”¶æ“š</div></div></div><button onclick="showInfoCard('gas')" class="w-full bg-white text-red-600 font-bold py-3 rounded-xl shadow-md active:scale-95 transition-transform flex items-center justify-center gap-2"><i class="fas fa-comment-dots"></i> çµ¦åº—å“¡çœ‹ (æ—¥æ–‡)</button></div></div>`;
                 const soundBoardHTML = `<div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 mb-6"><h3 class="text-xs font-bold text-gray-500 uppercase mb-3"><i class="fas fa-music mr-1"></i> å®‰æ’«éŸ³æ•ˆæ¿ (Soundboard)</h3><div class="grid grid-cols-3 gap-3"><button onclick="playSound('clapping')" class="aspect-square bg-yellow-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">ğŸ‘</button><button onclick="playSound('laugh')" class="aspect-square bg-pink-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">ğŸ˜†</button><button onclick="playSound('fart')" class="aspect-square bg-amber-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">ğŸ’¨</button><button onclick="playSound('magic')" class="aspect-square bg-purple-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">âœ¨</button><button onclick="playSound('wrong')" class="aspect-square bg-red-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">âŒ</button><button onclick="playSound('correct')" class="aspect-square bg-green-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">â­•</button></div></div>`;
                 main.innerHTML = `<div class="animate-slide-up space-y-4"><button onclick="openDriverMode()" class="w-full bg-gradient-to-r from-slate-800 to-black text-white p-6 rounded-3xl shadow-xl border border-slate-700 relative overflow-hidden group mb-4"><div class="absolute right-0 top-0 p-6 opacity-20 group-active:scale-110 transition-transform"><i class="fas fa-gauge-high text-7xl"></i></div><div class="relative z-10 flex flex-col items-start"><span class="bg-yellow-400 text-black text-[10px] font-bold px-2 py-1 rounded mb-2 animate-pulse">NEW</span><h3 class="text-2xl font-black italic">DRIVER HUD</h3><p class="text-sm text-gray-300 mt-1">é§•é§›å°ˆç”¨å„€è¡¨æ¿ / å¤§å­—é«”æ¨¡å¼</p></div></button>${parkingHTML}${gasHelperHTML}<div class="grid grid-cols-2 gap-3 mb-6 sm:grid-cols-4"><button onclick="quickSearch('toilets')" class="bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform"><i class="fas fa-restroom text-blue-500 text-xl mb-1 block"></i><span class="text-xs font-bold">æ‰¾å»æ‰€</span></button><button onclick="quickSearch('convenience store')" class="bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform"><i class="fas fa-store text-orange-500 text-xl mb-1 block"></i><span class="text-xs font-bold">æ‰¾è¶…å•†</span></button><button onclick="openDrawing()" class="bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform border-2 border-purple-100"><i class="fas fa-palette text-purple-500 text-xl mb-1 block"></i><span class="text-xs font-bold">å°å°ç•«å®¶</span></button><button onclick="document.getElementById('food-modal').classList.add('open')" class="bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform"><i class="fas fa-utensils text-green-600 text-xl mb-1 block"></i><span class="text-xs font-bold">åƒä»€éº¼ï¼Ÿ</span></button></div>${soundBoardHTML}${toolsDB.drive.map(d => `<div class="p-6 rounded-3xl glass-card ${d.color} border border-black/5 relative overflow-hidden"><i class="fas fa-car absolute -right-2 -bottom-2 text-6xl opacity-10"></i><div class="text-xs font-bold opacity-60 mb-2 uppercase tracking-wider">${d.title}</div><div class="text-xl font-black leading-tight">${d.content}</div></div>`).join('')}</div>`;
            } else if (currentToolFilter === 'signs') {
                main.innerHTML = `<div class="animate-slide-up grid gap-4">${toolsDB.signs.map(s => `<div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-4"><div class="text-4xl w-16 h-16 flex items-center justify-center bg-gray-50 rounded-2xl">${s.icon}</div><div class="flex-1"><h3 class="text-lg font-black ${s.color} mb-1">${s.title}</h3><p class="text-sm text-gray-600 leading-relaxed">${s.desc}</p></div></div>`).join('')}</div>`;
            } else if (currentToolFilter === 'coins') {
                main.innerHTML = `<div class="animate-slide-up space-y-4"><div class="bg-slate-800 text-white p-5 rounded-3xl text-center mb-4 shadow-lg"><h3 class="font-bold text-lg mb-1">ç¡¬å¹£é€ŸæŸ¥ç›¤</h3><p class="text-xs opacity-60">çµå¸³å‰çœ‹ä¸€ä¸‹ï¼Œå¿«é€ŸæŠŠé›¶éŒ¢èŠ±æ‰ï¼</p></div><div class="grid grid-cols-2 gap-4">${toolsDB.coins.map(c => `<div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center text-center"><div class="w-16 h-16 rounded-full flex items-center justify-center text-xl font-black shadow-inner mb-3 ${c.color}">${c.val}</div><div class="font-bold text-gray-800 text-lg">Â¥${c.val}</div><div class="text-xs text-blue-500 font-bold mb-1">ç´„ NT$${c.twd}</div><div class="text-[10px] text-gray-400 bg-gray-50 px-2 py-1 rounded-full">${c.desc}</div></div>`).join('')}</div></div>`;
            } else if (currentToolFilter === 'sizes') {
                main.innerHTML = `<div class="animate-slide-up"><div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-100"><div class="bg-blue-600 text-white p-4 text-center"><h3 class="font-bold text-lg"><i class="fas fa-shirt mr-2"></i>ç«¥è£ç«¥é‹å°ºå¯¸å°ç…§</h3></div><table class="w-full text-sm text-center"><thead class="bg-gray-50 text-gray-500 font-bold border-b"><tr><th class="py-3">å¹´é½¡</th><th class="py-3">æ—¥æœ¬èº«é«˜</th><th class="py-3">ç¾åœ‹</th><th class="py-3">é‹(cm)</th></tr></thead><tbody class="divide-y divide-gray-100">${toolsDB.sizes.map(s => `<tr><td class="py-4 font-bold text-gray-700">${s.label}</td><td class="py-4 text-blue-600 font-bold">${s.h}</td><td class="py-4 text-gray-500">${s.us}</td><td class="py-4 text-pink-500 font-bold">${s.shoe}</td></tr>`).join('')}</tbody></table></div></div>`;
            } else if (currentToolFilter === 'orders') {
                main.innerHTML = `<div class="animate-slide-up grid grid-cols-2 gap-4">${toolsDB.orders.map(o => `<div class="order-card" onclick="alert('${o.jp}')"><div class="text-5xl mb-2">${o.icon}</div><div class="font-black text-gray-800 text-lg mb-1">${o.title}</div><div class="text-xs text-gray-400 font-mono">${o.sub}</div><div class="mt-3 bg-blue-50 text-blue-600 font-black py-2 rounded-xl text-xl">${o.jp}</div></div>`).join('')}</div>`;
            } else if (currentToolFilter === 'jp') {
                main.innerHTML = `<div class="animate-slide-up space-y-6"><div class="glass-card p-4 rounded-2xl text-center bg-blue-50 border border-blue-200"><div class="text-sm text-blue-800 font-bold mb-1">ğŸ’¡ ä½¿ç”¨æ•™å­¸</div><div class="text-xs text-blue-600">é»æ“Š <i class="fas fa-volume-high mx-1 text-yellow-600"></i> é»ƒè‰²æŒ‰éˆ•ï¼Œæ‰‹æ©Ÿæœƒç›´æ¥å”¸å‡ºæ—¥èªï¼</div></div>${toolsDB.jp.map(cat => `<div><h3 class="text-xs font-bold text-gray-400 uppercase mb-3 ml-2 tracking-wider border-l-2 border-blue-500 pl-2">${cat.label}</h3><div class="grid gap-3">${cat.items.map(item => `<div class="glass-card p-5 rounded-3xl border border-slate-50 transition-transform flex items-center justify-between gap-3 relative z-10"><div class="flex-1"><div class="text-xs text-gray-500 mb-1 flex items-center gap-1"><i class="fas fa-language"></i> ${item.t}</div><div class="text-xl font-black text-gray-800 mb-1 leading-tight">${item.j}</div><div class="text-xs text-blue-500 font-bold bg-blue-50 inline-block px-2 py-0.5 rounded">${item.p}</div></div><button onclick="speak('${item.j}', this)" class="w-12 h-12 flex-shrink-0 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg active:scale-90 transition-transform z-20"><i class="fas fa-volume-high text-xl"></i></button></div>`).join('')}</div></div>`).join('')}</div>`;
            } else if (currentToolFilter === 'sos') {
                let allergyTags = medicalData.allergies.length > 0 ? medicalData.allergies.map(a => `<span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded border border-red-200">${allergyDict[a].jp}</span>`).join(" ") : "<span class='text-gray-400 text-xs'>ç„¡ (ãªã—)</span>";
                main.innerHTML = `
                <div class="animate-slide-up space-y-6">
                    <button onclick="openSosCard()" class="w-full bg-red-600 text-white rounded-3xl p-6 shadow-xl border-4 border-red-500 flex items-center justify-between active:scale-95 transition-transform animate-pulse">
                        <div class="text-left">
                            <h3 class="text-2xl font-black">ç·Šæ€¥æ±‚åŠ©å¡</h3>
                            <p class="text-xs opacity-80">çµ¦æ—¥æœ¬äººçœ‹ / å°‹æ±‚å¹«åŠ©</p>
                        </div>
                        <i class="fas fa-exclamation-circle text-5xl"></i>
                    </button>
                    <div class="safe-card p-6 rounded-3xl shadow-xl relative overflow-hidden"><div class="absolute top-0 right-0 p-4 opacity-10 text-red-600"><i class="fas fa-user-shield text-8xl"></i></div><div class="relative z-10"><div class="flex justify-between items-start mb-4"><h3 class="text-xl font-black text-gray-800"><i class="fas fa-passport text-red-500 mr-2"></i>å…’ç«¥å®‰å¿ƒè­·ç…§</h3><button onclick="toggleEditMedical()" class="text-xs bg-white border border-gray-200 px-3 py-1 rounded-full text-gray-500 font-bold">ç·¨è¼¯</button></div><div id="medical-view">${!medicalData.name ? `<div class="text-center py-6 text-gray-400 text-sm">âš ï¸ è«‹é»æ“Šã€Œç·¨è¼¯ã€è¼¸å…¥è³‡æ–™</div>` : `<div class="space-y-4"><div class="bg-white/60 p-3 rounded-xl border border-red-100"><div class="text-[10px] text-gray-500 uppercase">My Name</div><div class="text-2xl font-black text-gray-800">${medicalData.name}</div></div><div class="bg-white/60 p-3 rounded-xl border border-red-100"><div class="text-[10px] text-gray-500 uppercase">Emergency Contact</div><div class="text-xl font-bold text-blue-600"><i class="fas fa-phone mr-1"></i> ${medicalData.phone}</div></div><div class="bg-white/60 p-3 rounded-xl border border-red-100"><div class="text-[10px] text-gray-500 uppercase">Allergy</div><div class="flex flex-wrap gap-1 mt-1">${allergyTags}</div></div><div class="bg-white/60 p-3 rounded-xl border border-red-100 relative"><div class="text-[10px] text-gray-500 uppercase">Hotel</div><div class="font-bold text-gray-700">${medicalData.hotel}</div><button onclick="showInfoCard('hotel', '${medicalData.hotel}')" class="absolute top-3 right-3 bg-blue-600 text-white text-xs px-2 py-1 rounded shadow"><i class="fas fa-taxi mr-1"></i>çµ¦å¸æ©Ÿçœ‹</button></div></div>`}</div><div id="medical-edit" class="hidden space-y-3"><input id="in-name" type="text" placeholder="å­©å­æš±ç¨±" value="${medicalData.name}" class="w-full p-3 rounded-xl border border-gray-200 text-sm"><input id="in-phone" type="tel" placeholder="çˆ¸åª½é›»è©±" value="${medicalData.phone}" class="w-full p-3 rounded-xl border border-gray-200 text-sm"><input id="in-hotel" type="text" placeholder="ä½å®¿é£¯åº—" value="${medicalData.hotel}" class="w-full p-3 rounded-xl border border-gray-200 text-sm"><div class="text-xs font-bold text-gray-500 mt-2 mb-1">éæ•æº</div><div class="grid grid-cols-2 gap-2">${Object.keys(allergyDict).map(k => `<label class="flex items-center gap-2 bg-white p-2 rounded-lg border border-gray-100"><input type="checkbox" class="allergy-chk" value="${k}" ${medicalData.allergies.includes(k) ? 'checked' : ''}><span class="text-xs text-gray-600">${allergyDict[k].label}</span></label>`).join('')}</div><button onclick="saveMedical()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl mt-2">å„²å­˜</button></div></div></div><div class="space-y-3"><h3 class="text-xs font-bold text-gray-400 uppercase ml-2 tracking-wider">ç·Šæ€¥é›»è©±</h3>${toolsDB.sos.map(s => `<a href="tel:${s.tel}" class="${s.style} p-5 rounded-3xl shadow-lg flex items-center justify-between active:scale-95 transition-transform"><div><div class="text-sm opacity-80 font-medium mb-1">${s.name}</div><div class="text-3xl font-black tracking-tighter">${s.tel}</div></div><div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur flex items-center justify-center"><i class="fas fa-phone text-xl"></i></div></a>`).join('')}</div></div>`;
            } else if (currentToolFilter === 'sync') {
                 main.innerHTML = `<div class="animate-slide-up space-y-6"><div class="glass-card rounded-3xl p-6 border-l-4 border-purple-500"><div class="text-xs font-bold text-purple-600 uppercase mb-2">æˆ‘æ˜¯èˆŠæ‰‹æ©Ÿ / å‚³é€ç«¯</div><h3 class="text-xl font-bold text-gray-800 mb-2">å‚™ä»½è³‡æ–™</h3><p class="text-sm text-gray-500 mb-4">å°‡è³‡æ–™ç”¢ç”Ÿä»£ç¢¼ã€‚</p><button onclick="backupData()" class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.98] transition-transform"><i class="fas fa-copy mr-2"></i> è¤‡è£½ä»£ç¢¼</button></div><div class="glass-card rounded-3xl p-6 border-l-4 border-teal-500"><div class="text-xs font-bold text-teal-600 uppercase mb-2">æˆ‘æ˜¯æ–°æ‰‹æ©Ÿ / æ¥æ”¶ç«¯</div><h3 class="text-xl font-bold text-gray-800 mb-2">é‚„åŸè³‡æ–™</h3><textarea id="importDataInput" placeholder="è²¼ä¸Šä»£ç¢¼..." class="w-full h-24 bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs mb-3 focus:outline-teal-500"></textarea><button onclick="restoreData()" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.98] transition-transform"><i class="fas fa-file-import mr-2"></i> è¼‰å…¥</button></div></div>`;
            }
        }
    }
    // ================= Driver HUD Logic (v15.2 Final) =================
    let hudWatchId = null, wakeLock = null, hudCurrentEventIdx = 0, hudAllEvents = [];
    let roadType = 'city';
    let currentSpeedLimit = 50; // é è¨­é€Ÿé™ 50

    function flattenEvents() { let l=[]; itineraryDB.forEach(d=>{d.events.forEach(e=>{l.push({...((isRainyMode&&e.rainy)?{...e,...e.rainy}:e), dayTitle:d.day, fullTitle:e.title});});}); return l; }
    
    async function openDriverMode() { 
        document.getElementById('driver-hud').classList.remove('hidden'); 
        document.getElementById('driver-hud').classList.add('flex'); 
        hudAllEvents=flattenEvents(); 
        hudCurrentEventIdx=0; 
        updateHUDUI(); 
        // å•Ÿå‹• GPS ç›£è½
        if(navigator.geolocation) hudWatchId=navigator.geolocation.watchPosition(updateHudSpeed,console.log,{enableHighAccuracy:true}); 
        // å˜—è©¦ä¿æŒè¢å¹•å¸¸äº® (Wake Lock)
        try{if('wakeLock' in navigator) wakeLock=await navigator.wakeLock.request('screen');}catch(e){} 
        startHudClock(); 
    }
    
    function closeDriverMode() { 
        document.getElementById('driver-hud').classList.add('hidden'); 
        document.getElementById('driver-hud').classList.remove('flex'); 
        if(hudWatchId)navigator.geolocation.clearWatch(hudWatchId); 
        if(wakeLock)wakeLock.release(); 
    }
    
    function updateHUDUI() { 
        const e=hudAllEvents[hudCurrentEventIdx]; if(!e)return; 
        document.getElementById('hud-title').innerText=e.title; 
        const mc=document.getElementById('hud-mapcode'); 
        if(e.mapcode){
            mc.innerText=e.mapcode; 
            mc.classList.replace('text-gray-600','text-yellow-400');
        }else{
            mc.innerText="NO MAPCODE"; 
            mc.classList.replace('text-yellow-400','text-gray-600'); 
        } 
        const btn=document.getElementById('hud-nav-btn'); 
        if(e.map){
            btn.href=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.map)}`; 
            btn.classList.remove('opacity-50','pointer-events-none'); 
            btn.innerHTML=`<i class="fas fa-location-arrow animate-pulse"></i> <span>GO å°èˆª</span>`;
        }else{
            btn.href="#"; 
            btn.classList.add('opacity-50','pointer-events-none'); 
            btn.innerHTML=`<span>ç„¡å°èˆªé»</span>`;
        } 
    }
    
    function changeHudEvent(d) { 
        hudCurrentEventIdx+=d; 
        if(hudCurrentEventIdx<0)hudCurrentEventIdx=0; 
        if(hudCurrentEventIdx>=hudAllEvents.length)hudCurrentEventIdx=hudAllEvents.length-1; 
        updateHUDUI(); 
    }
    
    // é—œéµé‚è¼¯ï¼šé€Ÿåº¦é¡¯ç¤ºèˆ‡è¶…é€Ÿè®Šè‰² (ç½®ä¸­å¤§å­—ç‰ˆ)
    function updateHudSpeed(p) { 
        const s = p.coords.speed ? Math.round(p.coords.speed * 3.6) : 0; 
        const el = document.getElementById('hud-speed'); 
        const warn = document.getElementById('speed-warning');
        
        el.innerText = s; 
        
        // è¶…é€Ÿåˆ¤æ–·é‚è¼¯
        if(s > currentSpeedLimit) {
            // è¶…é€Ÿç‹€æ…‹ï¼šç´…è‰²ã€ç™¼å…‰ã€é¡¯ç¤ºè­¦å‘Š
            el.className = "text-[9rem] font-black text-red-500 leading-none tracking-tighter transition-all duration-200 drop-shadow-[0_0_15px_rgba(239,68,68,0.8)]";
            warn.classList.remove('opacity-0');
        } else {
            // æ­£å¸¸ç‹€æ…‹ï¼šç™½è‰²
            el.className = "text-[9rem] font-black text-white leading-none tracking-tighter transition-all duration-200 drop-shadow-2xl";
            warn.classList.add('opacity-0');
        }
    }
    // é—œéµé‚è¼¯ï¼šåˆ‡æ›é“è·¯é¡å‹èˆ‡é€Ÿé™
    function toggleRoadType() { 
        const b = document.getElementById('btn-road-type'); 
        if(roadType === 'city') {
            roadType = 'highway';
            currentSpeedLimit = 80; // é«˜é€Ÿå…¬è·¯é€Ÿé™è¨­ç‚º 80 (æ²–ç¹©è‡ªå‹•è»Šé“)
            b.innerText = "é«˜é€Ÿé“è·¯ (80)";
            b.className = "px-4 py-2 rounded-lg border border-green-500 bg-green-900/30 text-green-400 text-sm font-bold active:bg-green-800 transition-colors shadow-[0_0_10px_rgba(34,197,94,0.3)]";
            showToast("ğŸš— åˆ‡æ›ç‚ºé«˜é€Ÿæ¨¡å¼ (é™é€Ÿ80)");
        } else {
            roadType = 'city';
            currentSpeedLimit = 50; // ä¸€èˆ¬é“è·¯é€Ÿé™è¨­ç‚º 50
            b.innerText = "ä¸€èˆ¬é“è·¯ (50)";
            b.className = "px-4 py-2 rounded-lg border border-blue-900 bg-blue-900/20 text-blue-400 text-sm font-bold active:bg-blue-800 transition-colors";
            showToast("ğŸ™ï¸ åˆ‡æ›ç‚ºå¸‚å€æ¨¡å¼ (é™é€Ÿ50)");
        } 
    }
    
    function startHudClock() { const u=()=>{const d=new Date(); document.getElementById('hud-clock').innerText=`${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; if(!document.getElementById('driver-hud').classList.contains('hidden'))requestAnimationFrame(()=>setTimeout(u,1000));}; u(); }
    function copyHudMapCode() { const t=document.getElementById('hud-mapcode'); if(t.innerText!=="NO MAPCODE"){navigator.clipboard.writeText(t.innerText); t.style.color="#4ade80"; setTimeout(()=>t.style.color="",300); showToast("Copied");} }

    // Start App
    init();
</script>
</body>
</html>
