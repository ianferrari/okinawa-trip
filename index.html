<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>å¥å¥å…¨å®¶æ²–ç¹©éŠ ğŸ¦• v10.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; -webkit-tap-highlight-color: transparent; transition: background-color 0.5s; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* æ¯›ç»ç’ƒèˆ‡è³ªæ„Ÿ */
        .glass { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-dark { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); color: white; }
        .glass-card { background: rgba(255, 255, 255, 0.95); box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.6); }

        /* é›¨å¤©æ¨¡å¼ç‰¹æ•ˆ */
        body.rainy-mode #bg-layer { filter: grayscale(80%) brightness(0.6); }
        body.rainy-mode .glass-card { border-left: 4px solid #60a5fa !important; }
        .rain-badge { display: none; }
        body.rainy-mode .rain-badge { display: inline-block; }

        /* ç‰¹æ®Šå¡ç‰‡ç‰¹æ•ˆ */
        .smart-card { background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); border: 2px solid #3b82f6; box-shadow: 0 10px 40px -10px rgba(59, 130, 246, 0.4); }
        .pulse-dot { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); animation: pulse-blue 2s infinite; }
        .safe-card { background: linear-gradient(135deg, #fff1f2 0%, #fff 100%); border-left: 5px solid #e11d48; }
        .parking-card { background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); border: 2px solid #22c55e; }

        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* éŸ³æ³¢å‹•ç•« */
        .playing-wave { display: inline-flex; align-items: center; gap: 2px; height: 12px; }
        .playing-wave span { width: 3px; background: #713f12; animation: wave 0.8s infinite ease-in-out; border-radius: 2px; }
        .playing-wave span:nth-child(1) { height: 40%; animation-delay: 0s; }
        .playing-wave span:nth-child(2) { height: 100%; animation-delay: 0.1s; }
        .playing-wave span:nth-child(3) { height: 60%; animation-delay: 0.2s; }
        @keyframes wave { 0%, 100% { height: 40%; } 50% { height: 100%; } }

        /* iPhone å®‰å…¨å€åŸŸé©é… */
        .pt-safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* å‹•ç•«ç‰¹æ•ˆ */
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.4s ease-in-out; }
        
        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            50% { transform: rotate(0eg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }
        .animate-shake { animation: shake 0.3s ease-in-out 3; }

        .tab-active { background: #2563eb; color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); transform: scale(1.05); }
        .tab-inactive { background: rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Checkbox & Progress */
        .custom-checkbox:checked + div { background-color: #2563eb; border-color: #2563eb; }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 200px; transform: translateX(-50%); background-color: rgba(30, 41, 59, 0.95); color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 100; left: 50%; bottom: 120px; font-size: 14px; backdrop-filter: blur(8px); box-shadow: 0 10px 40px rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        #toast.show { visibility: visible; opacity: 1; bottom: 130px; }

        /* Calculator Specific */
        #jpyInput, #twdOutput, #rateInput { font-weight: 900; }
        #rateInput { border-bottom: 2px dashed #ca8a04; color: #ca8a04; width: 100px; text-align: center; }
        
        /* Pie Chart */
        .pie-chart { width: 140px; height: 140px; border-radius: 50%; position: relative; margin: 0 auto; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        .pie-chart::after { content: ""; position: absolute; width: 80px; height: 80px; background: white; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        /* Full Screen Card Modal */
        #modal-overlay, #expense-modal, #gasha-modal { display: none; }
        #modal-overlay.open, #expense-modal.open, #gasha-modal.open { display: flex; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 overflow-hidden relative">

    <div id="bg-layer" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-700 transform scale-105" 
         style="background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=1000&fit=crop');">
        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/10 to-slate-100/90"></div>
    </div>

    <div class="z-10 pt-safe-top px-5 pb-2 flex-shrink-0">
        <div class="flex justify-between items-start pt-6 mb-4 text-white">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="bg-blue-600 px-2 py-0.5 rounded-md text-[10px] font-bold tracking-wider uppercase shadow-lg border border-blue-400/30">2026 TRIP</span>
                    <div id="countdown" class="text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10">è¨ˆç®—ä¸­...</div>
                </div>
                <h1 class="text-3xl font-black tracking-tight drop-shadow-lg leading-tight">å¥å¥å…¨å®¶<br>æ²–ç¹©éŠ ğŸ¦•</h1>
                <p class="text-sm opacity-95 font-medium mt-2 text-blue-100 drop-shadow-md"><i class="fas fa-calendar-alt mr-1"></i>3/28 (å…­) - 4/3 (äº”)</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="toggleRainMode()" id="rain-btn" class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-white/20">
                    <i id="rain-icon" class="fas fa-sun text-xl mb-1 block text-yellow-400"></i>
                    <span id="rain-text" class="text-[9px] font-bold opacity-90">æ™´å¤©</span>
                </button>

                <div class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[70px] active:scale-95 transition-transform cursor-pointer" onclick="initWeather()">
                    <i id="weather-icon" class="fas fa-spinner fa-spin text-xl mb-1 block text-blue-300"></i>
                    <span id="weather-temp" class="text-sm font-bold">...</span>
                    <div id="weather-loc" class="text-[9px] opacity-70 mt-0.5">é‡æ•´</div>
                </div>
            </div>
        </div>

        <div id="sub-nav-container" class="mt-2 min-h-[44px]"></div>
    </div>

    <div id="main-scroll" class="flex-1 overflow-y-auto p-4 pb-32 z-10 scroll-smooth rounded-t-[2.5rem] bg-slate-50 shadow-[0_-10px_40px_rgba(0,0,0,0.15)] relative top-2">
        </div>

    <div class="fixed bottom-0 w-full glass flex justify-around items-center pb-safe-bottom h-[85px] z-50 rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-itinerary">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-map-location-dot text-xl text-blue-600"></i></div>
            <span class="text-[10px] font-bold text-blue-600">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('checklist')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-checklist">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-clipboard-list text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('missions')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-missions">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-medal text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æˆå°±</span>
        </button>
        <button onclick="switchTab('tools')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-tools">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-toolbox text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">å·¥å…·</span>
        </button>
    </div>

    <button onclick="openQuickExpense()" class="fixed bottom-[100px] right-4 w-14 h-14 bg-pink-500 rounded-full text-white shadow-2xl flex items-center justify-center z-40 active:scale-90 transition-transform border-4 border-white/20 backdrop-blur group">
        <i class="fas fa-plus text-2xl group-active:rotate-90 transition-transform"></i>
    </button>

    <div id="expense-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6" onclick="closeQuickExpense()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl relative animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-gray-800"><i class="fas fa-bolt text-yellow-400 mr-2"></i>å¿«é€Ÿè¨˜å¸³</h3>
                <button onclick="closeQuickExpense()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                    <label class="cursor-pointer">
                        <input type="radio" name="quick-cat" value="shopping" class="peer sr-only" checked>
                        <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white peer-checked:border-pink-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                            <i class="fas fa-bag-shopping"></i> è³¼ç‰©
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="quick-cat" value="food" class="peer sr-only">
                        <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                            <i class="fas fa-utensils"></i> é¤é£²
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="quick-cat" value="play" class="peer sr-only">
                        <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-purple-500 peer-checked:text-white peer-checked:border-purple-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                            <i class="fas fa-ticket"></i> å¨›æ¨‚
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="quick-cat" value="transport" class="peer sr-only">
                        <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                            <i class="fas fa-car"></i> äº¤é€š
                        </div>
                    </label>
                    <label class="cursor-pointer">
                        <input type="radio" name="quick-cat" value="other" class="peer sr-only">
                        <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-slate-500 peer-checked:text-white peer-checked:border-slate-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                            <i class="fas fa-box"></i> å…¶ä»–
                        </div>
                    </label>
                </div>

                <input id="quickExName" type="text" placeholder="å“é …åç¨± (å¦‚: å†°æ·‡æ·‹)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-pink-500">
                
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                    <input id="quickExPrice" type="number" placeholder="é‡‘é¡ (æ—¥å¹£)" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-8 pr-4 py-3 text-xl font-black text-gray-800 focus:outline-pink-500">
                </div>

                <button onclick="saveQuickExpense()" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-transform text-lg mt-2">
                    <i class="fas fa-check mr-2"></i> å„²å­˜é€™ç­†
                </button>
                <div class="h-6 sm:h-0"></div> </div>
        </div>
    </div>

    <div id="gasha-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col" onclick="closeGashaModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative animate-pop" onclick="event.stopPropagation()">
            <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-yellow-400 w-20 h-20 rounded-full flex items-center justify-center text-4xl shadow-lg border-4 border-white">
                ğŸ‰
            </div>
            <div class="mt-8">
                <div class="text-sm font-bold text-gray-400 mb-1 uppercase tracking-widest">Congratulations!</div>
                <div class="text-2xl font-black text-gray-900 mb-4">æ­å–œç²å¾—çå‹µ</div>
                
                <div class="bg-yellow-50 rounded-2xl p-6 border-2 border-yellow-200 mb-6">
                    <div id="gasha-reward-icon" class="text-6xl mb-3 block"></div>
                    <div id="gasha-reward-text" class="text-xl font-bold text-yellow-700"></div>
                </div>

                <button onclick="closeGashaModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold w-full shadow-lg active:scale-95 transition-transform">
                    å¤ªæ£’äº†ï¼æ”¶ä¸‹
                </button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col" onclick="closeModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800"><i class="fas fa-times text-2xl"></i></button>
            <div class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-widest">çµ¦å¸æ©Ÿçœ‹ (For Driver)</div>
            <div class="text-2xl font-black text-gray-900 mb-6 border-b pb-4">ã“ã®ãƒ›ãƒ†ãƒ«ã¾ã§<br>ãŠé¡˜ã„ã—ã¾ã™</div>
            <div id="modal-hotel-name" class="text-xl font-bold text-blue-700 mb-2"></div>
            <div class="text-xs text-gray-400">è«‹å¸¶æˆ‘å»é€™å®¶é£¯åº—</div>
            <div class="mt-8">
                 <button onclick="closeModal()" class="bg-gray-100 text-gray-600 px-6 py-3 rounded-xl font-bold w-full">é—œé–‰</button>
            </div>
        </div>
    </div>

    <div id="toast"><i class="fas fa-check-circle mr-2 text-green-400"></i><span id="toast-msg">å·²è¤‡è£½</span></div>

<script>
    // ================= DATA (è³‡æ–™åº«) =================
    const TRIP_YEAR = 2026;
    
    // åŒ¯ç‡
    let savedRate = localStorage.getItem('user_rate');
    let CURRENT_RATE = savedRate ? parseFloat(savedRate) : 0.21;
    let TOTAL_BUDGET = localStorage.getItem('trip_budget') ? parseInt(localStorage.getItem('trip_budget')) : 100000;
    
    // è¨˜å¸³è³‡æ–™
    let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];

    // å®‰å¿ƒè­·ç…§è³‡æ–™
    let medicalData = JSON.parse(localStorage.getItem('medical_data')) || {
        name: "", phone: "", hotel: "", allergies: []
    };

    // åœè»Šè³‡æ–™
    let parkingData = JSON.parse(localStorage.getItem('parking_data')) || null;

    // æ‰­è›‹è³‡æ–™ (Used Coins)
    let gashaCoinsUsed = localStorage.getItem('gasha_coins_used') ? parseInt(localStorage.getItem('gasha_coins_used')) : 0;

    // é›¨å¤©æ¨¡å¼ç‹€æ…‹
    let isRainyMode = false;

    // æ”¯å‡ºé¡åˆ¥å®šç¾©
    const expenseCats = {
        shopping: { name: "è³¼ç‰©", icon: "fa-bag-shopping", color: "#f43f5e" },
        food: { name: "é¤é£²", icon: "fa-utensils", color: "#f97316" },
        transport: { name: "äº¤é€š", icon: "fa-car", color: "#3b82f6" },
        play: { name: "å¨›æ¨‚", icon: "fa-ticket", color: "#8b5cf6" },
        hotel: { name: "ä½å®¿", icon: "fa-bed", color: "#10b981" },
        other: { name: "å…¶ä»–", icon: "fa-box", color: "#64748b" }
    };

    const bgImages = {
        D1: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=1000&fit=crop",
        D2: "https://images.unsplash.com/photo-1582967788606-a171f1080ca8?q=80&w=1000&fit=crop",
        D3: "https://images.unsplash.com/photo-1560275619-4662e36fa65c?q=80&w=1000&fit=crop",
        D4: "https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?q=80&w=1000&fit=crop",
        D5: "https://images.unsplash.com/photo-1534234828569-2f2249520468?q=80&w=1000&fit=crop",
        D6: "https://images.unsplash.com/photo-1570533412033-662309e3df4e?q=80&w=1000&fit=crop",
        D7: "https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1000&fit=crop",
        SHOP: "https://images.unsplash.com/photo-1472851294608-415522f96319?q=80&w=1000&fit=crop",
        TOOL: "https://images.unsplash.com/photo-1484417894907-623942c8ee29?q=80&w=1000&fit=crop",
        MISSION: "https://images.unsplash.com/photo-1533227297464-9429738d1964?q=80&w=1000&fit=crop",
        CALC: "https://images.unsplash.com/photo-1563986768603-41fef5d00369?q=80&w=1000&fit=crop",
        SYNC: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1000&fit=crop",
        SOS: "https://images.unsplash.com/photo-1588611910679-22a9009952a9?q=80&w=1000&fit=crop"
    };

    const allergyDict = {
        "egg": { label: "é›è›‹ (åµ)", jp: "åµ (Tamago)" },
        "milk": { label: "ç‰›å¥¶ (ä¹³)", jp: "ç‰›ä¹³ (Gyu-nyu)" },
        "peanut": { label: "èŠ±ç”Ÿ (è½èŠ±ç”Ÿ)", jp: "è½èŠ±ç”Ÿ (Rakkasei)" },
        "shrimp": { label: "è¦ (æµ·è€)", jp: "ã‚¨ãƒ“ (Ebi)" },
        "crab": { label: "èŸ¹ (èŸ¹)", jp: "ã‚«ãƒ‹ (Kani)" },
        "wheat": { label: "å°éº¥ (å°éº¦)", jp: "å°éº¦ (Komugi)" }
    };

    const itineraryDB = [
        { day: "D1", date: "3/28 (å…­)", title: "å•Ÿç¨‹ & é©æ‡‰", highlights: "æ©Ÿå ´è²·å¥¶ / OTSå–è»Š / ä½åè­·", bg: bgImages.D1, events: [
            { time: "13:15", title: "æ˜Ÿå®‡ JX302 èµ·é£›", icon: "fa-plane-departure", note: "çµ¦å¥å¥åƒè»Ÿç³–å¹³è¡¡è€³å£“", map: "å°ä¸­åœ‹éš›æ©Ÿå ´" },
            { time: "15:45", title: "æŠµé”é‚£éœ¸æ©Ÿå ´", icon: "fa-plane-arrival", note: "1F Lawson è²·é®®å¥¶/æˆé•·å¥¶", map: "" },
            { time: "16:30", title: "æ­æ¥é§è»Šå¾€ OTS", icon: "fa-bus", note: "1F å¤§å»³å¤–æ‰¾ OTS æ——å¹Ÿ (10-Aæœˆå°)", map: "" },
            { time: "17:00", title: "OTS è‡¨ç©ºè±å´ å–è»Š", icon: "fa-car", note: "æª¢æŸ¥è»Šæ³ã€è£æ±½åº§ã€‚å°èˆªè¨­é£¯åº—", map: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€" },
            { time: "18:00", title: "é«˜é€Ÿå…¬è·¯åŒ—ä¸Š", icon: "fa-road", note: "ä¸­é€”åœï¼šä¸­åŸPAæˆ–ä¼ŠèŠ¸SA &è¨˜å¾—è²·æ°´ ", map: "" },
            { time: "19:30", title: "é£¯åº— Check-in", icon: "fa-hotel", note: "Best Western Kouki Beach", map: "Best Western Okinawa Kouki Beach", mapcode: "206 473 354*11" },
            { time: "20:00", title: "æ™šé¤ï¼šåè­·åœ¨åœ°", icon: "fa-utensils", note: "ç¾æ‹‰èŠ±åˆ¥é‚¸ / å“¥å€«å¸ƒç‰›æ’ / å…¨å®¶", map: "Restaurant Columbin" }
        ]},
        { day: "D2", date: "3/29 (æ—¥)", title: "ç»ç’ƒèˆ¹ & è£œçµ¦", highlights: "æµ·ä¸­å…¬åœ’ / AEON æƒè²¨ / ç©æ²™", bg: bgImages.D2, events: [
            { time: "09:30", title: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’", icon: "fa-water", note: "æ­ç»ç’ƒåº•èˆ¹æ‰¾å°¼è« ğŸ ", map: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’", mapcode: "206 442 077*71",
              rainy: { title: "åè­·é³³æ¢¨åœ’ (å®¤å…§)", icon: "fa-leaf", note: "â˜” é›¨å¤©å‚™æ¡ˆï¼šæ­ç„¡äººè»Šçœ‹æé¾", map: "Nago Pineapple Park", mapcode: "206 716 467*85" } 
            },
            { time: "12:00", title: "åˆé¤ï¼šHama å£½å¸", icon: "fa-bowl-rice", note: "åè­·åº—ï¼Œå¹³åƒ¹è¿´è½‰å£½å¸", map: "HAMAå£½å¸ åè­·åº—" },
            { time: "13:30", title: "AEON åè­·åº—", icon: "fa-cart-shopping", note: "å¤§å‰µè²·ç©æ²™çµ„ã€è¶…å¸‚è²·æ°´", map: "AEON åè­·åº—", mapcode: "206 626 669*52" },
            { time: "15:00", title: "è¨±ç”°ä¼‘æ¯ç«™", icon: "fa-ticket", note: "è²·æ°´æ—é¤¨å„ªæƒ ç¥¨ (åªæ”¶ç¾é‡‘)", map: "é“ã®é§… è¨±ç”°" },
            { time: "16:00", title: "é£¯åº—æ²™ç˜ç©æ²™", icon: "fa-umbrella-beach", note: "æ‹¿å‡ºå¤§å‰µè²·çš„ç©å…·", map: "",
              rainy: { title: "é£¯åº—å®¤å…§/æˆ¿é–“ä¼‘æ¯", icon: "fa-bed", note: "â˜” é›¨å¤©å‚™æ¡ˆï¼šåƒé›¶é£Ÿçœ‹é›»è¦–" }
            },
            { time: "18:00", title: "æ™šé¤ï¼šç¾æ‹‰èŠ±åˆ¥é‚¸", icon: "fa-utensils", note: "èµ°è·¯å»åƒï¼Œæ¦»æ¦»ç±³åŒ…å»‚", map: "ç¾æ‹‰èŠ±" }
        ]},
        { day: "D3", date: "3/30 (ä¸€)", title: "ç¾éº—æµ· & å¤å®‡åˆ©", highlights: "é¯¨é¯Š / è·¨æµ·å¤§æ©‹ / è¦è¦é£¯", bg: bgImages.D3, events: [
            { time: "09:30", title: "ç¾éº—æµ·æ°´æ—é¤¨", icon: "fa-fish", note: "åœ P7 ç«‹é«”åœè»Šå ´æœ€å¿«ï¼Œç›´è¡é»‘æ½®ä¹‹æµ·", map: "æµ·æ´‹åšå…¬åœ’P7ç«‹é«”åœè»Šå ´", mapcode: "553 075 797*77" },
            { time: "13:30", title: "å‰å¾€å¤å®‡åˆ©å³¶", icon: "fa-car-side", note: "è»Šä¸Šè®“å¥å¥åˆç¡", map: "",
              rainy: { title: "å‰å¾€æ°´æœæ¨‚åœ’ (å®¤å…§)", icon: "fa-car", note: "â˜” é›¨å¤©æ”¹å»å®¤å…§æ™¯é»", map: "OKINAWA fruits land" }
            },
            { time: "14:30", title: "å¤å®‡åˆ©æµ·æ´‹å¡”", icon: "fa-tower-observation", note: "æ­ç„¡äººé³³æ¢¨è»Š", map: "å¤å®‡åˆ©æµ·æ´‹å¡”",
              rainy: { title: "æ²–ç¹©æ°´æœæ¨‚åœ’", icon: "fa-lemon", note: "â˜” é›¨å¤©å‚™æ¡ˆï¼šå®¤å…§è§£è¬éŠæˆ²", map: "OKINAWA fruits land", mapcode: "206 716 585*22" }
            },
            { time: "16:00", title: "é»å¿ƒï¼šè¦è¦é£¯", icon: "fa-shrimp", note: "Kouri Shrimp (æ©‹æ—)", map: "Kouri Shrimp" },
            { time: "16:30", title: "æ©‹ä¸‹æ²™ç˜", icon: "fa-camera", note: "æ‹å…¨å®¶ç¦", map: "å¤å®‡åˆ©æµ·ç˜",
              rainy: { title: "AEON é€›è¡—/ä¼‘æ¯", icon: "fa-shop", note: "â˜” é›¨å¤©å–æ¶ˆæ²™ç˜è¡Œç¨‹" }
            },
            { time: "18:00", title: "æ™šé¤ï¼šåè­·ä¸ƒé¸ä¸€", icon: "fa-fire-burner", note: "å¤§å®¶ / ç‡’è‚‰ä¹ƒæˆ‘é‚£éœ¸ / è—å£½å¸", map: "ç‡’è‚‰ä¹ƒæˆ‘é‚£éœ¸ æ–°é¤¨" }
        ]},
        { day: "D4", date: "3/31 (äºŒ)", title: "æé¾ & å…¬åœ’", highlights: "DINO Park / ç”œç”œåœˆ / æºœæ»‘æ¢¯", bg: bgImages.D4, events: [
            { time: "10:00", title: "DINO æé¾ PARK", icon: "fa-dragon", note: "âš ï¸ çˆ¸çˆ¸è«‹ç”¨æ¹å·¾ï¼Œæ‰¾80éš»æé¾", map: "DINOæé¾PARK å±±åŸäºç†±å¸¶ä¹‹æ£®", mapcode: "206 745 056*82",
              rainy: { title: "AEON åè­·åº— (äºŒåˆ·)", icon: "fa-gamepad", note: "â˜” æé¾å…¬åœ’ä¸‹é›¨æ³¥æ¿˜ï¼Œæ”¹å®¤å…§éŠæ¨‚å ´", map: "AEON åè­·åº—" }
            },
            { time: "11:30", title: "åˆé¤ï¼šå¾¡è“å­å¾¡æ®¿", icon: "fa-bowl-food", note: "å°±åœ¨æé¾å…¬åœ’æ¨“ä¸Š", map: "" },
            { time: "13:00", title: "å³¶è±†è…ç”œç”œåœˆ", icon: "fa-cookie-bite", note: "Shima Donuts (è³£å®Œåƒ A&W)", map: "Shima Donuts" },
            { time: "15:00", title: "21ä¸–ç´€ä¹‹æ£®å…¬åœ’", icon: "fa-child-reaching", note: "çœ‹é»‘è‰²ç«è»Šé ­ã€é•·æºœæ»‘æ¢¯", map: "21ä¸–ç´€ä¹‹æ£®å…¬åœ’", mapcode: "206 626 779*74",
              rainy: { title: "åè­·åšç‰©é¤¨", icon: "fa-building-columns", note: "â˜” é›¨å¤©å‚™æ¡ˆï¼šçœ‹é¯¨é­šéª¨éª¼æ¨™æœ¬", map: "Nago Museum" }
            },
            { time: "16:30", title: "Blue Seal å†°æ·‡æ·‹", icon: "fa-ice-cream", note: "åè­·åº—ï¼Œåƒ Kids Size", map: "Blue Seal Nago" }
        ]},
        { day: "D5", date: "4/01 (ä¸‰)", title: "å‹•ç‰© & æ”¾ç©º", highlights: "Neo Park å°ç«è»Š / é£¯åº—æ³³æ± ", bg: bgImages.D5, events: [
            { time: "10:00", title: "Neo Park å‹•æ¤ç‰©åœ’", icon: "fa-crow", note: "é€²é–€å…ˆæ­å¾©å¤å°ç«è»Š", map: "åè­·è‡ªç„¶å‹•æ¤ç‰©å…¬åœ’", mapcode: "206 689 725*11",
              rainy: { title: "ç¾éº—æµ· (äºŒåˆ·)", icon: "fa-fish", note: "â˜” é›¨å¤©å‚™æ¡ˆï¼šå›å»æ°´æ—é¤¨çœ‹æµ·ç‰›/æµ·é¾œ", map: "ç¾éº—æµ·æ°´æ—é¤¨" }
            },
            { time: "12:30", title: "åˆé¤ï¼šCookhal", icon: "fa-leaf", note: "æˆ–åƒ å¹¸é†¬æ²–ç¹©éºµ (æ¦»æ¦»ç±³)", map: "Cookhal" },
            { time: "15:30", title: "é£¯åº—æ³³æ± /æ²™ç˜", icon: "fa-person-swimming", note: "å¤§äººæ”¾ç©ºï¼Œå°å­©å¾¹åº•æ”¾é›»", map: "",
              rainy: { title: "é£¯åº—å®¤å…§è¨­æ–½", icon: "fa-hotel", note: "â˜” ä¸‹é›¨å°±å¥½å¥½äº«å—é£¯åº—å§" }
            },
            { time: "18:00", title: "æ™šé¤ï¼šç™¾å¹´å¤å®¶ å¤§å®¶", icon: "fa-house", note: "å¿…åƒé˜¿å¤è±¬ç«é‹ (å·²é ç´„)", map: "ç™¾å¹´å¤å®¶ å¤§å®¶" },
            { time: "20:00", title: "æ‰“åŒ…è¡Œæ", icon: "fa-suitcase", note: "æ˜å¤©è¦é€€æˆ¿å¾€å—äº†", map: "" }
        ]},
        { day: "D6", date: "4/02 (å››)", title: "ç§»å‹• & è³¼ç‰©", highlights: "PARCO CITY / DMM / ä½é‚£éœ¸", bg: bgImages.D6, events: [
            { time: "10:30", title: "é€€æˆ¿å¾€å—", icon: "fa-car", note: "ç›´å¥”æµ¦æ·» (ç´„1å°æ™‚)", map: "" },
            { time: "11:30", title: "PARCO CITY", icon: "fa-bag-shopping", note: "åˆé¤(2F) & è³¼ç‰©", map: "SAN-A æµ¦æ·»è¥¿æµ·å²¸ PARCO CITY", mapcode: "33 339 062*55" },
            { time: "15:00", title: "DMM æ°´æ—é¤¨", icon: "fa-fish-fins", note: "ä½æ–¼ iias å•†å ´ï¼Œçœ‹æ¨¹æ‡¶ã€æ‘¸é­š", map: "DMM Kariyushi Aquarium", mapcode: "232 543 400*25" },
            { time: "17:40", title: "é‚£éœ¸ Check-in", icon: "fa-building", note: "Daiwa Roynet åœ‹éš›é€š (è»Šåœ3F)", map: "Daiwa Roynet Hotel Naha Kokusai-dori" },
            { time: "19:00", title: "æ™šé¤ï¼šéº¥ç•¶å‹", icon: "fa-burger", note: "åœ‹éš›é€šç‰§å¿—åº— (å°å­©çš„æ•‘è´–)", map: "McDonald's Kokusai Dori Makishi" },
            { time: "20:30", title: "Fontana Gelato", icon: "fa-ice-cream", note: "å½©è™¹å†°æ·‡æ·‹", map: "Fontana Gelato" }
        ]},
        { day: "D7", date: "4/03 (äº”)", title: "ç¥ˆé¡˜ & è¿”å®¶", highlights: "æ³¢ä¸Šå®® / Outlet / 13:00é‚„è»Š", bg: bgImages.D7, events: [
            { time: "09:20", title: "æ³¢ä¸Šå®®", icon: "fa-torii-gate", note: "æ‡¸å´–ä¸Šçš„ç¥ç¤¾ï¼Œè²·å¾¡å®ˆ", map: "æ³¢ä¸Šå®®",
              rainy: { title: "ç³»æ»¿é­šå¸‚å ´", icon: "fa-fish", note: "â˜” é›¨å¤©å‚™æ¡ˆï¼šæœ‰é®é›¨æ£šï¼Œåƒæµ·é®®", map: "ç³¸æº€æ¼æ°‘é£Ÿå ‚" }
            },
            { time: "11:10", title: "ASHIBINAA Outlet", icon: "fa-shirt", note: "åˆé¤(ç¾é£Ÿè¡—) & æœ€å¾Œè¡åˆº", map: "ASHIBINAA Outlet", mapcode: "232 544 452*22" },
            { time: "12:40", title: "åŠ æ²¹ (OTSæ—)", icon: "fa-gas-pump", note: "ä¿ç•™æ”¶æ“šï¼(ENEOS)", map: "ENEOS Dr.Drive Self Toyosaki SS" },
            { time: "13:00", title: "OTS é‚„è»Š", icon: "fa-car-side", note: "å‹™å¿…æº–æ™‚ã€‚æª¢æŸ¥ ETC å¡æ‹”äº†æ²’", map: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€" },
            { time: "13:45", title: "æŠµé”æ©Ÿå ´", icon: "fa-plane-departure", note: "é€›å…ç¨…åº— (è²·é•·é ¸é¹¿è–¯æ¢)", map: "é‚£éœ¸æ©Ÿå ´" },
            { time: "16:45", title: "æ˜Ÿå®‡ JX303 èµ·é£›", icon: "fa-paper-plane", note: "å›å®¶å›‰ï¼", map: "" }
        ]}
    ];

    const checklistDB = [
        { id: "pack", title: "ğŸ’ è¡Œå‰æ‰“åŒ… (å®Œæ•´)", items: [
            { text: "è­·ç…§ (å…¨å®¶3æœ¬)", sub: "æ•ˆæœŸéœ€ > 2026/10" },
            { text: "é§•ç…§æ­£æœ¬ + æ—¥æ–‡è­¯æœ¬", sub: "OTS å–è»Šå¿…å‚™" },
            { text: "Visit Japan Web æˆªåœ–", sub: "å­˜æ‰‹æ©Ÿç›¸ç°¿" },
            { text: "ä½å®¿æ†‘è­‰/é›»è©±", sub: "ç¬¬ä¸€æ™š Check-in ç”¨" },
            { text: "å¥å¥å®‰æ’«åŒ…", sub: "è²¼ç´™æ›¸ã€è»Ÿç³–ã€è–„å¤–å¥—" },
            { text: "è»Šå…§ç™¾å¯¶è¢‹", sub: "é®é™½ç°¾ã€è»Šå……ã€åƒåœ¾è¢‹" },
            { text: "3C é›»å­", sub: "è¡Œå‹•é›»æº(éš¨èº«)ã€å……é›»é ­ã€ç·šã€ç›¸æ©Ÿ" },
            { text: "ç”Ÿæ´»å‚™è—¥", sub: "é€€ç‡’è—¥ã€ç›Šç”ŸèŒã€é«”æº«è¨ˆã€é¼»å™´åŠ‘" },
            { text: "é˜²æ›¬/ç©æ°´", sub: "æ³³è¡£ã€é˜²æ›¬ä¹³ã€å¸½å­ã€å¢¨é¡" },
            { text: "é£Ÿç‰©å‰ªåˆ€ (æ‰˜é‹)", sub: "çµ•å°ä¸å¯æ”¾éš¨èº«" },
            { text: "è¡£ç‰©å£“ç¸®è¢‹", sub: "å›ç¨‹è£é«’è¡£æœçœç©ºé–“" },
            { text: "æŒ‡ç”²å‰ª", sub: "é•·é€”æ—…è¡Œå¿…å‚™" },
            { text: "éš¨èº«ç­†", sub: "æ©Ÿä¸Šå¡«å…¥å¢ƒå¡ç”¨" },
            { text: "å¤¾éˆè¢‹ (å¤§/ä¸­)", sub: "è£æ¿•æ³³è¡£ã€åˆ†è£é›¶é£Ÿ" }
        ]},
        { id: "shop", title: "ğŸ›ï¸ è³¼ç‰©å¿…è²· (å®Œæ•´)", items: [
            { text: "åˆåˆ©ä»–å‘½ EX Plus", sub: "å®¶åº­å¸¸å‚™è—¥" },
            { text: "è‹¥å…ƒéŒ  (Wakamoto)", sub: "é¡§è…¸èƒƒ" },
            { text: "EVE æ­¢ç—›è—¥", sub: "è—è‰²/ç™½è‰²" },
            { text: "Kowa èšŠèŸ²æ­¢ç™¢æ¶²", sub: "åˆ·é ­ç‰ˆ (çµ¦å¥å¥ç”¨)" },
            { text: "å¤§å‰µ - å„ç¨®æ³¡æ¾¡çƒ", sub: "AEON åè­·åº—å¿…è²·" },
            { text: "å¤§å‰µ - æŒ–æ²™å·¥å…·çµ„", sub: "æµ·é‚Šç©æ²™ç”¨" },
            { text: "LuLuLun é¢è†œ", sub: "æ²–ç¹©é™å®š (è‹¦ç“œ/é¦™æª¸)" },
            { text: "å®‰è€æ›¬é˜²æ›¬", sub: "é‡‘ç“¶ (æ²–ç¹©å¤ªé™½æ¯’)" },
            { text: "Tomica æ²–ç¹©é™å®šè»Š", sub: "PARCO / æ©Ÿå ´" },
            { text: "è¾£å‘³è¦é¤… (å—é¢¨å ‚)", sub: "ä¸‹é…’é›¶é£Ÿ" },
            { text: "é‚ŠéŠ€é£Ÿå ‚è¾£æ²¹", sub: "çŸ³å£å³¶åç”¢" },
            { text: "Calbee éº¥ç‰‡", sub: "ç´…è‰²åŒ…è£æœ€ç¶“å…¸" },
            { text: "Orihiro è’Ÿè’»æœå‡", sub: "è¢‹è£å¥½æ”œå¸¶ (è¦æ‰˜é‹)" },
            { text: "ROIHI ç©´ä½è²¼å¸ƒ", sub: "è€äººé ­åƒ (æ¶¼æ„Ÿ/æº«æ„Ÿ)" },
            { text: "Fino é«®è†œ/é«®æ²¹", sub: "æ—¥æœ¬è²·å¾ˆä¾¿å®œ" }
        ]},
        { id: "return", title: "ğŸš¨ å›ç¨‹é˜²å‘† (SOP)", items: [
            { text: "ETC å¡æ‹”äº†å—ï¼Ÿ", sub: "é‚„è»Šå‰ç¢ºèª (æœ€å¸¸å¿˜è¨˜)" },
            { text: "è»Šå……é ­æ‹”äº†å—ï¼Ÿ", sub: "é‚„è»Šå‰ç¢ºèª" },
            { text: "é–€é‚Šåƒåœ¾/ç©å…·æ¸…ç©ºï¼Ÿ", sub: "é‚„è»Šå‰ç¢ºèª" },
            { text: "æ²¹åŠ æ»¿äº†å—ï¼Ÿ", sub: "ä¿ç•™æ”¶æ“šçµ¦åº—å“¡" },
            { text: "å¸ƒä¸/æœå‡ æ‰˜é‹äº†å—ï¼Ÿ", sub: "æ¶²é«” > 100ml ä¸å¯æ‰‹æ" },
            { text: "æ´—é¢ä¹³/ç‰™è† æ‰˜é‹äº†å—ï¼Ÿ", sub: "é€™ä¹Ÿæ˜¯æ¶²é«”ï¼" },
            { text: "è­·ç…§æ‹¿å‡ºä¾†äº†å—ï¼Ÿ", sub: "ä¸è¦é–åœ¨é£¯åº—ä¿éšªç®±" },
            { text: "Wifiæ©Ÿ/SIMå¡é‡", sub: "ç¢ºèªæ”¶å¥½" },
            { text: "è¡Œæç§¤é‡", sub: "ç¢ºèªæ²’è¶…é‡ (å–®ä»¶23kg?)" },
            { text: "èº«ä¸Šé›¶éŒ¢èŠ±å…‰", sub: "æ©Ÿå ´æ‰­è›‹æ©Ÿ/ä¾¿åˆ©å•†åº—" }
        ] }
    ];

    const missionsDB = [
        { id: "m1", title: "æˆ‘æ˜¯èˆ¹é•·", desc: "åœ¨ç»ç’ƒèˆ¹æ‰¾åˆ°å°¼è«", icon: "fa-fish" },
        { id: "m2", title: "æµ·æ´‹éœ¸ä¸»", desc: "è·Ÿå¤§é¯¨é¯Šæ‹åˆç…§", icon: "fa-camera" },
        { id: "m3", title: "å°å°å‹‡è€…", desc: "æ£®æ—æ¢éšªæ‹¯æ•‘å—å‚·çš„æé¾", icon: "fa-dragon" },
        { id: "m4", title: "é³¥é³¥é»å", desc: "æ­å°ç«è»Šæ•¸å‡º3ç¨®é³¥", icon: "fa-crow" },
        { id: "m5", title: "æµ·åº•å°‹å¯¶", desc: "åœ¨é€æ˜åœ°æ¿æ‰¾åˆ°é­š", icon: "fa-water" },
        { id: "m6", title: "èª å¿ƒç¥ˆç¦", desc: "åœ¨ç¥ç¤¾æŠ•ç¡¬å¹£èªªè¬è¬", icon: "fa-hands-praying" }
    ];

    const rewardsDB = [
        { icon: "ğŸ¬", text: "åƒä¸€é¡†è»Ÿç³–" },
        { icon: "ğŸ“º", text: "çœ‹ 10 åˆ†é˜å¡é€š" },
        { icon: "ğŸ§â€â™‚ï¸", text: "çˆ¸çˆ¸èƒŒèƒŒ 5 åˆ†é˜" },
        { icon: "ğŸ¹", text: "å–ä¸€ç“¶æœæ±" },
        { icon: "ğŸ§¸", text: "å»ä¾¿åˆ©å•†åº—è²·ç©å…·" },
        { icon: "ğŸ¥š", text: "æ‰­ä¸€é¡†çœŸçš„æ‰­è›‹" },
        { icon: "ğŸ¦", text: "åƒå†°æ·‡æ·‹" }
    ];

    const toolsDB = {
        drive: [
            { title: "å³é§•å£è¨£", content: "å·¦è½‰å°å½ã€å³è½‰å¤§å½<br>é›¨åˆ·åœ¨å·¦ã€æ–¹å‘ç‡ˆåœ¨å³", color: "bg-blue-50 text-blue-800" },
            { title: "åŠ æ²¹é‡‘å¥", content: "Regular æ»¿æ²¹ (ç´…æ§)<br>ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æº€ã‚¿ãƒ³<br>(Regyuraa mantan)", color: "bg-orange-50 text-orange-800" },
            { title: "å°èˆªè¨­å®š", content: "åœè»Šè«‹æ‰¾ ğŸ…¿ï¸ (P)<br>è¼¸å…¥ MapCode æœ€æº–", color: "bg-slate-100 text-slate-800" },
            { title: "é‡è¦æ¨™èªŒ", content: "ğŸ”» æ­¢ã¾ã‚Œ (åœ)ï¼šå®Œå…¨ç…åœ<br>â›” é€²å…¥ç¦æ­¢ï¼šä¸å¯é€²å…¥<br>â¬‡ï¸ å¾è¡Œï¼šæ¸›é€Ÿæ…¢è¡Œ", color: "bg-red-50 text-red-700" }
        ],
        jp: [
            { label: "ğŸ‘¶ è¦ªå­è‚²å…’", items: [
                { t: "æœ‰å…’ç«¥é¤å—?", j: "å­ã©ã‚‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹?", p: "Kodomo menyu wa..." },
                { t: "å¯ä»¥æ›å°¿å¸ƒå—?", j: "ãŠã‚€ã¤ã‚’æ›¿ãˆã¦ã‚‚ã„ã„ã§ã™ã‹?", p: "Omutsu o kaete..." },
                { t: "å“ºä¹³å®¤åœ¨å“ªè£¡?", j: "æˆä¹³å®¤ã¯ã©ã“ã§ã™ã‹?", p: "Junyu-shitsu wa..." },
                { t: "å¯ä»¥ç”¨æ¨è»Šå—?", j: "ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼ã¯ä½¿ãˆã¾ã™ã‹?", p: "Bebi ka wa..." },
                { t: "æœ‰å¬°å…’åºŠå—?", j: "ãƒ™ãƒ“ãƒ¼ãƒ™ãƒƒãƒ‰ã¯ã‚ã‚Šã¾ã™ã‹?", p: "Bebi beddo wa..." }
            ]},
            { label: "ğŸ½ï¸ é¤å»³ç”¨é¤", items: [
                { t: "æœ‰å…’ç«¥æ¤…å—?", j: "å­ä¾›ç”¨ã®æ¤…å­ã¯ã‚ã‚Šã¾ã™ã‹?", p: "Kodomo-yo no isu..." },
                { t: "çµ¦å…’ç«¥é¤å…·", j: "å­ä¾›ç”¨ã®å–ã‚Šçš¿ã¨ã‚¹ãƒ—ãƒ¼ãƒ³", p: "Torizara to supuun" },
                { t: "è«‹çµ¦æˆ‘æ°´", j: "ãŠæ°´ã‚’ãã ã•ã„", p: "Omizu o kudasai" },
                { t: "é€™å€‹æœƒè¾£å—?", j: "ã“ã‚Œã¯è¾›ã„ã§ã™ã‹?", p: "Kore wa karai..." },
                { t: "æ¨è–¦æ–™ç†æ˜¯ä»€éº¼?", j: "ãŠã™ã™ã‚ã®æ–™ç†ã¯ä½•ã§ã™ã‹?", p: "Osusume no..." },
                { t: "æˆ‘è¦å¤–å¸¶", j: "æŒã¡å¸°ã‚Šã«ã§ãã¾ã™ã‹", p: "Mochi-kaeri ni..." },
                { t: "æˆ‘è¦çµå¸³", j: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™", p: "Okaikei o onegai" }
            ]},
            { label: "ğŸ›ï¸ ä½å®¿ & è³¼ç‰©", items: [
                { t: "å¯ä»¥è©¦ç©¿å—?", j: "ã“ã‚Œã‚’è©¦ç€ã§ãã¾ã™ã‹?", p: "Kore o shichaku..." },
                { t: "å¯ä»¥åˆ·å¡å—?", j: "ã‚«ãƒ¼ãƒ‰ã§æ‰•ãˆã¾ã™ã‹?", p: "Kado de haraemasu..." },
                { t: "æˆ‘è¦è¾¦ç†å…¥ä½", j: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’ãŠé¡˜ã„ã—ã¾ã™", p: "Check-in o onegai" },
                { t: "è«‹å†çµ¦æˆ‘ä¸€æ¢æ¯›å·¾", j: "ã‚‚ã†ä¸€æšã‚¿ã‚ªãƒ«ã‚’ãã ã•ã„", p: "Mo ichimai taoru..." },
                { t: "å¯ä»¥å¯„æ”¾è¡Œæå—", j: "è·ç‰©ã‚’é ã‹ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹", p: "Nimotsu o azukatte..." }
            ]},
            { label: "ğŸš¨ ç·Šæ€¥ç‹€æ³", items: [
                { t: "å°å­©ç™¼ç‡’äº†", j: "å­ä¾›ãŒç†±ã‚’å‡ºã—ã¾ã—ãŸ", p: "Kodomo ga netsu o..." },
                { t: "é ­ç—›", j: "é ­ãŒç—›ã„ã§ã™", p: "Atama ga itai..." },
                { t: "æˆ‘æƒ³å»é†«é™¢", j: "ç—…é™¢ã¸è¡ŒããŸã„ã§ã™", p: "Byoin e ikitai..." },
                { t: "è«‹å«æ•‘è­·è»Š", j: "æ•‘æ€¥è»Šã‚’å‘¼ã‚“ã§ãã ã•ã„", p: "Kyukyu-sha o yonde" }
            ]}
        ],
        sos: [
            { name: "æ•‘è­·è»Š / ç«è­¦", tel: "119", style: "bg-red-500 text-white" },
            { name: "å ±è­¦ (è»Šç¦)", tel: "110", style: "bg-blue-600 text-white" },
            { name: "OTS ç§Ÿè»Šæ•‘æ´", tel: "098-856-8877", style: "bg-green-600 text-white" },
            { name: "å¤–äº¤éƒ¨æ€¥é›£æ•‘åŠ©", tel: "080-8056-0122", style: "bg-gray-700 text-white" },
            { name: "åè­·åŒ—éƒ¨é†«é™¢", tel: "0980-52-2719", style: "bg-white border text-gray-800" },
            { name: "é‚£éœ¸å—éƒ¨é†«ç™‚", tel: "098-888-0123", style: "bg-white border text-gray-800" }
        ]
    };

    // ================= LOGIC =================
    let activeTab = 'itinerary';
    let currentDayIdx = 0;
    let currentChecklistFilter = 'pack';
    let currentToolFilter = 'drive';

    function initWeather() {
        const weatherIcon = document.getElementById('weather-icon');
        const weatherTemp = document.getElementById('weather-temp');
        const weatherLoc = document.getElementById('weather-loc');

        weatherTemp.innerText = "...";
        weatherIcon.className = "fas fa-spinner fa-spin text-xl mb-1 block text-blue-300";

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    fetchWeather(position.coords.latitude, position.coords.longitude, "ç›®å‰ä½ç½®");
                },
                (error) => {
                    fetchWeather(26.5915, 127.9773, "åè­·å¸‚");
                }
            );
        } else {
            fetchWeather(26.5915, 127.9773, "åè­·å¸‚");
        }
    }

    async function fetchWeather(lat, lon, label) {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            const temp = Math.round(data.current_weather.temperature);
            const code = data.current_weather.weathercode;
            
            document.getElementById('weather-temp').innerText = temp + "Â°C";
            document.getElementById('weather-loc').innerText = label;
            
            const iconEl = document.getElementById('weather-icon');
            if (code <= 1) iconEl.className = "fas fa-sun text-xl mb-1 block text-yellow-400";
            else if (code <= 3) iconEl.className = "fas fa-cloud-sun text-xl mb-1 block text-yellow-400";
            else if (code <= 65) iconEl.className = "fas fa-cloud-rain text-xl mb-1 block text-blue-300";
            else iconEl.className = "fas fa-bolt text-xl mb-1 block text-yellow-500";
        } catch (e) {
            document.getElementById('weather-temp').innerText = "24Â°C";
            document.getElementById('weather-loc').innerText = "é å ±";
            document.getElementById('weather-icon').className = "fas fa-cloud-sun text-xl mb-1 block text-yellow-400";
        }
    }

    // New: Fetch Live Exchange Rate
    async function fetchExchangeRate() {
        const btn = document.getElementById('fetchRateBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
            const data = await res.json();
            const twd = data.rates.TWD;
            if(twd) {
                updateRate(twd.toFixed(4));
                document.getElementById('rateInput').value = twd.toFixed(4);
                showToast(`åŒ¯ç‡å·²æ›´æ–°ï¼š${twd}`);
            }
        } catch(e) {
            showToast("æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
        } finally {
            btn.innerHTML = originalText;
        }
    }

    function updateCountdown() {
        const tripStart = new Date(`${TRIP_YEAR}-03-28T13:15:00`).getTime();
        const tripEnd = new Date(`${TRIP_YEAR}-04-03T23:59:59`).getTime();
        const now = new Date().getTime();

        if (now < tripStart) {
            const diff = tripStart - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            document.getElementById('countdown').innerText = `é‚„æœ‰ ${days} å¤© ${hours} å°æ™‚`;
            document.getElementById('countdown').className = "text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10";
        } else if (now >= tripStart && now <= tripEnd) {
            document.getElementById('countdown').innerText = "âœˆï¸ æ—…ç¨‹é€²è¡Œä¸­";
            document.getElementById('countdown').className = "text-[10px] font-bold opacity-100 bg-pink-500/80 text-white px-2 py-0.5 rounded-md animate-pulse";
        } else {
            document.getElementById('countdown').innerText = "å›æ†¶æ»¿è¼‰ â¤ï¸";
            document.getElementById('countdown').className = "text-[10px] font-medium opacity-90 bg-gray-500/50 px-2 py-0.5 rounded-md";
        }
    }

    function init() {
        // Load rainy mode state
        if(localStorage.getItem('rainy_mode') === 'true') {
            isRainyMode = true;
            updateRainyModeUI();
        }
        
        switchTab('itinerary');
        updateCountdown();
        setInterval(updateCountdown, 60000);
        initWeather();
    }

    // ================= RAINY MODE =================
    window.toggleRainMode = () => {
        isRainyMode = !isRainyMode;
        localStorage.setItem('rainy_mode', isRainyMode);
        if(navigator.vibrate) navigator.vibrate(50);
        updateRainyModeUI();
        renderContent();
    }

    function updateRainyModeUI() {
        const btn = document.getElementById('rain-btn');
        const icon = document.getElementById('rain-icon');
        const text = document.getElementById('rain-text');
        const body = document.body;

        if (isRainyMode) {
            body.classList.add('rainy-mode');
            btn.className = "glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-blue-400/50 bg-blue-900/50";
            icon.className = "fas fa-cloud-showers-heavy text-xl mb-1 block text-blue-300";
            text.innerText = "é›¨å¤©å‚™æ¡ˆ";
            text.className = "text-[9px] font-bold text-blue-200";
            showToast("â˜” å·²åˆ‡æ›ç‚ºé›¨å¤©å‚™æ¡ˆæ¨¡å¼");
        } else {
            body.classList.remove('rainy-mode');
            btn.className = "glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-white/20";
            icon.className = "fas fa-sun text-xl mb-1 block text-yellow-400";
            text.innerText = "æ™´å¤©";
            text.className = "text-[9px] font-bold opacity-90";
            showToast("â˜€ï¸ å·²åˆ‡æ›ç‚ºæ™´å¤©æ¨¡å¼");
        }
    }

    window.switchTab = (tab, shouldRender=true) => {
        activeTab = tab;
        document.querySelectorAll('.nav-btn').forEach(btn => {
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            const box = btn.querySelector('.icon-box');
            
            if(btn.id === `btn-${tab}`) {
                icon.className = icon.className.replace('text-gray-400', 'text-blue-600');
                span.className = 'text-[10px] font-bold text-blue-600';
                box.className = 'icon-box p-2 rounded-2xl mb-1 transition-all bg-blue-50';
            } else {
                icon.className = `fas fa-${btn.id.split('-')[1] === 'itinerary' ? 'map-location-dot' : btn.id.split('-')[1] === 'checklist' ? 'clipboard-list' : btn.id.split('-')[1] === 'missions' ? 'medal' : 'toolbox'} text-xl text-gray-400`;
                span.className = 'text-[10px] font-bold text-gray-400';
                box.className = 'icon-box p-2 rounded-2xl mb-1 transition-all';
            }
        });
        
        renderHeaderSubNav();
        if(shouldRender) renderContent();
        setTimeout(updateSubNavStyle, 50);
    }

    function renderHeaderSubNav() {
        const container = document.getElementById('sub-nav-container');
        
        if (activeTab === 'itinerary') {
            container.innerHTML = `
                <div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar px-2">
                    ${itineraryDB.map((d, i) => `
                        <button onclick="currentDayIdx=${i}; renderContent(); updateHeaderActive()" 
                            class="day-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md transition-all duration-300 ${i === currentDayIdx ? 'tab-active' : 'tab-inactive'}">
                            <div class="text-[10px] opacity-80 uppercase">${d.day}</div>
                            <div>${d.date.split(' ')[0]}</div>
                        </button>
                    `).join('')}
                </div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${itineraryDB[currentDayIdx].bg}')`;
        } else if (activeTab === 'checklist') {
            container.innerHTML = `
                <div class="flex glass-dark p-1 rounded-2xl mx-1">
                    ${checklistDB.map(c => `
                        <button id="btn-chk-${c.id}" onclick="switchChecklist('${c.id}')" 
                            class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentChecklistFilter === c.id ? 'bg-white text-blue-600 shadow-sm' : 'text-white/80'}">
                            ${c.title.split(' ')[1]}
                        </button>
                    `).join('')}
                </div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${bgImages.SHOP}')`;
        } else if (activeTab === 'tools') {
            container.innerHTML = `
                <div class="flex glass-dark p-1 rounded-2xl mx-1 overflow-x-auto hide-scrollbar">
                    <button id="btn-tool-calc" onclick="switchTool('calc')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='calc'?'bg-white text-yellow-600':'text-white/80'}">ğŸ’° åŒ¯ç‡</button>
                    <button id="btn-tool-drive" onclick="switchTool('drive')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='drive'?'bg-white text-blue-600':'text-white/80'}">ğŸš— é§•é§›</button>
                    <button id="btn-tool-jp" onclick="switchTool('jp')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='jp'?'bg-white text-blue-600':'text-white/80'}">ğŸ—£ï¸ æ—¥èª</button>
                    <button id="btn-tool-sos" onclick="switchTool('sos')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='sos'?'bg-white text-red-600':'text-white/80'}">ğŸš¨ æ€¥é›£</button>
                    <button id="btn-tool-sync" onclick="switchTool('sync')" class="flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='sync'?'bg-white text-purple-600':'text-white/80'}">â˜ï¸ åŒæ­¥</button>
                </div>`;
             
             let bg = bgImages.TOOL;
             if(currentToolFilter === 'calc') bg = bgImages.CALC;
             if(currentToolFilter === 'sync') bg = bgImages.SYNC;
             if(currentToolFilter === 'sos') bg = bgImages.SOS;
             document.getElementById('bg-layer').style.backgroundImage = `url('${bg}')`;

        } else if (activeTab === 'missions') {
            container.innerHTML = `<div class="text-center text-white/90 text-sm font-bold pt-2 drop-shadow-md">å®Œæˆä»»å‹™ç²å¾—ä»£å¹£ï¼</div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${bgImages.MISSION}')`;
        }
    }

    function updateHeaderActive() {
        const btns = document.querySelectorAll('.day-btn');
        btns.forEach((btn, i) => {
            btn.className = `day-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md transition-all duration-300 ${i === currentDayIdx ? 'tab-active' : 'tab-inactive'}`;
        });
        document.getElementById('bg-layer').style.backgroundImage = `url('${itineraryDB[currentDayIdx].bg}')`;
    }
    
    // ================= SMART GUIDE LOGIC =================
    function getSmartSuggestion() {
        const now = new Date();
        
        let allEvents = [];
        itineraryDB.forEach((day, dIdx) => {
            const dateStr = day.date.split(' ')[0];
            const [m, d] = dateStr.split('/');
            
            day.events.forEach(ev => {
                const [h, min] = ev.time.split(':');
                const eventDate = new Date(TRIP_YEAR, parseInt(m)-1, parseInt(d), parseInt(h), parseInt(min));
                
                const finalEv = (isRainyMode && ev.rainy) ? { ...ev, ...ev.rainy } : ev;

                allEvents.push({
                    ...finalEv,
                    timestamp: eventDate,
                    dayTitle: day.title,
                    dayIdx: dIdx
                });
            });
        });

        let targetEvent = null;
        let label = "";
        let diffText = "";
        
        const firstEvent = allEvents[0];
        const lastEvent = allEvents[allEvents.length - 1];
        
        if (now < firstEvent.timestamp) {
            targetEvent = firstEvent;
            label = "å³å°‡é–‹å§‹ï¼šç¬¬ä¸€ç«™";
            const diffMin = Math.floor((firstEvent.timestamp - now) / 60000);
            diffText = "è¡Œå‰é è¦½";
        } else if (now > lastEvent.timestamp) {
             return null; 
        } else {
            targetEvent = allEvents.find(e => e.timestamp > now);
            if (targetEvent) {
                label = "ä¸‹ä¸€ç«™";
                const diffMin = Math.floor((targetEvent.timestamp - now) / 60000);
                if (diffMin < 60) diffText = `é‚„æœ‰ ${diffMin} åˆ†é˜`;
                else diffText = `é‚„æœ‰ ${Math.floor(diffMin/60)}å°æ™‚${diffMin%60}åˆ†`;
            }
        }
        
        return { event: targetEvent, label, diffText };
    }


    function renderContent() {
        const main = document.getElementById('main-scroll');
        
        if (activeTab === 'itinerary') {
            const d = itineraryDB[currentDayIdx];
            const smart = getSmartSuggestion();
            let smartHTML = '';
            
            if (smart && smart.event) {
                const ev = smart.event;
                // Fix map link for v10.1
                const mapLink = ev.map ? `https://maps.google.com/?q=${encodeURIComponent(ev.map)}` : null;
                const searchLink = `https://maps.google.com/?q=${encodeURIComponent(ev.title)}`;
                
                smartHTML = `
                    <div class="smart-card rounded-3xl p-5 mb-6 relative animate-slide-up">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <span class="bg-blue-600 text-white text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wider flex items-center gap-1">
                                    <div class="w-2 h-2 bg-white rounded-full pulse-dot"></div> ${smart.label}
                                </span>
                                <span class="text-xs text-blue-500 font-bold">${smart.diffText}</span>
                            </div>
                        </div>
                        
                        <div class="flex items-start gap-4 mb-4">
                            <div class="w-14 h-14 rounded-2xl bg-blue-50 text-blue-600 flex flex-shrink-0 items-center justify-center text-2xl border border-blue-100">
                                <i class="fas ${ev.icon}"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-black text-slate-800 leading-tight mb-1">${ev.title}</h2>
                                <p class="text-sm text-slate-500 font-medium">${ev.note || 'æº–å‚™å‡ºç™¼ï¼'}</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-3">
                            ${ev.mapcode ? `
                            <button onclick="copyMapCode('${ev.mapcode}')" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-colors active:scale-95">
                                <i class="fas fa-hashtag"></i> MapCode
                            </button>` : ''}
                            
                            <a href="${mapLink || searchLink}" target="_blank" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-blue-200 transition-colors active:scale-95 text-center no-underline">
                                <i class="fas ${mapLink ? 'fa-location-arrow' : 'fa-search'}"></i> ${mapLink ? 'å°èˆª' : 'æœå°‹'}
                            </a>
                        </div>
                    </div>
                `;
            }

            main.innerHTML = `
                <div class="animate-slide-up">
                    ${smartHTML}
                    
                    <div class="glass-card rounded-3xl p-5 mb-6 relative overflow-hidden border-l-4 border-blue-500">
                        <div class="flex items-center gap-2 mb-2">
                             <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-1 rounded-md">Day ${currentDayIdx + 1}</span>
                             <h2 class="text-xl font-bold text-gray-800">${d.date}</h2>
                        </div>
                        <div class="text-sm font-medium text-gray-500 mb-3">${d.title}</div>
                        <div class="text-sm bg-slate-50 p-3 rounded-xl border border-slate-100 text-gray-600 flex items-start gap-2">
                            <i class="fas fa-star text-yellow-500 mt-0.5"></i> 
                            <span class="font-medium">${d.highlights}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        ${d.events.map((e, idx) => {
                            const isRainyItem = isRainyMode && e.rainy;
                            const current = isRainyItem ? { ...e, ...e.rainy } : e;
                            const highlightClass = isRainyItem ? "border-l-4 border-blue-400 bg-blue-50/50" : "";
                            const badge = isRainyItem ? `<span class="absolute top-2 right-2 bg-blue-500 text-white text-[9px] px-2 py-0.5 rounded-full"><i class="fas fa-umbrella mr-1"></i>é›¨å¤©å‚™æ¡ˆ</span>` : "";
                            
                            // Link fix v10.1
                            const mapLink = current.map ? `https://maps.google.com/?q=${encodeURIComponent(current.map)}` : null;

                            return `
                            <div class="group bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-4 relative overflow-hidden transition-all active:scale-[0.98] ${highlightClass}">
                                ${badge}
                                <div class="flex flex-col items-center gap-2 mt-1 min-w-[3rem]">
                                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-50 to-indigo-50 text-blue-600 flex items-center justify-center text-xl shadow-inner border border-white">
                                        <i class="fas ${current.icon}"></i>
                                    </div>
                                    ${idx !== d.events.length - 1 ? '<div class="h-full w-0.5 bg-slate-100 rounded-full"></div>' : ''}
                                </div>
                                <div class="flex-1 py-1">
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="font-bold text-gray-800 text-lg">${current.time}</h3>
                                        <div class="flex gap-2">
                                            ${current.mapcode ? `<button onclick="copyMapCode('${current.mapcode}')" class="glass px-2 py-1.5 rounded-full text-[10px] text-slate-600 font-bold border border-slate-200 active:bg-slate-200"><i class="fas fa-hashtag mr-1"></i>MapCode</button>` : ''}
                                            ${mapLink ? `<a href="${mapLink}" target="_blank" class="glass px-3 py-1.5 rounded-full text-xs text-blue-600 font-bold border border-blue-100 active:bg-blue-50"><i class="fas fa-location-arrow mr-1"></i> GO</a>` : ''}
                                        </div>
                                    </div>
                                    <p class="font-bold text-gray-700 mb-2">${current.title}</p>
                                    ${current.note ? `<p class="text-xs text-gray-500 bg-slate-50 p-2 rounded-lg border border-slate-100"><i class="fas fa-info-circle mr-1 text-blue-400"></i>${current.note}</p>` : ''}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    <div class="h-12"></div>
                </div>`;
        } else if (activeTab === 'checklist') {
            const list = checklistDB.find(c => c.id === currentChecklistFilter);
            main.innerHTML = `
                <div class="animate-slide-up glass-card rounded-3xl p-6 min-h-[60vh]">
                    <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-4 border-gray-100 flex items-center gap-2">
                        <span class="w-1.5 h-6 bg-blue-500 rounded-full"></span>
                        ${list.title}
                    </h3>
                    <div class="space-y-4">
                        ${list.items.map((item, i) => {
                            const key = `chk_${currentChecklistFilter}_${i}`;
                            const isChecked = localStorage.getItem(key) === '1';
                            const textStyle = isChecked ? 'text-gray-400 line-through' : 'text-gray-700';
                            
                            return `
                                <label class="flex items-start gap-3 p-3 rounded-2xl transition-all border border-transparent hover:bg-slate-50 cursor-pointer group select-none">
                                    <div class="relative flex items-center mt-0.5">
                                        <input type="checkbox" class="custom-checkbox peer appearance-none w-6 h-6 border-2 border-slate-300 rounded-lg transition-all checked:bg-blue-500 checked:border-blue-500" 
                                            ${isChecked ? 'checked' : ''} onchange="toggleCheck('${key}')">
                                        <i class="fas fa-check text-white absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 peer-checked:opacity-100 text-xs pointer-events-none"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold transition-colors text-[15px] ${textStyle}">${item.text}</div>
                                        ${item.sub ? `<div class="text-xs text-gray-400 mt-0.5">${item.sub}</div>` : ''}
                                    </div>
                                </label>
                            `;
                        }).join('')}
                    </div>
                      <button onclick="resetChecklist('${currentChecklistFilter}')" class="w-full mt-8 py-4 bg-slate-50 rounded-2xl text-xs text-gray-400 font-bold tracking-wide active:bg-slate-100">
                        <i class="fas fa-rotate-right mr-1"></i> é‡ç½®æ¸…å–®
                    </button>
                </div>`;
        } else if (activeTab === 'missions') {
            const balance = getGashaBalance();
            main.innerHTML = `
                <div class="animate-slide-up space-y-4">
                    <div id="gasha-machine" class="glass-card rounded-3xl p-6 text-center border-4 border-pink-400 bg-pink-50 relative overflow-hidden">
                        <div class="absolute -left-10 -top-10 w-32 h-32 bg-pink-200 rounded-full opacity-50 blur-xl"></div>
                        <div class="relative z-10">
                            <h3 class="text-xl font-black text-pink-600 mb-2">ğŸ‰ å¿«æ¨‚æ‰­è›‹æ©Ÿ</h3>
                            <div class="text-4xl font-black text-gray-800 mb-2">${balance} <span class="text-sm text-gray-500 font-medium">æšä»£å¹£</span></div>
                            <p class="text-xs text-gray-500 mb-4">æ¯å®Œæˆ 1 å€‹ä»»å‹™ï¼Œå°±èƒ½è½‰ 1 æ¬¡ï¼</p>
                            
                            <button onclick="spinGasha()" ${balance <= 0 ? 'disabled' : ''} 
                                class="w-full py-4 rounded-2xl font-bold text-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2
                                ${balance > 0 ? 'bg-gradient-to-r from-pink-500 to-purple-500 text-white shadow-pink-300/50' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}">
                                ${balance > 0 ? '<i class="fas fa-gift animate-bounce"></i> æŠ•å…¥ä»£å¹£è½‰å‹•' : 'å»å®Œæˆä»»å‹™è³ºä»£å¹£ï¼'}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        ${missionsDB.map(m => {
                            const isDone = localStorage.getItem(m.id) === '1';
                            return `
                            <div onclick="toggleMission('${m.id}')" class="glass-card rounded-3xl p-4 flex flex-col items-center justify-center text-center gap-2 aspect-square relative overflow-hidden transition-all active:scale-95 cursor-pointer ${isDone ? 'border-2 border-yellow-400 bg-yellow-50/90' : 'grayscale opacity-80'}">
                                ${isDone ? '<div class="absolute top-2 right-2 text-yellow-500 text-xl animate-pop"><i class="fas fa-check-circle"></i></div>' : ''}
                                <div class="w-14 h-14 rounded-full ${isDone ? 'bg-yellow-400 text-white' : 'bg-slate-200 text-slate-400'} flex items-center justify-center text-2xl mb-1 shadow-sm transition-colors">
                                    <i class="fas ${m.icon}"></i>
                                </div>
                                <div class="font-bold text-slate-800 leading-tight">${m.title}</div>
                                <div class="text-[10px] text-slate-500 leading-tight">${m.desc}</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        } else if (activeTab === 'tools') {
            // (Tools Content)
             if (currentToolFilter === 'calc') {
                // v8.0 Pie Chart Logic
                let totalJPY = 0;
                const catTotals = {};
                
                expenses.forEach(e => {
                    totalJPY += e.price;
                    const cat = e.cat || 'other';
                    if (!catTotals[cat]) catTotals[cat] = 0;
                    catTotals[cat] += e.price;
                });
                
                let totalTWD = Math.round(totalJPY * CURRENT_RATE);
                let budgetLeft = TOTAL_BUDGET - totalTWD;
                let budgetPercent = Math.min((totalTWD / TOTAL_BUDGET) * 100, 100);
                
                // Tax Free Progress
                let taxFreePercent = Math.min((totalJPY / 5500) * 100, 100);
                let taxFreeLeft = 5500 - totalJPY;
                let taxFreeMsg = taxFreeLeft > 0 ? `é‚„å·® Â¥${taxFreeLeft.toLocaleString()} å¯å…ç¨…` : "ğŸ‰ æ­å–œï¼å·²é”å…ç¨…é–€æª»";
                
                // Gen Pie Chart CSS
                let gradientStr = "";
                let currentDeg = 0;
                let legendHTML = "";
                
                if (totalJPY > 0) {
                    const sortedCats = Object.keys(catTotals).sort((a,b) => catTotals[b] - catTotals[a]);
                    const gradients = [];
                    
                    sortedCats.forEach(c => {
                        const percent = catTotals[c] / totalJPY;
                        const deg = percent * 360;
                        const color = expenseCats[c] ? expenseCats[c].color : '#999';
                        const name = expenseCats[c] ? expenseCats[c].name : 'å…¶ä»–';
                        
                        gradients.push(`${color} ${currentDeg}deg ${currentDeg + deg}deg`);
                        currentDeg += deg;
                        
                        legendHTML += `
                            <div class="flex items-center gap-1 text-[10px] w-1/3 mb-1">
                                <div class="w-2 h-2 rounded-full" style="background:${color}"></div>
                                <span class="opacity-70">${name} ${Math.round(percent*100)}%</span>
                            </div>
                        `;
                    });
                    gradientStr = `conic-gradient(${gradients.join(', ')})`;
                } else {
                    gradientStr = "conic-gradient(#e2e8f0 0deg 360deg)";
                    legendHTML = `<div class="text-center w-full text-xs text-gray-400 mt-2">å°šç„¡è³‡æ–™</div>`;
                }

                let expenseListHTML = '';
                if(expenses.length === 0) {
                    expenseListHTML = `<div class="text-center py-8 text-gray-400 text-sm">ğŸ›ï¸ é‚„æ²’è²·æ±è¥¿...</div>`;
                } else {
                    expenseListHTML = expenses.map((item, idx) => {
                        const cat = item.cat || 'other';
                        const catInfo = expenseCats[cat];
                        
                        return `
                        <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm mb-2">
                            <div class="flex-1 flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs" style="background:${catInfo.color}">
                                    <i class="fas ${catInfo.icon}"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-gray-700">${item.name}</div>
                                    <div class="text-xs text-gray-400">Â¥${item.price.toLocaleString()} â‰ˆ $${Math.round(item.price * CURRENT_RATE).toLocaleString()}</div>
                                </div>
                            </div>
                            <button onclick="deleteExpense(${idx})" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center active:scale-90">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    `}).join('');
                }

                main.innerHTML = `
                    <div class="animate-slide-up space-y-4">
                        <div class="glass-card rounded-3xl p-6 text-center shadow-lg border-2 border-yellow-300 relative">
                             <button onclick="fetchExchangeRate()" id="fetchRateBtn" class="absolute top-4 right-4 bg-yellow-100 text-yellow-700 p-2 rounded-full text-xs shadow-sm active:scale-90 transition-transform">
                                <i class="fas fa-sync-alt"></i>
                            </button>

                            <h3 class="text-xs font-bold text-yellow-600 mb-2 uppercase tracking-wider">åŒ¯ç‡æ›ç®—å™¨</h3>
                            <div class="text-xl font-bold text-gray-500 mb-4 flex items-center justify-center gap-2">
                                1 JPY = <input type="number" id="rateInput" value="${CURRENT_RATE}" onchange="updateRate(this.value)" class="text-yellow-600 text-3xl font-black bg-transparent focus:outline-none focus:border-b-2 focus:border-yellow-500 transition-colors" step="0.0001"> TWD
                            </div>

                            <div class="flex flex-col gap-4">
                                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 relative">
                                    <label class="block text-sm font-medium text-gray-600 mb-1">æ—¥å¹£ (JPY)</label>
                                    <input type="number" id="jpyInput" oninput="convertCurrency()" placeholder="è¼¸å…¥æ—¥å¹£é‡‘é¡"
                                        class="w-full text-3xl text-gray-800 bg-transparent focus:outline-none text-center p-2 font-black">
                                </div>
                                <i class="fas fa-arrow-down text-3xl text-blue-500 animate-bounce absolute left-1/2 -translate-x-1/2 top-[52%] z-10 drop-shadow-sm"></i>
                                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                                    <label class="block text-sm font-medium text-gray-600 mb-1">ç´„ç­‰æ–¼å°å¹£ (TWD)</label>
                                    <div id="twdOutput" class="w-full text-4xl text-green-700 text-center p-2 font-black">0</div>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-dashed border-gray-200">
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="font-bold text-gray-500">å…ç¨…é€²åº¦ (ç›®æ¨™ Â¥5,500)</span>
                                    <span class="font-bold text-blue-500">${taxFreeMsg}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: ${taxFreePercent}%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-2 text-gray-300 py-2">
                            <div class="h-px bg-gray-200 flex-1"></div>
                            <span class="text-xs font-bold">æ•—å®¶è¨˜å¸³æœ¬</span>
                            <div class="h-px bg-gray-200 flex-1"></div>
                        </div>
                        
                        <div class="glass-card rounded-3xl p-4">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-xs font-bold text-gray-500">ç¸½é ç®—: $${TOTAL_BUDGET.toLocaleString()}</div>
                                <div class="text-xs font-bold ${budgetLeft < 0 ? 'text-red-500' : 'text-green-500'}">å‰©é¤˜: $${budgetLeft.toLocaleString()}</div>
                            </div>
                             <div class="w-full bg-gray-200 rounded-full h-1.5 mb-4">
                                <div class="bg-green-500 h-1.5 rounded-full transition-all duration-500" style="width: ${budgetPercent}%"></div>
                            </div>

                            <div class="pie-chart" style="background: ${gradientStr}"></div>
                            <div class="flex flex-wrap justify-center mt-3 px-2">
                                ${legendHTML}
                            </div>
                        </div>

                        <div class="glass-card rounded-3xl p-4">
                            <h3 class="text-sm font-bold text-gray-600 mb-3"><i class="fas fa-pen mr-1"></i> è¨˜ä¸€ç­†</h3>
                            
                            <div class="flex gap-2 mb-3 overflow-x-auto hide-scrollbar pb-1">
                                <label class="cursor-pointer">
                                    <input type="radio" name="cat" value="shopping" class="peer sr-only" checked>
                                    <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white peer-checked:border-pink-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                                        <i class="fas fa-bag-shopping"></i> è³¼ç‰©
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="cat" value="food" class="peer sr-only">
                                    <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white peer-checked:border-orange-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                                        <i class="fas fa-utensils"></i> é¤é£²
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="cat" value="play" class="peer sr-only">
                                    <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-purple-500 peer-checked:text-white peer-checked:border-purple-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                                        <i class="fas fa-ticket"></i> å¨›æ¨‚
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="cat" value="transport" class="peer sr-only">
                                    <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white peer-checked:border-blue-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                                        <i class="fas fa-car"></i> äº¤é€š
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="cat" value="other" class="peer sr-only">
                                    <div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-slate-500 peer-checked:text-white peer-checked:border-slate-500 transition-all font-bold flex items-center gap-1 whitespace-nowrap">
                                        <i class="fas fa-box"></i> å…¶ä»–
                                    </div>
                                </label>
                            </div>

                            <div class="flex flex-col gap-3 mb-3">
                                <input id="exName" type="text" placeholder="å“é …åç¨± (å¦‚: å¹é¢¨æ©Ÿ)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-blue-500">
                                <input id="exPrice" type="number" placeholder="Â¥ é‡‘é¡ (æ—¥å¹£)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-blue-500 font-bold">
                            </div>
                            
                            <div class="flex gap-2">
                                <button onclick="addExpense()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.98] transition-transform">
                                    <i class="fas fa-plus-circle mr-2"></i> æ–°å¢
                                </button>
                                <button onclick="exportExpenses()" class="px-4 bg-slate-200 text-slate-600 font-bold rounded-xl active:scale-[0.98] transition-transform">
                                    <i class="fas fa-share-from-square"></i>
                                </button>
                                <button onclick="setBudget()" class="px-4 bg-slate-200 text-slate-600 font-bold rounded-xl active:scale-[0.98] transition-transform">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>

                        <div class="pb-24">
                            ${expenseListHTML}
                        </div>
                    </div>
                    `;
                    setTimeout(() => {
                        const jpyInput = document.getElementById('jpyInput');
                        if (jpyInput) jpyInput.focus();
                    }, 100);
            } else if (currentToolFilter === 'drive') {
                 const parkingHTML = !parkingData ? 
                    `<div class="p-6 rounded-3xl parking-card border border-green-200 relative overflow-hidden bg-white">
                        <div class="text-center">
                            <i class="fas fa-square-parking text-4xl text-green-500 mb-3"></i>
                            <h3 class="text-lg font-bold text-gray-800 mb-1">é‚„æ²’è¨˜éŒ„åœè»Šä½ç½®</h3>
                            <p class="text-xs text-gray-500 mb-4">åœå¥½è»Šå¾ŒæŒ‰ä¸€ä¸‹ï¼Œä¸æ€•æ‰¾ä¸åˆ°è»Šï¼</p>
                            <button onclick="saveParking()" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.95] transition-transform">
                                <i class="fas fa-map-pin mr-2"></i> ğŸ…¿ï¸ æˆ‘åœé€™
                            </button>
                        </div>
                    </div>` : 
                    `<div class="p-6 rounded-3xl parking-card border border-green-500 relative overflow-hidden bg-green-50">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-green-700"><i class="fas fa-car-side text-8xl"></i></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-lg font-black text-green-800"><i class="fas fa-circle-check mr-2"></i>è»Šå­åœåœ¨é€™ï¼</h3>
                                <div class="text-xs text-green-600 font-bold bg-white px-2 py-1 rounded">${parkingData.time}</div>
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-green-200 mb-4 shadow-sm">
                                <div class="text-[10px] text-gray-400 uppercase">å‚™è¨» (æ¨“å±¤/å€åŸŸ)</div>
                                <div class="text-xl font-bold text-gray-800">${parkingData.note}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="findCar()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.95] transition-transform">
                                    <i class="fas fa-person-walking-arrow-right mr-2"></i> å¸¶æˆ‘æ‰¾è»Š
                                </button>
                                <button onclick="clearParking()" class="px-4 bg-white text-red-500 border border-red-200 font-bold rounded-xl active:scale-[0.95] transition-transform">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>`;

                main.innerHTML = `
                    <div class="animate-slide-up space-y-4">
                        ${parkingHTML}

                        <div class="grid grid-cols-2 gap-3 mb-6 sm:grid-cols-4">
                            <button onclick="quickSearch('toilets')" class="bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform">
                                <i class="fas fa-restroom text-blue-500 text-xl mb-1 block"></i>
                                <span class="text-xs font-bold">æ‰¾å»æ‰€</span>
                            </button>
                            <button onclick="quickSearch('convenience store')" class="bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform">
                                <i class="fas fa-store text-orange-500 text-xl mb-1 block"></i>
                                <span class="text-xs font-bold">æ‰¾è¶…å•†</span>
                            </button>
                            <button onclick="quickSearch('parking')" class="bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform">
                                <i class="fas fa-square-parking text-slate-600 text-xl mb-1 block"></i>
                                <span class="text-xs font-bold">æ‰¾åœè»Š</span>
                            </button>
                            <button onclick="quickSearch('æ²–ç¹© è¦ªå­å‹å–„é¤å»³')" class="bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform">
                                <i class="fas fa-child text-green-600 text-xl mb-1 block"></i>
                                <span class="text-xs font-bold">æ‰¾é¤å»³</span>
                            </button>
                        </div>

                        ${toolsDB.drive.map(d => `
                            <div class="p-6 rounded-3xl glass-card ${d.color} border border-black/5 relative overflow-hidden">
                                <i class="fas fa-car absolute -right-2 -bottom-2 text-6xl opacity-10"></i>
                                <div class="text-xs font-bold opacity-60 mb-2 uppercase tracking-wider">${d.title}</div>
                                <div class="text-xl font-black leading-tight">${d.content}</div>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (currentToolFilter === 'jp') {
                main.innerHTML = `
                    <div class="animate-slide-up space-y-6">
                        <div class="glass-card p-4 rounded-2xl text-center bg-blue-50 border border-blue-200">
                             <div class="text-sm text-blue-800 font-bold mb-1">ğŸ’¡ ä½¿ç”¨æ•™å­¸</div>
                             <div class="text-xs text-blue-600">é»æ“Š <i class="fas fa-volume-high mx-1 text-yellow-600"></i> é»ƒè‰²æŒ‰éˆ•ï¼Œæ‰‹æ©Ÿæœƒç›´æ¥å”¸å‡ºæ—¥èªï¼</div>
                        </div>

                        ${toolsDB.jp.map(cat => `
                            <div>
                                <h3 class="text-xs font-bold text-gray-400 uppercase mb-3 ml-2 tracking-wider border-l-2 border-blue-500 pl-2">${cat.label}</h3>
                                <div class="grid gap-3">
                                    ${cat.items.map((item, idx) => `
                                        <div class="glass-card p-5 rounded-3xl border border-slate-50 transition-transform flex items-center justify-between gap-3 relative z-10">
                                            <div class="flex-1">
                                                <div class="text-xs text-gray-500 mb-1 flex items-center gap-1"><i class="fas fa-language"></i> ${item.t}</div>
                                                <div class="text-xl font-black text-gray-800 mb-1 leading-tight">${item.j}</div>
                                                <div class="text-xs text-blue-500 font-bold bg-blue-50 inline-block px-2 py-0.5 rounded">${item.p}</div>
                                            </div>
                                            <button onclick="speak('${item.j}', this)" class="w-12 h-12 flex-shrink-0 rounded-full bg-yellow-400 text-yellow-900 flex items-center justify-center shadow-lg active:scale-90 transition-transform z-20">
                                                <i class="fas fa-volume-high text-xl"></i>
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
            } else if (currentToolFilter === 'sos') {
               // ... SOS content (same as before)
                let allergyTags = "";
                if(medicalData.allergies.length > 0) {
                    allergyTags = medicalData.allergies.map(a => 
                        `<span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded border border-red-200">${allergyDict[a].jp}</span>`
                    ).join(" ");
                } else {
                    allergyTags = "<span class='text-gray-400 text-xs'>ç„¡ (ãªã—)</span>";
                }

                main.innerHTML = `
                    <div class="animate-slide-up space-y-6">
                        
                        <div class="safe-card p-6 rounded-3xl shadow-xl relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10 text-red-600"><i class="fas fa-user-shield text-8xl"></i></div>
                            <div class="relative z-10">
                                <div class="flex justify-between items-start mb-4">
                                    <h3 class="text-xl font-black text-gray-800"><i class="fas fa-passport text-red-500 mr-2"></i>å…’ç«¥å®‰å¿ƒè­·ç…§</h3>
                                    <button onclick="toggleEditMedical()" class="text-xs bg-white border border-gray-200 px-3 py-1 rounded-full text-gray-500 font-bold">ç·¨è¼¯</button>
                                </div>
                                
                                <div id="medical-view">
                                    ${!medicalData.name ? 
                                    `<div class="text-center py-6 text-gray-400 text-sm">âš ï¸ è«‹é»æ“Šã€Œç·¨è¼¯ã€è¼¸å…¥è³‡æ–™<br>èµ°å¤±/å°±é†«æ™‚å‡ºç¤ºæ­¤å¡</div>` : 
                                    `
                                    <div class="space-y-4">
                                        <div class="bg-white/60 p-3 rounded-xl border border-red-100">
                                            <div class="text-[10px] text-gray-500 uppercase">My Name / ç§ã®åå‰</div>
                                            <div class="text-2xl font-black text-gray-800">${medicalData.name}</div>
                                        </div>
                                        
                                        <div class="bg-white/60 p-3 rounded-xl border border-red-100">
                                            <div class="text-[10px] text-gray-500 uppercase">Emergency Contact / ç·Šæ€¥é€£çµ¡å…ˆ</div>
                                            <div class="text-xl font-bold text-blue-600"><i class="fas fa-phone mr-1"></i> ${medicalData.phone}</div>
                                        </div>

                                        <div class="bg-white/60 p-3 rounded-xl border border-red-100">
                                            <div class="text-[10px] text-gray-500 uppercase">Allergy / ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ (éæ•)</div>
                                            <div class="flex flex-wrap gap-1 mt-1">${allergyTags}</div>
                                        </div>

                                        <div class="bg-white/60 p-3 rounded-xl border border-red-100 relative">
                                            <div class="text-[10px] text-gray-500 uppercase">Hotel / å®¿æ³Šãƒ›ãƒ†ãƒ«</div>
                                            <div class="font-bold text-gray-700">${medicalData.hotel}</div>
                                            <button onclick="showTaxiCard('${medicalData.hotel}')" class="absolute top-3 right-3 bg-blue-600 text-white text-xs px-2 py-1 rounded shadow"><i class="fas fa-taxi mr-1"></i>çµ¦å¸æ©Ÿçœ‹</button>
                                        </div>
                                        
                                        <div class="mt-4 p-3 bg-red-600 text-white rounded-xl text-center text-sm font-bold shadow-md">
                                            <i class="fas fa-hands-helping mr-1"></i> åŠ©ã‘ã¦ãã ã•ã„ (Please Help)
                                        </div>
                                    </div>
                                    `}
                                </div>

                                <div id="medical-edit" class="hidden space-y-3">
                                    <input id="in-name" type="text" placeholder="å­©å­æš±ç¨± (è‹±æ–‡/æ—¥æ–‡)" value="${medicalData.name}" class="w-full p-3 rounded-xl border border-gray-200 text-sm">
                                    <input id="in-phone" type="tel" placeholder="çˆ¸åª½è¯çµ¡é›»è©±" value="${medicalData.phone}" class="w-full p-3 rounded-xl border border-gray-200 text-sm">
                                    <input id="in-hotel" type="text" placeholder="ä½å®¿é£¯åº—åç¨±" value="${medicalData.hotel}" class="w-full p-3 rounded-xl border border-gray-200 text-sm">
                                    
                                    <div class="text-xs font-bold text-gray-500 mt-2 mb-1">éæ•æºå‹¾é¸ (è‡ªå‹•ç¿»æ—¥æ–‡)</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        ${Object.keys(allergyDict).map(k => `
                                            <label class="flex items-center gap-2 bg-white p-2 rounded-lg border border-gray-100">
                                                <input type="checkbox" class="allergy-chk" value="${k}" ${medicalData.allergies.includes(k) ? 'checked' : ''}>
                                                <span class="text-xs text-gray-600">${allergyDict[k].label}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                    
                                    <button onclick="saveMedical()" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl mt-2">å„²å­˜è³‡æ–™</button>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <h3 class="text-xs font-bold text-gray-400 uppercase ml-2 tracking-wider">ç·Šæ€¥é›»è©±</h3>
                            ${toolsDB.sos.map(s => `
                                <a href="tel:${s.tel}" class="${s.style} p-5 rounded-3xl shadow-lg flex items-center justify-between active:scale-95 transition-transform">
                                    <div>
                                        <div class="text-sm opacity-80 font-medium mb-1">${s.name}</div>
                                        <div class="text-3xl font-black tracking-tighter">${s.tel}</div>
                                    </div>
                                    <div class="w-12 h-12 rounded-full bg-white/20 backdrop-blur flex items-center justify-center">
                                        <i class="fas fa-phone text-xl"></i>
                                    </div>
                                </a>
                            `).join('')}
                        </div>
                    </div>`;
            } else if (currentToolFilter === 'sync') {
                 main.innerHTML = `
                    <div class="animate-slide-up space-y-6">
                        <div class="glass-card rounded-3xl p-6 border-l-4 border-purple-500">
                            <div class="text-xs font-bold text-purple-600 uppercase mb-2">æˆ‘æ˜¯èˆŠæ‰‹æ©Ÿ / å‚³é€ç«¯</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">å‚™ä»½è³‡æ–™</h3>
                            <p class="text-sm text-gray-500 mb-4">å°‡ç›®å‰çš„è¨˜å¸³ã€æ¸…å–®å‹¾é¸ç‹€æ…‹ç”¢ç”Ÿç‚ºä¸€ä¸²ä»£ç¢¼ï¼Œå‚³é€åˆ°å¦ä¸€å°æ‰‹æ©Ÿã€‚</p>
                            <button onclick="backupData()" class="w-full bg-purple-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.98] transition-transform">
                                <i class="fas fa-copy mr-2"></i> è¤‡è£½æœ¬æ©Ÿè³‡æ–™ä»£ç¢¼
                            </button>
                        </div>

                        <div class="glass-card rounded-3xl p-6 border-l-4 border-teal-500">
                            <div class="text-xs font-bold text-teal-600 uppercase mb-2">æˆ‘æ˜¯æ–°æ‰‹æ©Ÿ / æ¥æ”¶ç«¯</div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">é‚„åŸè³‡æ–™</h3>
                            <p class="text-sm text-gray-500 mb-4">è«‹è²¼ä¸Šå¦ä¸€å°æ‰‹æ©Ÿç”¢ç”Ÿçš„ä»£ç¢¼ã€‚âš ï¸ æ³¨æ„ï¼šç›®å‰çš„è³‡æ–™å°‡æœƒè¢«è¦†è“‹ã€‚</p>
                            
                            <textarea id="importDataInput" placeholder="åœ¨æ­¤è²¼ä¸Šå‚™ä»½ä»£ç¢¼..." class="w-full h-24 bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs mb-3 focus:outline-teal-500"></textarea>
                            
                            <button onclick="restoreData()" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.98] transition-transform">
                                <i class="fas fa-file-import mr-2"></i> è¼‰å…¥ä¸¦è¦†è“‹
                            </button>
                        </div>
                    </div>`;
            }
        }
    }

    // åˆ‡æ›æ¸…å–®
    window.switchChecklist = (id) => {
        currentChecklistFilter = id;
        renderContent(); 
        updateSubNavStyle(); 
    }

    // åˆ‡æ›å·¥å…·
    window.switchTool = (id) => {
        currentToolFilter = id;
        renderContent();
        updateSubNavStyle(); 
    }

    function updateSubNavStyle() {
        if (activeTab === 'checklist') {
            checklistDB.forEach(c => {
                const btn = document.getElementById(`btn-chk-${c.id}`);
                if (btn) {
                    if (currentChecklistFilter === c.id) {
                        btn.className = "flex-1 py-2 rounded-xl text-xs font-bold transition-all bg-white text-blue-600 shadow-sm";
                    } else {
                        btn.className = "flex-1 py-2 rounded-xl text-xs font-bold transition-all text-white/80";
                    }
                }
            });
        } else if (activeTab === 'tools') {
            const tools = ['calc', 'drive', 'jp', 'sos', 'sync'];
            tools.forEach(t => {
                const btn = document.getElementById(`btn-tool-${t}`);
                if (btn) {
                    let activeColor = "bg-white text-blue-600";
                    if(t === 'calc') activeColor = "bg-white text-yellow-600";
                    if(t === 'sos') activeColor = "bg-white text-red-600";
                    if(t === 'sync') activeColor = "bg-white text-purple-600";
                    
                    if (currentToolFilter === t) {
                        btn.className = `flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all ${activeColor} shadow-sm`;
                        let bg = bgImages.TOOL;
                        if(t === 'calc') bg = bgImages.CALC;
                        if(t === 'sync') bg = bgImages.SYNC;
                        if(t === 'sos') bg = bgImages.SOS;
                        document.getElementById('bg-layer').style.backgroundImage = `url('${bg}')`;
                    } else {
                        btn.className = "flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold whitespace-nowrap transition-all text-white/80";
                    }
                }
            });
        }
    }

    window.toggleCheck = (key) => {
        const val = localStorage.getItem(key);
        if (val === '1') localStorage.removeItem(key);
        else localStorage.setItem(key, '1');
        
        renderContent(); 
    }
    
    window.resetChecklist = (id) => {
        if(confirm('ç¢ºå®šè¦é‡ç½®é€™å€‹æ¸…å–®å—ï¼Ÿ')) {
            const len = checklistDB.find(c => c.id === id).items.length;
            for(let i=0; i<len; i++) localStorage.removeItem(`chk_${id}_${i}`);
            renderContent();
            showToast("å·²é‡ç½®æ¸…å–®");
        }
    }

    // Coin Sound
    function playCoinSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(987.77, ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(1318.51, ctx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
        osc.start();
        osc.stop(ctx.currentTime + 0.5);
    }

    // Gasha Sound
    function playGashaSound() {
         const ctx = new (window.AudioContext || window.webkitAudioContext)();
         // Simple noise/rattle effect
         const osc = ctx.createOscillator();
         const gain = ctx.createGain();
         osc.connect(gain);
         gain.connect(ctx.destination);
         osc.type = 'square';
         osc.frequency.setValueAtTime(100, ctx.currentTime);
         osc.frequency.linearRampToValueAtTime(800, ctx.currentTime + 0.2);
         gain.gain.setValueAtTime(0.1, ctx.currentTime);
         gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
         osc.start();
         osc.stop(ctx.currentTime + 0.3);
    }

    window.toggleMission = (id) => {
        const isDone = localStorage.getItem(id) === '1';
        if (isDone) {
            if(confirm('è¦å–æ¶ˆé€™å€‹æˆå°±å—ï¼Ÿ(ä»£å¹£æœƒæ¸›å°‘å–”)')) {
                localStorage.removeItem(id);
                renderContent();
            }
        } else {
            if(navigator.vibrate) navigator.vibrate(200);
            playCoinSound(); 
            localStorage.setItem(id, '1');
            showToast("ğŸ‰ ç²å¾—1æšä»£å¹£ï¼");
            renderContent();
        }
    }

    // ================= GASHA LOGIC v10.1 (No Negative Tokens) =================
    function getGashaBalance() {
        let completedMissions = 0;
        missionsDB.forEach(m => {
            if(localStorage.getItem(m.id) === '1') completedMissions++;
        });
        
        // Calculate balance
        let balance = completedMissions - gashaCoinsUsed;

        // Auto-correct if balance is negative (Child-friendly logic)
        if (balance < 0) {
            gashaCoinsUsed = completedMissions;
            localStorage.setItem('gasha_coins_used', gashaCoinsUsed);
            balance = 0;
        }

        return balance;
    }

    window.spinGasha = () => {
        const balance = getGashaBalance();
        if(balance <= 0) return;

        playGashaSound();
        const machine = document.getElementById('gasha-machine');
        machine.classList.add('animate-shake');
        
        // æ‰£é™¤ä»£å¹£
        gashaCoinsUsed++;
        localStorage.setItem('gasha_coins_used', gashaCoinsUsed);
        renderContent(); // Update UI to show decreased balance

        setTimeout(() => {
            machine.classList.remove('animate-shake');
            // Random Reward
            const reward = rewardsDB[Math.floor(Math.random() * rewardsDB.length)];
            
            document.getElementById('gasha-reward-icon').innerText = reward.icon;
            document.getElementById('gasha-reward-text').innerText = reward.text;
            document.getElementById('gasha-modal').classList.add('open');
            playCoinSound(); // Win sound
        }, 800);
    }

    window.closeGashaModal = () => {
        document.getElementById('gasha-modal').classList.remove('open');
    }

    // ================= OTHER LOGIC =================
    window.copyMapCode = (code) => {
        navigator.clipboard.writeText(code).then(() => {
            showToast("MapCode å·²è¤‡è£½");
        });
    }

    window.updateRate = (val) => {
        if(val && val > 0) {
            CURRENT_RATE = parseFloat(val);
            localStorage.setItem('user_rate', val); 
            convertCurrency(); 
            renderContent(); 
        }
    }

    window.convertCurrency = () => {
        const jpyInput = document.getElementById('jpyInput');
        const twdOutput = document.getElementById('twdOutput');
        const jpy = parseFloat(jpyInput.value);
        
        if (isNaN(jpy) || jpy <= 0) {
            twdOutput.innerText = "0";
            return;
        }

        const twd = jpy * CURRENT_RATE;
        twdOutput.innerText = twd.toFixed(twd % 1 !== 0 ? 2 : 0).toLocaleString('en-US');
    }

    // New: Budget Setting
    window.setBudget = () => {
        const newBudget = prompt("è«‹è¼¸å…¥ç¸½é ç®— (å°å¹£):", TOTAL_BUDGET);
        if(newBudget && !isNaN(newBudget)) {
            TOTAL_BUDGET = parseInt(newBudget);
            localStorage.setItem('trip_budget', TOTAL_BUDGET);
            renderContent();
        }
    }

    // æ­£å¸¸è¨˜å¸³
    window.addExpense = () => {
        const name = document.getElementById('exName').value;
        const price = document.getElementById('exPrice').value;
        const catEl = document.querySelector('input[name="cat"]:checked');
        const cat = catEl ? catEl.value : 'other';

        if(!name || !price) {
            showToast("è«‹è¼¸å…¥åç¨±å’Œé‡‘é¡");
            return;
        }

        expenses.unshift({ name: name, price: parseInt(price), cat: cat }); 
        localStorage.setItem('trip_expenses', JSON.stringify(expenses));
        
        showToast("å·²è¨˜å¸³");
        renderContent();
    }

    // å¿«é€Ÿè¨˜å¸³é‚è¼¯
    window.openQuickExpense = () => {
        document.getElementById('expense-modal').classList.add('open');
        setTimeout(() => document.getElementById('quickExPrice').focus(), 100);
    }

    window.closeQuickExpense = () => {
        document.getElementById('expense-modal').classList.remove('open');
        document.getElementById('quickExName').value = "";
        document.getElementById('quickExPrice').value = "";
    }

    window.saveQuickExpense = () => {
        const name = document.getElementById('quickExName').value;
        const price = document.getElementById('quickExPrice').value;
        const catEl = document.querySelector('input[name="quick-cat"]:checked');
        const cat = catEl ? catEl.value : 'shopping';

        if(!name || !price) {
            showToast("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
            return;
        }

        expenses.unshift({ name: name, price: parseInt(price), cat: cat }); 
        localStorage.setItem('trip_expenses', JSON.stringify(expenses));
        
        showToast("å¿«é€Ÿè¨˜å¸³æˆåŠŸï¼");
        
        // å¦‚æœå‰›å¥½åœ¨å·¥å…·é é¢ï¼Œæ›´æ–°UI
        if(activeTab === 'tools' && currentToolFilter === 'calc') {
            renderContent();
        }
        
        closeQuickExpense();
    }
    
    window.exportExpenses = () => {
        if(expenses.length === 0) {
            showToast("æ²’æœ‰å¸³å‹™å¯åŒ¯å‡º");
            return;
        }
        
        let total = 0;
        let text = "ğŸ¦• å¥å¥æ²–ç¹©æ•—å®¶æ˜ç´°ï¼š\n\n";
        expenses.forEach(e => {
            const catName = expenseCats[e.cat || 'other'].name;
            text += `[${catName}] ${e.name}: Â¥${e.price.toLocaleString()}\n`;
            total += e.price;
        });
        text += `\nğŸ’° ç¸½è¨ˆ: Â¥${total.toLocaleString()} (ç´„ NT$${Math.round(total * CURRENT_RATE).toLocaleString()})`;
        
        navigator.clipboard.writeText(text).then(() => {
            showToast("å¸³å‹™å·²è¤‡è£½ï¼");
        });
    }

    window.deleteExpense = (index) => {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
            expenses.splice(index, 1);
            localStorage.setItem('trip_expenses', JSON.stringify(expenses));
            renderContent();
        }
    }

    window.quickSearch = (query) => {
        // Universal Link for Google Maps (v10.1 Fix)
        const url = `https://maps.google.com/?q=${encodeURIComponent(query)}`;
        window.open(url, '_blank');
        showToast(`æ­£åœ¨æœå°‹...`);
    }

    // ================= SPEECH LOGIC =================
    window.speak = (text, btn) => {
        const originalContent = btn.innerHTML;
        btn.innerHTML = `<div class="playing-wave"><span></span><span></span><span></span></div>`;
        
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP'; 
            utterance.rate = 0.9; 
            
            utterance.onend = () => {
                btn.innerHTML = originalContent;
            };
            
            utterance.onerror = (e) => {
                console.error('Speech error', e);
                btn.innerHTML = originalContent;
                const url = `https://translate.google.com/?sl=ja&tl=zh-TW&text=${encodeURIComponent(text)}&op=translate`;
                window.open(url, '_blank');
            };

            window.speechSynthesis.speak(utterance);
        } else {
             btn.innerHTML = originalContent;
             const url = `https://translate.google.com/?sl=ja&tl=zh-TW&text=${encodeURIComponent(text)}&op=translate`;
             window.open(url, '_blank');
        }
    }

    // ================= MEDICAL ID & Taxi Card =================
    window.toggleEditMedical = () => {
        const view = document.getElementById('medical-view');
        const edit = document.getElementById('medical-edit');
        if(edit.classList.contains('hidden')) {
            view.classList.add('hidden');
            edit.classList.remove('hidden');
        } else {
            view.classList.remove('hidden');
            edit.classList.add('hidden');
        }
    }

    window.saveMedical = () => {
        const name = document.getElementById('in-name').value;
        const phone = document.getElementById('in-phone').value;
        const hotel = document.getElementById('in-hotel').value;
        const checkboxes = document.querySelectorAll('.allergy-chk:checked');
        const allergies = Array.from(checkboxes).map(c => c.value);

        medicalData = { name, phone, hotel, allergies };
        localStorage.setItem('medical_data', JSON.stringify(medicalData));
        
        toggleEditMedical();
        renderContent(); 
        showToast("å®‰å¿ƒè­·ç…§å·²æ›´æ–°");
    }

    window.showTaxiCard = (hotelName) => {
        if(!hotelName) {
            showToast("è«‹å…ˆç·¨è¼¯è¼¸å…¥é£¯åº—åç¨±");
            return;
        }
        document.getElementById('modal-hotel-name').innerText = hotelName;
        document.getElementById('modal-overlay').classList.add('open');
    }

    window.closeModal = () => {
        document.getElementById('modal-overlay').classList.remove('open');
    }

    // ================= PARKING LOGIC (v10.1 Fix Links) =================
    window.saveParking = () => {
        const note = prompt("è«‹è¼¸å…¥åœè»Šå‚™è¨» (å¦‚: 3F è—å€ A-12)", "B1 æŸ±å­æ—");
        if(note) {
            if (navigator.geolocation) {
                showToast("ğŸ“ æ­£åœ¨æŠ“å– GPS...");
                navigator.geolocation.getCurrentPosition((pos) => {
                    const now = new Date();
                    const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                    
                    parkingData = {
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude,
                        note: note,
                        time: timeStr
                    };
                    localStorage.setItem('parking_data', JSON.stringify(parkingData));
                    renderContent();
                    showToast("âœ… åœè»Šä½ç½®å·²è¨˜éŒ„ï¼");
                }, (err) => {
                    alert("ç„¡æ³•æŠ“å–ä½ç½®ï¼Œè«‹ç¢ºèª GPS å·²é–‹å•Ÿ");
                });
            } else {
                alert("ç€è¦½å™¨ä¸æ”¯æ´ GPS");
            }
        }
    }

    window.findCar = () => {
        if(parkingData) {
            // Fix for v10.1
            const url = `https://maps.google.com/?q=${parkingData.lat},${parkingData.lon}`;
            window.open(url, '_blank');
        }
    }

    window.clearParking = () => {
        if(confirm("ç¢ºå®šè¦æ¸…é™¤åœè»Šç´€éŒ„å—ï¼Ÿ")) {
            parkingData = null;
            localStorage.removeItem('parking_data');
            renderContent();
        }
    }

    // ================= BACKUP & RESTORE =================
    window.backupData = () => {
        const data = {};
        data.user_rate = localStorage.getItem('user_rate');
        data.trip_budget = localStorage.getItem('trip_budget');
        data.trip_expenses = localStorage.getItem('trip_expenses');
        data.medical_data = localStorage.getItem('medical_data');
        data.parking_data = localStorage.getItem('parking_data');
        // New: Backup Gasha progress
        data.gasha_coins_used = localStorage.getItem('gasha_coins_used');
        
        data.items = {};
        for(let i=0; i<localStorage.length; i++) {
            const k = localStorage.key(i);
            if(k.startsWith('chk_') || k.startsWith('m')) {
                data.items[k] = localStorage.getItem(k);
            }
        }
        
        try {
            const jsonStr = JSON.stringify(data);
            const encoded = btoa(encodeURIComponent(jsonStr)); 
            
            navigator.clipboard.writeText(encoded).then(() => {
                showToast("å‚™ä»½ç¢¼å·²è¤‡è£½ï¼è«‹å‚³çµ¦å¦ä¸€åŠ");
            });
        } catch (e) {
            alert("å‚™ä»½å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
            console.error(e);
        }
    }

    window.restoreData = () => {
        const input = document.getElementById('importDataInput');
        const code = input.value.trim();
        
        if(!code) {
            showToast("è«‹è²¼ä¸Šä»£ç¢¼");
            return;
        }
        
        if(!confirm("âš ï¸ ç¢ºå®šè¦è¼‰å…¥å—ï¼Ÿ\né€™å°‡æœƒè¦†è“‹æ‚¨æ‰‹æ©Ÿä¸Šç›®å‰çš„ï¼š\n- è¨˜å¸³ç´€éŒ„\n- æ¸…å–®å‹¾é¸ç‹€æ…‹\n- ä»»å‹™æˆå°±\n- å®‰å¿ƒè­·ç…§\n- æ‰­è›‹ç´€éŒ„")) {
            return;
        }
        
        try {
            const jsonStr = decodeURIComponent(atob(code));
            const data = JSON.parse(jsonStr);
            
            if(data.user_rate) localStorage.setItem('user_rate', data.user_rate);
            if(data.trip_budget) localStorage.setItem('trip_budget', data.trip_budget);
            if(data.trip_expenses) localStorage.setItem('trip_expenses', data.trip_expenses);
            if(data.medical_data) localStorage.setItem('medical_data', data.medical_data);
            if(data.parking_data) localStorage.setItem('parking_data', data.parking_data);
            // New: Restore Gasha
            if(data.gasha_coins_used) localStorage.setItem('gasha_coins_used', data.gasha_coins_used);
            
            if(data.items) {
                const keysToRemove = [];
                for(let i=0; i<localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if(k.startsWith('chk_') || k.startsWith('m')) keysToRemove.push(k);
                }
                keysToRemove.forEach(k => localStorage.removeItem(k));

                for (const k in data.items) {
                    localStorage.setItem(k, data.items[k]);
                }
            }
            
            alert("âœ… è³‡æ–™åŒæ­¥æˆåŠŸï¼ç¶²é å°‡é‡æ–°æ•´ç†ã€‚");
            location.reload();
            
        } catch (e) {
            alert("âŒ ä»£ç¢¼æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªæ˜¯å¦è¤‡è£½å®Œæ•´ã€‚");
            console.error(e);
        }
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        const m = document.getElementById('toast-msg');
        m.innerText = msg;
        t.className = "show";
        setTimeout(() => { t.className = ""; }, 3000);
    }

    init();
</script>
</body>
</html>
