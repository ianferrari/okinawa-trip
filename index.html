<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>å¥å¥å…¨å®¶æ²–ç¹©éŠ ğŸ¦• v17.0 Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* ================= åŸºç¤è¨­å®š ================= */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; -webkit-tap-highlight-color: transparent; transition: background-color 0.5s; overscroll-behavior-y: none; -webkit-overflow-scrolling: touch; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ================= è³ªæ„Ÿç‰¹æ•ˆ (Glassmorphism) ================= */
        .glass { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-dark { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); color: white; }
        .glass-card { background: rgba(255, 255, 255, 0.95); box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.6); }

        /* ================= æ¨¡å¼ç‰¹æ•ˆ ================= */
        body.rainy-mode #bg-layer { filter: grayscale(80%) brightness(0.6); }
        body.rainy-mode .glass-card { border-left: 4px solid #60a5fa !important; }
        .rain-badge { display: none; }
        body.rainy-mode .rain-badge { display: inline-block; }

        /* å¡ç‰‡æ¨£å¼ */
        .smart-card { background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%); border: 2px solid #3b82f6; box-shadow: 0 10px 40px -10px rgba(59, 130, 246, 0.4); }
        .safe-card { background: linear-gradient(135deg, #fff1f2 0%, #fff 100%); border-left: 5px solid #e11d48; }
        .parking-card { background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); border: 2px solid #22c55e; }

        /* ================= è¡Œç¨‹æ™‚é–“è»¸æ¨£å¼ (v17.3 ä¿®æ­£ç‰ˆ) ================= */
        /* 1. å¡ç‰‡å®¹å™¨ï¼šå¢åŠ åº•éƒ¨é–“è·ï¼Œçµ¦é€£æ¥ç·šå’Œè† å›Šç•™ä½å­ */
        .event-card-container {
            padding-bottom: 40px; /* é—œéµï¼é€™è£¡ç•™å‡ºç©ºé–“çµ¦ç§»å‹•æ™‚é–“è† å›Š */
            position: relative;
        }
        
        /* 2. é€£æ¥ç·š (è™›ç·š)ï¼šæ”¹ç”¨ bottom å®šä½ï¼Œç¢ºä¿å®ƒæ°¸é åœ¨å¡ç‰‡ä¸‹æ–¹ */
        .timeline-connector {
            position: absolute;
            left: 2.2rem; /* å°é½Šå·¦å´åœ–ç¤ºä¸­å¿ƒ */
            bottom: 0;    /* å›ºå®šåœ¨å®¹å™¨åº•éƒ¨ */
            height: 50px; /* é€£æ¥ç·šé•·åº¦ */
            width: 2px;
            border-left: 2px dashed #cbd5e1;
            z-index: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 3. ç‰¹ä¾‹ï¼šæœ€å¾Œä¸€å€‹è¡Œç¨‹ä¸éœ€è¦é€£æ¥ç·š */
        .event-card-container:last-child {
            padding-bottom: 20px;
        }
        .event-card-container:last-child .timeline-connector {
            display: none;
        }
        
        /* 4. ç§»å‹•æ™‚é–“è† å›Š (å°è—¥ä¸¸) */
        .travel-pill {
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            color: #64748b;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 99px;
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            /* è®“è† å›Šç½®ä¸­æ–¼è™›ç·šä¸Š */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* æ™¯é»è©³ç´° Modal */
        .spot-hero { height: 200px; background-size: cover; background-position: center; border-radius: 1.5rem 1.5rem 0 0; position: relative; }
        .spot-hero::after { content: ''; position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.7) 100%); border-radius: 1.5rem 1.5rem 0 0; }

        /* ================= ç¡¬å¹£æ¨£å¼ ================= */
        .coin-500 { background: radial-gradient(circle at 30% 30%, #fde047, #eab308); border: 2px solid #ca8a04; color: #713f12; }
        .coin-100 { background: radial-gradient(circle at 30% 30%, #f1f5f9, #cbd5e1); border: 2px solid #94a3b8; color: #475569; }
        .coin-50 { background: radial-gradient(circle at 30% 30%, #f1f5f9, #cbd5e1); border: 2px solid #94a3b8; color: #475569; position: relative; }
        .coin-50::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25%; height: 25%; background: #0f172a; border-radius: 50%; border: 1px solid #94a3b8; } 
        .coin-10 { background: radial-gradient(circle at 30% 30%, #fdba74, #ea580c); border: 2px solid #c2410c; color: #7c2d12; }
        .coin-5 { background: radial-gradient(circle at 30% 30%, #fde047, #ca8a04); border: 2px solid #b45309; color: #78350f; position: relative; }
        .coin-5::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25%; height: 25%; background: #0f172a; border-radius: 50%; border: 1px solid #b45309; }
        .coin-1 { background: radial-gradient(circle at 30% 30%, #e2e8f0, #94a3b8); border: 1px solid #64748b; color: #334155; }

        .order-card { background: white; border: 2px solid #e2e8f0; border-radius: 1rem; padding: 1rem; text-align: center; transition: all 0.2s; cursor: pointer; }
        .order-card:active { border-color: #3b82f6; background-color: #eff6ff; transform: scale(0.95); }

        /* ================= å‹•ç•« Keyframes ================= */
        @keyframes pulse-blue { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 50% { transform: rotate(0eg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        @keyframes wave { 0%, 100% { height: 40%; } 50% { height: 100%; } }
        @keyframes dinoWalk { 0% { transform: translateY(0) rotate(0deg); } 25% { transform: translateY(-3px) rotate(2deg); } 50% { transform: translateY(0) rotate(0deg); } 75% { transform: translateY(-3px) rotate(-2deg); } 100% { transform: translateY(0) rotate(0deg); } }

        .animate-slide-up { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-pop { animation: pop 0.4s ease-in-out; }
        .animate-shake { animation: shake 0.3s ease-in-out 3; }
        .animate-dino { animation: dinoWalk 0.6s infinite linear; }
        .pulse-dot { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); animation: pulse-blue 2s infinite; }

        .playing-wave { display: inline-flex; align-items: center; gap: 2px; height: 12px; }
        .playing-wave span { width: 3px; background: #713f12; animation: wave 0.8s infinite ease-in-out; border-radius: 2px; }
        .playing-wave span:nth-child(1) { height: 40%; animation-delay: 0s; }
        .playing-wave span:nth-child(2) { height: 100%; animation-delay: 0.1s; }
        .playing-wave span:nth-child(3) { height: 60%; animation-delay: 0.2s; }

        /* ================= ä»‹é¢å…ƒä»¶ ================= */
        .tab-active { background: #2563eb; color: white; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4); transform: scale(1.05); }
        .tab-inactive { background: rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255,255,255,0.1); }
        .custom-checkbox:checked + div { background-color: #2563eb; border-color: #2563eb; }
        
        #drawing-modal, #camera-modal, #ruler-modal { display: none; } 
        #drawing-modal.open, #camera-modal.open, #ruler-modal.open { display: flex; }
        
        canvas { touch-action: none; cursor: crosshair; }
        .color-btn.active { transform: scale(1.2); border: 2px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        
        #modal-overlay, #expense-modal, #gasha-modal, #reward-editor-modal, #gift-modal, #food-modal, #daily-check-modal, #spot-modal, #sos-card-modal { display: none; }
        #modal-overlay.open, #expense-modal.open, #gasha-modal.open, #reward-editor-modal.open, #gift-modal.open, #food-modal.open, #daily-check-modal.open, #spot-modal.open, #sos-card-modal.open { display: flex; }

        .pt-safe-top { padding-top: env(safe-area-inset-top); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        #toast { visibility: hidden; min-width: 200px; transform: translateX(-50%); background-color: rgba(30, 41, 59, 0.95); color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 999; left: 50%; bottom: 120px; font-size: 14px; backdrop-filter: blur(8px); box-shadow: 0 10px 40px rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        #toast.show { visibility: visible; opacity: 1; bottom: 130px; }

        #jpyInput, #twdOutput, #rateInput { font-weight: 900; }
        #rateInput { border-bottom: 2px dashed #ca8a04; color: #ca8a04; width: 100px; text-align: center; }
        .pie-chart { width: 140px; height: 140px; border-radius: 50%; position: relative; margin: 0 auto; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        .pie-chart::after { content: ""; position: absolute; width: 80px; height: 80px; background: white; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        .font-mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

        /* ================= v16.0 æ—¢æœ‰æ¨£å¼ (æ½®æ±/ç¿»è­¯/Wrapped/Geo) ================= */
        .tide-widget { background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 1.5rem; overflow: hidden; position: relative; min-height: 120px; }
        .wave-box { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; overflow: hidden; }
        .wave { position: absolute; bottom: 0; left: 0; width: 200%; height: 100%; background: url('data:image/svg+xml;utf8,<svg viewBox="0 0 1440 320" xmlns="http://www.w3.org/2000/svg"><path fill="rgba(255,255,255,0.3)" d="M0,192L48,197.3C96,203,192,213,288,229.3C384,245,480,267,576,250.7C672,235,768,181,864,181.3C960,181,1056,235,1152,234.7C1248,235,1344,181,1392,154.7L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>'); background-size: 50% 100%; animation: waveMove 10s linear infinite; }
        .wave:nth-child(2) { bottom: 5px; opacity: 0.5; animation: waveMove 7s linear infinite reverse; }
        @keyframes waveMove { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

        .mic-btn { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #f87171, #ef4444); box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4); display: flex; align-items: center; justify-content: center; font-size: 2rem; color: white; transition: all 0.3s; border: 4px solid rgba(255,255,255,0.2); }
        .mic-btn.listening { animation: pulse-red 1.5s infinite; background: #ef4444; transform: scale(1.1); }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        #wrapped-modal { background: #000; color: #fff; z-index: 300; }
        .wrapped-slide { height: 100%; display: flex; flex-col; align-items: center; justify-content: center; text-align: center; padding: 20px; opacity: 0; transition: opacity 0.5s; position: absolute; inset: 0; pointer-events: none; }
        .wrapped-slide.active { opacity: 1; pointer-events: auto; }
        .neon-text { text-shadow: 0 0 10px rgba(255,255,255,0.5), 0 0 20px rgba(255,255,255,0.3); }
        .stat-big { font-size: 4rem; font-weight: 900; line-height: 1; background: -webkit-linear-gradient(45deg, #FFD700, #FF8C00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        #geo-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 999; display: flex; align-items: center; gap: 15px; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); border: 2px solid #fbbf24; width: 90%; max-width: 350px; }
        #geo-toast.show { transform: translateX(-50%) translateY(0); }

        /* ================= v17.0 æ–°å¢æ¨£å¼ ================= */
        /* 1. éš¨èº«å°ºè¦ (Ruler) */
        .ruler-container { background: #fff; overflow-x: auto; overflow-y: hidden; white-space: nowrap; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); border-radius: 8px; border: 1px solid #e2e8f0; height: 100px; display: flex; align-items: flex-end; padding-left: 20px; padding-right: 20px; }
        .ruler-tick { width: 1px; background: #334155; display: inline-block; margin-right: 0; position: relative; flex-shrink: 0; }
        .ruler-tick.major { height: 40px; background: #0f172a; width: 2px; }
        .ruler-tick.minor { height: 20px; opacity: 0.6; }
        .ruler-tick.medium { height: 30px; opacity: 0.8; }
        .ruler-num { position: absolute; top: -25px; left: -10px; width: 20px; text-align: center; font-size: 12px; font-weight: bold; color: #0f172a; }

        /* 2. å°æé¾é€²åº¦æ¢ (Kids GPS) */
        .dino-progress-container { position: relative; height: 36px; background: rgba(255,255,255,0.2); border-radius: 18px; border: 1px solid rgba(255,255,255,0.3); margin-top: 5px; overflow: visible; }
        .dino-track { position: absolute; top: 50%; left: 10px; right: 10px; height: 4px; background: rgba(255,255,255,0.3); transform: translateY(-50%); border-radius: 2px; }
        .dino-fill { position: absolute; top: 0; left: 0; height: 100%; background: #fbbf24; border-radius: 2px; width: 0%; transition: width 0.5s; box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        .dino-icon { position: absolute; top: 50%; left: 0%; width: 32px; height: 32px; transform: translate(-50%, -50%); transition: left 0.5s; z-index: 10; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .dino-flag { position: absolute; top: 50%; right: 0; transform: translate(50%, -80%); font-size: 16px; z-index: 5; }

        /* 3. æµ®æ°´å°ç›¸æ©Ÿ (Memory Cam) */
        #camera-video { width: 100%; height: 100%; object-fit: cover; }
        .cam-viewport { position: relative; overflow: hidden; background: #000; border-radius: 1.5rem; aspect-ratio: 3/4; width: 100%; }
        .cam-overlay-text { position: absolute; bottom: 20px; right: 20px; text-align: right; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8); z-index: 10; pointer-events: none; }
        .cam-date { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1rem; color: #fbbf24; letter-spacing: 1px; }
        .cam-loc { font-size: 0.8rem; font-weight: 500; opacity: 0.9; }
        .cam-weather { font-size: 0.8rem; font-weight: 500; opacity: 0.9; }
        .cam-badge { position: absolute; top: 20px; left: 20px; background: #ef4444; color: white; padding: 2px 8px; font-size: 10px; font-weight: bold; transform: rotate(-5deg); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* 4. ç¾é£ŸæŒ‡æŒ‡é€š (Food Board) */
        .food-grid-item { position: relative; border-radius: 1rem; overflow: hidden; aspect-ratio: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.1s; }
        .food-grid-item:active { transform: scale(0.95); }
        .food-grid-img { width: 100%; height: 100%; object-fit: cover; }
        .food-grid-label { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); padding: 20px 8px 8px; color: white; font-size: 12px; font-weight: bold; text-align: center; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 overflow-hidden relative">
    <div id="bg-layer" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-700 transform scale-105" 
         style="background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=1000&fit=crop');">
        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/10 to-slate-100/90"></div>
    </div>

    <div class="z-10 pt-safe-top px-5 pb-2 flex-shrink-0">
        <div class="flex justify-between items-start pt-6 mb-2 text-white">
            <div class="flex-1 mr-2">
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-blue-600 px-2 py-0.5 rounded-md text-[10px] font-bold tracking-wider uppercase shadow-lg border border-blue-400/30">2026 TRIP</span>
                    <div id="countdown" class="text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10">è¨ˆç®—ä¸­...</div>
                </div>
                
                <h1 class="text-3xl font-black tracking-tight drop-shadow-lg leading-tight">å¥å¥å…¨å®¶<br>æ²–ç¹©éŠ ğŸ¦•</h1>

                <p id="date-info" class="text-sm opacity-95 font-medium mt-2 text-blue-100 drop-shadow-md"><i class="fas fa-calendar-alt mr-1"></i>3/28 (å…­) - 4/3 (äº”)</p>
            </div>
            
            <div class="flex gap-2 flex-col items-end">
                <div class="flex gap-2">
                    <button onclick="toggleRainMode()" id="rain-btn" class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-white/20">
                        <i id="rain-icon" class="fas fa-sun text-xl mb-1 block text-yellow-400"></i>
                        <span id="rain-text" class="text-[9px] font-bold opacity-90">æ™´å¤©</span>
                    </button>

                    <div class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[70px] active:scale-95 transition-transform cursor-pointer" onclick="initWeather()">
                        <i id="weather-icon" class="fas fa-spinner fa-spin text-xl mb-1 block text-blue-300"></i>
                        <span id="weather-temp" class="text-sm font-bold">...</span>
                        <div id="weather-loc" class="text-[9px] opacity-70 mt-0.5">é‡æ•´</div>
                    </div>
                </div>
                <button onclick="toggleVoiceMemo()" class="glass-dark w-10 h-10 rounded-full flex items-center justify-center active:bg-pink-500 transition-colors border border-white/20">
                     <i class="fas fa-microphone text-white"></i>
                </button>
            </div>
        </div>

        <div id="sub-nav-container" class="mt-2 min-h-[44px]"></div>
    </div>
    
    <div id="main-scroll" class="flex-1 overflow-y-auto p-4 pb-32 z-10 scroll-smooth rounded-t-[2.5rem] bg-slate-50 shadow-[0_-10px_40px_rgba(0,0,0,0.15)] relative top-2">
        </div>
    <div class="fixed bottom-0 w-full glass flex justify-around items-center pb-safe-bottom h-[85px] z-50 rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-itinerary">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-map-location-dot text-xl text-blue-600"></i></div>
            <span class="text-[10px] font-bold text-blue-600">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('checklist')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-checklist">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-clipboard-list text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('missions')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-missions">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-medal text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æˆå°±</span>
        </button>
        <button onclick="switchTab('tools')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-tools">
            <div class="icon-box p-2 rounded-2xl mb-1 transition-all duration-300 group-active:scale-90"><i class="fas fa-toolbox text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">å·¥å…·</span>
        </button>
    </div>

    <button onclick="openQuickExpense()" class="fixed bottom-[100px] right-4 w-14 h-14 bg-pink-500 rounded-full text-white shadow-2xl flex items-center justify-center z-40 active:scale-90 transition-transform border-4 border-white/20 backdrop-blur group">
        <i class="fas fa-plus text-2xl group-active:rotate-90 transition-transform"></i>
    </button>

    <div id="camera-modal" class="fixed inset-0 z-[200] bg-black flex flex-col hidden">
        <div class="flex justify-between items-center p-4 z-20 absolute top-0 w-full pt-safe-top">
            <button onclick="toggleCameraFacing()" class="text-white bg-black/30 w-10 h-10 rounded-full backdrop-blur flex items-center justify-center"><i class="fas fa-sync-alt"></i></button>
            <button onclick="closeCamera()" class="text-white bg-black/30 w-10 h-10 rounded-full backdrop-blur flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="flex-1 flex items-center justify-center bg-black relative">
            <div class="cam-viewport relative">
                <video id="camera-video" autoplay playsinline muted></video>
                <canvas id="camera-canvas" class="hidden"></canvas>
                <div id="cam-overlay" class="absolute inset-0 pointer-events-none hidden">
                    <div class="cam-badge">DAY <span id="cam-day-val">1</span></div>
                    <div class="cam-overlay-text">
                        <div class="cam-date" id="cam-date-val">2026/03/28</div>
                        <div class="cam-loc"><i class="fas fa-map-marker-alt mr-1 text-red-400"></i><span id="cam-loc-val">Okinawa</span></div>
                        <div class="cam-weather"><i class="fas fa-sun mr-1 text-yellow-400"></i><span id="cam-weather-val">24Â°C</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="h-32 bg-black flex items-center justify-center pb-safe-bottom gap-8">
            <button onclick="openGallery()" class="text-white opacity-50 flex flex-col items-center"><i class="fas fa-images text-2xl mb-1"></i><span class="text-[10px]">ç›¸ç°¿</span></button>
            <button onclick="takePhoto()" class="w-16 h-16 rounded-full bg-white border-4 border-gray-300 active:scale-90 transition-transform shadow-[0_0_20px_rgba(255,255,255,0.5)]"></button>
            <div class="w-8"></div> </div>
    </div>

    <div id="ruler-modal" class="fixed inset-0 z-[150] bg-white flex flex-col hidden animate-slide-up">
        <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-slate-50">
            <h3 class="font-black text-xl text-gray-800"><i class="fas fa-ruler-combined text-blue-500 mr-2"></i>éš¨èº«é‡é‡çœ‹</h3>
            <button onclick="closeRuler()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
        
        <div class="flex-1 flex flex-col items-center justify-center p-4 bg-slate-50 relative overflow-hidden">
            <div class="text-center mb-8">
                <div class="text-6xl font-black text-blue-600 mb-2 font-mono" id="ruler-display-val">0.0</div>
                <div class="text-sm text-gray-400 font-bold">cm</div>
            </div>
            
            <div id="ruler-scroll-area" class="w-full overflow-x-auto hide-scrollbar touch-pan-x bg-white border-y-2 border-blue-200 h-32 relative flex items-end pt-5 shadow-inner">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-0.5 h-full bg-red-500 z-10 opacity-70"></div>
                <div id="ruler-ticks" class="flex items-end pl-[50vw] pr-[50vw]">
                    </div>
            </div>
            <p class="text-xs text-gray-400 mt-4"><i class="fas fa-hand-pointer mr-1"></i> å·¦å³æ»‘å‹•åˆ»åº¦ä¾†æ¸¬é‡</p>
        </div>

        <div class="p-4 bg-white border-t border-gray-100 pb-safe-bottom">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-gray-500">æ ¡æ­£ (èª¿æ•´æ¯”ä¾‹)</span>
                <button onclick="resetRulerScale()" class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500">é‡ç½®</button>
            </div>
            <input type="range" id="ruler-scale" min="0.5" max="2.0" step="0.01" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateRulerScale(this.value)">
            <div class="text-[10px] text-gray-400 mt-1 text-center">å¦‚æœä¸æº–ï¼Œè«‹æ‹¿ä¿¡ç”¨å¡æˆ–ç¡¬å¹£å°ç…§åˆ»åº¦èª¿æ•´</div>
        </div>
    </div>

    <div id="spot-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6 hidden" onclick="closeSpotModal()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl shadow-2xl relative h-[80vh] flex flex-col animate-slide-up" onclick="event.stopPropagation()">
            <button onclick="closeSpotModal()" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/30 text-white backdrop-blur flex items-center justify-center"><i class="fas fa-times"></i></button>
            <div id="spot-hero" class="spot-hero flex-shrink-0">
                <div class="absolute bottom-4 left-4 text-white z-10">
                    <h3 id="spot-title" class="text-2xl font-black drop-shadow-md">æ™¯é»åç¨±</h3>
                    <div id="spot-tags" class="flex gap-2 mt-2"></div>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1 pb-safe-bottom">
                <div id="spot-desc" class="text-gray-600 leading-relaxed mb-6 text-sm"></div>
                <div class="bg-blue-50 rounded-xl p-4 mb-4 border border-blue-100">
                    <div class="text-xs font-bold text-blue-500 uppercase mb-2"><i class="fas fa-lightbulb mr-1"></i> å¥å¥çˆ¸ç­†è¨˜ (Tips)</div>
                    <div id="spot-tips" class="text-sm font-bold text-gray-800"></div>
                </div>
                <a id="spot-nav-btn" href="#" target="_blank" class="block w-full bg-blue-600 text-white text-center font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform"><i class="fas fa-location-arrow mr-2"></i> å°èˆªå»é€™è£¡</a>
            </div>
        </div>
    </div>

    <div id="sos-card-modal" class="fixed inset-0 z-[200] bg-red-600 flex flex-col items-center justify-center p-6 text-white hidden text-center">
        <button onclick="closeSosCard()" class="absolute top-6 right-6 text-white/70 text-4xl"><i class="fas fa-times-circle"></i></button>
        <div class="mb-8 animate-pulse"><i class="fas fa-exclamation-triangle text-6xl text-yellow-300"></i></div>
        <div class="text-xl font-bold mb-2 opacity-80">æˆ‘æ˜¯å°ç£äººï¼Œè«‹å¹«åŠ©æˆ‘</div>
        <h2 id="sos-jp-text" class="text-4xl sm:text-5xl font-black leading-tight mb-4 bg-white text-red-600 p-4 rounded-xl shadow-xl w-full">åŠ©ã‘ã¦ãã ã•ã„</h2>
        <p id="sos-sub-text" class="text-lg font-bold opacity-90">Please help me.</p>
        
        <div class="grid grid-cols-2 gap-4 w-full mt-10">
            <button onclick="setSosMsg('sick')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40">å°å­©ç”Ÿç—…<br>å­ä¾›ãŒç—…æ°—</button>
            <button onclick="setSosMsg('lost')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40">è¿·è·¯äº†<br>è¿·å­ã§ã™</button>
            <button onclick="setSosMsg('police')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40">å ±è­¦<br>è­¦å¯Ÿã‚’å‘¼ã‚“ã§</button>
            <button onclick="setSosMsg('ambulance')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40">å«æ•‘è­·è»Š<br>æ•‘æ€¥è»Šï¼</button>
        </div>
    </div>
    <div id="drawing-modal" class="fixed inset-0 z-[200] bg-white flex flex-col hidden">
        <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-white z-10">
            <h3 class="font-black text-xl text-gray-800"><i class="fas fa-palette text-purple-500 mr-2"></i>å°å°ç•«å®¶</h3>
            <button onclick="closeDrawing()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 relative bg-slate-50 overflow-hidden" id="canvas-container">
            <canvas id="drawing-canvas" class="w-full h-full touch-none"></canvas>
        </div>
        <div class="p-4 bg-white border-t border-gray-100 pb-safe-bottom">
            <div class="flex justify-between items-center gap-2">
                <div class="flex gap-2">
                    <button class="color-btn w-8 h-8 rounded-full bg-black ring-2 ring-offset-2 ring-transparent active" onclick="setColor('black', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-red-500 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#ef4444', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#3b82f6', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-green-500 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#22c55e', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-yellow-400 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#facc15', this)"></button>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearCanvas()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                    <button onclick="saveDrawing()" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg"><i class="fas fa-save"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="gift-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden" onclick="closeGiftModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-5 shadow-2xl relative h-[70vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 class="text-lg font-black text-gray-800"><i class="fas fa-gift text-red-500 mr-2"></i>ä¼´æ‰‹ç¦®æ¸…å–®</h3>
                <button onclick="closeGiftModal()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="gift-list-container" class="flex-1 overflow-y-auto space-y-2 mb-4 hide-scrollbar"></div>
            <div class="border-t pt-4 space-y-3">
                <input id="gift-who" type="text" placeholder="å°è±¡ (å¦‚: é˜¿å¬¤)" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500 font-bold">
                <input id="gift-what" type="text" placeholder="è¦è²·ä»€éº¼?" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500">
                <div class="flex gap-2">
                    <input id="gift-budget" type="number" placeholder="é ç®—(Â¥)" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500">
                    <button onclick="addGift()" class="bg-red-500 text-white font-bold px-6 py-2 rounded-xl shadow-lg active:scale-95 whitespace-nowrap"><i class="fas fa-plus mr-1"></i> æ–°å¢</button>
                </div>
            </div>
        </div>
    </div>

    <div id="expense-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6" onclick="closeQuickExpense()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl relative animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-gray-800"><i class="fas fa-bolt text-yellow-400 mr-2"></i>å¿«é€Ÿè¨˜å¸³</h3>
                <button onclick="closeQuickExpense()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="shopping" class="peer sr-only" checked><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-bag-shopping"></i> è³¼ç‰©</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="food" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-utensils"></i> é¤é£²</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="play" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-purple-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-ticket"></i> å¨›æ¨‚</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="transport" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-car"></i> äº¤é€š</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="other" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-slate-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-box"></i> å…¶ä»–</div></label>
                </div>
                <input id="quickExName" type="text" placeholder="å“é …åç¨± (å¦‚: å†°æ·‡æ·‹)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-pink-500">
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                    <input id="quickExPrice" type="number" placeholder="é‡‘é¡ (æ—¥å¹£)" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-8 pr-4 py-3 text-xl font-black text-gray-800 focus:outline-pink-500">
                </div>
                <button onclick="saveQuickExpense()" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-transform text-lg mt-2"><i class="fas fa-check mr-2"></i> å„²å­˜é€™ç­†</button>
            </div>
        </div>
    </div>

    <div id="gasha-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col hidden" onclick="closeGashaModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative animate-pop" onclick="event.stopPropagation()">
            <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-yellow-400 w-20 h-20 rounded-full flex items-center justify-center text-4xl shadow-lg border-4 border-white">ğŸ‰</div>
            <div class="mt-8">
                <div class="text-sm font-bold text-gray-400 mb-1 uppercase tracking-widest">Congratulations!</div>
                <div class="text-2xl font-black text-gray-900 mb-4">æ­å–œç²å¾—çå‹µ</div>
                <div class="bg-yellow-50 rounded-2xl p-6 border-2 border-yellow-200 mb-6">
                    <div id="gasha-reward-icon" class="text-6xl mb-3 block"></div>
                    <div id="gasha-reward-text" class="text-xl font-bold text-yellow-700"></div>
                </div>
                <button onclick="closeGashaModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold w-full shadow-lg active:scale-95 transition-transform">å¤ªæ£’äº†ï¼æ”¶ä¸‹</button>
            </div>
        </div>
    </div>

    <div id="food-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-6 hidden" onclick="document.getElementById('food-modal').classList.remove('open')">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-black text-gray-800 mb-2">ä»Šå¤©åƒä»€éº¼ï¼ŸğŸ˜‹</h3>
            <p class="text-xs text-gray-400 mb-6">ä¸çŸ¥é“åƒä»€éº¼çš„æ™‚å€™ï¼Œè®“å‘½é‹æ±ºå®šï¼</p>
            <div class="bg-orange-50 rounded-full w-48 h-48 mx-auto flex flex-col items-center justify-center border-4 border-orange-200 mb-8 relative overflow-hidden shadow-inner">
                <div id="food-result" class="text-7xl mb-2 z-10">â“</div>
                <div id="food-text" class="text-lg font-bold text-orange-800 z-10">é»æ“ŠæŒ‰éˆ•</div>
                <div class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-white/40 to-transparent"></div>
            </div>
            <button onclick="spinFood()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform text-lg"><i class="fas fa-dice mr-2"></i> å¹«æˆ‘é¸ï¼</button>
        </div>
    </div>

    <div id="daily-check-modal" class="fixed inset-0 z-[150] bg-blue-900/90 backdrop-blur-md flex items-center justify-center p-6 hidden">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl relative animate-slide-up">
            <div class="text-center mb-6">
                <div class="inline-block p-3 rounded-full bg-blue-100 text-blue-600 text-3xl mb-3"><i class="fas fa-door-open"></i></div>
                <h3 class="text-2xl font-black text-gray-800">å‡ºé–€å‰æª¢æŸ¥ï¼</h3>
                <p class="text-sm text-gray-500">ç¢ºèªæ²’å¿˜è¨˜é€™äº›æ±è¥¿å†å‡ºç™¼</p>
            </div>
            <div class="space-y-3 mb-6">
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100 active:bg-blue-50 transition-colors">
                    <input type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="checkDailyItem(this)">
                    <span class="font-bold text-gray-700">ğŸ”‘ æˆ¿å¡é‚„äº†å—ï¼Ÿ</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100 active:bg-blue-50 transition-colors">
                    <input type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="checkDailyItem(this)">
                    <span class="font-bold text-gray-700">ğŸ’§ æ°´å£ºè£æ»¿äº†å—ï¼Ÿ</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100 active:bg-blue-50 transition-colors">
                    <input type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="checkDailyItem(this)">
                    <span class="font-bold text-gray-700">ğŸ¼ å°¿å¸ƒ/å¥¶ç²‰å¸¶å¤ å—ï¼Ÿ</span>
                </label>
                <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100 active:bg-blue-50 transition-colors">
                    <input type="checkbox" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500" onchange="checkDailyItem(this)">
                    <span class="font-bold text-gray-700">ğŸ“± Wifiæ©Ÿ/æ‰‹æ©Ÿï¼Ÿ</span>
                </label>
            </div>
            <button id="daily-check-btn" onclick="finishDailyCheck()" disabled class="w-full bg-gray-300 text-white font-bold py-3 rounded-xl transition-all"><i class="fas fa-check mr-2"></i> éƒ½å¸¶äº†ï¼Œå‡ºç™¼ï¼</button>
        </div>
    </div>

    <div id="reward-editor-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden" onclick="closeRewardEditor()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-5 shadow-2xl relative h-[70vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 class="text-lg font-black text-gray-800"><i class="fas fa-gift text-pink-500 mr-2"></i>è¨­å®šæ‰­è›‹çå“</h3>
                <button onclick="closeRewardEditor()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="reward-list" class="flex-1 overflow-y-auto space-y-2 mb-4 hide-scrollbar"></div>
            <div class="border-t pt-4">
                <div class="flex gap-2 mb-2">
                    <select id="new-reward-icon" class="bg-gray-50 border border-gray-200 rounded-xl px-2 text-xl">
                        <option value="ğŸ¬">ğŸ¬</option><option value="ğŸ“º">ğŸ“º</option><option value="ğŸ¦">ğŸ¦</option>
                        <option value="ğŸ§¸">ğŸ§¸</option><option value="ğŸ¹">ğŸ¹</option><option value="ğŸ§â€â™‚ï¸">ğŸ§â€â™‚ï¸</option>
                        <option value="ğŸ¥š">ğŸ¥š</option><option value="ğŸš—">ğŸš—</option>
                    </select>
                    <input id="new-reward-text" type="text" placeholder="è¼¸å…¥æ–°çå“" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-3 py-2 text-sm">
                </div>
                <button onclick="addReward()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow active:scale-[0.98]"><i class="fas fa-plus mr-1"></i> æ–°å¢çé …</button>
                <button onclick="resetRewards()" class="w-full mt-2 text-xs text-gray-400 py-2">æ¢å¾©é è¨­å€¼</button>
            </div>
        </div>
    </div>
    
    <div id="modal-overlay" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col hidden" onclick="closeModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800"><i class="fas fa-times text-2xl"></i></button>
            <div id="modal-tag" class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-widest">çµ¦å¸æ©Ÿçœ‹ (For Driver)</div>
            <div id="modal-title" class="text-2xl font-black text-gray-900 mb-6 border-b pb-4">ã“ã®ãƒ›ãƒ†ãƒ«ã¾ã§<br>ãŠé¡˜ã„ã—ã¾ã™</div>
            <div id="modal-content" class="text-xl font-bold text-blue-700 mb-2"></div>
            <div id="modal-note" class="text-xs text-gray-400">è«‹å¸¶æˆ‘å»é€™å®¶é£¯åº—</div>
            <div class="mt-8"><button onclick="closeModal()" class="bg-gray-100 text-gray-600 px-6 py-3 rounded-xl font-bold w-full">é—œé–‰</button></div>
        </div>
    </div>

    <div id="driver-hud" class="fixed inset-0 bg-black z-[200] hidden flex-col p-6 text-white font-mono transition-opacity duration-300">
        <div class="flex justify-between items-center mb-4">
            <div class="flex flex-col">
                <span class="text-xs text-gray-500 uppercase tracking-widest">TIME</span>
                <span id="hud-clock" class="text-2xl font-bold text-gray-300">12:30</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleRoadType()" id="btn-road-type" class="px-4 py-2 rounded-lg border border-blue-900 bg-blue-900/20 text-blue-400 text-sm font-bold active:bg-blue-800 transition-colors">ä¸€èˆ¬é“è·¯ (50)</button>
                <button onclick="closeDriverMode()" class="w-10 h-10 rounded-full bg-red-900/30 text-red-500 border border-red-900/50 flex items-center justify-center active:scale-95"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <div class="flex flex-col items-center text-center relative mb-4">
            <div class="w-full">
                <h1 id="hud-title" class="text-3xl font-black text-white leading-tight drop-shadow-md truncate px-2">è¼‰å…¥ä¸­...</h1>
                
                <div class="my-4 w-full bg-gray-900 rounded-xl border border-gray-800 p-3 relative group active:bg-gray-800 transition-colors cursor-pointer" onclick="copyHudMapCode()">
                    <div class="text-[9px] text-gray-500 tracking-[0.2em] mb-1">MAPCODE</div>
                    <div id="hud-mapcode" class="text-4xl font-black text-yellow-400 tracking-wider font-mono">--- ---</div>
                </div>

                <a id="hud-nav-btn" href="#" target="_blank" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xl font-black py-4 rounded-xl shadow-[0_0_20px_rgba(37,99,235,0.3)] active:scale-[0.98] transition-all flex items-center justify-center gap-3"><i class="fas fa-location-arrow animate-pulse"></i><span>GO å°èˆª</span></a>
            </div>
        </div>

        <div class="flex-1 flex flex-col justify-center items-center relative">
            <div class="text-xs text-gray-600 font-bold uppercase tracking-[0.5em] mb-2">SPEED (GPS)</div>
            
            <div class="flex items-baseline justify-center gap-2 relative">
                <span id="hud-speed" class="text-[9rem] font-black text-white leading-none tracking-tighter transition-all duration-200 drop-shadow-2xl">0</span>
                <span class="text-xl text-gray-500 font-bold absolute -right-12 bottom-8">km/h</span>
            </div>

            <div id="speed-warning" class="opacity-0 transition-opacity duration-300 text-red-500 font-black text-lg mt-2 tracking-widest bg-red-900/30 px-3 py-1 rounded animate-pulse">
                âš ï¸ SLOW DOWN
            </div>
        </div>

        <div class="absolute bottom-8 right-6 flex gap-4">
             <button onclick="changeHudEvent(-1)" class="w-16 h-16 rounded-2xl border border-gray-800 bg-gray-900/80 text-gray-500 flex items-center justify-center active:bg-gray-800 backdrop-blur"><i class="fas fa-chevron-left text-xl"></i></button>
            <button onclick="changeHudEvent(1)" class="w-16 h-16 rounded-2xl border border-gray-700 bg-gray-800/80 text-white flex items-center justify-center active:bg-gray-700 shadow-lg shadow-white/5 backdrop-blur"><i class="fas fa-chevron-right text-xl"></i></button>
        </div>
    </div>

    <div id="geo-toast">
        <div class="w-10 h-10 rounded-full bg-yellow-400 flex items-center justify-center text-xl text-yellow-900 animate-bounce">
            <i class="fas fa-map-marker-alt"></i>
        </div>
        <div>
            <div class="text-[10px] font-bold text-gray-400 uppercase">MISSION UNLOCKED</div>
            <div id="geo-msg" class="font-bold text-gray-800 text-sm">æŠµé”ç›®çš„åœ°ï¼</div>
        </div>
    </div>

    <div id="wrapped-modal" class="fixed inset-0 hidden flex-col">
        <button onclick="closeWrapped()" class="absolute top-6 right-6 z-50 text-white/50 hover:text-white text-2xl"><i class="fas fa-times"></i></button>
        
        <div class="wrapped-slide active" id="wrap-1">
            <div class="text-6xl mb-4 animate-bounce">ğŸ¦–</div>
            <h2 class="text-3xl font-black mb-2 neon-text">æ—…ç¨‹å›é¡§</h2>
            <p class="text-gray-400">å¥å¥å…¨å®¶æ²–ç¹©éŠ 2026</p>
            <p class="mt-8 text-sm animate-pulse">é»æ“Šè¢å¹•ç¹¼çºŒ...</p>
        </div>
        
        <div class="wrapped-slide" id="wrap-2">
            <div class="text-xs font-bold text-blue-400 uppercase mb-4 tracking-widest">MOVEMENT</div>
            <h3 class="text-2xl font-bold mb-2">é€™å¹¾å¤©æˆ‘å€‘èµ°äº†</h3>
            <div class="stat-big mb-2" id="wrap-steps">0</div>
            <p class="text-xl">æ­¥</p>
            <div class="mt-6 text-gray-400 text-sm">ç›¸ç•¶æ–¼ç¹äº†åœ‹éš›é€š <span id="wrap-koku">0</span> åœˆï¼</div>
        </div>

        <div class="wrapped-slide" id="wrap-3">
            <div class="text-xs font-bold text-green-400 uppercase mb-4 tracking-widest">MONEY SPENT</div>
            <h3 class="text-2xl font-bold mb-2">çˆ¸çˆ¸çš„éŒ¢åŒ…ç˜¦äº†</h3>
            <div class="stat-big mb-2" id="wrap-money">Â¥0</div>
            <div class="mt-4 p-4 bg-white/10 rounded-xl w-full max-w-xs text-left">
                <div class="flex justify-between mb-2"><span>ğŸ›ï¸ è³¼ç‰©</span><span class="font-bold" id="wrap-shop">Â¥0</span></div>
                <div class="flex justify-between"><span>ğŸ½ï¸ åƒé£¯</span><span class="font-bold" id="wrap-food">Â¥0</span></div>
            </div>
        </div>

        <div class="wrapped-slide" id="wrap-4">
            <div class="text-xs font-bold text-pink-400 uppercase mb-4 tracking-widest">FUN & JOY</div>
            <h3 class="text-2xl font-bold mb-2">å¥å¥è½‰äº†</h3>
            <div class="stat-big mb-2 text-pink-500" id="wrap-gasha">0</div>
            <p class="text-xl">æ¬¡æ‰­è›‹</p>
            <div class="mt-8 text-yellow-400 font-bold text-lg border border-yellow-400/50 p-3 rounded-full">
                ğŸ† è§£é–æˆå°±ï¼š<span id="wrap-mission">0</span>/6
            </div>
        </div>

        <div class="wrapped-slide" id="wrap-5">
            <h2 class="text-3xl font-black mb-6 neon-text">ä¸‹æ¬¡å†å»å“ªè£¡ç©ï¼Ÿ</h2>
            <button onclick="closeWrapped()" class="bg-white text-black font-bold py-4 px-12 rounded-full shadow-[0_0_20px_rgba(255,255,255,0.5)] active:scale-95 transition-transform">
                å›åˆ°é¦–é  â¤ï¸
            </button>
        </div>
        
        <div class="absolute inset-0 z-40" onclick="nextWrappedSlide()"></div>
    </div>

    <div id="toast"><i class="fas fa-check-circle mr-2 text-green-400"></i><span id="toast-msg">å·²è¤‡è£½</span></div>

<script>
    // ================= 1. è³‡æ–™åº« (DATA) =================
    // é€™é‚Šé–‹å§‹ JS é‚è¼¯ï¼Œæ¥çºŒåˆ°ä¸‹ä¸€æ®µ...
    const TRIP_YEAR = 2026;
    
    // ç‹€æ…‹è®Šæ•¸
    let activeTab = 'itinerary';
    let currentDayIdx = 0;
    let currentChecklistFilter = 'pack';
    let currentToolFilter = 'drive'; 
    let isRainyMode = localStorage.getItem('rainy_mode') === 'true';
    let savedRate = localStorage.getItem('user_rate');
    let CURRENT_RATE = savedRate ? parseFloat(savedRate) : 0.21;
    let TOTAL_BUDGET = localStorage.getItem('trip_budget') ? parseInt(localStorage.getItem('trip_budget')) : 100000;
    
    // è³‡æ–™è®€å– (LocalStorage)
    let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];
    let taxBasket = [];
    let giftDB = JSON.parse(localStorage.getItem('trip_gifts')) || [];
    let medicalData = JSON.parse(localStorage.getItem('medical_data')) || { name: "", phone: "", hotel: "", allergies: [] };
    let parkingData = JSON.parse(localStorage.getItem('parking_data')) || null;
    let gashaCoinsUsed = localStorage.getItem('gasha_coins_used') ? parseInt(localStorage.getItem('gasha_coins_used')) : 0;
    
    // æ‰­è›‹çå‹µé è¨­å€¼
    const defaultRewards = [
        { icon: "ğŸ¬", text: "åƒä¸€é¡†è»Ÿç³–" }, { icon: "ğŸ“º", text: "çœ‹ 10 åˆ†é˜å¡é€š" },
        { icon: "ğŸ§â€â™‚ï¸", text: "çˆ¸çˆ¸èƒŒèƒŒ 5 åˆ†é˜" }, { icon: "ğŸ¹", text: "å–ä¸€ç“¶æœæ±" },
        { icon: "ğŸ§¸", text: "å»ä¾¿åˆ©å•†åº—è²·ç©å…·" }, { icon: "ğŸ¥š", text: "æ‰­ä¸€é¡†çœŸçš„æ‰­è›‹" },
        { icon: "ğŸ¦", text: "åƒå†°æ·‡æ·‹" }
    ];
    let rewardsDB = JSON.parse(localStorage.getItem('gasha_rewards')) || [...defaultRewards];
	
	// 1. æ™¯é»è©³ç´°è³‡æ–™åº«
    const spotInfoDB = {
        // --- Day 1 ---
        "tpe_airport": { title: "å°ä¸­åœ‹éš›æ©Ÿå ´", tags: ["å‡ºç™¼", "æ©Ÿå ´"], image: "https://images.unsplash.com/photo-1570710891163-6d3b5c47248b?q=80&w=1000", desc: "æ—…ç¨‹çš„èµ·é»ï¼è¨˜å¾—å†æ¬¡æª¢æŸ¥è­·ç…§æ•ˆæœŸã€‚", tips: "ğŸ’¡ å¸¶å°å­©é€šé—œå¯ä»¥èµ°å„ªå…ˆé€šé“ï¼Œè¨˜å¾—å…ˆè£å¥½æ°´ã€‚", map: "å°ä¸­åœ‹éš›æ©Ÿå ´" },
        "oka_airport": { title: "é‚£éœ¸æ©Ÿå ´", tags: ["æŠµé”", "æ‰­è›‹"], image: "https://images.unsplash.com/photo-1542332213-31f87348057f?q=80&w=1000", desc: "æ²–ç¹©çš„é–€æˆ¶ï¼ä¸€å‡ºä¾†å°±æœ‰æ»¿æ»¿çš„è˜­èŠ±é¦™ã€‚1F æœ‰ Lawson å¯ä»¥å…ˆè²·è£œçµ¦å“ã€‚", tips: "ğŸ’¡ åœ‹éš›ç·šèˆ‡åœ‹å…§ç·šç›¸é€£ï¼Œå» 2F èµ°é“æœ‰å¾ˆå¤šçš®å¡ä¸˜å¯ä»¥æ‹ã€‚", map: "é‚£éœ¸æ©Ÿå ´" },
        "ots_rent": { title: "OTS è‡¨ç©ºè±å´", tags: ["ç§Ÿè»Š", "è³¼ç¥¨"], image: "https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?q=80&w=1000", desc: "å°ç£äººæœ€æ„›çš„ç§Ÿè»Šå…¬å¸ï¼Œæœ‰ä¸­æ–‡äººå“¡ã€‚é€™è£¡æœ‰è³£å„ªæƒ é–€ç¥¨ï¼ˆç¾éº—æµ·ã€ç‰æ³‰æ´ç­‰ï¼‰ï¼Œæ¯”ç¾å ´è²·ä¾¿å®œï¼", tips: "ğŸ’¡ é€™è£¡æœ‰æ¨¡æ“¬é§•é§›è‰™å¯ä»¥è®“å°å­©ç©ï¼Œè¨˜å¾—æª¢æŸ¥ ETC å¡æ’å¥½äº†æ²’ã€‚", map: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€" },
        "hotel_nago": { title: "Best Western åè­·", tags: ["ä½å®¿", "æµ·æ™¯"], image: "https://images.unsplash.com/photo-1590523277543-a94d2e4eb00b?q=80&w=1000", desc: "ä½æ–¼åè­·å–œç€¨æµ·ç˜æ—ï¼Œæˆ¿é–“å¾ˆå¤§ï¼Œä¸”æ¯é–“éƒ½æœ‰ç„¡æ•µæµ·æ™¯ï¼æ¨“ä¸‹å°±æœ‰ä¾¿åˆ©å•†åº—ã€‚", tips: "ğŸ’¡ æ—©é¤å¯ä»¥çœ‹åˆ°æµ·ï¼Œè¨˜å¾—æ—©é»å»æ¶çª—é‚Šä½ç½®ã€‚", map: "Best Western Okinawa Kouki Beach" },
        "dinner_d1": { title: "å“¥å€«å¸ƒç‰›æ’ / ç¾æ‹‰èŠ±", tags: ["æ™šé¤", "åè­·"], image: "https://images.unsplash.com/photo-1600891964092-4316c288032e?q=80&w=1000", desc: "åè­·åœ¨åœ°è€å­—è™Ÿç‰›æ’é¤¨ã€Œå“¥å€«å¸ƒã€ï¼Œæˆ–æ˜¯å°é¢çš„ã€Œç¾æ‹‰èŠ±ã€åƒæ²–ç¹©æ–™ç†ï¼Œéƒ½æ˜¯åœ¨åœ°äººçš„æ„›åº—ã€‚", tips: "ğŸ’¡ å“¥å€«å¸ƒçš„æ¿ƒæ¹¯éå¸¸å¾©å¤å¥½å–ï¼", map: "Restaurant Columbin" },
        
        // --- Day 2 ---
        "busena": { title: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’", tags: ["çœ‹é­š", "ç»ç’ƒèˆ¹"], image: "https://images.unsplash.com/photo-1682687220742-aba13b6e50ba?q=80&w=1000", desc: "ä¸ç”¨å¼„æ¿•èº«é«”å°±èƒ½çœ‹æµ·åº•ä¸–ç•Œï¼å¾©å¤çš„é¯¨é­šé€ å‹ç»ç’ƒåº•èˆ¹ï¼Œå‡ºæµ·ç´„ 20 åˆ†é˜ï¼Œé­šç¾¤éå¸¸å¤šã€‚", tips: "ğŸ’¡ è‹¥é¢¨æµªå¤§èˆ¹æœƒåœé§›ï¼Œè¨˜å¾—å…ˆçœ‹å®˜ç¶²ã€‚æ‹¿æµ·ä¸­å±•æœ›å¡”çš„ç¥¨æ ¹å¯ä»¥è²·é­šé£¼æ–™é¤µé­šã€‚", map: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’" },
        "hama_sushi": { title: "HAMA å£½å¸ åè­·", tags: ["åˆé¤", "å£½å¸"], image: "https://images.unsplash.com/photo-1579871494447-9811cf80d66c?q=80&w=1000", desc: "æ—¥æœ¬çŸ¥åé€£é–å¹³åƒ¹è¿´è½‰å£½å¸ï¼Œç¨®é¡å¤šï¼Œæœ‰è¨±å¤šç†Ÿé£Ÿå’Œçƒé¾éºµé©åˆå°å­©ã€‚", tips: "ğŸ’¡ å¯ä»¥å…ˆç”¨ App é ç´„ï¼Œä¸ç„¶ç¾å ´è¦æŠ½è™Ÿç¢¼ç‰Œç­‰å¾ˆä¹…ã€‚", map: "HAMAå£½å¸ åè­·åº—" },
        "aeon_nago": { title: "AEON åè­·åº—", tags: ["è³¼ç‰©", "è£œçµ¦"], image: "https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?q=80&w=1000", desc: "åè­·æœ€å¤§çš„è¶…å¸‚å•†å ´ï¼Œæœ‰å¤§å‰µã€ç©å…·å€ã€è¶…å¸‚ã€‚é€™æ™‚å€™è¦è²·é½Šé€™å¹¾å¤©è¦å–çš„æ°´ã€é›¶é£Ÿã€ç©æ²™å·¥å…·ã€‚", tips: "ğŸ’¡ è¶…å¸‚æ™šä¸Šçš„ç†Ÿé£Ÿæ‰“æŠ˜å¾ˆåˆ’ç®—ï¼å¤§å‰µåœ¨ 2 æ¨“ã€‚", map: "AEON åè­·åº—" },
        "kyoda": { title: "è¨±ç”°ä¼‘æ¯ç«™", tags: ["ç¥¨åˆ¸", "ä¼‘æ¯"], image: "https://images.unsplash.com/photo-1534080564583-6be75777b70a?q=80&w=1000", desc: "å…¨æ²–ç¹©ç¬¬ä¸€åçš„ä¼‘æ¯ç«™ï¼é™¤äº†è²·æ°´æ—é¤¨å„ªæƒ ç¥¨ï¼ˆåªæ”¶ç¾é‡‘ï¼‰ï¼Œé€™è£¡çš„ç‚¸å¤©å©¦ç¾…ã€é»‘ç³–åŒ…ä¹Ÿæ˜¯å¿…åƒã€‚", tips: "ğŸ’¡ å¿…è²·ã€Œä¸‰çŸ¢ã€çš„ç‚¸é–‹å£ç¬‘ (Sata Andagi)ï¼Œç†±ç†±åƒè¶…è®šã€‚", map: "é“ã®é§… è¨±ç”°" },
        
        // --- Day 3 ---
        "churaumi": { title: "ç¾éº—æµ·æ°´æ—é¤¨", tags: ["å¿…å»", "é¯¨é¯Š"], image: "https://images.unsplash.com/photo-1582967788606-a171f1080ca8?q=80&w=1000", desc: "æ²–ç¹©åœ°æ¨™ï¼é‡‘æ°ä¸–ç•Œç´€éŒ„çš„ã€Œé»‘æ½®ä¹‹æµ·ã€æ°´æ§½ï¼Œçœ‹é¯¨é¯Šå’Œé¬¼è é­Ÿå„ªé›…æ¸¸å‹•ã€‚æˆ¶å¤–æœ‰å…è²»çš„æµ·è±šç§€ã€‚", tips: "ğŸ’¡ 11:00/13:00/15:00 æœ‰é¯¨é¯Šé¤µé£Ÿç§€ï¼Œå‹™å¿…ææ—© 15 åˆ†é˜å»å¡ä½ï¼", map: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨" },
        "kouri_drive": { title: "å¤å®‡åˆ©å¤§æ©‹", tags: ["é¢¨æ™¯", "å…œé¢¨"], image: "https://images.unsplash.com/photo-1596394516093-501ba68a0ba6?q=80&w=1000", desc: "é–‹è»Šç¶“éå…¨é•· 2km çš„è·¨æµ·å¤§æ©‹ï¼Œå…©é‚Šæ˜¯çµ•ç¾çš„ã€Œå¤å®‡åˆ©è—ã€ï¼Œå½·å½¿è¡Œé§›åœ¨æµ·ä¸Šã€‚", tips: "ğŸ’¡ éæ©‹æ™‚å¯ä»¥æŠŠè»Šçª—æ–ä¸‹ä¾†ï¼Œæµ·é¢¨å¾ˆèˆ’æœã€‚", map: "å¤å®‡åˆ©å¤§æ©‹" },
        "kouri_tower": { title: "å¤å®‡åˆ©æµ·æ´‹å¡”", tags: ["é¢¨æ™¯", "é³³æ¢¨è»Š"], image: "https://images.unsplash.com/photo-1560275619-4662e36fa65c?q=80&w=1000", desc: "å¯ä»¥æ­ä¹˜ç„¡äººè‡ªå‹•é§•é§›çš„é³³æ¢¨è»Šä¸Šå±±ï¼Œæ²¿é€”é¢¨æ™¯å„ªç¾ï¼Œå¡”é ‚æ•²é˜å¯ä»¥ç¥ˆæ±‚å¹¸ç¦ã€‚", tips: "ğŸ’¡ å¡”å…§çš„ç”œé»åº—æœ‰è³£ã€Œå¤å®‡åˆ©å³¶é™å®šã€çš„å—ç“œæ³¡èŠ™ã€‚", map: "å¤å®‡åˆ©æµ·æ´‹å¡”" },
        "kouri_shrimp": { title: "Kouri Shrimp", tags: ["é»å¿ƒ", "è¦è¦é£¯"], image: "https://images.unsplash.com/photo-1559339352-11d035aa65de?q=80&w=1000", desc: "åŸæœ¬æ˜¯é¤è»Šèµ·å®¶ï¼Œç¾åœ¨æœ‰åº—é¢äº†ã€‚è’œé¦™å¥¶æ²¹è¦é…ä¸Šå…©çƒé£¯ï¼Œè¶…ç´šç½ªæƒ¡åˆå¥½åƒï¼", tips: "ğŸ’¡ ç”¨é»é¤æ©Ÿé»é¤ï¼Œäººå¤šæ™‚å¯ä»¥å¤–å¸¶å»è»Šä¸Šæˆ–æµ·é‚Šåƒã€‚", map: "Kouri Shrimp" },
        "yakiniku": { title: "ç‡’è‚‰ä¹ƒæˆ‘é‚£éœ¸", tags: ["æ™šé¤", "ç‡’è‚‰"], image: "https://images.unsplash.com/photo-1594041680508-e3873d24c271?q=80&w=1000", desc: "åè­·æœ€æœ‰åçš„ç‡’è‚‰åº—ï¼Œè‡ªå®¶è‚‰èˆ–ç›´ç‡Ÿï¼Œé˜¿å¤è±¬å’Œå’Œç‰›éƒ½å¾ˆæ–°é®®ï¼Œåƒ¹æ ¼ä¹Ÿåˆç†ã€‚", tips: "ğŸ’¡ æ–°é¤¨åº§ä½æ¯”è¼ƒå¯¬æ•ä¹¾æ·¨ï¼Œé©åˆå¸¶å°å­©ã€‚", map: "ç‡’è‚‰ä¹ƒæˆ‘é‚£éœ¸ æ–°é¤¨" },

        // --- Day 4 ---
        "dino": { title: "DINO æé¾ PARK", tags: ["æé¾", "æ¢éšª"], image: "https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?q=80&w=1000", desc: "å°±åœ¨ã€Œå¾¡è“å­å¾¡æ®¿ã€åè­·åº—çš„å¾Œå±±ï¼ŒåŸå§‹æ£®æ—è£¡è—äº† 80 å¹¾éš»æœƒå‹•æœƒå«çš„æé¾ï¼Œéå¸¸é€¼çœŸï¼", tips: "ğŸ’¡ æ£®æ—è·¯é¢æœ‰äº›èµ·ä¼ï¼Œæ¨è»Šå‹‰å¼·å¯è¡Œä½†å»ºè­°ç”¨æ¹å·¾ã€‚å‡ºå£å°±æ˜¯åœŸç”¢åº—ã€‚", map: "DINOæé¾PARK å±±åŸäºç†±å¸¶ä¹‹æ£®" },
        "okashi": { title: "å¾¡è“å­å¾¡æ®¿", tags: ["åˆé¤", "ä¼´æ‰‹ç¦®"], image: "https://images.unsplash.com/photo-1574621100236-d25a64a063f3?q=80&w=1000", desc: "ç´…èŠ‹å¡”çš„ç™¼æºåœ°ï¼é€™è£¡å¯ä»¥åƒè§€å·¥å» ç”Ÿç”¢ç·šï¼ŒäºŒæ¨“æœ‰é¤å»³å¯ä»¥åƒé£¯ï¼Œé¢¨æ™¯ä¸éŒ¯ã€‚", tips: "ğŸ’¡ é€™è£¡è³£çš„ç´…èŠ‹å¡”æ˜¯æœ€æ–°é®®çš„ï¼Œå¯ä»¥è²·å–®å€‹ç¾å ´åƒã€‚", map: "å¾¡è“å­å¾¡æ®¿ åè­·åº—" },
        "shima_donuts": { title: "å³¶è±†è…ç”œç”œåœˆ", tags: ["ç”œé»", "å¥åº·"], image: "https://images.unsplash.com/photo-1626017240366-075f8f5370d0?q=80&w=1000", desc: "ç”¨æ²–ç¹©å³¶è±†è…æ¸£åšçš„ç”œç”œåœˆï¼Œå£æ„ŸQå½ˆåˆå¥åº·ï¼Œçµ¦å°å­©åƒä¹Ÿå¾ˆå®‰å¿ƒã€‚åº—é¢éå¸¸å¯æ„›ã€‚", tips: "ğŸ’¡ å¸¸å¸¸ä¸‹åˆå°±è³£å®Œäº†ï¼Œå»ºè­°æ—©é»å»æˆ–å…ˆæ‰“é›»è©±é ç•™ã€‚", map: "Shima Donuts" },
        "park_21": { title: "21ä¸–ç´€ä¹‹æ£®å…¬åœ’", tags: ["å…¬åœ’", "æ”¾é›»"], image: "https://images.unsplash.com/photo-1563507577884-3c87f2771239?q=80&w=1000", desc: "åè­·å¸‚æ°‘çš„å¤§å…¬åœ’ï¼Œæœ‰æ²™ç˜ã€æ£’çƒå ´ï¼Œé‡é»æ˜¯æœ‰å¤§å‹éŠæ¨‚è¨­æ–½å’Œé•·é•·çš„æºœæ»‘æ¢¯ï¼é‚„æœ‰å±•ç¤ºè’¸æ±½ç«è»Šé ­ã€‚", tips: "ğŸ’¡ é€™è£¡æ²’æœ‰é®è”­ï¼Œè¨˜å¾—é˜²æ›¬å’Œè£œæ°´ã€‚", map: "21ä¸–ç´€ä¹‹æ£®å…¬åœ’" },
        "blue_seal": { title: "Blue Seal å†°æ·‡æ·‹", tags: ["å†°å“", "å¿…åƒ"], image: "https://images.unsplash.com/photo-1501443762994-82bd5dace89a?q=80&w=1000", desc: "æºè‡ªç¾åœ‹çš„æ²–ç¹©åœ¨åœ°å†°æ·‡æ·‹ï¼å¿…é»ã€Œé¹½å‘³é‡‘æ¥šç³•ã€å’Œã€Œç´…èŠ‹ã€å£å‘³ã€‚", tips: "ğŸ’¡ æ¯å€‹æœˆçš„ 10 è™Ÿå’Œ 20 è™Ÿæœ‰å„ªæƒ æ´»å‹•ï¼ˆBig Dip Dayï¼‰ã€‚", map: "Blue Seal Nago" },

        // --- Day 5 ---
        "neopark": { title: "Neo Park å‹•æ¤ç‰©åœ’", tags: ["å‹•ç‰©", "ç«è»Š"], image: "https://images.unsplash.com/photo-1534234828569-2f2249520468?q=80&w=1000", desc: "ä¸»æ‰“ã€Œäººèˆ‡å‹•ç‰©é›¶è·é›¢ã€ï¼Œå¯ä»¥æ­ä¹˜å¾©å¤è¼•ä¾¿éµé“å°ç«è»Šç’°åœ’ä¸€å‘¨ã€‚é³¥é¡éå¸¸å¤šä¸”ç†±æƒ…ã€‚", tips: "ğŸ’¡ é€²é–€è¨˜å¾—è²·é³¥é£¼æ–™ï¼Œä½†è¦æ³¨æ„é³¥ç¾¤å¯èƒ½æœƒå¾ˆæ¿€å‹•ã€‚", map: "åè­·è‡ªç„¶å‹•æ¤ç‰©å…¬åœ’" },
        "cookhal": { title: "Cookhal", tags: ["åˆé¤", "è¾²å ´"], image: "https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=1000", desc: "è¾²å ´ç›´ç‡Ÿçš„å’–å•¡å»³ï¼Œé£Ÿæè¶…ç´šæ–°é®®ï¼Œå……æ»¿é‡èœçš„æ–™ç†ã€‚ç’°å¢ƒå¾ˆèˆ’æœæ”¾é¬†ã€‚", tips: "ğŸ’¡ é€™è£¡ä¹Ÿæœ‰è³£æ–°é®®çš„æ²–ç¹©è”¬æœå’ŒåŠ å·¥å“ã€‚", map: "Cookhal" },
        "ufuya": { title: "ç™¾å¹´å¤å®¶ å¤§å®¶", tags: ["æ™šé¤", "é˜¿å¤è±¬"], image: "https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=1000", desc: "ç”±ç™¾å¹´å¤å®…æ”¹å»ºçš„é¤å»³ï¼Œæ°£æ°›æ»¿åˆ†ï¼å¿…åƒé˜¿å¤è±¬æ¶®æ¶®é‹ï¼Œæ™šä¸Šé‚„æœ‰ç‡ˆå…‰é€ æ™¯ã€‚", tips: "ğŸ’¡ é€™è£¡éå¸¸ç†±é–€ï¼Œæ²’æœ‰é ç´„å¹¾ä¹åƒä¸åˆ°ï¼Œä¸€å®šè¦å…ˆè¨‚ä½ã€‚", map: "ç™¾å¹´å¤å®¶ å¤§å®¶" },

        // --- Day 6 ---
        "parco": { title: "PARCO CITY", tags: ["è³¼ç‰©", "é›¨å¤©"], image: "https://images.unsplash.com/photo-1472851294608-415522f96319?q=80&w=1000", desc: "æµ¦æ·»è¥¿æµ·å²¸æœ€æ–°æœ€å¤§çš„å•†å ´ï¼Uniqlo, MUJI, é˜¿å¡å°‡æœ¬èˆ–æ‡‰æœ‰ç›¡æœ‰ã€‚ç¾é£Ÿè¡—å¯ä»¥ç›´æ¥çœ‹æµ·ã€‚", tips: "ğŸ’¡ 3F çš„ Green Zone å…’ç«¥å€å¯ä»¥æ”¾é›»ã€‚åœè»Šå ´éå¸¸å¤§ï¼Œè¨˜å¾—æ‹ç…§è¨˜ä½ç½®ã€‚", map: "SAN-A æµ¦æ·»è¥¿æµ·å²¸ PARCO CITY" },
        "dmm": { title: "DMM æ°´æ—é¤¨", tags: ["æ°´æ—é¤¨", "ç§‘æŠ€"], image: "https://images.unsplash.com/photo-1535591273668-578e31182c4f?q=80&w=1000", desc: "çµåˆæœ€æ–°å½±åƒæŠ€è¡“çš„æ°´æ—é¤¨ï¼Œé›–ç„¶æ¯”ç¾éº—æµ·å°ï¼Œä½†äº’å‹•æ€§å¾ˆé«˜ã€‚å¯ä»¥æ‘¸é­šã€çœ‹æ¨¹æ‡¶ã€‚", tips: "ğŸ’¡ ä½æ–¼ iias å•†å ´å…§ï¼Œé€›å®Œå¯ä»¥ç›´æ¥åƒé£¯é€›è¡—ã€‚", map: "DMM Kariyushi Aquarium" },
        "daiwa": { title: "Daiwa Roynet", tags: ["ä½å®¿", "å¸‚å€"], image: "https://images.unsplash.com/photo-1566073771259-6a8506099945?q=80&w=1000", desc: "å°±åœ¨åœ‹éš›é€šæ—é‚Šï¼Œäº¤é€šè¶…ç´šæ–¹ä¾¿ï¼Œé›¢å–®è»Œç‰§å¿—ç«™å¾ˆè¿‘ã€‚æˆ¿é–“ä¹¾æ·¨èˆ’é©ã€‚", tips: "ğŸ’¡ é£¯åº—åœè»Šå ´æ˜¯å¡”å¼çš„ï¼Œå¦‚æœè»Šå¤ªå¤§å¯èƒ½è¦åœç‰¹ç´„åœè»Šå ´ã€‚", map: "Daiwa Roynet Hotel Naha Kokusai-dori" },
        "mcdonalds": { title: "éº¥ç•¶å‹ åœ‹éš›é€š", tags: ["æ™šé¤", "æ•‘è´–"], image: "https://images.unsplash.com/photo-1552895638-f7fe08d2f7d5?q=80&w=1000", desc: "ç•¶å°å­©ä¸æƒ³åƒæ—¥æœ¬æ–™ç†æ™‚çš„æ•‘æ˜Ÿã€‚æ—¥æœ¬éº¥ç•¶å‹çš„å¿«æ¨‚å…’ç«¥é¤ç©å…·é€šå¸¸å¾ˆå²å®³ï¼", tips: "ğŸ’¡ å¯ä»¥ç”¨æ©Ÿå™¨é»é¤ï¼Œæœ‰ä¸­æ–‡ä»‹é¢ã€‚", map: "McDonald's Kokusai Dori Makishi" },
        "fontana": { title: "Fontana Gelato", tags: ["ç”œé»", "æ‰“å¡"], image: "https://images.unsplash.com/photo-1560008511-11c63416e52d?q=80&w=1000", desc: "åœ‹éš›é€šå··å­è£¡çš„ç¾©å¼å†°æ·‡æ·‹ï¼Œè‰²å½©ç¹½ç´›çš„å½©è™¹å†°æ·‡æ·‹æ˜¯æ‹ç…§æ‰“å¡å¿…å‚™ï¼", tips: "ğŸ’¡ åº—é¢å¾ˆå°å®¹æ˜“éŒ¯éï¼Œèªæ˜é–€å£çš„å¤§å†°æ·‡æ·‹æ¨¡å‹ã€‚", map: "Fontana Gelato" },

        // --- Day 7 ---
        "naminoue": { title: "æ³¢ä¸Šå®®", tags: ["ç¥ç¤¾", "æ™¯é»"], image: "https://images.unsplash.com/photo-1599464402636-6c2438883e1c?q=80&w=1000", desc: "é‚£éœ¸å¸‚å…§å”¯ä¸€çš„æ²™ç˜ç¥ç¤¾ï¼Œå»ºåœ¨æ‡¸å´–ä¸Šï¼Œéå¸¸æœ‰æ°£å‹¢ã€‚å¯ä»¥è²·æ›¸åŒ…é€ å‹çš„å¾¡å®ˆã€‚", tips: "ğŸ’¡ æ—é‚Šå°±æ˜¯æ³¢ä¹‹ä¸Šæµ·ç˜ï¼Œæ‹œå®Œå¯ä»¥å»è¸©è¸©æ°´ã€‚", map: "æ³¢ä¸Šå®®" },
        "ashibinaa": { title: "ASHIBINAA Outlet", tags: ["è³¼ç‰©", "Outlet"], image: "https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=1000", desc: "ä½æ–¼æ©Ÿå ´é™„è¿‘ï¼Œé©åˆå›ç¨‹å‰æœ€å¾Œè¡åˆºã€‚Adidas, Nike, GAP å¸¸å¸¸æœ‰é©šäººçš„æŠ˜æ‰£ã€‚", tips: "ğŸ’¡ é€±æœ«äººå¾ˆå¤šï¼Œå»ºè­°é ç•™è¶³å¤ æ™‚é–“å»æ©Ÿå ´ã€‚", map: "ASHIBINAA Outlet" },
        "gas_station": { title: "ENEOS åŠ æ²¹ç«™", tags: ["åŠ æ²¹", "é‚„è»Š"], image: "https://images.unsplash.com/photo-1626863905121-3b0c0ed7b94c?q=80&w=1000", desc: "OTS æ—é‚Šçš„åŠ æ²¹ç«™ï¼Œé‚„è»Šå‰å¿…é ˆåŠ æ»¿æ²¹ä¸¦ä¿ç•™æ”¶æ“šã€‚è¨˜å¾—åŠ  Regular (ç´…æ§)ã€‚", tips: "ğŸ’¡ é€™è£¡é€šå¸¸æ’éšŠå¾ˆé•·ï¼Œå»ºè­°é ç•™ 20 åˆ†é˜åŠ æ²¹æ™‚é–“ã€‚", map: "ENEOS Dr.Drive Self Toyosaki SS" }
    };

    const bgImages = {
        D1: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=1000&fit=crop",
        D2: "https://images.unsplash.com/photo-1582967788606-a171f1080ca8?q=80&w=1000&fit=crop",
        D3: "https://images.unsplash.com/photo-1560275619-4662e36fa65c?q=80&w=1000&fit=crop",
        D4: "https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?q=80&w=1000&fit=crop",
        D5: "https://images.unsplash.com/photo-1534234828569-2f2249520468?q=80&w=1000&fit=crop",
        D6: "https://images.unsplash.com/photo-1570533412033-662309e3df4e?q=80&w=1000&fit=crop",
        D7: "https://images.unsplash.com/photo-1542051841857-5f90071e7989?q=80&w=1000&fit=crop",
        SHOP: "https://images.unsplash.com/photo-1472851294608-415522f96319?q=80&w=1000&fit=crop",
        TOOL: "https://images.unsplash.com/photo-1484417894907-623942c8ee29?q=80&w=1000&fit=crop",
        MISSION: "https://images.unsplash.com/photo-1533227297464-9429738d1964?q=80&w=1000&fit=crop",
        CALC: "https://images.unsplash.com/photo-1563986768603-41fef5d00369?q=80&w=1000&fit=crop",
        SYNC: "https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=1000&fit=crop",
        SOS: "https://images.unsplash.com/photo-1588611910679-22a9009952a9?q=80&w=1000&fit=crop"
    };

    // 2. è¡Œç¨‹è³‡æ–™åº« (å·²æ•´åˆå¤©æ°£èˆ‡ç©¿æ­å»ºè­° v17.5)
    const itineraryDB = [
        { 
            day: "D1", date: "3/28 (å…­)", title: "å•Ÿç¨‹ & é©æ‡‰", highlights: "æ©Ÿå ´è²·å¥¶ / OTSå–è»Š / ä½åè­·", bg: bgImages.D1, 
            weather: {
                icon: "fa-cloud-sun", temp: "20Â°C - 24Â°C", rain: "20%", uv: "ä¸­",
                wear: "èˆ’é©é•·è¤² + è–„å¤–å¥— (æ´‹è”¥å¼ç©¿æ­)",
                tips: "é£›æ©Ÿèˆ‡æ©Ÿå ´å†·æ°£è¼ƒå¼·ï¼Œéš¨èº«åŒ…è¨˜å¾—å¸¶ä¸€ä»¶å¤–å¥—çµ¦å¥å¥ã€‚"
            },
            events: [
                { time: "09:00", title: "å¾å®¶è£¡å‡ºç™¼", icon: "fa-house", note: "é ç•™ 40-50 åˆ†é˜è»Šç¨‹å‰å¾€æ¸…æ³‰å´—æ©Ÿå ´ã€‚", duration: "1h", travel: "ğŸš— 40åˆ†" },
                { time: "10:00", title: "æŠµé”å°ä¸­åœ‹éš›æ©Ÿå ´", spotId: "tpe_airport", icon: "fa-plane-departure", note: "è¾¦ç†æ‰˜é‹ã€‚æ¨è»Šæ¨åˆ°ç™»æ©Ÿå£å†æ‰˜é‹ã€‚", map: "å°ä¸­åœ‹éš›æ©Ÿå ´", duration: "3h", travel: "âœˆï¸ ç­‰å¾…èµ·é£›" },
                { time: "13:15", title: "æ˜Ÿå®‡ JX302 èµ·é£›", icon: "fa-paper-plane", note: "çµ¦å¥å¥å–æœæ±/åƒè»Ÿç³–å¹³è¡¡è€³å£“ã€‚", duration: "2.5h", travel: "âœˆï¸ é£›è¡Œ 90åˆ†" },
                { time: "15:45", title: "æŠµé”é‚£éœ¸æ©Ÿå ´", spotId: "oka_airport", icon: "fa-plane-arrival", note: "å…¥å¢ƒã€æ‹¿è¡Œæã€éç¨…é—œã€‚", duration: "45m", travel: "ğŸš¶ æ­¥è¡Œ" },
                { time: "16:15", title: "æ©Ÿå ´è£œçµ¦ (Lawson)", icon: "fa-cart-shopping", note: "1F å…¥å¢ƒå¤§å»³æ—ã€‚è²·é®®å¥¶æˆ–æ˜æ²»å¡Šç‹€å¥¶ç²‰ã€‚", duration: "15m", travel: "ğŸšŒ æ¥é§ 15åˆ†" },
                { time: "16:30", title: "æ­æ¥é§è»Šå¾€ OTS", icon: "fa-bus", note: "1F å¤§å»³å¤– 10-A æœˆå°ã€‚", travel: "ğŸšŒ ç§»å‹• 20åˆ†" },
                { time: "17:00", title: "OTS è‡¨ç©ºè±å´ å–è»Š", spotId: "ots_rent", icon: "fa-car", note: "æª¢æŸ¥è»Šæ³ã€è£æ±½åº§ã€‚å°èˆªè¨­å®šé£¯åº—ã€‚", map: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€", lat: 26.1558, lon: 127.6534, duration: "1h", travel: "ğŸš— é–‹è»Š 60åˆ†" },
                { time: "18:00", title: "å‡ºç™¼åŒ—ä¸Š (é«˜é€Ÿå…¬è·¯)", icon: "fa-road", note: "ä¸­é€”åœ ä¸­åŸPA æˆ– ä¼ŠèŠ¸SA ä¼‘æ¯è²·æ°´ã€‚", travel: "ğŸš— é–‹è»Š 30åˆ†" },
                { time: "19:30", title: "é£¯åº— Check-in", spotId: "hotel_nago", icon: "fa-hotel", note: "Best Western Kouki Beachã€‚é€²æˆ¿å…ˆçœ‹æµ·ï¼", map: "Best Western Okinawa Kouki Beach", mapcode: "206 473 354*11", lat: 26.5414, lon: 127.9458, duration: "30m" },
                { time: "20:00", title: "æ™šé¤ï¼šç¾æ‹‰èŠ±åˆ¥é‚¸", spotId: "dinner_d1", icon: "fa-utensils", note: "èµ°è·¯å»åƒï¼Œæ¦»æ¦»ç±³åŒ…å»‚ã€‚", map: "Restaurant Columbin", duration: "1.5h" },
                { time: "21:30", title: "ä¼‘æ¯ & æ´—æ¾¡", icon: "fa-bed", note: "æ‹¿å‡ºé™ªç¡ç©å¶ï¼Œæº–å‚™æ˜å¤©æ¢éšªã€‚" }
            ]
        },
        { 
            day: "D2", date: "3/29 (æ—¥)", title: "é©æ‡‰ & è£œçµ¦", highlights: "ç»ç’ƒèˆ¹ / AEON æƒè²¨ / ç©æ²™", bg: bgImages.D2, 
            weather: {
                icon: "fa-sun", temp: "22Â°C - 26Â°C", rain: "0%", uv: "é«˜",
                wear: "çŸ­è¢–ä¸Šè¡£ + çŸ­è¤² + é®é™½å¸½",
                tips: "ä»Šå¤©æœƒå»æµ·é‚Šèˆ‡å…¬åœ’ï¼Œç´«å¤–ç·šè¼ƒå¼·ï¼Œè¨˜å¾—å¹«å°å­©æ“¦é˜²æ›¬ã€‚"
            },
            events: [
                { time: "08:30", title: "é£¯åº—æ—©é¤", icon: "fa-mug-hot", note: "äº«å—æµ·æ™¯æ—©é¤ï¼Œå¹«å¥å¥å¸¶æ°´å£ºã€‚", duration: "1h", travel: "ğŸš— 10åˆ†" },
                { time: "10:00", title: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’", spotId: "busena", icon: "fa-water", note: "æ­ç»ç’ƒåº•èˆ¹çœ‹å°¼è« ğŸ  (æ¯20åˆ†ä¸€ç­)", map: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’", mapcode: "206 442 077*71", duration: "1.5h", lat: 26.5278, lon: 127.9306, rainy: { title: "Neo Park (é›¨å¤©å‚™æ¡ˆ)", icon: "fa-leaf", note: "â˜” é›¨å¤©æ”¹æ­å°ç«è»Š" }, travel: "ğŸš— 20åˆ†" },
                { time: "12:00", title: "åˆé¤ï¼šHama å£½å¸", spotId: "hama_sushi", icon: "fa-bowl-rice", note: "åè­·åº—ã€‚å¹³æ¿é»é¤ï¼Œé€é¤åƒç«è»Šï¼", map: "HAMAå£½å¸ åè­·åº—", lat: 26.5960, lon: 127.9830, duration: "1h", travel: "ğŸš— 2åˆ†" },
                { time: "13:30", title: "AEON åè­·åº—", spotId: "aeon_nago", icon: "fa-cart-shopping", note: "å¤§å‰µæƒè²¨(æé¾çƒ)ã€è¶…å¸‚è²·å°¿å¸ƒæ°´æœã€‚", map: "AEON åè­·åº—", mapcode: "206 626 669*52", duration: "1.5h", travel: "ğŸš— 10åˆ†" },
                { time: "15:00", title: "è¨±ç”°ä¼‘æ¯ç«™", spotId: "kyoda", icon: "fa-ticket", note: "å¿…è²·æ°´æ—é¤¨å„ªæƒ ç¥¨ (åªæ”¶ç¾é‡‘)ã€‚", map: "é“ã®é§… è¨±ç”°", duration: "30m", travel: "ğŸš— 15åˆ†" },
                { time: "16:00", title: "é£¯åº—æ²™ç˜ç©æ²™", spotId: "hotel_nago", icon: "fa-umbrella-beach", note: "æ‹¿å‡ºå‰›è²·çš„æŒ–æ²™çµ„å¤§ç©ç‰¹ç©ã€‚", lat: 26.5414, lon: 127.9458, duration: "1.5h" },
                { time: "18:00", title: "æ™šé¤ï¼šç¾æ‹‰èŠ±åˆ¥é‚¸", spotId: "dinner_d1", icon: "fa-utensils", note: "å°±åœ¨é£¯åº—éš”å£ï¼Œèµ°è·¯å»åƒã€‚", map: "ç¾æ‹‰èŠ±", duration: "1.5h" },
                { time: "20:00", title: "è©¦ç”¨æé¾æ³¡æ¾¡çƒ", icon: "fa-bath", note: "é©šå–œæ´—æ¾¡æ™‚é–“ï¼" }
            ]
        },
        { 
            day: "D3", date: "3/30 (ä¸€)", title: "æµ·æ´‹ & å¤§æ©‹", highlights: "é¯¨é¯Š / å¤å®‡åˆ©è— / è¦è¦é£¯", bg: bgImages.D3, 
            weather: {
                icon: "fa-wind", temp: "21Â°C - 25Â°C", rain: "10%", uv: "ä¸­",
                wear: "å¥½èµ°çš„é‹ + é˜²é¢¨å¤–å¥—",
                tips: "å¤å®‡åˆ©å¤§æ©‹é¢¨å¾ˆå¤§ï¼Œå°å­©å¸½å­è¦æœ‰ç¹©å­æˆ–å…ˆæ”¶èµ·ä¾†ã€‚"
            },
            events: [
                { time: "08:30", title: "é£¯åº—æ—©é¤ & å‡ºç™¼", icon: "fa-car", note: "æº–æ™‚å‡ºç™¼é¿é–‹äººæ½®ã€‚", duration: "1h", travel: "ğŸš— 40åˆ†" },
                { time: "09:30", title: "ç¾éº—æµ·æ°´æ—é¤¨", spotId: "churaumi", icon: "fa-fish", note: "åœ P7 åœè»Šå ´ã€‚ç›´å¥” 2F é»‘æ½®ä¹‹æµ·ã€‚", map: "æµ·æ´‹åšå…¬åœ’P7ç«‹é«”åœè»Šå ´", mapcode: "553 075 797*77", duration: "3h", lat: 26.6943, lon: 127.8779 },
                { time: "10:30", title: "æµ·è±šåŠ‡å ´", icon: "fa-person-swimming", note: "æˆ¶å¤–å…è²»æµ·è±šç§€ (ç„¡é®è”½ï¼Œè¦æˆ´å¸½å­)ã€‚", map: "", duration: "30m" },
                { time: "12:00", title: "åˆé¤ï¼šé¤¨å…§è‡ªåŠ©é¤", icon: "fa-utensils", note: "Inoh è‡ªåŠ©é¤æˆ– Ocean Blue å’–å•¡ã€‚", map: "", duration: "1.5h", travel: "ğŸš— 40åˆ† (åˆç¡)" },
                { time: "13:30", title: "å‰å¾€å¤å®‡åˆ©å³¶", spotId: "kouri_drive", icon: "fa-bridge-water", note: "è»Šç¨‹å¹³ç©©ï¼Œè®“å¥å¥è»Šä¸Šè£œçœ ã€‚", travel: "ğŸš— 5åˆ†" },
                { time: "14:30", title: "å¤å®‡åˆ©æµ·æ´‹å¡”", spotId: "kouri_tower", icon: "fa-tower-observation", note: "æ­ç„¡äººé³³æ¢¨è»Šä¸Šå±±ã€‚", map: "å¤å®‡åˆ©æµ·æ´‹å¡”", lat: 26.7042, lon: 128.0286, duration: "1.5h", travel: "ğŸš— 2åˆ†" },
                { time: "16:00", title: "é»å¿ƒï¼šè¦è¦é£¯", spotId: "kouri_shrimp", icon: "fa-shrimp", note: "Kouri Shrimpï¼Œäººå¤šå°±æ‹ç…§æ‰“å¡ã€‚", map: "Kouri Shrimp", duration: "30m" },
                { time: "16:30", title: "æ©‹ä¸‹æ²™ç˜", spotId: "kouri_drive", icon: "fa-camera", note: "æ‹å…¨å®¶ç¦ï¼Œæ°´æ·ºæ²™ç™½ã€‚", map: "å¤å®‡åˆ©æµ·ç˜", duration: "30m", travel: "ğŸš— 30åˆ†" },
                { time: "18:00", title: "æ™šé¤ï¼šåè­·ä¸ƒé¸ä¸€", spotId: "yakiniku", icon: "fa-fire-burner", note: "å¤§å®¶ / ç‡’è‚‰ä¹ƒæˆ‘é‚£éœ¸ / è—å£½å¸ã€‚", map: "ç‡’è‚‰ä¹ƒæˆ‘é‚£éœ¸ æ–°é¤¨", duration: "1.5h" },
                { time: "20:00", title: "è²¼ä¼‘è¶³æ™‚é–“", icon: "fa-moon", note: "ä»Šå¤©èµ°æœ€å¤šè·¯ï¼Œæ—©é»ç¡ã€‚" }
            ]
        },
        { 
            day: "D4", date: "3/31 (äºŒ)", title: "æ¢éšª & å†°æ·‡æ·‹", highlights: "DINO Park / ç”œç”œåœˆ / æºœæ»‘æ¢¯", bg: bgImages.D4, 
            weather: {
                icon: "fa-cloud", temp: "22Â°C - 27Â°C", rain: "30%", uv: "ä¸­",
                wear: "é•·è¤² (é˜²èšŠ) + é€æ°£ä¸Šè¡£",
                tips: "æé¾å…¬åœ’æ˜¯åŸå§‹æ£®æ—ï¼Œå‹™å¿…å¹«å°å­©å™´é˜²èšŠæ¶²ã€‚"
            },
            events: [
                { time: "09:00", title: "é£¯åº—æ—©é¤", icon: "fa-mug-hot", note: "åƒé£½ä¸€é»ï¼Œä»Šå¤©è¦èµ°æ£®æ—æ­¥é“ã€‚", duration: "1h", travel: "ğŸš— 15åˆ†" },
                { time: "10:00", title: "DINO æé¾ PARK", spotId: "dino", icon: "fa-dragon", note: "âš ï¸ ç”¨èƒŒå·¾ã€‚æ‰¾ 80 éš»æé¾ï¼", map: "DINOæé¾PARK å±±åŸäºç†±å¸¶ä¹‹æ£®", mapcode: "206 745 056*82", lat: 26.6267, lon: 127.9620, duration: "1.5h", rainy: { title: "AEON éŠæ¨‚å ´ (é›¨å¤©)", icon: "fa-gamepad", note: "â˜” é›¨å¤©æ”¹å» AEON ç©å®¤å…§è¨­æ–½" } },
                { time: "11:30", title: "åˆé¤ï¼šå¾¡è“å­å¾¡æ®¿", spotId: "okashi", icon: "fa-bowl-food", note: "å°±åœ¨æé¾å…¬åœ’æ¨“ä¸Šã€‚é †ä¾¿è©¦åƒç´…èŠ‹å¡”ã€‚", map: "", duration: "1.5h", travel: "ğŸš— 5åˆ†" },
                { time: "13:00", title: "å³¶è±†è…ç”œç”œåœˆ", spotId: "shima_donuts", icon: "fa-cookie-bite", note: "è²·å®Œå›è»Šä¸Šåƒï¼Œé †ä¾¿åˆç¡ã€‚", map: "Shima Donuts", duration: "30m", travel: "ğŸš— 5åˆ† (åˆç¡)" },
                { time: "13:30", title: "è»Šä¸Šåˆç¡å……é›»", icon: "fa-battery-full", note: "é–‹å¾€ 21 ä¸–ç´€ä¹‹æ£®å…¬åœ’ (è®“å¥å¥ç¡ 30-60åˆ†)ã€‚" },
                { time: "15:00", title: "21ä¸–ç´€ä¹‹æ£®å…¬åœ’", spotId: "park_21", icon: "fa-train", note: "æ‰¾é»‘è‰²ç«è»Šé ­ã€ç©æºœæ»‘æ¢¯ã€‚", map: "21ä¸–ç´€ä¹‹æ£®å…¬åœ’", mapcode: "206 626 779*74", duration: "1.5h", travel: "ğŸš— 5åˆ†" },
                { time: "16:30", title: "Blue Seal å†°æ·‡æ·‹", spotId: "blue_seal", icon: "fa-ice-cream", note: "åè­·æ——è‰¦åº—ï¼Œåƒ Kids Sizeã€‚", map: "Blue Seal Nago", duration: "1h" },
                { time: "17:30", title: "æ™šé¤ï¼šåè­·ä¸ƒé¸ä¸€", icon: "fa-utensils", note: "A&W æ¼¢å ¡ / è—å£½å¸ / æš–æš®æ‹‰éºµã€‚", map: "", duration: "1.5h" },
                { time: "19:30", title: "ä¼‘æ¯", icon: "fa-moon", note: "ä»Šå¤©åƒäº†ç”œé»åˆåƒå†°ï¼Œé–‹å¿ƒç¡è¦ºã€‚" }
            ]
        },
        { 
            day: "D5", date: "4/01 (ä¸‰)", title: "å‹•ç‰© & æ”¾ç©º", highlights: "Neo Park å°ç«è»Š / é£¯åº—æ³³æ± ", bg: bgImages.D5, 
            weather: {
                icon: "fa-sun", temp: "23Â°C - 28Â°C", rain: "0%", uv: "é«˜",
                wear: "æ³³è¡£ (ç©¿åœ¨è£¡é¢) + æ¶¼é‹",
                tips: "ä¸‹åˆæœƒç©æ°´ï¼Œè¨˜å¾—å¤šå¸¶ä¸€å¥—ä¹¾æ·¨è¡£ç‰©å’Œæ¯›å·¾ã€‚"
            },
            events: [
                { time: "09:30", title: "é£¯åº—æ—©é¤ & æ‚ é–’å‡ºç™¼", icon: "fa-mug-hot", note: "ä¸ç”¨å¤ªæ—©èµ·ï¼Œå…¬åœ’å¾ˆè¿‘ã€‚", duration: "30m", travel: "ğŸš— 5åˆ†" },
                { time: "10:00", title: "Neo Park å‹•æ¤ç‰©åœ’", spotId: "neopark", icon: "fa-train-subway", note: "é€²é–€å…ˆæ­å¾©å¤å°ç«è»Šã€‚é³¥é¡æ”¾é¤Šã€‚", map: "åè­·è‡ªç„¶å‹•æ¤ç‰©å…¬åœ’", mapcode: "206 689 725*11", lat: 26.5986, lon: 127.9733, duration: "2.5h", travel: "ğŸš— 3åˆ†" },
                { time: "12:30", title: "åˆé¤ï¼šCookhal", spotId: "cookhal", icon: "fa-leaf", note: "å°±åœ¨å…¬åœ’æ—ï¼Œæˆ–å»åƒå¹¸é†¬æ²–ç¹©éºµã€‚", map: "Cookhal", duration: "1.5h", travel: "ğŸš— 15åˆ†" },
                { time: "14:00", title: "å›é£¯åº—åˆç¡", icon: "fa-bed", note: "ç›´æ¥å›æˆ¿é–“èˆ’æœç¡ä¸€è¦ºã€‚", map: "", duration: "1.5h" },
                { time: "15:30", title: "é£¯åº—æ²™ç˜/æ³³æ± ", spotId: "hotel_nago", icon: "fa-umbrella-beach", note: "ç¡é£½ä¸‹æ¨“ç©æ°´ï¼Œå †å¤§åŸå ¡ã€‚", lat: 26.5414, lon: 127.9458, duration: "2.5h" },
                { time: "18:00", title: "æ™šé¤ï¼šå¤§å®¶ Ufuya", spotId: "ufuya", icon: "fa-house", note: "ç™¾å¹´å¤å®…é˜¿å¤è±¬ (è¨˜å¾—é ç´„)ã€‚", map: "ç™¾å¹´å¤å®¶ å¤§å®¶", duration: "2h" },
                { time: "20:00", title: "æ‰“åŒ…è¡Œæ", icon: "fa-suitcase", note: "æ˜å¤©è¦é€€æˆ¿å¾€å—äº†ã€‚" }
            ]
        },
        { 
            day: "D6", date: "4/02 (å››)", title: "è³¼ç‰© & æ°´æ—", highlights: "PARCO CITY / DMM / ä½é‚£éœ¸", bg: bgImages.D6, 
            weather: {
                icon: "fa-cloud-rain", temp: "22Â°C - 26Â°C", rain: "40%", uv: "ä½",
                wear: "æ–¹ä¾¿ç©¿è„«çš„é‹ (è©¦ç©¿è¡£æœ)",
                tips: "å®¤å…§è¡Œç¨‹ç‚ºä¸»ï¼Œä¸ç”¨æ“”å¿ƒä¸‹é›¨ã€‚å•†å ´å†·æ°£é€šå¸¸å¾ˆå¼·ã€‚"
            },
            events: [
                { time: "10:30", title: "é€€æˆ¿å¾€å—", icon: "fa-car-side", note: "è¡Œæå…¨ä¸Šè»Šã€‚ç›´å¥”æµ¦æ·»ã€‚", duration: "1h", travel: "ğŸš— 60åˆ†" },
                { time: "11:30", title: "PARCO CITY", spotId: "parco", icon: "fa-bag-shopping", note: "2F ç¾é£Ÿè¡—åˆé¤ & æƒè²¨ (Uniqlo/é˜¿å¡å°‡)ã€‚", map: "SAN-A æµ¦æ·»è¥¿æµ·å²¸ PARCO CITY", mapcode: "33 339 062*55", lat: 26.2642, lon: 127.6934, duration: "2.5h", travel: "ğŸš— 30åˆ† (åˆç¡)" },
                { time: "14:00", title: "ç§»å‹• & åˆç¡", icon: "fa-battery-half", note: "å‰å¾€ DMMï¼Œè»Šä¸Šè®“å¥å¥è£œçœ ã€‚" },
                { time: "15:00", title: "DMM æ°´æ—é¤¨", spotId: "dmm", icon: "fa-fish-fins", note: "iias å•†å ´å…§ã€‚çœ‹æ¨¹æ‡¶ã€æ‘¸é­šã€‚", map: "DMM Kariyushi Aquarium", mapcode: "232 543 400*25", lat: 26.1557, lon: 127.6533, duration: "2h", travel: "ğŸš— 25åˆ†" },
                { time: "17:00", title: "å‰å¾€é‚£éœ¸å¸‚å€", icon: "fa-city", note: "é¿é–‹å°–å³°æ™‚æ®µï¼Œé–‹å›é‚£éœ¸ã€‚", map: "" },
                { time: "17:40", title: "é‚£éœ¸ Check-in", spotId: "daiwa", icon: "fa-hotel", note: "Daiwa Roynet åœ‹éš›é€šã€‚åœ D-Parking 3Fã€‚", map: "Daiwa Roynet Hotel Naha Kokusai-dori", lat: 26.2163, lon: 127.6917, duration: "1h" },
                { time: "19:00", title: "æ™šé¤ï¼šåœ‹éš›é€šç¾é£Ÿ", spotId: "mcdonalds", icon: "fa-burger", note: "ç‰›æ’æˆ–å±…é…’å±‹ã€‚éº¥ç•¶å‹æ˜¯å‚™æ¡ˆã€‚", map: "McDonald's Kokusai Dori Makishi", duration: "1.5h" },
                { time: "20:30", title: "Fontana Gelato", spotId: "fontana", icon: "fa-ice-cream", note: "å½©è™¹å†°æ·‡æ·‹ï¼Œå®Œç¾çµå°¾ã€‚", map: "Fontana Gelato" },
                { time: "21:00", title: "æœ€å¾Œæ‰“åŒ…", icon: "fa-box-open", note: "æˆ°åˆ©å“å¡ç®±å­ï¼Œæª¢æŸ¥è­·ç…§ã€‚" }
            ]
        },
        { 
            day: "D7", date: "4/03 (äº”)", title: "ç¥ˆç¦ & è¿”å®¶", highlights: "æ³¢ä¸Šå®® / Outlet / æ©Ÿå ´", bg: bgImages.D7, 
            weather: {
                icon: "fa-plane", temp: "21Â°C - 25Â°C", rain: "10%", uv: "ä¸­",
                wear: "å¯¬é¬†èˆ’é©çš„è¡£æœ (æ­æ©Ÿ)",
                tips: "å›ç¨‹è¡Œæå¤šï¼Œéš¨èº«åŒ…ç›¡é‡è¼•ä¾¿ï¼Œè¨˜å¾—æª¢æŸ¥è­·ç…§åœ¨ä¸åœ¨èº«ä¸Šã€‚"
            },
            events: [
                { time: "09:00", title: "é€€æˆ¿ & å‡ºç™¼", icon: "fa-suitcase-rolling", note: "è¡Œæå…¨ä¸Šè»Šã€‚", duration: "20m", travel: "ğŸš— 20åˆ†" },
                { time: "09:20", title: "æ³¢ä¸Šå®®", spotId: "naminoue", icon: "fa-torii-gate", note: "è²·å¾¡å®ˆã€å¯«ç¹ªé¦¬ã€‚å»æ©‹ä¸Šæ‹æ‡¸å´–ç¥ç¤¾ã€‚", map: "æ³¢ä¸Šå®®", lat: 26.2206, lon: 127.6713, duration: "1h", travel: "ğŸš— 40åˆ†" },
                { time: "10:30", title: "å‰å¾€è±è¦‹åŸ", icon: "fa-road", note: "å‰å¾€ Outlet æ–¹å‘ã€‚", map: "" },
                { time: "11:10", title: "ASHIBINAA Outlet", spotId: "ashibinaa", icon: "fa-shirt", note: "åˆé¤ (2Fç¾é£Ÿè¡—) + æœ€å¾Œè¡åˆºã€‚", map: "ASHIBINAA Outlet", mapcode: "232 544 452*22", lat: 26.1585, lon: 127.6570, duration: "1.5h", travel: "ğŸš— 5åˆ†" },
                { time: "12:40", title: "åŠ æ²¹ (OTSæ—)", spotId: "gas_station", icon: "fa-gas-pump", note: "å‹™å¿…åŠ æ»¿æ²¹ï¼ä¿ç•™æ”¶æ“šã€‚", map: "ENEOS Dr.Drive Self Toyosaki SS", duration: "20m" },
                { time: "13:00", title: "OTS é‚„è»Š", spotId: "ots_rent", icon: "fa-check-double", note: "é‚„é‘°åŒ™ã€æª¢æŸ¥ ETC æ‹”äº†æ²’ã€‚", map: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€", lat: 26.1558, lon: 127.6534, duration: "45m", travel: "ğŸšŒ æ¥é§ 20åˆ†" },
                { time: "13:45", title: "æŠµé”é‚£éœ¸æ©Ÿå ´", spotId: "oka_airport", icon: "fa-plane", note: "è¾¦ç†ç™»æ©Ÿã€‚é€›å…ç¨…åº—ã€‚", map: "é‚£éœ¸æ©Ÿå ´", lat: 26.2048, lon: 127.6458, duration: "3h" },
                { time: "16:45", title: "æ˜Ÿå®‡ JX303 èµ·é£›", icon: "fa-paper-plane", note: "å›å®¶å›‰ï¼", map: "", travel: "âœˆï¸ é£›è¡Œ" },
                { time: "17:25", title: "æŠµé”å°ä¸­", icon: "fa-house", note: "ç”œèœœçš„å®¶ã€‚", map: "" },
                { time: "æ—…ç¨‹å›é¡§", title: "ğŸ“Š æŸ¥çœ‹æ•¸æ“š", icon: "fa-chart-pie", note: "é»æ“ŠæŸ¥çœ‹é€™è¶Ÿæ—…ç¨‹çš„çµ±è¨ˆ", spotId: null, map: null, action: "openWrapped()" }
            ]
        }
    ];

    // v17.4 ä¿®æ­£: ç¾é£Ÿåœ–ç‰‡é€£çµ (æ›´æ›ç‚ºç©©å®šåœ–æº)
    const foodBoardDB = [
        { name: "æ²–ç¹©éºµ", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Okinawa_soba.jpg/640px-Okinawa_soba.jpg", jp: "æ²–ç¸„ãã°ã‚’ãã ã•ã„", note: "Okinawa Soba" },
        { name: "å¡”å¯é£¯", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Taco_rice.jpg/640px-Taco_rice.jpg", jp: "ã‚¿ã‚³ãƒ©ã‚¤ã‚¹ã‚’ãã ã•ã„", note: "Taco Rice" },
        { name: "ç‚¸è±¬æ’", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Tonkatsu.jpg/640px-Tonkatsu.jpg", jp: "ã¨ã‚“ã‹ã¤ã‚’ãã ã•ã„", note: "Tonkatsu" },
        { name: "è‹¦ç“œç‚’è›‹", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Goya_chanpuru.jpg/640px-Goya_chanpuru.jpg", jp: "ã‚´ãƒ¼ãƒ¤ãƒ¼ãƒãƒ£ãƒ³ãƒ—ãƒ«ãƒ¼ã‚’ãã ã•ã„", note: "Goya Chanpuru" },
        { name: "æµ·è‘¡è„", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/57/Umibudo.jpg/640px-Umibudo.jpg", jp: "æµ·ã¶ã©ã†ã‚’ãã ã•ã„", note: "Umi Budo" },
        { name: "ç‚¸è–¯æ¢", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/French_Fries.JPG/640px-French_Fries.JPG", jp: "ãƒ•ãƒ©ã‚¤ãƒ‰ãƒãƒ†ãƒˆã‚’ãã ã•ã„", note: "Potato" },
        { name: "ç‚’é£¯", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Fried_rice_with_egg%2C_shrimp%2C_and_scallion.jpg/640px-Fried_rice_with_egg%2C_shrimp%2C_and_scallion.jpg", jp: "ãƒãƒ£ãƒ¼ãƒãƒ³ã‚’ãã ã•ã„", note: "Cha-han" },
        { name: "ç‚¸é›", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/90/Karaage_by_jscash_in_Tokyo.jpg/640px-Karaage_by_jscash_in_Tokyo.jpg", jp: "å”æšã’ã‚’ãã ã•ã„", note: "Karaage" },
        { name: "å…’ç«¥é¤", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Okosama_lunch_by_kawanet.jpg/640px-Okosama_lunch_by_kawanet.jpg", jp: "ãŠå­æ§˜ã‚»ãƒƒãƒˆã‚’ãã ã•ã„", note: "Kids Meal" },
        { name: "å†°é–‹æ°´", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/Glass_of_water.jpg/480px-Glass_of_water.jpg", jp: "ãŠæ°´ã‚’ãã ã•ã„", note: "Water" }
    ];
    // æ½®æ±è³‡æ–™ (2026 3æœˆåº•é æ¸¬æ•¸æ“šï¼Œé‚£éœ¸æ¸¯åŸºæº–)
    const tideDB = {
        "D1": { high: "18:40", low: "12:15", sun: "18:38" },
        "D2": { high: "19:15", low: "12:50", sun: "18:39" }, // å¤§æ½®
        "D3": { high: "19:50", low: "13:25", sun: "18:40" },
        "D4": { high: "07:30", low: "14:00", sun: "18:40" },
        "D5": { high: "08:05", low: "14:35", sun: "18:41" },
        "D6": { high: "08:40", low: "15:15", sun: "18:41" },
        "D7": { high: "09:20", low: "16:00", sun: "18:42" }
    };

    // è¨˜å¸³åˆ†é¡å®šç¾©
    const expenseCats = {
        shopping: { name: "è³¼ç‰©", icon: "fa-bag-shopping", color: "#f43f5e" },
        food: { name: "é¤é£²", icon: "fa-utensils", color: "#f97316" },
        transport: { name: "äº¤é€š", icon: "fa-car", color: "#3b82f6" },
        play: { name: "å¨›æ¨‚", icon: "fa-ticket", color: "#8b5cf6" },
        hotel: { name: "ä½å®¿", icon: "fa-bed", color: "#10b981" },
        other: { name: "å…¶ä»–", icon: "fa-box", color: "#64748b" }
    };
    
    // æ¸…å–®è³‡æ–™åº«
    const defaultChecklistDB = [
        { id: "pack", title: "ğŸ’ è¡Œå‰æ‰“åŒ… (å®Œæ•´)", items: [{ text: "è­·ç…§ (å…¨å®¶3æœ¬)", sub: "æ•ˆæœŸéœ€ > 2026/10" }, { text: "é§•ç…§æ­£æœ¬ + æ—¥æ–‡è­¯æœ¬", sub: "OTS å–è»Šå¿…å‚™" }, { text: "Visit Japan Web æˆªåœ–", sub: "å­˜æ‰‹æ©Ÿç›¸ç°¿" }, { text: "ä½å®¿æ†‘è­‰/é›»è©±", sub: "ç¬¬ä¸€æ™š Check-in ç”¨" }, { text: "å¥å¥å®‰æ’«åŒ…", sub: "è²¼ç´™æ›¸ã€è»Ÿç³–ã€è–„å¤–å¥—" }, { text: "è»Šå…§ç™¾å¯¶è¢‹", sub: "é®é™½ç°¾ã€è»Šå……ã€åƒåœ¾è¢‹" }, { text: "3C é›»å­", sub: "è¡Œå‹•é›»æº(éš¨èº«)ã€å……é›»é ­ã€ç·šã€ç›¸æ©Ÿ" }, { text: "ç”Ÿæ´»å‚™è—¥", sub: "é€€ç‡’è—¥ã€ç›Šç”ŸèŒã€é«”æº«è¨ˆã€é¼»å™´åŠ‘" }, { text: "é˜²æ›¬/ç©æ°´", sub: "æ³³è¡£ã€é˜²æ›¬ä¹³ã€å¸½å­ã€å¢¨é¡" }, { text: "é£Ÿç‰©å‰ªåˆ€ (æ‰˜é‹)", sub: "çµ•å°ä¸å¯æ”¾éš¨èº«" }, { text: "è¡£ç‰©å£“ç¸®è¢‹", sub: "å›ç¨‹è£é«’è¡£æœçœç©ºé–“" }, { text: "æŒ‡ç”²å‰ª", sub: "é•·é€”æ—…è¡Œå¿…å‚™" }, { text: "éš¨èº«ç­†", sub: "æ©Ÿä¸Šå¡«å…¥å¢ƒå¡ç”¨" }, { text: "å¤¾éˆè¢‹ (å¤§/ä¸­)", sub: "è£æ¿•æ³³è¡£ã€åˆ†è£é›¶é£Ÿ" }] },
        { id: "shop", title: "ğŸ›ï¸ è³¼ç‰©å¿…è²· (åƒè€ƒåƒ¹)", items: [{ text: "åˆåˆ©ä»–å‘½ EX Plus", sub: "ä½æ¨™: Â¥4980 / å‡åƒ¹: Â¥5500" }, { text: "è‹¥å…ƒéŒ  (Wakamoto)", sub: "ä½æ¨™: Â¥1680 / å‡åƒ¹: Â¥1880" }, { text: "EVE AéŒ  (60éŒ )", sub: "ä½æ¨™: Â¥598 / è—è‰²æ¬¾è¼ƒè²´" }, { text: "Kowa èšŠèŸ²æ­¢ç™¢æ¶²", sub: "åˆ·é ­ç‰ˆ (çµ¦å¥å¥ç”¨)" }, { text: "å¤§å‰µ - å„ç¨®æ³¡æ¾¡çƒ", sub: "AEON åè­·åº—å¿…è²·" }, { text: "å¤§å‰µ - æŒ–æ²™å·¥å…·çµ„", sub: "æµ·é‚Šç©æ²™ç”¨" }, { text: "LuLuLun é¢è†œ", sub: "æ²–ç¹©é™å®š (è‹¦ç“œ/é¦™æª¸)" }, { text: "å®‰è€æ›¬é˜²æ›¬", sub: "é‡‘ç“¶ Â¥2680" }, { text: "Tomica æ²–ç¹©é™å®šè»Š", sub: "PARCO / æ©Ÿå ´" }, { text: "è¾£å‘³è¦é¤… (å—é¢¨å ‚)", sub: "ä¸‹é…’é›¶é£Ÿ" }, { text: "é‚ŠéŠ€é£Ÿå ‚è¾£æ²¹", sub: "çŸ³å£å³¶åç”¢" }, { text: "Calbee éº¥ç‰‡", sub: "ç´…è‰²åŒ…è£æœ€ç¶“å…¸" }, { text: "Orihiro è’Ÿè’»æœå‡", sub: "è¢‹è£å¥½æ”œå¸¶ (è¦æ‰˜é‹)" }, { text: "ROIHI ç©´ä½è²¼å¸ƒ", sub: "è€äººé ­åƒ (æ¶¼æ„Ÿ/æº«æ„Ÿ)" }, { text: "Fino é«®è†œ/é«®æ²¹", sub: "æ—¥æœ¬è²·å¾ˆä¾¿å®œ" }] },
        { id: "return", title: "ğŸš¨ å›ç¨‹é˜²å‘† (SOP)", items: [{ text: "ETC å¡æ‹”äº†å—ï¼Ÿ", sub: "é‚„è»Šå‰ç¢ºèª (æœ€å¸¸å¿˜è¨˜)" }, { text: "è»Šå……é ­æ‹”äº†å—ï¼Ÿ", sub: "é‚„è»Šå‰ç¢ºèª" }, { text: "é–€é‚Šåƒåœ¾/ç©å…·æ¸…ç©ºï¼Ÿ", sub: "é‚„è»Šå‰ç¢ºèª" }, { text: "æ²¹åŠ æ»¿äº†å—ï¼Ÿ", sub: "ä¿ç•™æ”¶æ“šçµ¦åº—å“¡" }, { text: "å¸ƒä¸/æœå‡ æ‰˜é‹äº†å—ï¼Ÿ", sub: "æ¶²é«” > 100ml ä¸å¯æ‰‹æ" }, { text: "æ´—é¢ä¹³/ç‰™è† æ‰˜é‹äº†å—ï¼Ÿ", sub: "é€™ä¹Ÿæ˜¯æ¶²é«”ï¼" }, { text: "è­·ç…§æ‹¿å‡ºä¾†äº†å—ï¼Ÿ", sub: "ä¸è¦é–åœ¨é£¯åº—ä¿éšªç®±" }, { text: "Wifiæ©Ÿ/SIMå¡é‡", sub: "ç¢ºèªæ”¶å¥½" }, { text: "è¡Œæç§¤é‡", sub: "ç¢ºèªæ²’è¶…é‡ (å–®ä»¶23kg?)" }, { text: "èº«ä¸Šé›¶éŒ¢èŠ±å…‰", sub: "æ©Ÿå ´æ‰­è›‹æ©Ÿ/ä¾¿åˆ©å•†åº—" }] }
    ];
    let checklistDB = JSON.parse(localStorage.getItem('trip_checklist_db')) || defaultChecklistDB;

    // ä»»å‹™è³‡æ–™åº« (å« GPS åº§æ¨™)
    const missionsDB = [
        { id: "m1", title: "æˆ‘æ˜¯èˆ¹é•·", desc: "åœ¨ç»ç’ƒèˆ¹æ‰¾åˆ°å°¼è«", icon: "fa-fish", lat: 26.5278, lon: 127.9306 }, // æµ·ä¸­å…¬åœ’
        { id: "m2", title: "æµ·æ´‹éœ¸ä¸»", desc: "è·Ÿå¤§é¯¨é¯Šæ‹åˆç…§", icon: "fa-camera", lat: 26.6943, lon: 127.8779 }, // æ°´æ—é¤¨
        { id: "m3", title: "å°å°å‹‡è€…", desc: "æ£®æ—æ¢éšªæ‹¯æ•‘æé¾", icon: "fa-dragon", lat: 26.6267, lon: 127.9620 }, // æé¾å…¬åœ’
        { id: "m4", title: "é³¥é³¥é»å", desc: "æ­å°ç«è»Šæ•¸å‡º3ç¨®é³¥", icon: "fa-crow", lat: 26.5986, lon: 127.9733 }, // Neo Park
        { id: "m5", title: "æµ·åº•å°‹å¯¶", desc: "åœ¨é€æ˜åœ°æ¿æ‰¾åˆ°é­š", icon: "fa-water", lat: 26.5278, lon: 127.9306 }, // æµ·ä¸­å…¬åœ’
        { id: "m6", title: "èª å¿ƒç¥ˆç¦", desc: "åœ¨ç¥ç¤¾æŠ•ç¡¬å¹£èªªè¬è¬", icon: "fa-hands-praying", lat: 26.2206, lon: 127.6713 } // æ³¢ä¸Šå®®
    ];

    // å·¥å…·è³‡æ–™åº« (éœæ…‹å…§å®¹)
    const toolsDB = {
        drive: [
            { title: "å³é§•å£è¨£", content: "å·¦è½‰å°å½ã€å³è½‰å¤§å½<br>é›¨åˆ·åœ¨å·¦ã€æ–¹å‘ç‡ˆåœ¨å³", color: "bg-blue-50 text-blue-800" },
            { title: "åŠ æ²¹é‡‘å¥", content: "Regular æ»¿æ²¹ (ç´…æ§)<br>ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æº€ã‚¿ãƒ³<br>(Regyuraa mantan)", color: "bg-orange-50 text-orange-800" },
            { title: "å°èˆªè¨­å®š", content: "åœè»Šè«‹æ‰¾ ğŸ…¿ï¸ (P)<br>è¼¸å…¥ MapCode æœ€æº–", color: "bg-slate-100 text-slate-800" }
        ],
        signs: [
            { icon: "ğŸ”»", title: "æ­¢ã¾ã‚Œ (åœ)", desc: "ä¸€å®šè¦å®Œå…¨ç…åœï¼Œå·¦å³çœ‹ï¼Œæ•¸3ç§’å†é–‹ã€‚", color: "text-red-600" },
            { icon: "â›”", title: "é€²å…¥ç¦æ­¢", desc: "å–®è¡Œé“å‡ºå£ï¼Œä¸å¯é€²å…¥ã€‚", color: "text-red-600" },
            { icon: "ğŸš¥", title: "ç´…ç‡ˆ+ç¶ ç®­é ­", desc: "ç´…ç‡ˆåœï¼Œä½†ã€Œç¶ è‰²ç®­é ­ã€æŒ‡çš„æ–¹å‘å¯ä»¥èµ° (å³è½‰è»Šå…é©š)ã€‚", color: "text-green-600" },
            { icon: "ğŸŸ¡", title: "é–ƒçˆé»ƒç‡ˆ", desc: "æ³¨æ„å®‰å…¨ï¼Œæ¸›é€Ÿé€šéã€‚", color: "text-yellow-500" },
            { icon: "ğŸ”´", title: "é–ƒçˆç´…ç‡ˆ", desc: "ç­‰åŒã€Œæ­¢ã¾ã‚Œã€ï¼Œéœ€å®Œå…¨ç…åœå†é–‹ã€‚", color: "text-red-500" },
            { icon: "ğŸ…¿ï¸", title: "é§è»Šç¦æ­¢", desc: "é•åœç½°æ¬¾å¾ˆé‡ï¼Œè«‹æ‰¾æ”¶è²»åœè»Šå ´ã€‚", color: "text-blue-600" }
        ],
        jp: [
            { label: "ğŸ‘¶ è¦ªå­è‚²å…’", items: [{ t: "æœ‰å…’ç«¥é¤å—?", j: "å­ã©ã‚‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹?", p: "Kodomo menyu wa..." }, { t: "å¯ä»¥æ›å°¿å¸ƒå—?", j: "ãŠã‚€ã¤ã‚’æ›¿ãˆã¦ã‚‚ã„ã„ã§ã™ã‹?", p: "Omutsu o kaete..." }, { t: "å“ºä¹³å®¤åœ¨å“ªè£¡?", j: "æˆä¹³å®¤ã¯ã©ã“ã§ã™ã‹?", p: "Junyu-shitsu wa..." }, { t: "å¯ä»¥ç”¨æ¨è»Šå—?", j: "ãƒ™ãƒ“ãƒ¼ã‚«ãƒ¼ã¯ä½¿ãˆã¾ã™ã‹?", p: "Bebi ka wa..." }] },
            { label: "ğŸ½ï¸ é¤å»³ç”¨é¤", items: [{ t: "è«‹çµ¦æˆ‘æ°´", j: "ãŠæ°´ã‚’ãã ã•ã„", p: "Omizu o kudasai" }, { t: "æ¨è–¦æ–™ç†æ˜¯ä»€éº¼?", j: "ãŠã™ã™ã‚ã®æ–™ç†ã¯ä½•ã§ã™ã‹?", p: "Osusume no..." }, { t: "æˆ‘è¦å¤–å¸¶", j: "æŒã¡å¸°ã‚Šã«ã§ãã¾ã™ã‹", p: "Mochi-kaeri ni..." }, { t: "æˆ‘è¦çµå¸³", j: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™", p: "Okaikei o onegai" }] },
            { label: "ğŸ›ï¸ ä½å®¿ & è³¼ç‰©", items: [{ t: "å¯ä»¥è©¦ç©¿å—?", j: "ã“ã‚Œã‚’è©¦ç€ã§ãã¾ã™ã‹?", p: "Kore o shichaku..." }, { t: "å¯ä»¥åˆ·å¡å—?", j: "ã‚«ãƒ¼ãƒ‰ã§æ‰•ãˆã¾ã™ã‹?", p: "Kado de haraemasu..." }, { t: "æˆ‘è¦è¾¦ç†å…¥ä½", j: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’ãŠé¡˜ã„ã—ã¾ã™", p: "Check-in o onegai" }, { t: "è«‹å†çµ¦æˆ‘ä¸€æ¢æ¯›å·¾", j: "ã‚‚ã†ä¸€æšã‚¿ã‚ªãƒ«ã‚’ãã ã•ã„", p: "Mo ichimai taoru..." }] }
        ],
        orders: [
            { icon: "âŒğŸ§…", title: "ä¸è¦è”¥", jp: "ãƒã‚®æŠœãã§", sub: "Negi nuki" },
            { icon: "âŒğŸ§Š", title: "å»å†°", jp: "æ°·ãªã—ã§", sub: "Koori nashi" },
            { icon: "ğŸ‘¶ğŸ´", title: "å…’ç«¥é¤å…·", jp: "å­ä¾›ç”¨é£Ÿå™¨", sub: "Kodomo shokki" },
            { icon: "ğŸ§‚â¬‡ï¸", title: "å‘³é“æ·¡ä¸€é»", jp: "å‘³è–„ã‚ã§", sub: "Aji usume" },
            { icon: "ğŸ’³", title: "ç”¨å¡çµå¸³", jp: "ã‚«ãƒ¼ãƒ‰ã§", sub: "Card de" }
        ],
        coins: [
            { val: 500, color: "coin-500", twd: "110", desc: "æœ€å¤§é‡‘å¹£" },
            { val: 100, color: "coin-100", twd: "22", desc: "æœ€å¸¸ç”¨/æ‰­è›‹" },
            { val: 50, color: "coin-50", twd: "11", desc: "éŠ€è‰²æœ‰æ´" },
            { val: 10, color: "coin-10", twd: "2", desc: "éŠ…è‰²" },
            { val: 5, color: "coin-5", twd: "1", desc: "é‡‘è‰²æœ‰æ´ (çµç·£)" },
            { val: 1, color: "coin-1", twd: "0.2", desc: "è¶…è¼• (é‹)" }
        ],
        sizes: [
            { label: "2-3æ­²", h: "90-95cm", us: "3T", shoe: "14-15" },
            { label: "3-4æ­²", h: "100cm", us: "4T", shoe: "16" },
            { label: "5-6æ­²", h: "110-120cm", us: "5-6", shoe: "17-18" },
            { label: "7-8æ­²", h: "130cm", us: "7-8", shoe: "19-20" }
        ],
        sos: [
            { name: "æ•‘è­·è»Š / ç«è­¦", tel: "119", style: "bg-red-500 text-white" }, { name: "å ±è­¦ (è»Šç¦)", tel: "110", style: "bg-blue-600 text-white" },
            { name: "OTS ç§Ÿè»Šæ•‘æ´", tel: "098-856-8877", style: "bg-green-600 text-white" }, { name: "å¤–äº¤éƒ¨æ€¥é›£æ•‘åŠ©", tel: "080-8056-0122", style: "bg-gray-700 text-white" },
            { name: "åè­·åŒ—éƒ¨é†«é™¢", tel: "0980-52-2719", style: "bg-white border text-gray-800" }, { name: "é‚£éœ¸å—éƒ¨é†«ç™‚", tel: "098-888-0123", style: "bg-white border text-gray-800" }
        ]
    };

    const allergyDict = { "egg": { label: "é›è›‹ (åµ)", jp: "åµ (Tamago)" }, "milk": { label: "ç‰›å¥¶ (ä¹³)", jp: "ç‰›ä¹³ (Gyu-nyu)" }, "peanut": { label: "èŠ±ç”Ÿ (è½èŠ±ç”Ÿ)", jp: "è½èŠ±ç”Ÿ (Rakkasei)" }, "shrimp": { label: "è¦ (æµ·è€)", jp: "ã‚¨ãƒ“ (Ebi)" }, "crab": { label: "èŸ¹ (èŸ¹)", jp: "ã‚«ãƒ‹ (Kani)" }, "wheat": { label: "å°éº¥ (å°éº¦)", jp: "å°éº¦ (Komugi)" } };
    const sosMessages = { sick: { jp: "å­ä¾›ãŒç—…æ°—ã§ã™", en: "My child is sick.", note: "å°å­©ç”Ÿç—…äº†" }, lost: { jp: "é“ã«è¿·ã„ã¾ã—ãŸ", en: "I am lost.", note: "æˆ‘è¿·è·¯äº†" }, police: { jp: "è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„", en: "Call the police!", note: "è«‹å«è­¦å¯Ÿ" }, ambulance: { jp: "æ•‘æ€¥è»Šã‚’å‘¼ã‚“ã§ãã ã•ã„", en: "Call an ambulance!", note: "è«‹å«æ•‘è­·è»Š" } };
	// ================= 2. é‚è¼¯èˆ‡åŠŸèƒ½ (LOGIC) =================

    function init() {
        if(isRainyMode) updateRainyModeUI();
        switchTab('itinerary');
        updateCountdown();
        setInterval(updateCountdown, 60000);
        initWeather();
        checkDailyPopup();
        // v17.0: å¦‚æœæœ‰å„²å­˜çš„æ—¥è¨˜ï¼Œå¯ä»¥åœ¨é€™è£¡é è¼‰ (ç›®å‰æ˜¯ localStorage è‡ªå‹•è®€å–)
    }

    // å¤©æ°£æ¨¡çµ„ (v16.0 æ›´æ–°: åŠ å…¥ checkGeofence)
    function initWeather() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    fetchWeather(lat, lon, "ç›®å‰ä½ç½®");
                    checkGeofence(lat, lon); // æª¢æŸ¥æ˜¯å¦åˆ°é”ä»»å‹™é»
                    updateDinoGPS(lat, lon); // v17.0: æ›´æ–°å°æé¾ä½ç½®
                },
                (error) => fetchWeather(26.5915, 127.9773, "åè­·å¸‚")
            );
        } else { fetchWeather(26.5915, 127.9773, "åè­·å¸‚"); }
    }

    async function fetchWeather(lat, lon, label) {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            const temp = Math.round(data.current_weather.temperature);
            const code = data.current_weather.weathercode;
            document.getElementById('weather-temp').innerText = temp + "Â°C";
            document.getElementById('weather-loc').innerText = label;
            const iconEl = document.getElementById('weather-icon');
            if (code <= 1) iconEl.className = "fas fa-sun text-xl mb-1 block text-yellow-400";
            else if (code <= 3) iconEl.className = "fas fa-cloud-sun text-xl mb-1 block text-yellow-400";
            else if (code <= 65) iconEl.className = "fas fa-cloud-rain text-xl mb-1 block text-blue-300";
            else iconEl.className = "fas fa-bolt text-xl mb-1 block text-yellow-500";
            
            // v17.0: æ›´æ–°ç›¸æ©Ÿæµ®æ°´å°çš„å¤©æ°£
            document.getElementById('cam-weather-val').innerText = `${temp}Â°C`;
        } catch (e) {
            document.getElementById('weather-temp').innerText = "24Â°C";
            document.getElementById('weather-loc').innerText = "é å ±";
        }
    }

    function updateCountdown() {
        const tripStart = new Date(`${TRIP_YEAR}-03-28T13:15:00`).getTime();
        const tripEnd = new Date(`${TRIP_YEAR}-04-03T23:59:59`).getTime();
        const now = new Date().getTime();
        const el = document.getElementById('countdown');
        if (now < tripStart) {
            const diff = tripStart - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            el.innerText = `é‚„æœ‰ ${days} å¤© ${hours} å°æ™‚`;
            el.className = "text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10";
        } else if (now >= tripStart && now <= tripEnd) {
            el.innerText = "âœˆï¸ æ—…ç¨‹é€²è¡Œä¸­";
            el.className = "text-[10px] font-bold opacity-100 bg-pink-500/80 text-white px-2 py-0.5 rounded-md animate-pulse";
        } else {
            el.innerText = "å›æ†¶æ»¿è¼‰ â¤ï¸";
            el.className = "text-[10px] font-medium opacity-90 bg-gray-500/50 px-2 py-0.5 rounded-md";
        }
    }

    // é é¢åˆ‡æ›
    window.switchTab = (tab, shouldRender = true) => {
        activeTab = tab;
        document.querySelectorAll('.nav-btn').forEach(btn => {
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            const box = btn.querySelector('.icon-box');
            if (btn.id === `btn-${tab}`) {
                icon.className = icon.className.replace('text-gray-400', 'text-blue-600');
                span.className = 'text-[10px] font-bold text-blue-600';
                box.className = 'icon-box p-2 rounded-2xl mb-1 transition-all bg-blue-50';
            } else {
                let defaultIcon = 'toolbox';
                if (btn.id.includes('itinerary')) defaultIcon = 'map-location-dot';
                if (btn.id.includes('checklist')) defaultIcon = 'clipboard-list';
                if (btn.id.includes('missions')) defaultIcon = 'medal';
                icon.className = `fas fa-${defaultIcon} text-xl text-gray-400`;
                span.className = 'text-[10px] font-bold text-gray-400';
                box.className = 'icon-box p-2 rounded-2xl mb-1 transition-all';
            }
        });
        
        renderHeaderSubNav();
        if (shouldRender) renderContent();
        setTimeout(updateSubNavStyle, 50);
    }
    
    window.switchChecklist = (id) => { currentChecklistFilter = id; renderContent(); updateSubNavStyle(); }
    window.switchTool = (id) => { currentToolFilter = id; renderContent(); updateSubNavStyle(); }
    
    function updateSubNavStyle() {
        if (activeTab === 'checklist') {
            checklistDB.forEach(c => {
                const btn = document.getElementById(`btn-chk-${c.id}`);
                if (btn) btn.className = currentChecklistFilter === c.id ?
                    "flex-1 py-2 rounded-xl text-xs font-bold transition-all bg-white text-blue-600 shadow-sm" :
                    "flex-1 py-2 rounded-xl text-xs font-bold transition-all text-white/80";
            });
        } else if (activeTab === 'tools') {
            // v18.2 ä¿®æ­£ï¼šæ›´æ–°ç‚ºå››å¤§åˆ†é¡çš„ ID (money, drive, food, gadget)
            ['money', 'drive', 'food', 'gadget'].forEach(t => { 
                const btn = document.getElementById(`btn-tool-${t}`);
                if (btn) {
                    let c = "bg-white text-blue-600";
                    // å®šç¾©æ¯å€‹æŒ‰éˆ•è¢«é¸ä¸­æ™‚çš„é¡è‰²
                    if (t === 'money') c = "bg-white text-pink-600 shadow-sm";
                    if (t === 'drive') c = "bg-white text-blue-600 shadow-sm";
                    if (t === 'food') c = "bg-white text-orange-600 shadow-sm";
                    if (t === 'gadget') c = "bg-white text-purple-600 shadow-sm";
                    
                    // åˆ¤æ–·æ˜¯å¦ç‚ºç•¶å‰é¸ä¸­çš„å·¥å…·ï¼Œçµ¦äºˆå°æ‡‰æ¨£å¼
                    btn.className = currentToolFilter === t ?
                        `flex-1 py-2 rounded-xl text-xs font-bold transition-all ${c}` :
                        "flex-1 py-2 rounded-xl text-xs font-bold transition-all text-white/80";
                }
            });
        }
    }

    // æ¸²æŸ“ä¸Šæ–¹å­é¸å–®
    function renderHeaderSubNav() {
        const container = document.getElementById('sub-nav-container');
        if (activeTab === 'itinerary') {
            container.innerHTML = `<div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar px-2">${itineraryDB.map((d, i) => `<button onclick="currentDayIdx=${i}; renderContent(); updateHeaderActive()" class="day-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md transition-all duration-300 ${i === currentDayIdx ? 'tab-active' : 'tab-inactive'}"><div class="text-[10px] opacity-80 uppercase">${d.day}</div><div>${d.date.split(' ')[0]}</div></button>`).join('')}</div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${itineraryDB[currentDayIdx].bg}')`;
        } else if (activeTab === 'checklist') {
            container.innerHTML = `<div class="flex glass-dark p-1 rounded-2xl mx-1">${checklistDB.map(c => `<button id="btn-chk-${c.id}" onclick="switchChecklist('${c.id}')" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentChecklistFilter === c.id ? 'bg-white text-blue-600 shadow-sm' : 'text-white/80'}">${c.title.split(' ')[1]}</button>`).join('')}</div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${bgImages.SHOP}')`;
        } else if (activeTab === 'tools') {
            // v18.1: æ”¹ç‚ºå››å¤§åˆ†é¡é¸å–®
            container.innerHTML = `
            <div class="flex glass-dark p-1 rounded-2xl mx-1">
                <button id="btn-tool-money" onclick="switchTool('money')" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentToolFilter==='money'?'bg-white text-pink-600 shadow-sm':'text-white/80'}">ğŸ’° æ¶ˆè²»</button>
                <button id="btn-tool-drive" onclick="switchTool('drive')" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentToolFilter==='drive'?'bg-white text-blue-600 shadow-sm':'text-white/80'}">ğŸš— äº¤é€š</button>
                <button id="btn-tool-food" onclick="switchTool('food')" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentToolFilter==='food'?'bg-white text-orange-600 shadow-sm':'text-white/80'}">ğŸ± ç”¨é¤</button>
                <button id="btn-tool-gadget" onclick="switchTool('gadget')" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentToolFilter==='gadget'?'bg-white text-purple-600 shadow-sm':'text-white/80'}">ğŸ› ï¸ å·¥å…·</button>
            </div>`;
            
            // è¨­å®šèƒŒæ™¯åœ–
            let bg = bgImages.TOOL; // é è¨­
            if (currentToolFilter === 'money') bg = bgImages.SHOP;
            if (currentToolFilter === 'drive') bg = "https://images.unsplash.com/photo-1449965408869-eaa3f722e40d?q=80&w=1000&fit=crop";
            if (currentToolFilter === 'food') bg = "https://images.unsplash.com/photo-1569058242253-92a9c755a0ec?q=80&w=1000&fit=crop";
            if (currentToolFilter === 'gadget') bg = bgImages.SYNC;
            
            document.getElementById('bg-layer').style.backgroundImage = `url('${bg}')`;
        } else if (activeTab === 'missions') {
            container.innerHTML = `<div class="text-center text-white/90 text-sm font-bold pt-2 drop-shadow-md">å®Œæˆä»»å‹™ç²å¾—ä»£å¹£ï¼</div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${bgImages.MISSION}')`;
        }
    }

    function updateHeaderActive() {
        document.querySelectorAll('.day-btn').forEach((btn, i) => {
            btn.className = `day-btn flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md transition-all duration-300 ${i === currentDayIdx ? 'tab-active' : 'tab-inactive'}`;
        });
        document.getElementById('bg-layer').style.backgroundImage = `url('${itineraryDB[currentDayIdx].bg}')`;
        // v17.0: åˆ·æ–°å°æé¾ä½ç½®
        if(navigator.geolocation) {
             navigator.geolocation.getCurrentPosition((p) => updateDinoGPS(p.coords.latitude, p.coords.longitude));
        }
    }

    // æ¸²æŸ“ä¸»å…§å®¹
    function renderContent() {
        const main = document.getElementById('main-scroll');
        
        // 1. è¡Œç¨‹ (Itinerary) - æ•´åˆå¤©æ°£ v17.5 + åœ°åœ– v18.0
        if (activeTab === 'itinerary') {
            const d = itineraryDB[currentDayIdx];
            const diaryKey = `diary_${d.day}`;
            const savedDiary = localStorage.getItem(diaryKey) || "";
            
            // å–å¾—æ—¥è½è³‡è¨Š (é˜²å‘†: è‹¥ç„¡è³‡æ–™å‰‡é è¨­ 18:40)
            const tideInfo = tideDB[d.day] || { sun: "18:40" };

            // æ±ºå®šå¤©æ°£ ICON é¡è‰²
            let weatherColor = "text-yellow-400"; // é è¨­æ™´å¤©é»ƒ
            if(d.weather && d.weather.icon.includes('rain')) weatherColor = "text-blue-400";
            if(d.weather && d.weather.icon.includes('cloud')) weatherColor = "text-gray-400";
            if(d.weather && d.weather.icon.includes('wind')) weatherColor = "text-teal-400";
            if(d.weather && d.weather.icon.includes('plane')) weatherColor = "text-purple-400";

            main.innerHTML = `
            <div class="animate-slide-up">
                <div class="glass-card rounded-3xl p-5 mb-4 relative overflow-hidden border-l-4 border-blue-500 shadow-lg">
                    
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex flex-col">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded-md shadow-sm">Day ${currentDayIdx + 1}</span>
                                <h2 class="text-2xl font-black text-gray-800 tracking-tight">${d.date}</h2>
                            </div>
                            <div class="text-sm font-bold text-gray-500">${d.title}</div>
                        </div>
                        
                        <div class="flex flex-col items-end">
                             ${d.weather ? `
                                <div class="flex items-center gap-1">
                                    <i class="fas ${d.weather.icon} ${weatherColor} text-2xl drop-shadow-sm"></i>
                                    <span class="text-lg font-black text-gray-700">${d.weather.temp.split(' ')[0]}</span>
                                </div>
                                <div class="text-[10px] font-bold text-gray-400 mt-1">é™é›¨ ${d.weather.rain}</div>
                             ` : ''}
                        </div>
                    </div>

                    ${d.weather ? `
                    <div class="bg-blue-50/80 rounded-xl p-3 mb-3 border border-blue-100 flex flex-col gap-2">
                        <div class="flex items-start gap-2">
                            <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-blue-500 shadow-sm shrink-0 mt-0.5">
                                <i class="fas fa-tshirt text-sm"></i>
                            </div>
                            <div>
                                <div class="text-[9px] text-gray-400 font-bold uppercase tracking-wide">OOTD ç©¿æ­å»ºè­°</div>
                                <div class="text-sm font-bold text-blue-900 leading-tight">${d.weather.wear}</div>
                            </div>
                        </div>
                        
                        <div class="w-full h-px bg-blue-200/50 dashed my-1"></div>

                        <div class="flex justify-between items-center px-1">
                            <div class="flex items-center gap-1.5" title="ç´«å¤–ç·š">
                                <i class="fas fa-sun text-orange-400 text-xs"></i>
                                <span class="text-xs font-bold text-gray-600">UV: ${d.weather.uv}</span>
                            </div>
                            <div class="w-px h-3 bg-blue-200"></div>
                            <div class="flex items-center gap-1.5" title="æ—¥è½æ™‚é–“">
                                <i class="fas fa-cloud-moon text-purple-400 text-xs"></i>
                                <span class="text-xs font-bold text-gray-600">æ—¥è½ ${tideInfo.sun}</span>
                            </div>
                        </div>
                        
                        ${d.weather.tips ? `
                        <div class="mt-1 text-[10px] text-blue-600 bg-white/60 px-2 py-1.5 rounded-lg flex items-start gap-1">
                            <i class="fas fa-circle-info mt-0.5"></i> ${d.weather.tips}
                        </div>` : ''}
                    </div>
                    ` : ''}

                    <div id="day-map-container" class="w-full h-40 bg-slate-100 rounded-2xl mb-3 border border-slate-200 shadow-inner z-0 relative overflow-hidden"></div>

                    <div class="text-sm bg-white p-3 rounded-xl border border-slate-100 text-gray-700 flex items-start gap-2 shadow-sm">
                        <i class="fas fa-star text-yellow-400 mt-0.5 text-lg"></i> 
                        <span class="font-bold pt-0.5">${d.highlights}</span>
                    </div>
                </div>
                
                <div class="space-y-4">
                 ${d.events.map((e, idx) => {
                        const isRainyItem = isRainyMode && e.rainy;
                        const current = isRainyItem ? { ...e, ...e.rainy } : e;
                        const badge = isRainyItem ? `<span class="absolute top-2 right-2 bg-blue-500 text-white text-[9px] px-2 py-0.5 rounded-full"><i class="fas fa-umbrella mr-1"></i>é›¨å¤©å‚™æ¡ˆ</span>` : "";
                        const mapLink = current.map ? `http://maps.google.com/?q=${encodeURIComponent(current.map)}` : null;
                        const shareBtn = `<button onclick="shareEvent('${current.title}', '${current.mapcode || ''}', '${current.note || ''}')" class="glass px-3 py-1.5 rounded-full text-xs text-green-600 font-bold border border-green-100 active:bg-green-50"><i class="fas fa-share-nodes mr-1"></i>åˆ†äº«</button>`;
                        const isLast = idx === d.events.length - 1;
                        const travelHtml = (current.travel && !isLast) ? `<div class="travel-pill">${current.travel}</div>` : '';
                        const durationTag = current.duration ? `<span class="text-xs bg-pink-100 text-pink-600 px-2 py-1 rounded-md ml-2 font-bold shadow-sm"><i class="fas fa-clock mr-1"></i>åœç•™ ${current.duration}</span>` : '';
                        const titleHtml = current.spotId 
                            ? `<div onclick="openSpotModal('${current.spotId}')" class="font-bold text-blue-600 text-lg cursor-pointer hover:underline decoration-blue-300 underline-offset-4 decoration-2 flex items-center gap-1">${current.title} <i class="fas fa-circle-info text-xs opacity-50"></i></div>`
                            : `<h3 class="font-bold text-gray-800 text-lg" ${current.action ? `onclick="${current.action}"` : ''}>${current.title}</h3>`;

                        return `
                        <div class="relative group event-card-container">
                            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-4 relative z-10 overflow-hidden transition-all active:scale-[0.98] ${isRainyItem ? "border-l-4 border-blue-400 bg-blue-50/50" : ""}">
                                ${badge}
                                <div class="flex flex-col items-center gap-2 mt-1 min-w-[3.5rem]">
                                    <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-50 to-indigo-50 text-blue-600 flex items-center justify-center text-xl shadow-inner border border-white z-10 relative">
                                        <i class="fas ${current.icon}"></i>
                                    </div>
                                </div>
                                <div class="flex-1 py-1 min-w-0">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="flex items-center">
                                            <h3 class="font-bold text-gray-800 text-lg mr-1">${current.time}</h3>
                                        </div>
                                        <div class="flex gap-2 shrink-0">
                                            ${shareBtn}
                                            ${mapLink ? `<a href="${mapLink}" target="_blank" class="glass px-3 py-1.5 rounded-full text-xs text-blue-600 font-bold border border-blue-100 active:bg-blue-50"><i class="fas fa-location-arrow mr-1"></i> GO</a>` : ''}
                                        </div>
                                    </div>
                                    <div class="flex items-center flex-wrap mb-2 gap-y-1">
                                        ${titleHtml}
                                        ${durationTag}
                                    </div>
                                    ${current.note ? `<p class="text-xs text-gray-500 bg-slate-50 p-2 rounded-lg border border-slate-100 leading-relaxed"><i class="fas fa-info-circle mr-1 text-blue-400"></i>${current.note}</p>` : ''}
                                    ${current.mapcode ? `<div onclick="copyMapCode('${current.mapcode}')" class="mt-2 text-[10px] inline-block bg-yellow-50 text-yellow-700 px-2 py-1 rounded border border-yellow-200 cursor-pointer active:bg-yellow-100"><i class="fas fa-hashtag mr-1"></i>MapCode: ${current.mapcode}</div>` : ''}
                                </div>
                            </div>
                            
                            ${current.travel ? `<div class="timeline-connector"><div class="travel-pill">${current.travel}</div></div>` : '<div class="timeline-connector" style="border:none"></div>'}
                        </div>`;
                }).join('')}
                </div>
                
                <div class="mt-4 bg-yellow-50 p-4 rounded-2xl border border-yellow-200 relative mb-6">
                    <label class="text-[10px] font-bold text-yellow-600 uppercase mb-1 block"><i class="fas fa-pen-nib mr-1"></i> ä»Šæ—¥éš¨ç­† (One-Line Diary)</label>
                    <textarea id="diary-textarea" class="w-full bg-transparent border-none text-sm text-gray-700 focus:ring-0 p-0 resize-none h-16 leading-relaxed focus:outline-none" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼å¥½ç¬‘çš„äº‹ï¼Ÿ(è‡ªå‹•å„²å­˜)" oninput="localStorage.setItem('${diaryKey}', this.value)">${savedDiary}</textarea>
                    <div class="text-right mt-1"><button onclick="toggleVoiceMemo()" class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full"><i class="fas fa-microphone mr-1"></i>èªéŸ³è¼¸å…¥</button></div>
                </div>
                <div class="h-12"></div>
            </div>`;

            // v18.0: å»¶é²è¼‰å…¥åœ°åœ– (å› ç‚ºè¦ç­‰ä¸Šé¢ innerHTML æ¸²æŸ“å®Œï¼Œåœ°åœ–å®¹å™¨å‡ºç¾å¾Œæ‰èƒ½ç•«åœ°åœ–)
            setTimeout(initDayMap, 100);		
        } else if (activeTab === 'checklist') {
            const list = checklistDB.find(c => c.id === currentChecklistFilter);
            main.innerHTML = `
            <div class="animate-slide-up glass-card rounded-3xl p-6 min-h-[60vh]">
                <h3 class="font-bold text-xl mb-6 text-gray-800 border-b pb-4 border-gray-100 flex items-center gap-2">
                    <span class="w-1.5 h-6 bg-blue-500 rounded-full"></span>${list.title}
                </h3>
                <div class="space-y-3">
                    ${list.items.map((item, i) => { 
                        const key = `chk_${currentChecklistFilter}_${item.text}`; 
                        const isChecked = localStorage.getItem(key) === '1'; 
                        const textStyle = isChecked ? 'text-gray-400 line-through' : 'text-gray-700'; 
                        return `<div class="flex items-start gap-2 group"><label class="flex-1 flex items-start gap-3 p-3 rounded-2xl transition-all border border-transparent hover:bg-slate-50 cursor-pointer select-none border-slate-100 shadow-sm bg-white"><div class="relative flex items-center mt-0.5"><input type="checkbox" class="custom-checkbox peer appearance-none w-6 h-6 border-2 border-slate-300 rounded-lg transition-all checked:bg-blue-500 checked:border-blue-500" ${isChecked ? 'checked' : ''} onchange="toggleCheck('${key}')"><i class="fas fa-check text-white absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 opacity-0 peer-checked:opacity-100 text-xs pointer-events-none"></i></div><div class="flex-1"><div class="font-bold transition-colors text-[15px] ${textStyle}">${item.text}</div>${item.sub ? `<div class="text-xs text-gray-400 mt-0.5">${item.sub}</div>` : ''}</div></label><button onclick="deleteChecklistItem(${i})" class="mt-3 w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-500 active:scale-90 transition-all rounded-full hover:bg-red-50"><i class="fas fa-trash-alt"></i></button></div>`; 
                    }).join('')}
                </div>
                <button onclick="addChecklistItem()" class="w-full mt-4 py-3 border-2 border-dashed border-gray-300 rounded-2xl text-gray-500 font-bold hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all active:scale-[0.98]"><i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®</button>
                <div class="mt-8 pt-4 border-t border-gray-100"><button onclick="resetChecklist('${currentChecklistFilter}')" class="w-full py-4 bg-slate-50 rounded-2xl text-xs text-gray-400 font-bold tracking-wide active:bg-slate-100 mb-2"><i class="fas fa-rotate-right mr-1"></i> é‡ç½®å‹¾é¸ç‹€æ…‹</button><button onclick="openGiftModal()" class="w-full py-4 bg-red-50 text-red-500 rounded-2xl text-lg font-bold shadow-sm active:scale-95 border border-red-100"><i class="fas fa-gift mr-2"></i> ç®¡ç†ä¼´æ‰‹ç¦®æ¸…å–®</button></div>
            </div>`;
			
		} else if (activeTab === 'missions') {
            const balance = getGashaBalance();
            
            // é€™è£¡æ•´åˆäº†ï¼šæ‰­è›‹æ©Ÿ + ä»»å‹™åˆ—è¡¨ + v18.0 ç…§ç‰‡å›æ†¶ç‰†
            main.innerHTML = `
            <div class="animate-slide-up space-y-4">
                <div id="gasha-machine" class="glass-card rounded-3xl p-6 text-center border-4 border-pink-400 bg-pink-50 relative overflow-hidden">
                    <div class="absolute -left-10 -top-10 w-32 h-32 bg-pink-200 rounded-full opacity-50 blur-xl"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-black text-pink-600">ğŸ‰ å¿«æ¨‚æ‰­è›‹æ©Ÿ</h3>
                            <button onclick="openRewardEditor()" class="text-[10px] bg-white border border-pink-200 text-pink-400 px-2 py-1 rounded-full"><i class="fas fa-cog"></i> è¨­å®šçå“</button>
                        </div>
                        <div class="text-4xl font-black text-gray-800 mb-2">${balance} <span class="text-sm text-gray-500 font-medium">æšä»£å¹£</span></div>
                        <p class="text-xs text-gray-500 mb-4">æ¯å®Œæˆ 1 å€‹ä»»å‹™ï¼Œå°±èƒ½è½‰ 1 æ¬¡ï¼</p>
                        <button onclick="spinGasha()" ${balance <= 0 ? 'disabled' : ''} class="w-full py-4 rounded-2xl font-bold text-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 ${balance > 0 ? 'bg-gradient-to-r from-pink-500 to-purple-500 text-white shadow-pink-300/50' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}">
                            ${balance > 0 ? '<i class="fas fa-gift animate-bounce"></i> æŠ•å…¥ä»£å¹£è½‰å‹•' : 'å»å®Œæˆä»»å‹™è³ºä»£å¹£ï¼'}
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    ${missionsDB.map(m => {
                        const isDone = localStorage.getItem(m.id) === '1'; 
                        return `<div onclick="toggleMission('${m.id}')" class="glass-card rounded-3xl p-4 flex flex-col items-center justify-center text-center gap-2 aspect-square relative overflow-hidden transition-all active:scale-95 cursor-pointer ${isDone ? 'border-2 border-yellow-400 bg-yellow-50/90' : 'grayscale opacity-80'}">
                            ${isDone ? '<div class="absolute top-2 right-2 text-yellow-500 text-xl animate-pop"><i class="fas fa-check-circle"></i></div>' : ''}
                            <div class="w-14 h-14 rounded-full ${isDone ? 'bg-yellow-400 text-white' : 'bg-slate-200 text-slate-400'} flex items-center justify-center text-2xl mb-1 shadow-sm transition-colors"><i class="fas ${m.icon}"></i></div>
                            <div class="font-bold text-slate-800 leading-tight">${m.title}</div>
                            <div class="text-[10px] text-slate-500 leading-tight">${m.desc}</div>
                        </div>`
                    }).join('')}
                </div>

                <div class="glass-card rounded-3xl p-4 border border-slate-100 bg-white/80 mt-6">
                    <h3 class="font-black text-gray-800 mb-3 flex items-center gap-2">
                        <i class="fas fa-images text-blue-500"></i> æ—…ç¨‹å›æ†¶ç‰†
                    </h3>
                    <div id="gallery-grid" class="grid grid-cols-3 gap-2">
                        <div class="col-span-3 text-center py-4"><i class="fas fa-spinner fa-spin text-gray-300"></i></div>
                    </div>
                </div>
                <div class="h-12"></div>
            </div>`;

            // v18.0: å»¶é²è¼‰å…¥ç…§ç‰‡ (å› ç‚ºè¦ç­‰ HTML æ¸²æŸ“å®Œ)
            setTimeout(loadGallery, 100);		        
        } else if (activeTab === 'tools') {
            
            // --- 1. æ¶ˆè²»é«˜æ‰‹ (Money) ---
            if (currentToolFilter === 'money') {
                // ç¢ºä¿è®Šæ•¸éƒ½æœ‰åˆå§‹å€¼ï¼Œé¿å…å ±éŒ¯
                let totalJPY = 0; 
                const catTotals = {}; 
                
                // è¨ˆç®—ç¸½èŠ±è²»
                if(expenses && expenses.length > 0) {
                    expenses.forEach(e => { 
                        totalJPY += e.price; 
                        const cat = e.cat || 'other'; 
                        if (!catTotals[cat]) catTotals[cat] = 0; 
                        catTotals[cat] += e.price; 
                    }); 
                }

                // è¨ˆç®—åŒ¯ç‡èˆ‡é ç®—
                let curRate = typeof CURRENT_RATE !== 'undefined' ? CURRENT_RATE : 0.21;
                let totalBudget = typeof TOTAL_BUDGET !== 'undefined' ? TOTAL_BUDGET : 100000;
                let totalTWD = Math.round(totalJPY * curRate); 
                let budgetLeft = totalBudget - totalTWD;
                let budgetPercent = Math.min((totalTWD / totalBudget) * 100, 100); 
                
                // å…ç¨…è¨ˆç®—
                let currentTaxBasket = typeof taxBasket !== 'undefined' ? taxBasket : [];
                let taxBasketTotal = currentTaxBasket.reduce((a, b) => a + b, 0);
                let taxDiff = 5500 - taxBasketTotal; 
                let taxMsg = taxDiff > 0 ? `é‚„å·® Â¥${taxDiff.toLocaleString()}` : "ğŸ‰ å…ç¨…é”æˆï¼";
                let taxPercent = Math.min((taxBasketTotal / 5500) * 100, 100);
                let taxBasketItems = currentTaxBasket.map((price) => `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded-md text-[10px] font-bold">Â¥${price}</span>`).join(" "); 
                
                // åœ“é¤…åœ–é‚è¼¯
                let gradientStr = "conic-gradient(#e2e8f0 0deg 360deg)";
                let legendHTML = `<div class="text-center w-full text-xs text-gray-400 mt-2">å°šç„¡è³‡æ–™</div>`; 
                
                if (totalJPY > 0) { 
                    const sortedCats = Object.keys(catTotals).sort((a,b) => catTotals[b] - catTotals[a]);
                    const gradients = []; 
                    let currentDeg = 0; 
                    legendHTML = "";
                    sortedCats.forEach(c => { 
                        const percent = catTotals[c] / totalJPY; 
                        const deg = percent * 360; 
                        const color = expenseCats[c] ? expenseCats[c].color : '#999'; 
                        gradients.push(`${color} ${currentDeg}deg ${currentDeg + deg}deg`); 
                        currentDeg += deg; 
                        legendHTML += `<div class="flex items-center gap-1 text-[10px] w-1/3 mb-1"><div class="w-2 h-2 rounded-full" style="background:${color}"></div><span class="opacity-70">${expenseCats[c].name} ${Math.round(percent*100)}%</span></div>`; 
                    }); 
                    gradientStr = `conic-gradient(${gradients.join(', ')})`;
                } 

                // è¨˜å¸³åˆ—è¡¨ HTML
                let expenseListHTML = (expenses && expenses.length > 0) ? 
                    expenses.map((item, idx) => { 
                        const cat = item.cat || 'other'; 
                        const catInfo = expenseCats[cat] || expenseCats.other; 
                        return `<div class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm mb-2"><div class="flex-1 flex items-center gap-3"><div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs" style="background:${catInfo.color}"><i class="fas ${catInfo.icon}"></i></div><div><div class="font-bold text-gray-700">${item.name}</div><div class="text-xs text-gray-400">Â¥${item.price.toLocaleString()}</div></div></div><button onclick="deleteExpense(${idx})" class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center active:scale-90"><i class="fas fa-trash-alt text-xs"></i></button></div>`; 
                    }).join('') : `<div class="text-center py-8 text-gray-400 text-sm">ğŸ›ï¸ é‚„æ²’è²·æ±è¥¿...</div>`;

                // çµ„åˆæœ€çµ‚ HTML
                main.innerHTML = `
                <div class="animate-slide-up space-y-4">
                    <div class="glass-card rounded-3xl p-6 text-center shadow-lg border-2 border-yellow-300 relative">
                        <button onclick="fetchExchangeRate()" id="fetchRateBtn" class="absolute top-4 right-4 bg-yellow-100 text-yellow-700 p-2 rounded-full text-xs shadow-sm active:scale-90 transition-transform"><i class="fas fa-sync-alt"></i></button>
                        <h3 class="text-xs font-bold text-yellow-600 mb-2 uppercase tracking-wider">åŒ¯ç‡æ›ç®—å™¨</h3>
                        <div class="text-xl font-bold text-gray-500 mb-4 flex items-center justify-center gap-2">1 JPY = <input type="number" id="rateInput" value="${curRate}" onchange="updateRate(this.value)" class="text-yellow-600 text-3xl font-black bg-transparent focus:outline-none focus:border-b-2 focus:border-yellow-500 transition-colors" step="0.0001"> TWD</div>
                        <div class="flex flex-col gap-4">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 relative"><label class="block text-sm font-medium text-gray-600 mb-1">æ—¥å¹£ (JPY)</label><input type="number" id="jpyInput" oninput="convertCurrency()" placeholder="è¼¸å…¥æ—¥å¹£é‡‘é¡" class="w-full text-3xl text-gray-800 bg-transparent focus:outline-none text-center p-2 font-black"></div>
                            <i class="fas fa-arrow-down text-3xl text-blue-500 animate-bounce absolute left-1/2 -translate-x-1/2 top-[52%] z-10 drop-shadow-sm"></i>
                            <div class="bg-green-50 p-4 rounded-xl border border-green-100"><label class="block text-sm font-medium text-gray-600 mb-1">ç´„ç­‰æ–¼å°å¹£ (TWD)</label><div id="twdOutput" class="w-full text-4xl text-green-700 text-center p-2 font-black">0</div></div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-pink-50 to-white rounded-3xl p-5 border-2 border-pink-200 shadow-md relative overflow-hidden">
                        <div class="flex justify-between items-center mb-3"><h3 class="font-black text-pink-600 flex items-center"><i class="fas fa-bag-shopping mr-2"></i>å…ç¨…æ¹Šå–®ç¥å™¨</h3><button onclick="resetTaxBasket()" class="text-[10px] bg-white border border-gray-200 px-2 py-1 rounded text-gray-400">æ¸…ç©º</button></div>
                        <div class="flex gap-2 mb-3"><input type="number" id="taxItemInput" placeholder="Â¥ å•†å“é‡‘é¡" class="flex-1 min-w-0 bg-white border-2 border-pink-100 rounded-xl px-4 py-3 text-xl font-bold focus:outline-pink-400 text-gray-700"><button onclick="addTaxItem()" class="flex-none w-16 bg-pink-500 text-white rounded-xl shadow-lg active:scale-95 flex items-center justify-center"><i class="fas fa-plus text-2xl"></i></button></div>
                        <div class="mb-2"><div class="flex justify-between text-xs mb-1 font-bold text-gray-500"><span>ç›®å‰: Â¥${taxBasketTotal.toLocaleString()}</span><span class="${taxDiff > 0 ? 'text-blue-500' : 'text-orange-500'}">${taxMsg}</span></div><div class="w-full bg-gray-200 rounded-full h-3"><div class="${taxDiff>0?'bg-blue-500':'bg-gradient-to-r from-yellow-400 to-orange-500 animate-pulse'} h-3 rounded-full transition-all duration-300" style="width: ${taxPercent}%"></div></div></div><div class="flex flex-wrap gap-1 min-h-[20px]">${taxBasketItems}</div>
                    </div>

                    <div class="glass-card rounded-3xl p-4">
                        <div class="flex justify-between items-center mb-2"><div class="text-xs font-bold text-gray-500">ç¸½é ç®—: $${totalBudget.toLocaleString()}</div><div class="text-xs font-bold ${budgetLeft < 0 ? 'text-red-500' : 'text-green-500'}">å‰©é¤˜: $${budgetLeft.toLocaleString()}</div></div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5 mb-4"><div class="bg-green-500 h-1.5 rounded-full transition-all duration-500" style="width: ${budgetPercent}%"></div></div>
                        <div class="pie-chart" style="background: ${gradientStr}"></div><div class="flex flex-wrap justify-center mt-3 px-2">${legendHTML}</div>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-4">
                        <h3 class="text-sm font-bold text-gray-600 mb-3"><i class="fas fa-pen mr-1"></i> è¨˜ä¸€ç­†</h3>
                        <div class="flex gap-2 mb-3 overflow-x-auto hide-scrollbar pb-1">
                            <label class="cursor-pointer"><input type="radio" name="cat" value="shopping" class="peer sr-only" checked><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-bag-shopping"></i> è³¼ç‰©</div></label>
                            <label class="cursor-pointer"><input type="radio" name="cat" value="food" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-utensils"></i> é¤é£²</div></label>
                            <label class="cursor-pointer"><input type="radio" name="cat" value="play" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-purple-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-ticket"></i> å¨›æ¨‚</div></label>
                            <label class="cursor-pointer"><input type="radio" name="cat" value="transport" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-car"></i> äº¤é€š</div></label>
                            <label class="cursor-pointer"><input type="radio" name="cat" value="other" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-slate-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-box"></i> å…¶ä»–</div></label>
                        </div>
                        <div class="flex flex-col gap-3 mb-3"><input id="exName" type="text" placeholder="å“é …åç¨±" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-blue-500"><input id="exPrice" type="number" placeholder="Â¥ é‡‘é¡" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-blue-500 font-bold"></div>
                        <div class="flex gap-2"><button onclick="addExpense()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.98] transition-transform"><i class="fas fa-plus-circle mr-2"></i> æ–°å¢</button><button onclick="exportExpenses()" class="px-4 bg-slate-200 text-slate-600 font-bold rounded-xl active:scale-[0.98] transition-transform"><i class="fas fa-share-from-square"></i></button><button onclick="setBudget()" class="px-4 bg-slate-200 text-slate-600 font-bold rounded-xl active:scale-[0.98] transition-transform"><i class="fas fa-cog"></i></button></div>
                    </div>
                    <div class="pb-6">${expenseListHTML}</div>

                    <div class="bg-slate-800 text-white p-5 rounded-3xl text-center shadow-lg"><h3 class="font-bold text-lg mb-1">ç¡¬å¹£é€ŸæŸ¥ç›¤</h3><p class="text-xs opacity-60">çµå¸³å‰çœ‹ä¸€ä¸‹ï¼Œå¿«é€ŸæŠŠé›¶éŒ¢èŠ±æ‰ï¼</p></div>
                    <div class="grid grid-cols-2 gap-4">${toolsDB.coins.map(c => `<div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center text-center"><div class="w-16 h-16 rounded-full flex items-center justify-center text-xl font-black shadow-inner mb-3 ${c.color}">${c.val}</div><div class="font-bold text-gray-800 text-lg">Â¥${c.val}</div><div class="text-xs text-blue-500 font-bold mb-1">ç´„ NT$${c.twd}</div><div class="text-[10px] text-gray-400 bg-gray-50 px-2 py-1 rounded-full">${c.desc}</div></div>`).join('')}</div>
                    
                    <div class="bg-white rounded-3xl shadow-lg overflow-hidden border border-slate-100"><div class="bg-blue-600 text-white p-4 text-center"><h3 class="font-bold text-lg"><i class="fas fa-shirt mr-2"></i>ç«¥è£ç«¥é‹å°ºå¯¸å°ç…§</h3></div><table class="w-full text-sm text-center"><thead class="bg-gray-50 text-gray-500 font-bold border-b"><tr><th class="py-3">å¹´é½¡</th><th class="py-3">æ—¥æœ¬èº«é«˜</th><th class="py-3">ç¾åœ‹</th><th class="py-3">é‹(cm)</th></tr></thead><tbody class="divide-y divide-gray-100">${toolsDB.sizes.map(s => `<tr><td class="py-4 font-bold text-gray-700">${s.label}</td><td class="py-4 text-blue-600 font-bold">${s.h}</td><td class="py-4 text-gray-500">${s.us}</td><td class="py-4 text-pink-500 font-bold">${s.shoe}</td></tr>`).join('')}</tbody></table></div>
                </div>`;
                setTimeout(() => { const i = document.getElementById('jpyInput'); if(i) i.focus(); }, 100);
            
            // --- 2. è‡ªé§•ç¥éšŠå‹ (Drive) ---
            } else if (currentToolFilter === 'drive') {
                const parkingPhotoHtml = (parkingData && parkingData.photo) ? `<div class="mt-3 relative group"><img src="${parkingData.photo}" class="w-full rounded-xl border border-green-300 shadow-sm" onclick="showParkingPhotoFull('${parkingData.photo}')"><div class="absolute bottom-2 right-2 text-[10px] bg-black/50 text-white px-2 py-1 rounded backdrop-blur">é»æ“Šæ”¾å¤§</div></div>` : '';
                const parkingHTML = !parkingData ? `<div class="p-6 rounded-3xl parking-card border border-green-200 relative overflow-hidden bg-white"><div class="text-center"><i class="fas fa-square-parking text-4xl text-green-500 mb-3"></i><h3 class="text-lg font-bold text-gray-800 mb-1">é‚„æ²’è¨˜éŒ„åœè»Šä½ç½®</h3><p class="text-xs text-gray-400 mb-3">åœå¥½è»Šè¨˜å¾—æ‹å¼µç…§ï¼</p><button onclick="saveParking()" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg mt-3"><i class="fas fa-camera mr-2"></i> ğŸ“· è¨˜éŒ„è»Šä½</button></div></div>` : `<div class="p-6 rounded-3xl parking-card border border-green-500 relative overflow-hidden bg-green-50"><div class="relative z-10"><div class="flex justify-between items-start mb-2"><h3 class="text-lg font-black text-green-800"><i class="fas fa-circle-check mr-2"></i>è»Šå­åœåœ¨é€™ï¼</h3><div class="text-xs text-green-600 font-bold bg-white px-2 py-1 rounded">${parkingData.time}</div></div><div class="bg-white p-3 rounded-xl border border-green-200 mb-4 shadow-sm"><div class="text-[10px] text-gray-400 uppercase">å‚™è¨» (æ¨“å±¤/å€åŸŸ)</div><div class="text-xl font-bold text-gray-800">${parkingData.note}</div>${parkingPhotoHtml}</div><div class="flex gap-2"><button onclick="findCar()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.95] transition-transform"><i class="fas fa-person-walking-arrow-right mr-2"></i> å¸¶æˆ‘æ‰¾è»Š</button><button onclick="clearParking()" class="px-4 bg-white text-red-500 border border-red-200 font-bold rounded-xl active:scale-[0.95] transition-transform"><i class="fas fa-trash-alt"></i></button></div></div></div>`;
                const gasHelperHTML = `<div class="bg-gradient-to-br from-red-500 to-red-600 rounded-3xl p-1 shadow-lg mb-6 relative overflow-hidden text-white"><div class="bg-white/10 backdrop-blur-sm p-5 rounded-[1.3rem] border border-white/20"><div class="flex justify-between items-start mb-4"><div><div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mb-1">GAS STATION</div><h3 class="text-2xl font-black">åŠ æ²¹è«‹æ‰¾ <span class="text-yellow-300">ç´…æ§</span></h3><p class="text-xs opacity-90">Regular (ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼) = 92/95ç„¡é‰›</p></div><div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-red-600 text-2xl shadow-md"><i class="fas fa-gas-pump"></i></div></div><div class="grid grid-cols-2 gap-2 text-center mb-4"><div class="bg-black/20 rounded-lg p-2"><i class="fas fa-hand-sparkles mb-1 block opacity-70"></i><div class="text-[10px]">1.é™¤éœé›»</div></div><div class="bg-black/20 rounded-lg p-2"><i class="fas fa-credit-card mb-1 block opacity-70"></i><div class="text-[10px]">2.ä»˜éŒ¢/é¸æ²¹</div></div><div class="bg-red-700 rounded-lg p-2 border border-red-400"><i class="fas fa-fill-drip mb-1 block"></i><div class="text-[10px] font-bold">3.ç´…æ§åŠ æ²¹</div></div><div class="bg-black/20 rounded-lg p-2"><i class="fas fa-receipt mb-1 block opacity-70"></i><div class="text-[10px]">4.æ‹¿æ”¶æ“š</div></div></div><button onclick="showInfoCard('gas')" class="w-full bg-white text-red-600 font-bold py-3 rounded-xl shadow-md active:scale-95 transition-transform flex items-center justify-center gap-2"><i class="fas fa-comment-dots"></i> çµ¦åº—å“¡çœ‹ (æ—¥æ–‡)</button></div></div>`;
                const tideWidget = getTideWidgetHTML();
                
                // é€™è£¡ä¹Ÿæ•´åˆäº† SOS ç·Šæ€¥æ±‚åŠ©å¡ (åŸæœ¬åœ¨ç¨ç«‹é é¢)
                let allergyTags = medicalData.allergies.length > 0 ? medicalData.allergies.map(a => `<span class="bg-red-100 text-red-700 text-xs font-bold px-2 py-1 rounded border border-red-200">${allergyDict[a].jp}</span>`).join(" ") : "<span class='text-gray-400 text-xs'>ç„¡ (ãªã—)</span>";
                const sosHTML = `<div class="mt-6 border-t pt-4"><h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-wider">ç·Šæ€¥å®‰å…¨</h3><button onclick="openSosCard()" class="w-full bg-red-600 text-white rounded-3xl p-4 shadow-lg flex items-center justify-between active:scale-95 transition-transform mb-4"><div class="text-left"><h3 class="text-lg font-black">SOS ç·Šæ€¥æ±‚åŠ©å¡</h3></div><i class="fas fa-exclamation-circle text-3xl"></i></button><div class="safe-card p-4 rounded-3xl shadow-sm relative overflow-hidden mb-4"><div class="flex justify-between items-start mb-2"><h3 class="text-lg font-black text-gray-800">å®‰å¿ƒè­·ç…§</h3><button onclick="toggleEditMedical()" class="text-xs bg-white border border-gray-200 px-2 py-1 rounded text-gray-500">ç·¨è¼¯</button></div><div id="medical-view">${!medicalData.name ? `<div class="text-center py-2 text-gray-400 text-xs">è«‹é»æ“Šç·¨è¼¯</div>` : `<div class="space-y-2"><div class="text-sm font-bold">${medicalData.name} <span class="text-xs font-normal text-gray-500">(${medicalData.hotel})</span></div><div class="flex gap-1 flex-wrap">${allergyTags}</div></div>`}</div><div id="medical-edit" class="hidden space-y-2 mt-2"><input id="in-name" type="text" placeholder="æš±ç¨±" value="${medicalData.name}" class="w-full p-2 border rounded text-xs"><input id="in-phone" type="tel" placeholder="é›»è©±" value="${medicalData.phone}" class="w-full p-2 border rounded text-xs"><input id="in-hotel" type="text" placeholder="é£¯åº—" value="${medicalData.hotel}" class="w-full p-2 border rounded text-xs"><button onclick="saveMedical()" class="w-full bg-gray-800 text-white text-xs py-2 rounded">å„²å­˜</button></div></div><div class="space-y-2">${toolsDB.sos.map(s => `<a href="tel:${s.tel}" class="${s.style} p-3 rounded-2xl shadow-sm flex items-center justify-between"><div><div class="text-xs opacity-80">${s.name}</div><div class="text-lg font-black">${s.tel}</div></div><i class="fas fa-phone"></i></a>`).join('')}</div></div>`;

                main.innerHTML = `<div class="animate-slide-up space-y-4">
                    <button onclick="openDriverMode()" class="w-full bg-gradient-to-r from-slate-800 to-black text-white p-6 rounded-3xl shadow-xl border border-slate-700 relative overflow-hidden group mb-4">
                        <div class="absolute right-0 top-0 p-6 opacity-20 group-active:scale-110 transition-transform"><i class="fas fa-gauge-high text-7xl"></i></div>
                        <div class="relative z-10 flex flex-col items-start"><span class="bg-yellow-400 text-black text-[10px] font-bold px-2 py-1 rounded mb-2 animate-pulse">NEW</span><h3 class="text-2xl font-black italic">DRIVER HUD</h3><p class="text-sm text-gray-300 mt-1">é§•é§›å°ˆç”¨å„€è¡¨æ¿ / å¤§å­—é«”æ¨¡å¼</p></div>
                    </button>
                    ${tideWidget}
                    ${parkingHTML}
                    ${gasHelperHTML}
                    <div class="grid gap-4">${toolsDB.signs.map(s => `<div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex items-center gap-4"><div class="text-3xl w-12 h-12 flex items-center justify-center bg-gray-50 rounded-2xl">${s.icon}</div><div class="flex-1"><h3 class="text-base font-black ${s.color} mb-1">${s.title}</h3><p class="text-xs text-gray-600 leading-relaxed">${s.desc}</p></div></div>`).join('')}</div>
                    ${sosHTML}
                </div>`;
            
            // --- 3. æºé€šé»é¤ (Food) ---
            } else if (currentToolFilter === 'food') {
                main.innerHTML = `
                <div class="animate-slide-up space-y-4">
                    <div class="bg-slate-800 rounded-3xl p-5 text-center text-white relative overflow-hidden shadow-xl mb-4">
                        <h3 class="text-base font-bold mb-3">æ—¥èªç¿»è­¯è’Ÿè’»</h3>
                        <div class="flex justify-center mb-4"><button id="mic-btn" onclick="toggleTranslation()" class="mic-btn"><i class="fas fa-microphone"></i></button></div>
                        <div id="trans-output" class="min-h-[2.5rem] text-lg font-bold text-gray-200 bg-white/10 rounded-xl p-2 flex items-center justify-center">é»æ“ŠæŒ‰éˆ•ï¼Œè«‹åº—å“¡èªªè©±</div>
                    </div>

                    <div class="bg-orange-50 border border-orange-200 rounded-3xl p-5 text-center">
                        <h3 class="text-lg font-black text-orange-800 mb-1"><i class="fas fa-utensils mr-2"></i>æ‰‹æŒ‡é»é¤é€š</h3>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            ${foodBoardDB.map(f => `
                                <div class="food-grid-item" onclick="speak('${f.jp}', this)">
                                    <img src="${f.img}" class="food-grid-img" loading="lazy">
                                    <div class="food-grid-label"><div class="text-lg">${f.name}</div><div class="text-[10px] font-normal opacity-80">${f.note}</div></div>
                                    <div class="absolute top-2 right-2 bg-white/90 rounded-full w-8 h-8 flex items-center justify-center text-orange-500 shadow-md"><i class="fas fa-volume-high"></i></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider ml-2 mt-4">é»é¤å¸¸ç”¨å¥</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="speak('è¾›ã„ã§ã™ã‹ï¼Ÿ (Karai desuka?)', this)" class="bg-red-100 text-red-700 py-3 rounded-2xl font-bold active:scale-95 transition-transform text-xs"><i class="fas fa-pepper-hot mr-1"></i> é€™æœƒè¾£å—ï¼Ÿ</button>
                        <button onclick="speak('åµã‚„ç‰›ä¹³ã¯å…¥ã£ã¦ã„ã¾ã™ã‹ï¼Ÿ', this)" class="bg-yellow-100 text-yellow-700 py-3 rounded-2xl font-bold active:scale-95 transition-transform text-xs"><i class="fas fa-exclamation-triangle mr-1"></i> å«è›‹/å¥¶å—ï¼Ÿ</button>
                        ${toolsDB.orders.map(o => `<div class="bg-white border-2 border-slate-100 rounded-2xl p-3 text-center active:bg-blue-50 active:border-blue-200 transition-colors" onclick="speak('${o.jp}', this)"><div class="text-2xl mb-1">${o.icon}</div><div class="font-bold text-gray-700 text-sm">${o.title}</div><div class="text-[10px] text-gray-400">${o.sub}</div></div>`).join('')}
                    </div>

                    <div class="mt-4 space-y-2">
                        ${toolsDB.jp.map(cat => `<div class="collapse-group"><h4 class="text-xs font-bold text-blue-500 bg-blue-50 px-3 py-2 rounded-lg mb-2">${cat.label}</h4><div class="grid gap-2">${cat.items.map(item => `<div class="bg-white p-3 rounded-xl border border-slate-50 flex justify-between items-center" onclick="speak('${item.j}', this)"><div class="flex-1"><div class="text-xs text-gray-500">${item.t}</div><div class="font-bold text-gray-800">${item.j}</div></div><i class="fas fa-volume-high text-yellow-400"></i></div>`).join('')}</div></div>`).join('')}
                    </div>
                </div>`;
            
            // --- 4. è¬ç”¨å·¥å…·ç®± (Gadget) ---
            } else if (currentToolFilter === 'gadget') {
                const soundBoardHTML = `<div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100 mb-6"><h3 class="text-xs font-bold text-gray-500 uppercase mb-3"><i class="fas fa-music mr-1"></i> å®‰æ’«éŸ³æ•ˆæ¿</h3><div class="grid grid-cols-3 gap-3"><button onclick="playSound('clapping')" class="aspect-square bg-yellow-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">ğŸ‘</button><button onclick="playSound('laugh')" class="aspect-square bg-pink-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">ğŸ˜†</button><button onclick="playSound('fart')" class="aspect-square bg-amber-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">ğŸ’¨</button><button onclick="playSound('magic')" class="aspect-square bg-purple-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">âœ¨</button><button onclick="playSound('wrong')" class="aspect-square bg-red-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">âŒ</button><button onclick="playSound('correct')" class="aspect-square bg-green-100 rounded-2xl text-2xl flex items-center justify-center shadow-sm active:scale-90 transition-transform">â­•</button></div></div>`;
                
                main.innerHTML = `<div class="animate-slide-up space-y-4">
                    <div class="grid grid-cols-2 gap-3 mb-6">
                        <button onclick="openCamera()" class="bg-white p-4 rounded-3xl shadow-sm text-center active:scale-95 transition-transform border-2 border-yellow-100"><i class="fas fa-camera text-yellow-500 text-3xl mb-2 block"></i><span class="text-sm font-bold">å›æ†¶ç›¸æ©Ÿ</span></button>
                        <button onclick="openDrawing()" class="bg-white p-4 rounded-3xl shadow-sm text-center active:scale-95 transition-transform border-2 border-purple-100"><i class="fas fa-palette text-purple-500 text-3xl mb-2 block"></i><span class="text-sm font-bold">å°å°ç•«å®¶</span></button>
                        <button onclick="openRuler()" class="bg-white p-4 rounded-3xl shadow-sm text-center active:scale-95 transition-transform border-2 border-blue-100"><i class="fas fa-ruler-combined text-blue-500 text-3xl mb-2 block"></i><span class="text-sm font-bold">éš¨èº«å°ºè¦</span></button>
                        <button onclick="goBackHotel()" class="bg-white p-4 rounded-3xl shadow-sm text-center active:scale-95 transition-transform border-2 border-green-100"><i class="fas fa-house-chimney text-green-500 text-3xl mb-2 block"></i><span class="text-sm font-bold">å›é£¯åº—</span></button>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <button onclick="quickSearch('toilets')" class="flex-1 bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform"><i class="fas fa-restroom text-blue-500 mb-1"></i> æ‰¾å»æ‰€</button>
                        <button onclick="quickSearch('convenience store')" class="flex-1 bg-white p-3 rounded-2xl shadow-sm text-center active:scale-95 transition-transform"><i class="fas fa-store text-orange-500 mb-1"></i> æ‰¾è¶…å•†</button>
                    </div>

                    ${soundBoardHTML}

                    <div class="glass-card rounded-3xl p-6 border-l-4 border-purple-500 mb-4">
                        <div class="text-xs font-bold text-purple-600 uppercase mb-2">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</div>
                        <div class="flex gap-2">
                            <button onclick="backupData()" class="flex-1 bg-purple-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.98] transition-transform"><i class="fas fa-copy mr-2"></i> è¤‡è£½ä»£ç¢¼ (èˆŠæ©Ÿ)</button>
                        </div>
                        <div class="mt-4 pt-4 border-t border-purple-100">
                            <textarea id="importDataInput" placeholder="åœ¨æ­¤è²¼ä¸Šä»£ç¢¼..." class="w-full h-16 bg-slate-50 border border-slate-200 rounded-xl p-3 text-xs mb-2 focus:outline-teal-500"></textarea>
                            <button onclick="restoreData()" class="w-full bg-teal-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-[0.98] transition-transform"><i class="fas fa-file-import mr-2"></i> è¼‰å…¥è³‡æ–™ (æ–°æ©Ÿ)</button>
                        </div>
                    </div>
                </div>`;
            }
        }
    }
	
	// ================= 3. è¼”åŠ©èˆ‡å…¶ä»–åŠŸèƒ½ (Helpers) =================
    
    // --- 1. å°å°ç•«å®¶ (Drawing) ---
    let isDrawing = false; let ctx = null; let currentColor = 'black';
    window.openDrawing = () => { const modal = document.getElementById('drawing-modal'); modal.classList.add('open'); const canvas = document.getElementById('drawing-canvas'); const container = document.getElementById('canvas-container'); canvas.width = container.clientWidth; canvas.height = container.clientHeight; ctx = canvas.getContext('2d'); ctx.lineCap = 'round'; ctx.lineWidth = 5; ctx.strokeStyle = currentColor; canvas.addEventListener('touchstart', startDraw, {passive: false}); canvas.addEventListener('touchmove', draw, {passive: false}); canvas.addEventListener('touchend', endDraw); canvas.addEventListener('mousedown', startDraw); canvas.addEventListener('mousemove', draw); canvas.addEventListener('mouseup', endDraw); }
    window.closeDrawing = () => document.getElementById('drawing-modal').classList.remove('open');
    function startDraw(e) { e.preventDefault(); isDrawing = true; draw(e); }
    function draw(e) { if (!isDrawing) return; e.preventDefault(); const canvas = document.getElementById('drawing-canvas'); const rect = canvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top; ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y); }
    function endDraw() { isDrawing = false; ctx.beginPath(); }
    window.setColor = (color, btn) => { currentColor = color; ctx.strokeStyle = color; document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    window.clearCanvas = () => { const canvas = document.getElementById('drawing-canvas'); ctx.clearRect(0, 0, canvas.width, canvas.height); }
    window.saveDrawing = () => { const canvas = document.getElementById('drawing-canvas'); const link = document.createElement('a'); link.download = `kuku-drawing-${Date.now()}.png`; link.href = canvas.toDataURL(); link.click(); showToast("ç•«ä½œå·²ä¸‹è¼‰ï¼"); }

    // --- 2. v17.0 æ–°åŠŸèƒ½: éš¨èº«å°ºè¦ (Smart Ruler) ---
    let rulerScale = 1.0; // æ ¡æ­£æ¯”ä¾‹
    const basePPI = 96; // åŸºæº– PPI (å‡è¨­å€¼ï¼Œé æ ¡æ­£èª¿æ•´)
    
    window.openRuler = () => {
        document.getElementById('ruler-modal').classList.add('open');
        renderRulerTicks();
    }
    window.closeRuler = () => document.getElementById('ruler-modal').classList.remove('open');
    window.updateRulerScale = (val) => {
        rulerScale = parseFloat(val);
        renderRulerTicks();
    }
    window.resetRulerScale = () => {
        document.getElementById('ruler-scale').value = 1.0;
        updateRulerScale(1.0);
    }
    
    function renderRulerTicks() {
        const container = document.getElementById('ruler-ticks');
        container.innerHTML = '';
        const pxPerCm = (basePPI / 2.54) * rulerScale;
        
        // ç”Ÿæˆ 30 å…¬åˆ†çš„åˆ»åº¦
        for (let i = 0; i <= 30; i++) {
            // ä¸»åˆ»åº¦ (cm)
            const tick = document.createElement('div');
            tick.className = 'ruler-tick major';
            tick.style.marginRight = `${pxPerCm / 10 - 2}px`; // æ¸›å» border å¯¬åº¦
            
            const num = document.createElement('div');
            num.className = 'ruler-num';
            num.innerText = i;
            tick.appendChild(num);
            container.appendChild(tick);

            if (i < 30) {
                // ç”Ÿæˆæ¯«ç±³åˆ»åº¦ (mm)
                for (let j = 1; j < 10; j++) {
                    const subTick = document.createElement('div');
                    subTick.className = j === 5 ? 'ruler-tick medium' : 'ruler-tick minor';
                    // æœ€å¾Œä¸€å€‹æ¯«ç±³ä¸éœ€è¦ marginï¼Œå› ç‚ºä¸‹ä¸€å€‹æ˜¯ä¸»åˆ»åº¦
                    const margin = (pxPerCm / 10) - 1; 
                    subTick.style.marginRight = `${margin}px`;
                    container.appendChild(subTick);
                }
            }
        }
        document.getElementById('ruler-display-val').innerText = (rulerScale * 10).toFixed(1); // é¡¯ç¤ºç›®å‰æ ¡æ­£åƒæ•¸ä¾›åƒè€ƒ
    }
    // ç›£è½å°ºè¦æ²å‹•ï¼Œæ›´æ–°æ•¸å€¼é¡¯ç¤º (æ¨¡æ“¬æ¸¬é‡è®€æ•¸)
    document.getElementById('ruler-scroll-area')?.addEventListener('scroll', (e) => {
        const pxPerCm = (basePPI / 2.54) * rulerScale;
        const scrollLeft = e.target.scrollLeft;
        const cm = (scrollLeft / pxPerCm).toFixed(1);
        document.getElementById('ruler-display-val').innerText = cm;
    });

    // --- 3. v17.0 æ–°åŠŸèƒ½: å›æ†¶æµ®æ°´å°ç›¸æ©Ÿ (Memory Cam) ---
    let stream = null;
    let videoTrack = null;
    let facingMode = 'environment'; // é è¨­å¾Œé¡é ­

    // å•Ÿå‹•ç›¸æ©Ÿè¦–çª—
    window.openCamera = async () => {
        const modal = document.getElementById('camera-modal');
        
        // 1. å¼·åˆ¶é¡¯ç¤ºè¦–çª— (ä¿®æ­£ CSS æ¬Šé‡å•é¡Œ)
        modal.classList.remove('hidden'); 
        modal.classList.add('open'); 
        
        // 2. æ›´æ–°æµ®æ°´å°è³‡æ–™ (æ—¥æœŸ/åœ°é»/Day)
        const today = new Date();
        document.getElementById('cam-day-val').innerText = currentDayIdx + 1;
        document.getElementById('cam-date-val').innerText = `${today.getFullYear()}/${(today.getMonth()+1).toString().padStart(2,'0')}/${today.getDate().toString().padStart(2,'0')}`;
        document.getElementById('cam-loc-val').innerText = "Okinawa"; 
        
        // å˜—è©¦æŠ“å– GPS åœ°é»
        if(navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(p => {
                 if(p.coords.latitude > 26.5) document.getElementById('cam-loc-val').innerText = "Nago, Okinawa";
                 else document.getElementById('cam-loc-val').innerText = "Naha, Okinawa";
             });
        }
        
        startCamera();
    }

    // å•Ÿå‹•é¡é ­ä¸²æµ (å« iOS é»‘å±ä¿®æ­£)
    async function startCamera() {
        const video = document.getElementById('camera-video');
        try {
            if (stream) { stream.getTracks().forEach(track => track.stop()); }
            
            // v17.2 ä¿®æ­£ï¼šå¼·åˆ¶æŒ‡å®šè§£æåº¦ï¼Œè§£æ±ºéƒ¨åˆ† iOS é»‘å±å•é¡Œ
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: facingMode,
                    width: { ideal: 1280 }, // æå‡è§£æåº¦ï¼Œè®“ iOS é¡˜æ„å•Ÿå‹•
                    height: { ideal: 720 } 
                },
                audio: false 
            });
            
            video.srcObject = stream;
            
            // v17.2 é—œéµä¿®æ­£ï¼šiOS å¿…é ˆé¡¯å¼å‘¼å« play()
            video.onloadedmetadata = () => {
                video.play().catch(e => console.log("Play error:", e));
            };

            document.getElementById('cam-overlay').classList.remove('hidden');
        } catch (err) {
            console.error(err);
            alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼šè«‹ç¢ºèª\n1. ç”¨ Safari é–‹å•Ÿ\n2. å…è¨±ç›¸æ©Ÿæ¬Šé™\n3. ç¶²å€æ˜¯ https æˆ– localhost");
            closeCamera();
        }
    }

    // é—œé–‰ç›¸æ©Ÿ
    window.closeCamera = () => {
        const video = document.getElementById('camera-video');
        const modal = document.getElementById('camera-modal');
        
        if (stream) { stream.getTracks().forEach(track => track.stop()); }
        video.srcObject = null;
        
        modal.classList.remove('open'); // ç§»é™¤ open è®“å®ƒè®Šå› display: none
        setTimeout(() => modal.classList.add('hidden'), 300); // ç­‰å‹•ç•«è·‘å®Œå†å®Œå…¨éš±è—
    }

    // åˆ‡æ›å‰å¾Œé¡é ­
    window.toggleCameraFacing = () => {
        facingMode = facingMode === 'user' ? 'environment' : 'user';
        startCamera();
    }

    // æ‹ç…§ä¸¦ä¸‹è¼‰ (å« iOS å­˜æª”ä¿®æ­£)
    window.takePhoto = () => {
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        
        // --- 1. ç¹ªè£½å½±åƒ ---
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // è™•ç†è‡ªæ‹é¡åƒ
        if (facingMode === 'user') {
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
        }
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        if (facingMode === 'user') ctx.setTransform(1, 0, 0, 1, 0, 0); // é‡ç½®çŸ©é™£

        // --- 2. ç¹ªè£½æµ®æ°´å° ---
        const scale = canvas.width / 800; // éŸ¿æ‡‰å¼ç¸®æ”¾
        ctx.shadowColor = "rgba(0,0,0,0.8)";
        ctx.shadowBlur = 4 * scale;
        
        // æ—¥æœŸ
        ctx.fillStyle = "#fbbf24";
        ctx.font = `bold ${30 * scale}px monospace`;
        ctx.textAlign = "right";
        const dateText = document.getElementById('cam-date-val').innerText;
        ctx.fillText(dateText, canvas.width - (20 * scale), canvas.height - (70 * scale));
        
        // åœ°é»
        ctx.fillStyle = "white";
        ctx.font = `${20 * scale}px sans-serif`;
        const locText = "ğŸ“ " + document.getElementById('cam-loc-val').innerText;
        ctx.fillText(locText, canvas.width - (20 * scale), canvas.height - (45 * scale));

        // å¤©æ°£ (é˜²å‘†: è‹¥ç„¡å¤©æ°£è³‡è¨Šå‰‡é¡¯ç¤ºæ™´å¤©)
        const weatherText = "â˜€ï¸ " + (document.getElementById('cam-weather-val')?.innerText || 'æ™´å¤©'); 
        ctx.fillText(weatherText, canvas.width - (20 * scale), canvas.height - (20 * scale));

        // Day Badge (å·¦ä¸Šè§’æ¨™ç±¤)
        ctx.save();
        ctx.translate(30 * scale, 40 * scale);
        ctx.rotate(-5 * Math.PI / 180);
        ctx.fillStyle = "#ef4444";
        ctx.fillRect(0, 0, 100 * scale, 30 * scale);
        ctx.fillStyle = "white";
        ctx.font = `bold ${20 * scale}px sans-serif`;
        ctx.textAlign = "center";
        ctx.fillText(`DAY ${currentDayIdx+1}`, 50 * scale, 22 * scale);
        ctx.restore();

        // --- 3. ä¸‹è¼‰åœ–ç‰‡ & å­˜å…¥å›æ†¶ç‰† ---
        canvas.toBlob(function(blob) {
            if (!blob) { showToast("ğŸš¨ å¤±æ•—ï¼Œè«‹é‡è©¦ï¼"); return; }
            
            // A. ä¸‹è¼‰åˆ°æ‰‹æ©Ÿç›¸ç°¿
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = `kuku-memory-${Date.now()}.jpg`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 100);

            // B. [æ–°åŠŸèƒ½] è‡ªå‹•å­˜å…¥ App å›æ†¶ç‰†
            savePhotoToDB(blob); // <--- é—œéµå°±æ˜¯åŠ é€™ä¸€è¡Œ

            showToast("ğŸ“¸ å·²å„²å­˜ä¸¦åŠ å…¥å›æ†¶ç‰†ï¼");
        }, 'image/jpeg', 0.95);
        
        // é–ƒå…‰ç‰¹æ•ˆ
        const flash = document.createElement('div');
        flash.className = "fixed inset-0 bg-white z-[300] transition-opacity duration-300";
        document.body.appendChild(flash);
        setTimeout(() => { flash.style.opacity = 0; setTimeout(() => flash.remove(), 300); }, 50);
    }
    
    // é–‹å•Ÿç›¸ç°¿ (è§¸ç™¼ input file)
    window.openGallery = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
            showToast("åŠŸèƒ½é–‹ç™¼ä¸­ï¼šåŒ¯å…¥ç…§ç‰‡åŠ æ¡†");
        };
        input.click();
    }
    
    // v17.0: ç¶å®šé¦–é ç›¸æ©ŸæŒ‰éˆ• (åœ¨ Part 3 ä¹‹å‰æœªå®šç¾©ï¼Œé€™è£¡å‹•æ…‹ç¶å®šæˆ–ç›´æ¥åœ¨ HTML å¢åŠ )
    // è¨»ï¼šåœ¨ tools é é¢æˆ‘å€‘å·²ç¶“æœ‰æŒ‰éˆ•å¯ä»¥ call openCamera()

    // --- 4. v17.0 æ–°åŠŸèƒ½: å°æé¾ GPS (Dino Tracker) ---
    function updateDinoGPS(lat, lon) {
        const d = itineraryDB[currentDayIdx];
        if (!d.events || d.events.length < 2) return;
        
        // æ‰¾å‡ºç•¶å¤©ç¬¬ä¸€å€‹å’Œæœ€å¾Œä¸€å€‹æœ‰åº§æ¨™çš„é»ï¼Œä½œç‚ºèµ·é»å’Œçµ‚é»
        const points = d.events.filter(e => e.lat);
        if (points.length < 2) return;
        
        const start = points[0];
        const end = points[points.length - 1];
        
        // è¨ˆç®—ç¸½è·é›¢
        const totalDist = getDistanceFromLatLonInKm(start.lat, start.lon, end.lat, end.lon);
        // è¨ˆç®—ç›®å‰è·é›¢èµ·é»çš„è·é›¢
        const currentDist = getDistanceFromLatLonInKm(start.lat, start.lon, lat, lon);
        
        // è¨ˆç®—é€²åº¦ (0% - 100%)
        let progress = (currentDist / totalDist) * 100;
        if (progress < 0) progress = 0;
        if (progress > 100) progress = 100;
        
        // æ›´æ–° UI
        const bar = document.getElementById('dino-fill-bar');
        const marker = document.getElementById('dino-marker');
        const status = document.getElementById('dino-status-text');
        
        if(bar && marker) {
            bar.style.width = `${progress}%`;
            marker.style.left = `${progress}%`;
            status.innerText = progress > 90 ? "å¿«åˆ°äº†ï¼åŠ æ²¹ï¼" : `æ—…ç¨‹é€²è¡Œä¸­ (${Math.round(progress)}%)`;
        }
    }

    // --- 5. v17.0 æ–°åŠŸèƒ½: èªéŸ³æ—¥è¨˜ (Voice Memo) ---
    function toggleVoiceMemo() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("ä½ çš„æ‰‹æ©Ÿä¸æ”¯æ´èªéŸ³è¼¸å…¥ ğŸ˜­ (è«‹ç”¨ Chrome)");
            return;
        }
        
        const recognition = new webkitSpeechRecognition();
        recognition.lang = 'zh-TW'; // è½ä¸­æ–‡
        recognition.interimResults = false;
        
        recognition.onstart = function() {
            showToast("ğŸ™ï¸ è«‹é–‹å§‹èªªè©±...");
        };
        
        recognition.onresult = function(event) {
            const text = event.results[0][0].transcript;
            const textarea = document.getElementById('diary-textarea');
            if(textarea) {
                const original = textarea.value;
                textarea.value = original ? original + "\n" + text : text;
                // è§¸ç™¼ input event ä»¥å„²å­˜
                textarea.dispatchEvent(new Event('input'));
                showToast("âœ… å·²å¯«å…¥æ—¥è¨˜ï¼");
            }
        };
        
        recognition.onerror = function(e) {
            showToast("âŒ è½ä¸æ¸…æ¥šï¼Œè«‹å†è©¦ä¸€æ¬¡");
        };
        
        recognition.start();
    }
    
    // --- 6. v17.0 æ–°åŠŸèƒ½: é¡¯ç¤ºåœè»Šå¤§åœ– ---
    window.showParkingPhotoFull = (src) => {
        // ç°¡å–®ç”¨ä¸€å€‹å…¨è¢å¹• div é¡¯ç¤º
        const div = document.createElement('div');
        div.className = "fixed inset-0 z-[300] bg-black flex items-center justify-center p-2";
        div.onclick = () => div.remove();
        div.innerHTML = `<img src="${src}" class="max-w-full max-h-full rounded-lg shadow-2xl border-2 border-white">`;
        document.body.appendChild(div);
    }

    // --- ä¼´æ‰‹ç¦® (Gifts) ---
    window.openGiftModal = () => { renderGiftList(); document.getElementById('gift-modal').classList.add('open'); }
    window.closeGiftModal = () => document.getElementById('gift-modal').classList.remove('open');
    window.addGift = () => { const who = document.getElementById('gift-who').value; const what = document.getElementById('gift-what').value; const budget = document.getElementById('gift-budget').value; if(who && what) { giftDB.push({ who, what, budget: budget || 0, bought: false }); saveGifts(); renderGiftList(); document.getElementById('gift-who').value = ''; document.getElementById('gift-what').value = ''; document.getElementById('gift-budget').value = ''; } else { showToast("è«‹è¼¸å…¥å°è±¡å’Œç‰©å“"); } }
    window.renderGiftList = () => { const container = document.getElementById('gift-list-container'); if(!container) return; if(giftDB.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 py-10">å°šç„¡ä¼´æ‰‹ç¦®æ¸…å–®<br>å¿«åŠ ä¸€äº›å§ï¼</div>`; return; } container.innerHTML = giftDB.map((g, i) => `<div class="bg-gray-50 p-3 rounded-xl border border-gray-100 flex justify-between items-center ${g.bought ? 'opacity-50' : ''}"><div class="flex items-center gap-3"><button onclick="toggleGift(${i})" class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${g.bought ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'}">${g.bought ? '<i class="fas fa-check text-xs"></i>' : ''}</button><div><div class="font-bold text-gray-700 ${g.bought ? 'line-through' : ''}">${g.what} <span class="text-xs font-normal text-gray-500">(${g.who})</span></div><div class="text-xs text-gray-400">é ç®—: Â¥${g.budget}</div></div></div><button onclick="deleteGift(${i})" class="text-gray-300 hover:text-red-500 px-2"><i class="fas fa-trash-alt"></i></button></div>`).join(''); }
    window.toggleGift = (idx) => { giftDB[idx].bought = !giftDB[idx].bought; saveGifts(); renderGiftList(); if(giftDB[idx].bought) showToast("å·²æ¨™è¨˜ç‚ºè³¼è²·ï¼"); }
    window.deleteGift = (idx) => { if(confirm("åˆªé™¤æ­¤é …ç›®ï¼Ÿ")) { giftDB.splice(idx, 1); saveGifts(); renderGiftList(); } }
    function saveGifts() { localStorage.setItem('trip_gifts', JSON.stringify(giftDB)); }
    // --- å½ˆçª—èˆ‡åˆ†äº« (Modals & Share) ---
    window.openSpotModal = (id) => { const spot = spotInfoDB[id]; if(!spot) return; document.getElementById('spot-title').innerText = spot.title; document.getElementById('spot-hero').style.backgroundImage = `url('${spot.image}')`; document.getElementById('spot-desc').innerText = spot.desc; document.getElementById('spot-tips').innerText = spot.tips; const tagsHtml = spot.tags.map(t => `<span class="bg-black/40 px-2 py-1 rounded text-[10px] backdrop-blur-md font-bold text-white shadow-sm border border-white/20">${t}</span>`).join(''); document.getElementById('spot-tags').innerHTML = tagsHtml; const btn = document.getElementById('spot-nav-btn'); btn.href = `http://maps.google.com/?q=${encodeURIComponent(spot.map)}`; document.getElementById('spot-modal').classList.add('open'); }
    window.closeSpotModal = () => document.getElementById('spot-modal').classList.remove('open');
    
    window.openSosCard = () => document.getElementById('sos-card-modal').classList.add('open');
    window.closeSosCard = () => document.getElementById('sos-card-modal').classList.remove('open');
    window.setSosMsg = (type) => { const msg = sosMessages[type]; if(msg) { document.getElementById('sos-jp-text').innerText = msg.jp; document.getElementById('sos-sub-text').innerText = msg.en; if(navigator.vibrate) navigator.vibrate(100); } }
    
    window.shareEvent = async (title, mapcode, note) => { const shareData = { title: `å¥å¥è¡Œç¨‹ï¼š${title}`, text: `æˆ‘å€‘è¦å»ï¼š${title}\nMapCode: ${mapcode || 'ç„¡'}\nå‚™è¨»: ${note}`, }; if (navigator.share) { try { await navigator.share(shareData); } catch (err) { console.log('åˆ†äº«å–æ¶ˆ'); } } else { navigator.clipboard.writeText(shareData.text).then(() => showToast("å·²è¤‡è£½è¡Œç¨‹è³‡è¨Šï¼")); } }

    // --- è²éŸ³èˆ‡äº’å‹• (Sound & Games) ---
    window.playSound = (type) => { const ctx = new (window.AudioContext || window.webkitAudioContext)(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); const now = ctx.currentTime; if (type === 'magic') { osc.type = 'sine'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(1000, now + 0.3); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3); osc.start(now); osc.stop(now + 0.3); } else if (type === 'wrong') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.3); gain.gain.setValueAtTime(0.3, now); gain.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(now); osc.stop(now + 0.3); } else if (type === 'correct') { osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.setValueAtTime(800, now + 0.1); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(now); osc.stop(now + 0.4); } else if (type === 'fart') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(120, now); osc.frequency.linearRampToValueAtTime(60, now + 0.4); gain.gain.setValueAtTime(0.5, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(now); osc.stop(now + 0.4); } else if (type === 'laugh') { osc.type = 'triangle'; osc.frequency.setValueAtTime(400, now); osc.frequency.linearRampToValueAtTime(600, now + 0.1); osc.frequency.linearRampToValueAtTime(400, now + 0.2); gain.gain.setValueAtTime(0.3, now); osc.start(now); osc.stop(now + 0.3); } else if (type === 'clapping') { /* ç°¡åŒ–æŒè² */ const o=ctx.createOscillator();o.type='triangle';o.frequency.setValueAtTime(150,now);const g=ctx.createGain();o.connect(g);g.connect(ctx.destination);g.gain.setValueAtTime(0.5,now);g.gain.exponentialRampToValueAtTime(0.01,now+0.5);o.start(now);o.stop(now+0.5); } else { playCoinSound(); } }
    window.spinFood = () => { /* ä¿ç•™èˆŠç‰ˆåƒä»€éº¼åŠŸèƒ½ */ const iconEl = document.getElementById('food-result'); const textEl = document.getElementById('food-text'); let count = 0; const interval = setInterval(() => { const opts = [{icon:"ğŸœ",name:"æ‹‰éºµ"},{icon:"ğŸ¥©",name:"ç‡’è‚‰"},{icon:"ğŸ£",name:"å£½å¸"},{icon:"ğŸ”",name:"æ¼¢å ¡"}]; const random = opts[Math.floor(Math.random() * opts.length)]; iconEl.innerText = random.icon; textEl.innerText = random.name; count++; if(count > 20) { clearInterval(interval); playCoinSound(); iconEl.classList.add('animate-pop'); setTimeout(() => iconEl.classList.remove('animate-pop'), 500); } }, 80); }
    
    // --- æ¯æ—¥å‡ºé–€æª¢æŸ¥ (Daily Check) ---
    function checkDailyPopup() { const today = new Date().toISOString().split('T')[0]; const lastCheck = localStorage.getItem('last_departure_check'); const currentHour = new Date().getHours(); if (today !== lastCheck && currentHour >= 6 && currentHour <= 11) { document.getElementById('daily-check-modal').classList.add('open'); } }
    window.checkDailyItem = (cb) => { const all = document.querySelectorAll('#daily-check-modal input[type="checkbox"]'); const checked = document.querySelectorAll('#daily-check-modal input[type="checkbox"]:checked'); const btn = document.getElementById('daily-check-btn'); if(all.length === checked.length) { btn.disabled = false; btn.classList.remove('bg-gray-300'); btn.classList.add('bg-blue-600', 'shadow-lg'); } }
    window.finishDailyCheck = () => { localStorage.setItem('last_departure_check', new Date().toISOString().split('T')[0]); document.getElementById('daily-check-modal').classList.remove('open'); showToast("å‡ºç™¼ï¼ç¥ä»Šå¤©æ—…é€”æ„‰å¿«ï¼ğŸš—"); playSound('correct'); }
    
    // --- é›¨å¤©æ¨¡å¼ (Rain Mode) ---
    window.toggleRainMode = () => { isRainyMode = !isRainyMode; localStorage.setItem('rainy_mode', isRainyMode); if(navigator.vibrate) navigator.vibrate(50); updateRainyModeUI(); renderContent(); }
    function updateRainyModeUI() { const btn = document.getElementById('rain-btn'); const icon = document.getElementById('rain-icon'); const text = document.getElementById('rain-text'); const body = document.body; if (isRainyMode) { body.classList.add('rainy-mode'); btn.className = "glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-blue-400/50 bg-blue-900/50"; icon.className = "fas fa-cloud-showers-heavy text-xl mb-1 block text-blue-300"; text.innerText = "é›¨å¤©å‚™æ¡ˆ"; text.className = "text-[9px] font-bold text-blue-200"; showToast("â˜” å·²åˆ‡æ›ç‚ºé›¨å¤©å‚™æ¡ˆæ¨¡å¼"); } else { body.classList.remove('rainy-mode'); btn.className = "glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-white/20"; icon.className = "fas fa-sun text-xl mb-1 block text-yellow-400"; text.innerText = "æ™´å¤©"; text.className = "text-[9px] font-bold opacity-90"; showToast("â˜€ï¸ å·²åˆ‡æ›ç‚ºæ™´å¤©æ¨¡å¼"); } }
    
    // --- è¨ˆç®—æ©Ÿèˆ‡è¨˜å¸³ (Calc) ---
    window.addTaxItem = () => { const input = document.getElementById('taxItemInput'); const val = parseInt(input.value); if(val && val > 0) { taxBasket.push(val); input.value = ""; renderContent(); const i = document.getElementById('taxItemInput'); if(i) i.focus(); } }
    window.resetTaxBasket = () => { if(confirm("ç¢ºå®šè¦æ¸…ç©ºå…ç¨…è³¼ç‰©ç±ƒå—ï¼Ÿ")) { taxBasket = []; renderContent(); } }
    window.fetchExchangeRate = async () => { const btn = document.getElementById('fetchRateBtn'); const originalText = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY'); const data = await res.json(); const twd = data.rates.TWD; if(twd) { updateRate(twd.toFixed(4)); document.getElementById('rateInput').value = twd.toFixed(4); showToast(`åŒ¯ç‡å·²æ›´æ–°ï¼š${twd}`); } } catch(e) { showToast("æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); } finally { btn.innerHTML = originalText; } }
    window.toggleCheck = (key) => { const v=localStorage.getItem(key); v==='1'?localStorage.removeItem(key):localStorage.setItem(key,'1'); renderContent(); }
    window.addChecklistItem = () => { const text = prompt("æ–°å¢é …ç›®åç¨±ï¼š"); if (!text) return; const sub = prompt("å‚™è¨» (å¯ä¸å¡«)ï¼š") || ""; const list = checklistDB.find(c => c.id === currentChecklistFilter); list.items.push({ text: text, sub: sub }); saveChecklistDB(); renderContent(); showToast("å·²æ–°å¢é …ç›®"); }
    window.deleteChecklistItem = (index) => { if (!confirm("åˆªé™¤æ­¤é …ç›®ï¼Ÿ")) return; const list = checklistDB.find(c => c.id === currentChecklistFilter); const itemText = list.items[index].text; localStorage.removeItem(`chk_${currentChecklistFilter}_${itemText}`); list.items.splice(index, 1); saveChecklistDB(); renderContent(); showToast("å·²åˆªé™¤é …ç›®"); }
    window.resetChecklist = (id) => { if(confirm('é‡ç½®æ¸…å–®ï¼Ÿ')) { checklistDB.find(c=>c.id===id).items.forEach(item => localStorage.removeItem(`chk_${id}_${item.text}`)); renderContent(); showToast("å·²é‡ç½®"); } }
    function saveChecklistDB() { localStorage.setItem('trip_checklist_db', JSON.stringify(checklistDB)); }
    
    // --- éŠæˆ²åŒ– (Game Logic) ---
    function playCoinSound() { const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='sine'; o.frequency.setValueAtTime(987,ctx.currentTime); o.frequency.exponentialRampToValueAtTime(1318,ctx.currentTime+0.1); g.gain.setValueAtTime(0.3,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.5); o.start(); o.stop(ctx.currentTime+0.5); }
    function playGashaSound() { const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='square'; o.frequency.setValueAtTime(100,ctx.currentTime); o.frequency.linearRampToValueAtTime(800,ctx.currentTime+0.2); g.gain.setValueAtTime(0.1,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.3); o.start(); o.stop(ctx.currentTime+0.3); }
    window.toggleMission = (id) => { const d=localStorage.getItem(id)==='1'; if(d){if(confirm('å–æ¶ˆæˆå°±ï¼Ÿ')) localStorage.removeItem(id); renderContent();}else{if(navigator.vibrate)navigator.vibrate(200); playCoinSound(); localStorage.setItem(id,'1'); showToast("ğŸ‰ ç²å¾—ä»£å¹£ï¼"); renderContent();} }
    function getGashaBalance() { let c=0; missionsDB.forEach(m=>{if(localStorage.getItem(m.id)==='1')c++}); let b=c-gashaCoinsUsed; if(b<0){gashaCoinsUsed=c; localStorage.setItem('gasha_coins_used', gashaCoinsUsed); b=0;} return b; }
    window.spinGasha = () => { if(getGashaBalance()<=0)return; playGashaSound(); document.getElementById('gasha-machine').classList.add('animate-shake'); gashaCoinsUsed++; localStorage.setItem('gasha_coins_used', gashaCoinsUsed); renderContent(); setTimeout(()=>{document.getElementById('gasha-machine').classList.remove('animate-shake'); const r=rewardsDB[Math.floor(Math.random()*rewardsDB.length)]; document.getElementById('gasha-reward-icon').innerText=r.icon; document.getElementById('gasha-reward-text').innerText=r.text; document.getElementById('gasha-modal').classList.add('open'); playCoinSound();}, 800); }
    window.closeGashaModal = () => document.getElementById('gasha-modal').classList.remove('open');
    
    // --- ä¸€èˆ¬å·¥å…· (Utils) ---
    window.copyMapCode = (c) => { navigator.clipboard.writeText(c).then(()=>showToast("MapCode å·²è¤‡è£½")); }
    window.updateRate = (v) => { if(v>0){CURRENT_RATE=parseFloat(v); localStorage.setItem('user_rate',v); convertCurrency(); renderContent();} }
    window.convertCurrency = () => { const j=parseFloat(document.getElementById('jpyInput').value); const t=document.getElementById('twdOutput'); if(isNaN(j)||j<=0){t.innerText="0";return;} t.innerText=(j*CURRENT_RATE).toFixed(j%1!==0?2:0).toLocaleString('en-US'); }
    window.setBudget = () => { const n=prompt("è¼¸å…¥ç¸½é ç®—:", TOTAL_BUDGET); if(n&&!isNaN(n)){TOTAL_BUDGET=parseInt(n); localStorage.setItem('trip_budget', TOTAL_BUDGET); renderContent();} }
    window.addExpense = () => { const n=document.getElementById('exName').value; const p=document.getElementById('exPrice').value; const c=document.querySelector('input[name="cat"]:checked')?.value||'other'; if(!n||!p){showToast("è«‹è¼¸å…¥å®Œæ•´");return;} expenses.unshift({name:n,price:parseInt(p),cat:c}); localStorage.setItem('trip_expenses',JSON.stringify(expenses)); showToast("å·²è¨˜å¸³"); renderContent(); }
    window.openQuickExpense = () => { document.getElementById('expense-modal').classList.add('open'); setTimeout(()=>document.getElementById('quickExPrice').focus(),100); }
    window.closeQuickExpense = () => { document.getElementById('expense-modal').classList.remove('open'); document.getElementById('quickExName').value=""; document.getElementById('quickExPrice').value=""; }
    window.saveQuickExpense = () => { const n=document.getElementById('quickExName').value; const p=document.getElementById('quickExPrice').value; const c=document.querySelector('input[name="quick-cat"]:checked')?.value||'shopping'; if(!n||!p){showToast("è«‹è¼¸å…¥å®Œæ•´");return;} expenses.unshift({name:n,price:parseInt(p),cat:c}); localStorage.setItem('trip_expenses',JSON.stringify(expenses)); showToast("å¿«é€Ÿè¨˜å¸³æˆåŠŸ"); if(activeTab==='tools'&&currentToolFilter==='calc')renderContent(); closeQuickExpense(); }
    window.exportExpenses = () => { if(expenses.length===0)return; let t=0; let txt="ğŸ¦• å¸³å‹™ï¼š\n"; expenses.forEach(e=>{txt+=`${e.name}: Â¥${e.price}\n`;t+=e.price;}); txt+=`ç¸½è¨ˆ: Â¥${t}`; navigator.clipboard.writeText(txt).then(()=>showToast("å·²è¤‡è£½")); }
    window.deleteExpense = (i) => { if(confirm("åˆªé™¤ï¼Ÿ")){expenses.splice(i,1); localStorage.setItem('trip_expenses',JSON.stringify(expenses)); renderContent();} }
    window.quickSearch = (q) => { window.open(`http://maps.google.com/?q=${encodeURIComponent(q)}`,'_blank'); showToast("æœå°‹ä¸­..."); }
    // v17.0: é»é¤èªéŸ³ä½¿ç”¨ speak() å‡½å¼ï¼Œæ”¯æ´æ—¥èª
    window.speak = (t,b) => { 
        if(b && b.querySelector) { // å¦‚æœæ˜¯æŒ‰éˆ•å…ƒç´ 
            const o=b.innerHTML; b.innerHTML=`<div class="playing-wave"><span></span><span></span><span></span></div>`; 
            const reset = () => b.innerHTML = o;
            if('speechSynthesis' in window){const u=new SpeechSynthesisUtterance(t);u.lang='ja-JP';u.rate=0.9;u.onend=reset;u.onerror=()=>{reset();window.open(`https://translate.google.com/?sl=ja&tl=zh-TW&text=${encodeURIComponent(t)}&op=translate`,'_blank');};window.speechSynthesis.speak(u);}else{reset();window.open(`https://translate.google.com/?sl=ja&tl=zh-TW&text=${encodeURIComponent(t)}&op=translate`,'_blank');}
        } else {
            // ç´”æ–‡å­—è§¸ç™¼
             if('speechSynthesis' in window){const u=new SpeechSynthesisUtterance(t);u.lang='ja-JP';window.speechSynthesis.speak(u);}
        }
    }
    window.toggleEditMedical = () => { document.getElementById('medical-view').classList.toggle('hidden'); document.getElementById('medical-edit').classList.toggle('hidden'); }
    window.saveMedical = () => { const n=document.getElementById('in-name').value; const p=document.getElementById('in-phone').value; const h=document.getElementById('in-hotel').value; const a=Array.from(document.querySelectorAll('.allergy-chk:checked')).map(c=>c.value); medicalData={name:n,phone:p,hotel:h,allergies:a}; localStorage.setItem('medical_data',JSON.stringify(medicalData)); toggleEditMedical(); renderContent(); showToast("å·²æ›´æ–°"); }
    window.showInfoCard = (t, p) => { const m=document.getElementById('modal-overlay'); const tag=document.getElementById('modal-tag'); const tit=document.getElementById('modal-title'); const con=document.getElementById('modal-content'); const not=document.getElementById('modal-note'); if(t==='hotel'){if(!p){showToast("è«‹å…ˆç·¨è¼¯");return;} tag.innerText="çµ¦å¸æ©Ÿçœ‹"; tit.innerHTML="ã“ã®ãƒ›ãƒ†ãƒ«ã¾ã§<br>ãŠé¡˜ã„ã—ã¾ã™"; con.innerText=p; con.className="text-xl font-bold text-blue-700 mb-2"; not.innerText="è«‹å¸¶æˆ‘å»é€™å®¶é£¯åº—";}else if(t==='gas'){tag.innerText="çµ¦åº—å“¡"; tit.innerHTML="ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æº€ã‚¿ãƒ³<br>ç¾é‡‘ã§"; con.innerText="Regular Full / Cash"; con.className="text-xl font-bold text-red-600 mb-2"; not.innerText="ç´…æ§åŠ æ»¿ï¼Œä»˜ç¾";} m.classList.add('open'); }
    window.closeModal = () => document.getElementById('modal-overlay').classList.remove('open');
    window.openRewardEditor = () => { renderRewardList(); document.getElementById('reward-editor-modal').classList.add('open'); }
    window.closeRewardEditor = () => document.getElementById('reward-editor-modal').classList.remove('open');
    window.renderRewardList = () => { const list = document.getElementById('reward-list'); if(!list) return; list.innerHTML = rewardsDB.map((r, i) => `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100"><div class="flex items-center gap-3"><span class="text-2xl bg-white w-10 h-10 flex items-center justify-center rounded-full shadow-sm">${r.icon}</span><span class="font-bold text-gray-700 text-sm">${r.text}</span></div><button onclick="deleteReward(${i})" class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center active:bg-red-200"><i class="fas fa-trash-alt text-xs"></i></button></div>`).join(''); }
    window.addReward = () => { const icon = document.getElementById('new-reward-icon').value; const text = document.getElementById('new-reward-text').value; if(text) { rewardsDB.push({ icon, text }); saveRewards(); renderRewardList(); document.getElementById('new-reward-text').value = ''; } else { showToast("è«‹è¼¸å…¥çå“åç¨±"); } }
    window.deleteReward = (idx) => { if(confirm('åˆªé™¤é€™å€‹çé …ï¼Ÿ')) { rewardsDB.splice(idx, 1); saveRewards(); renderRewardList(); } }
    window.resetRewards = () => { if(confirm('æ¢å¾©ç‚ºé è¨­çå‹µï¼Ÿ')) { rewardsDB = [...defaultRewards]; saveRewards(); renderRewardList(); } }
    function saveRewards() { localStorage.setItem('gasha_rewards', JSON.stringify(rewardsDB)); }
    
    // v17.0 å‡ç´šç‰ˆ: åœè»Šå„²å­˜ (æ”¯æ´ç…§ç‰‡)
    window.saveParking = () => { 
        const n = prompt("ä½ç½®å‚™è¨» (ä¾‹å¦‚: B1 ç¶ å€):", parkingData ? parkingData.note : ""); 
        if(n === null) return;
        
        // å˜—è©¦ä¸Šå‚³ç…§ç‰‡?
        const wantPhoto = confirm("è¦é †ä¾¿æ‹å¼µç…§/ä¸Šå‚³ç…§ç‰‡å—ï¼Ÿ");
        let photoData = null;
        
        if (wantPhoto) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // å„ªå…ˆä½¿ç”¨å¾Œé¡é ­
            input.onchange = (e) => {
                const file = e.target.files[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        photoData = evt.target.result;
                        saveParkingToStorage(n, photoData);
                    };
                    reader.readAsDataURL(file);
                } else {
                    saveParkingToStorage(n, null);
                }
            };
            input.click();
        } else {
            saveParkingToStorage(n, null);
        }
    }
    
    function saveParkingToStorage(note, photo) {
        if(navigator.geolocation){
            navigator.geolocation.getCurrentPosition(p=>{
                parkingData = {
                    lat: p.coords.latitude,
                    lon: p.coords.longitude,
                    note: note,
                    photo: photo || (parkingData ? parkingData.photo : null), // ä¿ç•™èˆŠç…§ç‰‡
                    time: new Date().toTimeString().slice(0,5)
                }; 
                localStorage.setItem('parking_data',JSON.stringify(parkingData)); 
                renderContent(); 
                showToast("âœ… å·²è¨˜éŒ„åœè»Šä½ï¼");
            });
        }
    }
    
    window.findCar = () => { if(parkingData) window.open(`http://maps.google.com/?q=${parkingData.lat},${parkingData.lon}`, '_blank'); }
    window.clearParking = () => { if(confirm("æ¸…é™¤ï¼Ÿ")){parkingData=null; localStorage.removeItem('parking_data'); renderContent();} }
    window.backupData = () => { const d={user_rate:localStorage.getItem('user_rate'), trip_budget:localStorage.getItem('trip_budget'), trip_expenses:localStorage.getItem('trip_expenses'), trip_gifts:localStorage.getItem('trip_gifts'), medical_data:localStorage.getItem('medical_data'), parking_data:localStorage.getItem('parking_data'), gasha_coins_used:localStorage.getItem('gasha_coins_used'), gasha_rewards:localStorage.getItem('gasha_rewards'), items:{}}; for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i); if(k.startsWith('chk_')||k.startsWith('m')||k.startsWith('diary_')||k==='last_departure_check')d.items[k]=localStorage.getItem(k);} navigator.clipboard.writeText(btoa(encodeURIComponent(JSON.stringify(d)))).then(()=>showToast("ä»£ç¢¼å·²è¤‡è£½")); }
    window.restoreData = () => { const c=document.getElementById('importDataInput').value.trim(); if(!c)return; if(confirm("è¦†è“‹è³‡æ–™ï¼Ÿ")){try{const d=JSON.parse(decodeURIComponent(atob(c))); if(d.user_rate)localStorage.setItem('user_rate',d.user_rate); if(d.trip_budget)localStorage.setItem('trip_budget',d.trip_budget); if(d.trip_expenses)localStorage.setItem('trip_expenses',d.trip_expenses); if(d.trip_gifts)localStorage.setItem('trip_gifts',d.trip_gifts); if(d.medical_data)localStorage.setItem('medical_data',d.medical_data); if(d.parking_data)localStorage.setItem('parking_data',d.parking_data); if(d.gasha_coins_used)localStorage.setItem('gasha_coins_used',d.gasha_coins_used); if(d.gasha_rewards)localStorage.setItem('gasha_rewards',d.gasha_rewards); if(d.items){for(let k in d.items)localStorage.setItem(k,d.items[k]);} alert("æˆåŠŸï¼"); location.reload();}catch(e){alert("ä»£ç¢¼éŒ¯èª¤");}} }
    function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.className="show"; setTimeout(()=>t.className="",3000); }
    
    // --- Geofence & HUD Helpers ---
    function checkGeofence(userLat, userLon) {
        missionsDB.forEach(m => {
            if (localStorage.getItem(m.id) !== '1' && localStorage.getItem(m.id + '_notified') !== '1') {
                const dist = getDistanceFromLatLonInKm(userLat, userLon, m.lat, m.lon);
                if (dist < 0.5) { // 500m
                    showGeoToast(`æ¥è¿‘ä»»å‹™é»ï¼š${m.title}`);
                    localStorage.setItem(m.id + '_notified', '1');
                    if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
                    playSound('magic');
                }
            }
        });
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
        var R = 6371; var dLat = deg2rad(lat2-lat1); var dLon = deg2rad(lon2-lon1); 
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function showGeoToast(msg) { const t = document.getElementById('geo-toast'); document.getElementById('geo-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 5000); }

    // --- Translation ---
    let recognition;
    function toggleTranslation() {
        // v17.0 ä½¿ç”¨æ–°çš„ toggleVoiceMemo å–ä»£æˆ–å…±ç”¨ï¼Œé€™è£¡ä¿ç•™ç¿»è­¯å°ˆç”¨ä»‹é¢é‚è¼¯ (Part 8 ä½¿ç”¨)
        const btn = document.getElementById('mic-btn');
        const output = document.getElementById('trans-output');
        if (!('webkitSpeechRecognition' in window)) { output.innerHTML = '<span class="text-red-400">âŒ ä¸æ”¯æ´</span>'; return; }
        if (btn.classList.contains('listening')) { if(recognition) recognition.stop(); btn.classList.remove('listening'); output.innerText = "é»æ“ŠæŒ‰éˆ•ï¼Œè«‹åº—å“¡èªªè©±"; return; }
        try {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja-JP'; recognition.continuous = false; recognition.interimResults = false;
            recognition.onstart = function() { btn.classList.add('listening'); output.innerHTML = '<span class="animate-pulse">ğŸ‡¯ğŸ‡µ è½æ—¥æ–‡ä¸­...</span>'; };
            recognition.onresult = function(event) { const transcript = event.results[0][0].transcript; output.className = "w-full bg-white/10 rounded-xl p-4 flex flex-col items-center justify-center gap-3 animate-pop"; output.innerHTML = `<div class="text-2xl font-black text-white tracking-widest">ã€Œ${transcript}ã€</div><a href="https://translate.google.com/?sl=ja&tl=zh-TW&text=${encodeURIComponent(transcript)}&op=translate" target="_blank" class="bg-blue-600 text-white text-sm px-8 py-3 rounded-full font-bold shadow-lg">ğŸ¦– ç¿»è­¯æˆä¸­æ–‡</a>`; };
            recognition.onerror = function(event) { output.innerHTML = `<span class="text-red-400 text-sm font-bold">âŒ éŒ¯èª¤ (è«‹é‡è©¦)</span>`; btn.classList.remove('listening'); };
            recognition.onend = function() { btn.classList.remove('listening'); };
            recognition.start();
        } catch (e) { output.innerHTML = '<span class="text-red-400">âŒ å•Ÿå‹•å¤±æ•—</span>'; }
    }
   
    function getTideWidgetHTML() { const d = itineraryDB[currentDayIdx].day; const info = tideDB[d] || tideDB["D1"]; return `<div class="tide-widget mb-6 shadow-lg"><div class="relative z-10 p-5"><div class="flex justify-between items-start"><div><div class="text-[10px] font-bold opacity-70 uppercase tracking-widest">TIDE & SUN (Day ${currentDayIdx+1})</div><div class="text-2xl font-black mt-1 flex items-center gap-2"><i class="fas fa-water text-blue-200"></i> ${info.low} <span class="text-xs opacity-70 font-normal">ä¹¾æ½®</span></div><div class="text-sm font-bold mt-1 opacity-90"><i class="fas fa-sun text-yellow-300 mr-1"></i> æ—¥è½ ${info.sun}</div></div><div class="text-right"><div class="text-[10px] opacity-70">é©åˆç©æ°´</div><div class="text-xl font-bold">${parseInt(info.low.split(':')[0]) - 2}:00 - ${parseInt(info.low.split(':')[0]) + 2}:00</div></div></div></div><div class="wave-box"><div class="wave"></div><div class="wave"></div></div></div>`; }

    // --- Wrapped ---
    let currentWrapSlide = 1;
    function openWrapped() {
        const totalExp = expenses.reduce((a, b) => a + b.price, 0);
        const shopExp = expenses.filter(e => e.cat === 'shopping').reduce((a, b) => a + b.price, 0);
        const foodExp = expenses.filter(e => e.cat === 'food').reduce((a, b) => a + b.price, 0);
        const missionsDone = missionsDB.filter(m => localStorage.getItem(m.id) === '1').length;
        const totalGasha = parseInt(localStorage.getItem('gasha_coins_used') || 0);
        const totalSteps = (currentDayIdx + 1) * 8500 + Math.floor(Math.random()*2000); 
        document.getElementById('wrap-steps').innerText = totalSteps.toLocaleString();
        document.getElementById('wrap-koku').innerText = (totalSteps * 0.0007 / 1.6).toFixed(1);
        document.getElementById('wrap-money').innerText = "Â¥" + totalExp.toLocaleString();
        document.getElementById('wrap-shop').innerText = "Â¥" + shopExp.toLocaleString();
        document.getElementById('wrap-food').innerText = "Â¥" + foodExp.toLocaleString();
        document.getElementById('wrap-gasha').innerText = totalGasha;
        document.getElementById('wrap-mission').innerText = missionsDone;
        document.getElementById('wrapped-modal').classList.remove('hidden'); document.getElementById('wrapped-modal').classList.add('flex'); showWrapSlide(1);
    }
    function closeWrapped() { document.getElementById('wrapped-modal').classList.add('hidden'); document.getElementById('wrapped-modal').classList.remove('flex'); }
    function showWrapSlide(n) { document.querySelectorAll('.wrapped-slide').forEach(s => s.classList.remove('active')); document.getElementById(`wrap-${n}`).classList.add('active'); currentWrapSlide = n; }
    function nextWrappedSlide() { if (currentWrapSlide < 5) { showWrapSlide(currentWrapSlide + 1); if(navigator.vibrate) navigator.vibrate(50); } else { closeWrapped(); } }

    // --- Driver HUD ---
    let hudWatchId = null, wakeLock = null, hudCurrentEventIdx = 0, hudAllEvents = [];
    let roadType = 'city'; let currentSpeedLimit = 50; 
    function flattenEvents() { let l=[]; itineraryDB.forEach(d=>{d.events.forEach(e=>{l.push({...((isRainyMode&&e.rainy)?{...e,...e.rainy}:e), dayTitle:d.day, fullTitle:e.title});});}); return l; }
    async function openDriverMode() { document.getElementById('driver-hud').classList.remove('hidden'); document.getElementById('driver-hud').classList.add('flex'); hudAllEvents=flattenEvents(); hudCurrentEventIdx=0; updateHUDUI(); if(navigator.geolocation) hudWatchId=navigator.geolocation.watchPosition(updateHudSpeed,console.log,{enableHighAccuracy:true}); try{if('wakeLock' in navigator) wakeLock=await navigator.wakeLock.request('screen');}catch(e){} startHudClock(); }
    function closeDriverMode() { document.getElementById('driver-hud').classList.add('hidden'); document.getElementById('driver-hud').classList.remove('flex'); if(hudWatchId)navigator.geolocation.clearWatch(hudWatchId); if(wakeLock)wakeLock.release(); }
    function updateHUDUI() { const e=hudAllEvents[hudCurrentEventIdx]; if(!e)return; document.getElementById('hud-title').innerText=e.title; const mc=document.getElementById('hud-mapcode'); if(e.mapcode){mc.innerText=e.mapcode; mc.classList.replace('text-gray-600','text-yellow-400');}else{mc.innerText="NO MAPCODE"; mc.classList.replace('text-yellow-400','text-gray-600');} const btn=document.getElementById('hud-nav-btn'); if(e.map){btn.href=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.map)}`; btn.classList.remove('opacity-50','pointer-events-none'); btn.innerHTML=`<i class="fas fa-location-arrow animate-pulse"></i> <span>GO å°èˆª</span>`;}else{btn.href="#"; btn.classList.add('opacity-50','pointer-events-none'); btn.innerHTML=`<span>ç„¡å°èˆªé»</span>`;} }
    function changeHudEvent(d) { hudCurrentEventIdx+=d; if(hudCurrentEventIdx<0)hudCurrentEventIdx=0; if(hudCurrentEventIdx>=hudAllEvents.length)hudCurrentEventIdx=hudAllEvents.length-1; updateHUDUI(); }
    function updateHudSpeed(p) { const s = p.coords.speed ? Math.round(p.coords.speed * 3.6) : 0; const el = document.getElementById('hud-speed'); const warn = document.getElementById('speed-warning'); el.innerText = s; if(s > currentSpeedLimit) { el.className = "text-[9rem] font-black text-red-500 leading-none tracking-tighter transition-all duration-200 drop-shadow-[0_0_15px_rgba(239,68,68,0.8)]"; warn.classList.remove('opacity-0'); } else { el.className = "text-[9rem] font-black text-white leading-none tracking-tighter transition-all duration-200 drop-shadow-2xl"; warn.classList.add('opacity-0'); } }
    function toggleRoadType() { const b = document.getElementById('btn-road-type'); if(roadType === 'city') { roadType = 'highway'; currentSpeedLimit = 80; b.innerText = "é«˜é€Ÿé“è·¯ (80)"; b.className = "px-4 py-2 rounded-lg border border-green-500 bg-green-900/30 text-green-400 text-sm font-bold active:bg-green-800 transition-colors shadow-[0_0_10px_rgba(34,197,94,0.3)]"; showToast("ğŸš— åˆ‡æ›ç‚ºé«˜é€Ÿæ¨¡å¼ (é™é€Ÿ80)"); } else { roadType = 'city'; currentSpeedLimit = 50; b.innerText = "ä¸€èˆ¬é“è·¯ (50)"; b.className = "px-4 py-2 rounded-lg border border-blue-900 bg-blue-900/20 text-blue-400 text-sm font-bold active:bg-blue-800 transition-colors"; showToast("ğŸ™ï¸ åˆ‡æ›ç‚ºå¸‚å€æ¨¡å¼ (é™é€Ÿ50)"); } }
    function startHudClock() { const u=()=>{const d=new Date(); document.getElementById('hud-clock').innerText=`${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`; if(!document.getElementById('driver-hud').classList.contains('hidden'))requestAnimationFrame(()=>setTimeout(u,1000));}; u(); }
    function copyHudMapCode() { const t=document.getElementById('hud-mapcode'); if(t.innerText!=="NO MAPCODE"){navigator.clipboard.writeText(t.innerText); t.style.color="#4ade80"; setTimeout(()=>t.style.color="",300); showToast("Copied");} }
	
	// v17.4 æ–°åŠŸèƒ½: ä¸€éµå°èˆªå›é£¯åº—
    window.goBackHotel = () => {
        let hotel = "";
        // åˆ¤æ–·ä»Šå¤©æ˜¯å“ªä¸€å¤©ï¼Œæ±ºå®šå›å“ªå®¶é£¯åº—
        if (currentDayIdx <= 4) { // Day 1 - Day 5 ä½åè­·
            hotel = "Best Western Okinawa Kouki Beach";
        } else { // Day 6 - Day 7 ä½é‚£éœ¸
            hotel = "Daiwa Roynet Hotel Naha Kokusai-dori";
        }

        if(confirm(`å°èˆªå›ä»Šæ™šä½å®¿ï¼Ÿ\nğŸ¨ ${hotel}`)) {
            // ä½¿ç”¨ Google Maps æœå°‹é€£çµ
            window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hotel)}`, '_blank');
        }
    }
	
	// ================= v18.0 æ–°åŠŸèƒ½ï¼šåœ°åœ–èˆ‡ç›¸ç°¿æ ¸å¿ƒé‚è¼¯ =================

    // --- 1. æ¯æ—¥è·¯å¾‘åœ°åœ– (Leaflet) ---
    let dayMap = null;
    function initDayMap() {
        const d = itineraryDB[currentDayIdx];
        // æ‰¾å‡ºç•¶å¤©æ‰€æœ‰æœ‰åº§æ¨™çš„é»
        const points = d.events.filter(e => e.lat && e.lon);
        
        // å¦‚æœåœ°åœ–å®¹å™¨ä¸å­˜åœ¨æˆ–æ˜¯ç•¶å¤©æ²’æœ‰åº§æ¨™é»ï¼Œå°±éš±è—
        const mapEl = document.getElementById('day-map-container');
        if (!mapEl) return;
        
        if (points.length === 0) {
            mapEl.innerHTML = '<div class="h-full flex items-center justify-center text-gray-300 text-xs bg-slate-50 rounded-xl">ä»Šæ—¥ç„¡è·¯ç·šè³‡æ–™</div>';
            return;
        }

        // åˆå§‹åŒ–åœ°åœ–
        if (dayMap) { dayMap.remove(); dayMap = null; }
        // å»ºç«‹åœ°åœ–å¯¦ä¾‹
        dayMap = L.map('day-map-container', { zoomControl: false, attributionControl: false });
        
        // åŠ å…¥åœ–å±¤ (ä½¿ç”¨ CartoDB ç°¡æ½”é¢¨æ ¼)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 19
        }).addTo(dayMap);

        // ç•«ç·šèˆ‡æ¨™è¨˜
        const latlngs = points.map(p => [p.lat, p.lon]);
        const polyline = L.polyline(latlngs, {color: '#3b82f6', weight: 4, opacity: 0.7, dashArray: '5, 10'}).addTo(dayMap);

        // åŠ ä¸Šèµ·é»çµ‚é»èˆ‡ä¸­é–“é»çš„æ¨™è¨˜
        points.forEach((p, idx) => {
            let color = '#3b82f6'; // ä¸­é–“é»è—è‰²
            if (idx === 0) color = '#22c55e'; // èµ·é»ç¶ è‰²
            if (idx === points.length - 1) color = '#ef4444'; // çµ‚é»ç´…è‰²
            
            const markerHtml = `<div style="background:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>`;
            const icon = L.divIcon({ className: 'custom-div-icon', html: markerHtml, iconSize: [12, 12], iconAnchor: [6, 6] });
            
            L.marker([p.lat, p.lon], {icon: icon}).addTo(dayMap).bindPopup(`<b style="font-size:12px">${p.title}</b>`);
        });

        // è‡ªå‹•èª¿æ•´è¦–é‡ç¯„åœ
        dayMap.fitBounds(polyline.getBounds(), { padding: [30, 30] });
    }

    // --- 2. ç…§ç‰‡å›æ†¶ç‰† (IndexedDB) ---
    // é–‹å•Ÿè³‡æ–™åº«
    function openPhotoDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open("TripGalleryDB", 1);
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                if (!db.objectStoreNames.contains("photos")) {
                    db.createObjectStore("photos", { keyPath: "id", autoIncrement: true });
                }
            };
            request.onsuccess = function(event) { resolve(event.target.result); };
            request.onerror = function(event) { reject("DB Error"); };
        });
    }

    // å„²å­˜ç…§ç‰‡
    async function savePhotoToDB(blob) {
        try {
            const db = await openPhotoDB();
            const tx = db.transaction("photos", "readwrite");
            const store = tx.objectStore("photos");
            store.add({ data: blob, date: new Date().toLocaleString(), day: `Day ${currentDayIdx+1}` });
            console.log("ç…§ç‰‡å·²å­˜å…¥è³‡æ–™åº«");
        } catch (e) { console.error("å­˜æª”å¤±æ•—", e); }
    }

    // è®€å–ä¸¦é¡¯ç¤ºç…§ç‰‡ç‰†
    async function loadGallery() {
        const container = document.getElementById('gallery-grid');
        if (!container) return;
        
        try {
            const db = await openPhotoDB();
            const tx = db.transaction("photos", "readonly");
            const store = tx.objectStore("photos");
            const request = store.getAll();
            
            request.onsuccess = function() {
                const photos = request.result.reverse(); // æœ€æ–°çš„åœ¨å‰é¢
                if (photos.length === 0) {
                    container.innerHTML = `<div class="col-span-3 text-center text-gray-400 py-4 text-xs">é‚„æ²’æ‹ç…§ç‰‡å–”ï¼å¿«å»ç”¨ã€Œå·¥å…· > å›æ†¶ç›¸æ©Ÿã€æ‹ç…§å§ï¼</div>`;
                    return;
                }
                
                container.innerHTML = photos.map(p => {
                    const url = URL.createObjectURL(p.data);
                    return `<div class="aspect-square rounded-xl overflow-hidden relative shadow-sm border border-slate-100 group" onclick="showParkingPhotoFull('${url}')">
                        <img src="${url}" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[9px] p-1 text-center backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">${p.day}</div>
                    </div>`;
                }).join('');
            };
        } catch (e) {
            container.innerHTML = "è¼‰å…¥å¤±æ•—";
        }
    }
	
    // Start App
    init();
</script>
</body>
</html>
